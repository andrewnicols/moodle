define ("core_message/message_drawer_view_search",["jquery","core/custom_interaction_events","core/notification","core/pubsub","core/str","core/templates","core_message/message_repository","core_message/message_drawer_events"],function($,CustomEvents,Notification,PubSub,Str,Templates,Repository,Events){var USERS_SEARCH_LIMIT=50,USERS_INITIAL_SEARCH_LIMIT=3,SELECTORS={BLOCK_ICON_CONTAINER:"[data-region=\"block-icon-container\"]",CANCEL_SEARCH_BUTTON:"[data-action=\"cancel-search\"]",CONTACTS_CONTAINER:"[data-region=\"contacts-container\"]",CONTACTS_LIST:"[data-region=\"contacts-container\"] [data-region=\"list\"]",EMPTY_MESSAGE_CONTAINER:"[data-region=\"empty-message-container\"]",LIST:"[data-region=\"list\"]",LOADING_ICON_CONTAINER:"[data-region=\"loading-icon-container\"]",LOADING_PLACEHOLDER:"[data-region=\"loading-placeholder\"]",MESSAGES_LIST:"[data-region=\"messages-container\"] [data-region=\"list\"]",MESSAGES_CONTAINER:"[data-region=\"messages-container\"]",NON_CONTACTS_CONTAINER:"[data-region=\"non-contacts-container\"]",NON_CONTACTS_LIST:"[data-region=\"non-contacts-container\"] [data-region=\"list\"]",SEARCH_ICON_CONTAINER:"[data-region=\"search-icon-container\"]",SEARCH_ACTION:"[data-action=\"search\"]",SEARCH_INPUT:"[data-region=\"search-input\"]",SEARCH_RESULTS_CONTAINER:"[data-region=\"search-results-container\"]",LOAD_MORE_USERS:"[data-action=\"load-more-users\"]",LOAD_MORE_MESSAGES:"[data-action=\"load-more-messages\"]",BUTTON_TEXT:"[data-region=\"button-text\"]",NO_RESULTS_CONTAINTER:"[data-region=\"no-results-container\"]",ALL_CONTACTS_CONTAINER:"[data-region=\"all-contacts-container\"]"},TEMPLATES={CONTACTS_LIST:"core_message/message_drawer_contacts_list",NON_CONTACTS_LIST:"core_message/message_drawer_non_contacts_list",MESSAGES_LIST:"core_message/message_drawer_messages_list"},getLoggedInUserId=function(body){return body.attr("data-user-id")},getEmptyMessageContainer=function(body){return body.find(SELECTORS.EMPTY_MESSAGE_CONTAINER)},getLoadingIconContainer=function(header){return header.find(SELECTORS.LOADING_ICON_CONTAINER)},getLoadingPlaceholder=function(body){return body.find(SELECTORS.LOADING_PLACEHOLDER)},getSearchIconContainer=function(header){return header.find(SELECTORS.SEARCH_ICON_CONTAINER)},getSearchInput=function(header){return header.find(SELECTORS.SEARCH_INPUT)},getSearchResultsContainer=function(body){return body.find(SELECTORS.SEARCH_RESULTS_CONTAINER)},getContactsContainer=function(body){return body.find(SELECTORS.CONTACTS_CONTAINER)},getNonContactsContainer=function(body){return body.find(SELECTORS.NON_CONTACTS_CONTAINER)},getMessagesContainer=function(body){return body.find(SELECTORS.MESSAGES_CONTAINER)},showEmptyMessage=function(body){getEmptyMessageContainer(body).removeClass("hidden")},hideEmptyMessage=function(body){getEmptyMessageContainer(body).addClass("hidden")},showLoadingIcon=function(header){getLoadingIconContainer(header).removeClass("hidden")},hideLoadingIcon=function(header){getLoadingIconContainer(header).addClass("hidden")},showLoadingPlaceholder=function(body){getLoadingPlaceholder(body).removeClass("hidden")},hideLoadingPlaceholder=function(body){getLoadingPlaceholder(body).addClass("hidden")},showSearchIcon=function(header){getSearchIconContainer(header).removeClass("hidden")},hideSearchIcon=function(header){getSearchIconContainer(header).addClass("hidden")},showSearchResults=function(body){getSearchResultsContainer(body).removeClass("hidden")},hideSearchResults=function(body){getSearchResultsContainer(body).addClass("hidden")},showNoSearchResults=function(body){var container=getSearchResultsContainer(body);container.find(SELECTORS.ALL_CONTACTS_CONTAINER).addClass("hidden");container.find(SELECTORS.MESSAGES_CONTAINER).addClass("hidden");container.find(SELECTORS.NO_RESULTS_CONTAINTER).removeClass("hidden")},hideNoSearchResults=function(body){var container=getSearchResultsContainer(body);container.find(SELECTORS.ALL_CONTACTS_CONTAINER).removeClass("hidden");container.find(SELECTORS.MESSAGES_CONTAINER).removeClass("hidden");container.find(SELECTORS.NO_RESULTS_CONTAINTER).addClass("hidden")},showAllContactsSearchResults=function(body){var container=getSearchResultsContainer(body);container.find(SELECTORS.ALL_CONTACTS_CONTAINER).removeClass("hidden")},hideAllContactsSearchResults=function(body){var container=getSearchResultsContainer(body);container.find(SELECTORS.ALL_CONTACTS_CONTAINER).addClass("hidden")},showContactsSearchResults=function(body){var container=getSearchResultsContainer(body);container.find(SELECTORS.CONTACTS_CONTAINER).removeClass("hidden")},hideContactsSearchResults=function(body){var container=getSearchResultsContainer(body);container.find(SELECTORS.CONTACTS_CONTAINER).addClass("hidden")},showNonContactsSearchResults=function(body){var container=getSearchResultsContainer(body);container.find(SELECTORS.NON_CONTACTS_CONTAINER).removeClass("hidden")},hideNonContactsSearchResults=function(body){var container=getSearchResultsContainer(body);container.find(SELECTORS.NON_CONTACTS_CONTAINER).addClass("hidden")},showMessagesSearchResults=function(body){var container=getSearchResultsContainer(body);container.find(SELECTORS.MESSAGES_CONTAINER).removeClass("hidden")},hideMessagesSearchResults=function(body){var container=getSearchResultsContainer(body);container.find(SELECTORS.MESSAGES_CONTAINER).addClass("hidden")},disableSearchInput=function(header){getSearchInput(header).prop("disabled",!0)},enableSearchInput=function(header){getSearchInput(header).prop("disabled",!1)},clearSearchInput=function(header){getSearchInput(header).val("")},clearAllSearchResults=function(body){body.find(SELECTORS.CONTACTS_LIST).empty();body.find(SELECTORS.NON_CONTACTS_LIST).empty();body.find(SELECTORS.MESSAGES_LIST).empty();hideNoSearchResults(body);showAllContactsSearchResults(body);showContactsSearchResults(body);showNonContactsSearchResults(body);showMessagesSearchResults(body);showLoadMoreUsersButton(body);showLoadMoreMessagesButton(body)},startLoading=function(header,body){hideSearchIcon(header);hideEmptyMessage(body);hideSearchResults(body);showLoadingIcon(header);showLoadingPlaceholder(body);disableSearchInput(header)},stopLoading=function(header,body){showSearchIcon(header);hideEmptyMessage(body);showSearchResults(body);hideLoadingIcon(header);hideLoadingPlaceholder(body);enableSearchInput(header)},showUsersLoadingIcon=function(root){var button=root.find(SELECTORS.LOAD_MORE_USERS);button.prop("disabled",!0);button.find(SELECTORS.BUTTON_TEXT).addClass("hidden");button.find(SELECTORS.LOADING_ICON_CONTAINER).removeClass("hidden")},hideUsersLoadingIcon=function(root){var button=root.find(SELECTORS.LOAD_MORE_USERS);button.prop("disabled",!1);button.find(SELECTORS.BUTTON_TEXT).removeClass("hidden");button.find(SELECTORS.LOADING_ICON_CONTAINER).addClass("hidden")},showLoadMoreUsersButton=function(root){root.find(SELECTORS.LOAD_MORE_USERS).removeClass("hidden")},hideLoadMoreUsersButton=function(root){root.find(SELECTORS.LOAD_MORE_USERS).addClass("hidden")},showMessagesLoadingIcon=function(root){var button=root.find(SELECTORS.LOAD_MORE_MESSAGES);button.prop("disabled",!0);button.find(SELECTORS.BUTTON_TEXT).addClass("hidden");button.find(SELECTORS.LOADING_ICON_CONTAINER).removeClass("hidden")},hideMessagesLoadingIcon=function(root){var button=root.find(SELECTORS.LOAD_MORE_MESSAGES);button.prop("disabled",!1);button.find(SELECTORS.BUTTON_TEXT).removeClass("hidden");button.find(SELECTORS.LOADING_ICON_CONTAINER).addClass("hidden")},showLoadMoreMessagesButton=function(root){root.find(SELECTORS.LOAD_MORE_MESSAGES).removeClass("hidden")},hideLoadMoreMessagesButton=function(root){root.find(SELECTORS.LOAD_MORE_MESSAGES).addClass("hidden")},findContact=function(root,userId){return root.find("[data-contact-user-id=\""+userId+"\"]")},addContact=function(root,contact){var nonContactsContainer=getNonContactsContainer(root),nonContact=findContact(nonContactsContainer,contact.userid);if(nonContact.length){nonContact.remove();var contactsContainer=getContactsContainer(root);contactsContainer.removeClass("hidden");contactsContainer.find(SELECTORS.LIST).append(nonContact)}if(!nonContactsContainer.find(SELECTORS.LIST).children().length){nonContactsContainer.addClass("hidden")}},removeContact=function(root,userId){var contactsContainer=getContactsContainer(root),contact=findContact(contactsContainer,userId);if(contact.length){contact.remove();var nonContactsContainer=getNonContactsContainer(root);nonContactsContainer.removeClass("hidden");nonContactsContainer.find(SELECTORS.LIST).append(contact)}if(!contactsContainer.find(SELECTORS.LIST).children().length){contactsContainer.addClass("hidden")}},blockContact=function(root,userId){var contact=findContact(root,userId);if(contact.length){contact.find(SELECTORS.BLOCK_ICON_CONTAINER).removeClass("hidden")}},unblockContact=function(root,userId){var contact=findContact(root,userId);if(contact.length){contact.find(SELECTORS.BLOCK_ICON_CONTAINER).addClass("hidden")}},highlightSearch=function(content,searchText){if(!content){return""}var regex=new RegExp("("+searchText+")","gi");return content.replace(regex,"<span class=\"matchtext\">$1</span>")},renderContacts=function(root,contacts){var container=getContactsContainer(root),frompanel=root.attr("data-in-panel"),list=container.find(SELECTORS.LIST);return Templates.render(TEMPLATES.CONTACTS_LIST,{contacts:contacts,frompanel:frompanel}).then(function(html){list.append(html);return html})},renderNonContacts=function(root,nonContacts){var container=getNonContactsContainer(root),frompanel=root.attr("data-in-panel"),list=container.find(SELECTORS.LIST);return Templates.render(TEMPLATES.NON_CONTACTS_LIST,{noncontacts:nonContacts,frompanel:frompanel}).then(function(html){list.append(html);return html})},renderMessages=function(root,messages){var container=getMessagesContainer(root),frompanel=root.attr("data-in-panel"),list=container.find(SELECTORS.LIST);return Templates.render(TEMPLATES.MESSAGES_LIST,{messages:messages,frompanel:frompanel}).then(function(html){list.append(html);return html})},loadMoreUsers=function(root,loggedInUserId,text,limit,offset){var loadedAll=!1;showUsersLoadingIcon(root);return Repository.searchUsers(loggedInUserId,text,limit+1,offset).then(function(results){var contacts=results.contacts,noncontacts=results.noncontacts;if(contacts.length<=limit&&noncontacts.length<=limit){loadedAll=!0;return{contacts:contacts,noncontacts:noncontacts}}else{return{contacts:contacts.slice(0,limit),noncontacts:noncontacts.slice(0,limit)}}}).then(function(results){var contactsCount=results.contacts.length,nonContactsCount=results.noncontacts.length;if(contactsCount){results.contacts.forEach(function(contact){contact.highlight=highlightSearch(contact.fullname,text)})}if(nonContactsCount){results.noncontacts.forEach(function(contact){contact.highlight=highlightSearch(contact.fullname,text)})}return $.when(contactsCount?renderContacts(root,results.contacts):!0,nonContactsCount?renderNonContacts(root,results.noncontacts):!0).then(function(){return{contactsCount:contactsCount,nonContactsCount:nonContactsCount}})}).then(function(counts){hideUsersLoadingIcon(root);if(loadedAll){hideLoadMoreUsersButton(root)}return counts}).catch(function(error){hideUsersLoadingIcon(root);throw error})},loadMoreMessages=function(root,loggedInUserId,text,limit,offset){var loadedAll=!1;showMessagesLoadingIcon(root);return Repository.searchMessages(loggedInUserId,text,limit+1,offset).then(function(results){var messages=results.contacts;if(messages.length<=limit){loadedAll=!0;return messages}else{return messages.slice(0,limit)}}).then(function(messages){if(messages.length){messages.forEach(function(message){message.lastmessage=highlightSearch(message.lastmessage,text)});return renderMessages(root,messages).then(function(){return messages.length})}else{return messages.length}}).then(function(count){hideMessagesLoadingIcon(root);if(loadedAll){hideLoadMoreMessagesButton(root)}return count}).catch(function(error){hideMessagesLoadingIcon(root);throw error})},search=function(header,body,searchText,usersLimit,usersOffset,messagesLimit,messagesOffset){var loggedInUserId=getLoggedInUserId(body);startLoading(header,body);clearAllSearchResults(body);return $.when(loadMoreUsers(body,loggedInUserId,searchText,usersLimit,usersOffset),loadMoreMessages(body,loggedInUserId,searchText,messagesLimit,messagesOffset)).then(function(userCounts,messagesCount){var contactsCount=userCounts.contactsCount,nonContactsCount=userCounts.nonContactsCount;stopLoading(header,body);if(!contactsCount&&!nonContactsCount&&!messagesCount){showNoSearchResults(body)}else{if(!contactsCount&&!nonContactsCount){hideAllContactsSearchResults(body)}else{if(!contactsCount){hideContactsSearchResults(body)}if(!nonContactsCount){hideNonContactsSearchResults(body)}}if(!messagesCount){hideMessagesSearchResults(body)}}})},registerEventListeners=function(header,body){var loggedInUserId=getLoggedInUserId(body),searchInput=getSearchInput(header),searchText="",messagesOffset=0,usersOffset=0,searchEventHandler=function(e,data){searchText=searchInput.val().trim();if(""!==searchText){messagesOffset=0;usersOffset=0;search(header,body,searchText,USERS_INITIAL_SEARCH_LIMIT,usersOffset,50,messagesOffset).then(function(){searchInput.focus();usersOffset=usersOffset+USERS_INITIAL_SEARCH_LIMIT;messagesOffset=messagesOffset+50}).catch(Notification.exception)}data.originalEvent.preventDefault()};CustomEvents.define(searchInput,[CustomEvents.events.enter]);CustomEvents.define(header,[CustomEvents.events.activate]);CustomEvents.define(body,[CustomEvents.events.activate]);searchInput.on(CustomEvents.events.enter,searchEventHandler);header.on(CustomEvents.events.activate,SELECTORS.SEARCH_ACTION,searchEventHandler);body.on(CustomEvents.events.activate,SELECTORS.LOAD_MORE_MESSAGES,function(e,data){if(""!==searchText){loadMoreMessages(body,loggedInUserId,searchText,50,messagesOffset).then(function(){messagesOffset=messagesOffset+50}).catch(Notification.exception)}data.originalEvent.preventDefault()});body.on(CustomEvents.events.activate,SELECTORS.LOAD_MORE_USERS,function(e,data){if(""!==searchText){loadMoreUsers(body,loggedInUserId,searchText,USERS_SEARCH_LIMIT,usersOffset).then(function(){usersOffset=usersOffset+USERS_SEARCH_LIMIT}).catch(Notification.exception)}data.originalEvent.preventDefault()});header.on(CustomEvents.events.activate,SELECTORS.CANCEL_SEARCH_BUTTON,function(){clearSearchInput(header);showEmptyMessage(body);showSearchIcon(header);hideSearchResults(body);hideLoadingIcon(header);hideLoadingPlaceholder(body);usersOffset=0;messagesOffset=0});PubSub.subscribe(Events.CONTACT_ADDED,function(userId){addContact(body,userId)});PubSub.subscribe(Events.CONTACT_REMOVED,function(userId){removeContact(body,userId)});PubSub.subscribe(Events.CONTACT_BLOCKED,function(userId){blockContact(body,userId)});PubSub.subscribe(Events.CONTACT_UNBLOCKED,function(userId){unblockContact(body,userId)})};return{show:function(namespace,header,body){if(!body.attr("data-init")){registerEventListeners(header,body);body.attr("data-init",!0)}var searchInput=getSearchInput(header);searchInput.focus();return $.Deferred().resolve().promise()},description:function(namespace,header){if("object"!=typeof header){return Str.get_string("messagedrawerviewsearch","core_message")}var searchInput=getSearchInput(header),searchText=searchInput.val().trim();return Str.get_string("messagedrawerviewsearch","core_message",searchText)}}});
//# sourceMappingURL=message_drawer_view_search.min.js.map
