define ("core_message/message_drawer_view_overview",["jquery","core/key_codes","core/pubsub","core/str","core_message/message_drawer_router","core_message/message_drawer_routes","core_message/message_drawer_events","core_message/message_drawer_view_overview_section","core_message/message_repository","core_message/message_drawer_view_conversation_constants"],function($,KeyCodes,PubSub,Str,Router,Routes,MessageDrawerEvents,Section,MessageRepository,Constants){var SELECTORS={CONTACT_REQUEST_COUNT:"[data-region=\"contact-request-count\"]",FAVOURITES:"[data-region=\"view-overview-favourites\"]",GROUP_MESSAGES:"[data-region=\"view-overview-group-messages\"]",MESSAGES:"[data-region=\"view-overview-messages\"]",SEARCH_INPUT:"[data-region=\"view-overview-search-input\"]",SECTION_TOGGLE_BUTTON:"[data-toggle]"},OVERVIEW_SECTION_TYPES={PRIVATE:[Constants.CONVERSATION_TYPES.PRIVATE,Constants.CONVERSATION_TYPES.SELF],PUBLIC:[Constants.CONVERSATION_TYPES.PUBLIC],FAVOURITE:null},loadAllCountsPromise=null,loadAllCounts=function(loggedInUserId){if(null===loadAllCountsPromise){loadAllCountsPromise=MessageRepository.getAllConversationCounts(loggedInUserId)}return loadAllCountsPromise},filterCountsByTypes=function(counts,types,includeFavourites){var total=0;if(types&&types.length){total=types.reduce(function(carry,type){return carry+counts.types[type]},total)}if(includeFavourites){total+=counts.favourites}return total},openSection=function(sections){var isAlreadyOpen=sections.some(function(section){var sectionRoot=section[0];return Section.isVisible(sectionRoot)});if(isAlreadyOpen){return}sections.sort(function(a,b){var aTotal=a[1],aUnread=a[2],bTotal=b[1],bUnread=b[2];if(0<aUnread&&0==bUnread){return-1}else if(0==aUnread&&0<bUnread){return 1}else if(0<aTotal&&0==bTotal){return-1}else if(0==aTotal&&0<bTotal){return 1}else{return 0}});var sectionRoot=sections[0][0],button=sectionRoot.find(SELECTORS.SECTION_TOGGLE_BUTTON);button.click()},getSearchInput=function(header){return header.find(SELECTORS.SEARCH_INPUT)},getLoggedInUserId=function(body){return body.attr("data-user-id")},decrementContactRequestCount=function(header){return function(){var countContainer=header.find(SELECTORS.CONTACT_REQUEST_COUNT),count=parseInt(countContainer.text(),10);count=isNaN(count)?0:count-1;if(0>=count){countContainer.addClass("hidden")}else{countContainer.text(count)}}},registerEventListeners=function(namespace,header){var searchInput=getSearchInput(header),ignoredKeys=[KeyCodes.tab,KeyCodes.shift,KeyCodes.ctrl,KeyCodes.alt];searchInput.on("click",function(){Router.go(namespace,Routes.VIEW_SEARCH)});searchInput.on("keydown",function(e){if(0>ignoredKeys.indexOf(e.keyCode)&&"Meta"!=e.key){Router.go(namespace,Routes.VIEW_SEARCH)}});PubSub.subscribe(MessageDrawerEvents.CONTACT_REQUEST_ACCEPTED,decrementContactRequestCount(header));PubSub.subscribe(MessageDrawerEvents.CONTACT_REQUEST_DECLINED,decrementContactRequestCount(header))};return{show:function(namespace,header,body){if(!header.attr("data-init")){registerEventListeners(namespace,header);header.attr("data-init",!0)}var fromPanel=header.attr("data-in-panel")?"frompanel":null;getSearchInput(header).val("");var loggedInUserId=getLoggedInUserId(body),allCounts=loadAllCounts(loggedInUserId),sections=[[body.find(SELECTORS.FAVOURITES),OVERVIEW_SECTION_TYPES.FAVOURITE,!0],[body.find(SELECTORS.GROUP_MESSAGES),OVERVIEW_SECTION_TYPES.PUBLIC,!1],[body.find(SELECTORS.MESSAGES),OVERVIEW_SECTION_TYPES.PRIVATE,!1]];sections.forEach(function(args){var sectionRoot=args[0],sectionTypes=args[1],includeFavourites=args[2],totalCountPromise=allCounts.then(function(result){return filterCountsByTypes(result.total,sectionTypes,includeFavourites)}),unreadCountPromise=allCounts.then(function(result){return filterCountsByTypes(result.unread,sectionTypes,includeFavourites)});Section.show(namespace,null,sectionRoot,null,sectionTypes,includeFavourites,totalCountPromise,unreadCountPromise,fromPanel)});return allCounts.then(function(result){var sectionParams=sections.map(function(section){var sectionRoot=section[0],sectionTypes=section[1],includeFavourites=section[2],totalCount=filterCountsByTypes(result.total,sectionTypes,includeFavourites),unreadCount=filterCountsByTypes(result.unread,sectionTypes,includeFavourites);return[sectionRoot,totalCount,unreadCount]});return openSection(sectionParams)})},description:function(){return Str.get_string("messagedrawerviewoverview","core_message")}}});
//# sourceMappingURL=message_drawer_view_overview.min.js.map
