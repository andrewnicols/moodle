define ("core_message/message_repository",["jquery","core/ajax","core/notification","core_message/message_drawer_view_conversation_constants"],function($,Ajax,Notification,Constants){var CONVERSATION_TYPES=Constants.CONVERSATION_TYPES,sendMessagesToUser=function(toUserId,messages){var formattedMessages=messages.map(function(message){return{touserid:toUserId,text:message}});return Ajax.call([{methodname:"core_message_send_instant_messages",args:{messages:formattedMessages}}])[0].then(function(results){var errors=results.reduce(function(carry,result){if(result.errormessage){carry.push(result.errormessage)}return carry},[]);if(errors.length){throw new Error(errors.join("\n"))}return results}).then(function(results){return results.map(function(result){return{id:result.msgid,text:result.text,timecreated:result.timecreated,useridfrom:result.useridfrom,conversationid:result.conversationid,candeletemessagesforallusers:result.candeletemessagesforallusers}})})},sendMessagesToConversation=function(conversationId,messages){var formattedMessages=messages.map(function(message){return{text:message}});return Ajax.call([{methodname:"core_message_send_messages_to_conversation",args:{conversationid:conversationId,messages:formattedMessages}}])[0]};return{query:function query(args){if("undefined"==typeof args.limit){args.limit=0}if("undefined"==typeof args.offset){args.offset=0}if("undefined"==typeof args.type){args.type=null}if("undefined"==typeof args.favouritesonly){args.favouritesonly=!1}args.limitfrom=args.offset;args.limitnum=args.limit;delete args.limit;delete args.offset;var promise=Ajax.call([{methodname:"core_message_data_for_messagearea_conversations",args:args}])[0];promise.fail(Notification.exception);return promise},countUnreadConversations:function countUnreadConversations(args){var promise=Ajax.call([{methodname:"core_message_get_unread_conversations_count",args:args}])[0];promise.fail(Notification.exception);return promise},markAllAsRead:function markAllAsRead(args){var promise=Ajax.call([{methodname:"core_message_mark_all_messages_as_read",args:args}])[0];promise.fail(Notification.exception);return promise},getContacts:function getContacts(userId,limit,offset){var args={userid:userId};if("undefined"!=typeof limit){args.limitnum=limit}if("undefined"!=typeof offset){args.limitfrom=offset}return Ajax.call([{methodname:"core_message_get_user_contacts",args:args}])[0]},getProfile:function getProfile(userId,profileUserId){return Ajax.call([{methodname:"core_message_data_for_messagearea_get_profile",args:{currentuserid:userId,otheruserid:profileUserId}}])[0]},blockUser:function blockUser(userId,blockedUserId){return $.when.apply(null,Ajax.call([{methodname:"core_message_block_user",args:{userid:userId,blockeduserid:blockedUserId}},{methodname:"core_message_get_member_info",args:{referenceuserid:userId,userids:[blockedUserId],includecontactrequests:!0,includeprivacyinfo:!0}}])).then(function(reponse1,profiles){return profiles.length?profiles[0]:{}})},unblockUser:function unblockUser(userId,unblockedUserId){return $.when.apply(null,Ajax.call([{methodname:"core_message_unblock_user",args:{userid:userId,unblockeduserid:unblockedUserId}},{methodname:"core_message_get_member_info",args:{referenceuserid:userId,userids:[unblockedUserId],includecontactrequests:!0,includeprivacyinfo:!0}}])).then(function(reponse1,profiles){return profiles.length?profiles[0]:{}})},createContactRequest:function createContactRequest(userId,requestUserIds){return Ajax.call([{methodname:"core_message_create_contact_request",args:{userid:userId,requesteduserid:requestUserIds}}])[0]},deleteContacts:function deleteContacts(userId,contactUserIds){return $.when.apply(null,Ajax.call([{methodname:"core_message_delete_contacts",args:{userid:userId,userids:contactUserIds}},{methodname:"core_message_get_member_info",args:{referenceuserid:userId,userids:contactUserIds,includecontactrequests:!0,includeprivacyinfo:!0}}])).then(function(response1,profiles){return profiles})},getMessages:function getMessages(currentUserId,conversationId,limit,offset,newestFirst,timeFrom){var args={currentuserid:currentUserId,convid:conversationId,newest:newestFirst?!0:!1};if("undefined"!=typeof limit){args.limitnum=limit}if("undefined"!=typeof offset){args.limitfrom=offset}if("undefined"!=typeof timeFrom){args.timefrom=timeFrom}return Ajax.call([{methodname:"core_message_get_conversation_messages",args:args}])[0]},searchUsers:function searchUsers(userId,searchString,limit,offset){var args={userid:userId,search:searchString};if("undefined"!=typeof limit){args.limitnum=limit}if("undefined"!=typeof offset){args.limitfrom=offset}return Ajax.call([{methodname:"core_message_message_search_users",args:args}])[0]},searchMessages:function searchMessages(userId,searchString,limit,offset){var args={userid:userId,search:searchString};if("undefined"!=typeof limit){args.limitnum=limit}if("undefined"!=typeof offset){args.limitfrom=offset}return Ajax.call([{methodname:"core_message_data_for_messagearea_search_messages",args:args}])[0]},sendMessagesToUser:sendMessagesToUser,sendMessageToUser:function sendMessageToUser(toUserId,text){return sendMessagesToUser(toUserId,[text]).then(function(results){return results[0]})},sendMessagesToConversation:sendMessagesToConversation,sendMessageToConversation:function sendMessageToConversation(conversationId,text){return sendMessagesToConversation(conversationId,[text]).then(function(result){return result[0]})},savePreferences:function savePreferences(userId,preferences){return Ajax.call([{methodname:"core_user_update_user_preferences",args:{userid:userId,preferences:preferences}}])[0]},getPreferences:function getPreferences(userId){return Ajax.call([{methodname:"core_user_get_user_preferences",args:{userid:userId}}])[0]},deleteMessages:function deleteMessages(userId,messageIds){return $.when.apply(null,Ajax.call(messageIds.map(function(messageId){return{methodname:"core_message_delete_message",args:{messageid:messageId,userid:userId}}})))},deleteMessagesForAllUsers:function deleteMessagesForAllUsers(userId,messageIds){return $.when.apply(null,Ajax.call(messageIds.map(function(messageId){return{methodname:"core_message_delete_message_for_all_users",args:{messageid:messageId,userid:userId}}})))},deleteConversation:function deleteConversation(userId,conversationId){return Ajax.call([{methodname:"core_message_delete_conversations_by_id",args:{userid:userId,conversationids:[conversationId]}}])[0]},getContactRequests:function getContactRequests(userId){return Ajax.call([{methodname:"core_message_get_contact_requests",args:{userid:userId}}])[0]},acceptContactRequest:function acceptContactRequest(sendingUserId,recipientUserId){return $.when.apply(null,Ajax.call([{methodname:"core_message_confirm_contact_request",args:{userid:sendingUserId,requesteduserid:recipientUserId}},{methodname:"core_message_get_member_info",args:{referenceuserid:recipientUserId,userids:[sendingUserId],includecontactrequests:!0,includeprivacyinfo:!0}}])).then(function(reponse1,profiles){return profiles.length?profiles[0]:{}})},declineContactRequest:function declineContactRequest(sendingUserId,recipientUserId){return $.when.apply(null,Ajax.call([{methodname:"core_message_decline_contact_request",args:{userid:sendingUserId,requesteduserid:recipientUserId}},{methodname:"core_message_get_member_info",args:{referenceuserid:recipientUserId,userids:[sendingUserId],includecontactrequests:!0,includeprivacyinfo:!0}}])).then(function(reponse1,profiles){return profiles.length?profiles[0]:{}})},getConversation:function getConversation(loggedInUserId,conversationId,includeContactRequests,includePrivacyInfo,memberLimit,memberOffset,messageLimit,messageOffset,newestMessagesFirst){var args={userid:loggedInUserId,conversationid:conversationId};if("undefined"!=typeof includeContactRequests&&null!==includeContactRequests){args.includecontactrequests=includeContactRequests}if("undefined"!=typeof includePrivacyInfo&&null!==includePrivacyInfo){args.includeprivacyinfo=includePrivacyInfo}if("undefined"!=typeof memberLimit&&null!==memberLimit){args.memberlimit=memberLimit}if("undefined"!=typeof memberOffset&&null!==memberOffset){args.memberoffset=memberOffset}if("undefined"!=typeof messageLimit&&null!==messageLimit){args.messagelimit=messageLimit}if("undefined"!=typeof messageOffset&&null!==messageOffset){args.messageoffset=messageOffset}if("undefined"!=typeof newestMessagesFirst&&null!==newestMessagesFirst){args.newestmessagesfirst=newestMessagesFirst}return Ajax.call([{methodname:"core_message_get_conversation",args:args}])[0]},getConversationBetweenUsers:function getConversationBetweenUsers(loggedInUserId,otherUserId,includeContactRequests,includePrivacyInfo,memberLimit,memberOffset,messageLimit,messageOffset,newestMessagesFirst){var args={userid:loggedInUserId,otheruserid:otherUserId};if("undefined"!=typeof includeContactRequests&&null!==includeContactRequests){args.includecontactrequests=includeContactRequests}if("undefined"!=typeof includePrivacyInfo&&null!==includePrivacyInfo){args.includeprivacyinfo=includePrivacyInfo}if("undefined"!=typeof memberLimit&&null!==memberLimit){args.memberlimit=memberLimit}if("undefined"!=typeof memberOffset&&null!==memberOffset){args.memberoffset=memberOffset}if("undefined"!=typeof messageLimit&&null!==messageLimit){args.messagelimit=messageLimit}if("undefined"!=typeof messageOffset&&null!==messageOffset){args.messageoffset=messageOffset}if("undefined"!=typeof newestMessagesFirst&&null!==newestMessagesFirst){args.newestmessagesfirst=newestMessagesFirst}return Ajax.call([{methodname:"core_message_get_conversation_between_users",args:args}])[0]},getSelfConversation:function getSelfConversation(loggedInUserId,messageLimit,messageOffset,newestMessagesFirst){var args={userid:loggedInUserId};if("undefined"!=typeof messageLimit&&null!==messageLimit){args.messagelimit=messageLimit}if("undefined"!=typeof messageOffset&&null!==messageOffset){args.messageoffset=messageOffset}if("undefined"!=typeof newestMessagesFirst&&null!==newestMessagesFirst){args.newestmessagesfirst=newestMessagesFirst}return Ajax.call([{methodname:"core_message_get_self_conversation",args:args}])[0]},getConversations:function getConversations(userId,type,limit,offset,favourites,mergeself){var args={userid:userId,type:type};if("undefined"!=typeof limit&&null!==limit){args.limitnum=limit}if("undefined"!=typeof offset&&null!==offset){args.limitfrom=offset}if("undefined"!=typeof favourites&&null!==favourites){args.favourites=favourites}if("undefined"!=typeof mergeself&&null!==mergeself){args.mergeself=mergeself}return Ajax.call([{methodname:"core_message_get_conversations",args:args}])[0].then(function(result){if(result.conversations.length){result.conversations=result.conversations.map(function(conversation){if(conversation.type==CONVERSATION_TYPES.PRIVATE||conversation.type==CONVERSATION_TYPES.SELF){var otherUser=conversation.members.length?conversation.members[0]:null;if(otherUser){conversation.name=conversation.name?conversation.name:otherUser.fullname;conversation.imageurl=conversation.imageurl?conversation.imageurl:otherUser.profileimageurl}}return conversation})}return result})},getConversationMembers:function getConversationMembers(conversationId,loggedInUserId,limit,offset,includeContactRequests){var args={userid:loggedInUserId,conversationid:conversationId};if("undefined"!=typeof limit&&null!==limit){args.limitnum=limit}if("undefined"!=typeof offset&&null!==offset){args.limitfrom=offset}if("undefined"!=typeof includeContactRequests&&null!==includeContactRequests){args.includecontactrequests=includeContactRequests}return Ajax.call([{methodname:"core_message_get_conversation_members",args:args}])[0]},setFavouriteConversations:function setFavouriteConversations(userId,conversationIds){return Ajax.call([{methodname:"core_message_set_favourite_conversations",args:{userid:userId,conversations:conversationIds}}])[0]},setMutedConversations:function setMutedConversations(userId,conversationIds){return Ajax.call([{methodname:"core_message_mute_conversations",args:{userid:userId,conversationids:conversationIds}}])[0]},unsetFavouriteConversations:function unsetFavouriteConversations(userId,conversationIds){return Ajax.call([{methodname:"core_message_unset_favourite_conversations",args:{userid:userId,conversations:conversationIds}}])[0]},unsetMutedConversations:function unsetMutedConversations(userId,conversationIds){return Ajax.call([{methodname:"core_message_unmute_conversations",args:{userid:userId,conversationids:conversationIds}}])[0]},getMemberInfo:function getMemberInfo(referenceUserId,userIds,includeContactRequests,includePrivacyInfo){var args={referenceuserid:referenceUserId,userids:userIds};if("undefined"!=typeof includeContactRequests){args.includecontactrequests=includeContactRequests}if("undefined"!=typeof includePrivacyInfo){args.includeprivacyinfo=includePrivacyInfo}return Ajax.call([{methodname:"core_message_get_member_info",args:args}])[0]},markAllConversationMessagesAsRead:function markAllConversationMessagesAsRead(userId,conversationId){return Ajax.call([{methodname:"core_message_mark_all_conversation_messages_as_read",args:{userid:userId,conversationid:conversationId}}])[0]},getUserMessagePreferences:function getUserMessagePreferences(userId){return Ajax.call([{methodname:"core_message_get_user_message_preferences",args:{userid:userId}}])[0]},getTotalConversationCounts:function getTotalConversationCounts(userId){return Ajax.call([{methodname:"core_message_get_conversation_counts",args:{userid:userId}}])[0]},getUnreadConversationCounts:function getUnreadConversationCounts(userId){return Ajax.call([{methodname:"core_message_get_unread_conversation_counts",args:{userid:userId}}])[0]},getAllConversationCounts:function getAllConversationCounts(userId){return $.when.apply(null,Ajax.call([{methodname:"core_message_get_conversation_counts",args:{userid:userId}},{methodname:"core_message_get_unread_conversation_counts",args:{userid:userId}}])).then(function(total,unread){return{total:total,unread:unread}})}}});
//# sourceMappingURL=message_repository.min.js.map
