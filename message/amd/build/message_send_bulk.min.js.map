{"version":3,"sources":["../src/message_send_bulk.js"],"names":["showModal","users","callback","length","Promise","resolve","titlePromise","ModalFactory","create","type","types","SAVE_CANCEL","body","Templates","render","title","then","modal","setSaveButtonText","getRoot","on","ModalEvents","hidden","remove","save","messageText","find","val","sendMessage","show","messages","forEach","user","push","touserid","text","Ajax","call","methodname","args","messageIds","msg","Notification","addNotification","message","catch","exception"],"mappings":"kWAuBA,sDACA,8CACA,oDACA,oCACA,oD,kFAUO,GAAMA,CAAAA,SAAS,CAAG,SAACC,KAAD,CAA4B,IAApBC,CAAAA,QAAoB,wDAAT,IAAS,CACjD,GAAI,CAACD,KAAK,CAACE,MAAX,CAAmB,CAEf,MAAOC,CAAAA,OAAO,CAACC,OAAR,EACV,CACD,GAAIC,CAAAA,YAAY,CAAG,IAAnB,CACA,GAAoB,CAAhB,EAAAL,KAAK,CAACE,MAAV,CAAuB,CACnBG,YAAY,CAAG,oBAAW,uBAAX,CAAoC,cAApC,CAClB,CAFD,IAEO,CACHA,YAAY,CAAG,oBAAW,iBAAX,CAA8B,cAA9B,CAA8CL,KAAK,CAACE,MAApD,CAClB,CAED,MAAOI,wBAAaC,MAAb,CAAoB,CACvBC,IAAI,CAAEF,uBAAaG,KAAb,CAAmBC,WADF,CAEvBC,IAAI,CAAEC,mBAAUC,MAAV,CAAiB,gCAAjB,CAAmD,EAAnD,CAFiB,CAGvBC,KAAK,CAAET,YAHgB,CAApB,EAKNU,IALM,CAKD,SAASC,KAAT,CAAgB,CAClBA,KAAK,CAACC,iBAAN,CAAwBZ,YAAxB,EAGAW,KAAK,CAACE,OAAN,GAAgBC,EAAhB,CAAmBC,sBAAYC,MAA/B,CAAuC,UAAW,CAC9C,GAAIpB,QAAJ,CAAc,CACVA,QAAQ,EACX,CACDe,KAAK,CAACE,OAAN,GAAgBI,MAAhB,EACH,CALD,EAOAN,KAAK,CAACE,OAAN,GAAgBC,EAAhB,CAAmBC,sBAAYG,IAA/B,CAAqC,UAAW,CAC5C,GAAIC,CAAAA,WAAW,CAAGR,KAAK,CAACE,OAAN,GAAgBO,IAAhB,CAAqB,eAArB,EAAsCC,GAAtC,EAAlB,CACAC,WAAW,CAACH,WAAD,CAAcxB,KAAd,CACd,CAHD,EAKAgB,KAAK,CAACY,IAAN,GAEA,MAAOZ,CAAAA,KACV,CAxBM,CAyBV,CArCM,C,6BA+CA,GAAMW,CAAAA,WAAW,CAAG,SAACH,WAAD,CAAcxB,KAAd,CAAwB,CAC/C,GAAI6B,CAAAA,QAAQ,CAAG,EAAf,CAEA7B,KAAK,CAAC8B,OAAN,CAAc,SAAAC,IAAI,CAAI,CAClBF,QAAQ,CAACG,IAAT,CAAc,CACVC,QAAQ,CAAEF,IADA,CAEVG,IAAI,CAAEV,WAFI,CAAd,CAIH,CALD,EAOA,MAAOW,eAAKC,IAAL,CAAU,CAAC,CACdC,UAAU,CAAE,oCADE,CAEdC,IAAI,CAAE,CAACT,QAAQ,CAAEA,QAAX,CAFQ,CAAD,CAAV,EAGH,CAHG,EAINd,IAJM,CAID,SAASwB,UAAT,CAAqB,CACvB,GAAyB,CAArB,EAAAA,UAAU,CAACrC,MAAf,CAA4B,CACxB,MAAO,oBAAW,2BAAX,CAAwC,cAAxC,CACV,CAFD,IAEO,CACH,MAAO,oBAAW,qBAAX,CAAkC,cAAlC,CAAkDqC,UAAU,CAACrC,MAA7D,CACV,CACJ,CAVM,EAWNa,IAXM,CAWD,SAASyB,GAAT,CAAc,CAChBC,sBAAaC,eAAb,CAA6B,CACzBC,OAAO,CAAEH,GADgB,CAEzBhC,IAAI,CAAE,SAFmB,CAA7B,EAIA,QACH,CAjBM,EAkBNoC,KAlBM,CAkBAH,sBAAaI,SAlBb,CAmBV,CA7BM,C","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Send bulk message to the given user ids.\n *\n * @module     core_message/message_send_bulk\n * @copyright  2019 Shamim Rezaie <shamim@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport {get_string} from 'core/str';\nimport ModalFactory from 'core/modal_factory';\nimport Templates from 'core/templates';\nimport ModalEvents from 'core/modal_events';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\n\n/**\n * Show the send message popup.\n *\n * @method showModal\n * @param {int[]} users\n * @param {Function} callback A callback to apply after the form is closed.\n * @returns {Promise}\n */\nexport const showModal = (users, callback = null) => {\n    if (!users.length) {\n        // Nothing to do.\n        return Promise.resolve();\n    }\n    let titlePromise = null;\n    if (users.length == 1) {\n        titlePromise = get_string('sendbulkmessagesingle', 'core_message');\n    } else {\n        titlePromise = get_string('sendbulkmessage', 'core_message', users.length);\n    }\n\n    return ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        body: Templates.render('core_message/send_bulk_message', {}),\n        title: titlePromise,\n    })\n    .then(function(modal) {\n        modal.setSaveButtonText(titlePromise);\n\n        // When the dialog is closed, perform the callback (if provided).\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            if (callback) {\n                callback();\n            }\n            modal.getRoot().remove();\n        });\n\n        modal.getRoot().on(ModalEvents.save, function() {\n            let messageText = modal.getRoot().find('form textarea').val();\n            sendMessage(messageText, users);\n        });\n\n        modal.show();\n\n        return modal;\n    });\n};\n\n/**\n * Send a message to these users.\n *\n * @method sendMessage\n * @param {String} messageText\n * @param {Number[]} users\n * @returns {Promise}\n */\nexport const sendMessage = (messageText, users) => {\n    let messages = [];\n\n    users.forEach(user => {\n        messages.push({\n            touserid: user,\n            text: messageText\n        });\n    });\n\n    return Ajax.call([{\n        methodname: 'core_message_send_instant_messages',\n        args: {messages: messages}\n    }])[0]\n    .then(function(messageIds) {\n        if (messageIds.length == 1) {\n            return get_string('sendbulkmessagesentsingle', 'core_message');\n        } else {\n            return get_string('sendbulkmessagesent', 'core_message', messageIds.length);\n        }\n    })\n    .then(function(msg) {\n        Notification.addNotification({\n            message: msg,\n            type: \"success\"\n        });\n        return true;\n    })\n    .catch(Notification.exception);\n};\n"],"file":"message_send_bulk.min.js"}