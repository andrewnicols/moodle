{"version":3,"sources":["../src/message_drawer_router.js"],"names":["define","$","PubSub","Str","MessageDrawerEvents","Aria","routes","history","SELECTORS","CAN_RECEIVE_FOCUS","ROUTES_BACK","changeRoute","namespace","newRoute","newConfig","fromPanel","slice","call","arguments","some","arg","args","renderPromise","Deferred","resolve","promise","Object","keys","forEach","route","config","isMatch","parameters","element","removeClass","attr","unhide","get","addClass","hide","onGo","apply","concat","currentFocusElement","document","activeElement","hasFocus","firstFocusable","i","length","has","find","filter","first","focus","record","params","publish","ROUTE_CHANGED","go","inHistory","reduce","carry","previous","push","historylength","previousRecord","prevConfig","elements","focusElement","getDescription","then","description","get_string","label","catch","add","back","pop","window","setTimeout"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A simple router for the message drawer that allows navigating between\n * the \"pages\" in the drawer.\n *\n * This module will maintain a linear history of the unique pages access\n * to allow navigating back.\n *\n * @module     core_message/message_drawer_router\n * @copyright  2018 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(\n[\n    'jquery',\n    'core/pubsub',\n    'core/str',\n    'core_message/message_drawer_events',\n    'core/aria',\n],\nfunction(\n    $,\n    PubSub,\n    Str,\n    MessageDrawerEvents,\n    Aria\n) {\n\n    /* @var {object} routes Message drawer route elements and callbacks. */\n    var routes = {};\n\n    /* @var {object} history Store for route objects history. */\n    var history = {};\n\n    var SELECTORS = {\n        CAN_RECEIVE_FOCUS: 'input:not([type=\"hidden\"]), a[href], button, textarea, select, [tabindex]',\n        ROUTES_BACK: '[data-route-back]'\n    };\n\n    /**\n     * Add a route.\n     *\n     * @param {String} namespace Unique identifier for the Routes\n     * @param {string} route Route config name.\n     * @param {array} parameters Route parameters.\n     * @param {callback} onGo Route initialization function.\n     * @param {callback} getDescription Route initialization function.\n     */\n    var add = function(namespace, route, parameters, onGo, getDescription) {\n        if (!routes[namespace]) {\n            routes[namespace] = [];\n        }\n\n        routes[namespace][route] =\n            {\n                parameters: parameters,\n                onGo: onGo,\n                getDescription: getDescription\n            };\n    };\n\n    /**\n     * Go to a defined route and run the route callbacks.\n     *\n     * @param {String} namespace Unique identifier for the Routes\n     * @param {string} newRoute Route config name.\n     * @return {object} record Current route record with route config name and parameters.\n     */\n    var changeRoute = function(namespace, newRoute) {\n        var newConfig;\n\n        // Check if the Route change call is made from an element in the app panel.\n        var fromPanel = [].slice.call(arguments).some(function(arg) {\n            return arg == 'frompanel';\n        });\n        // Get the rest of the arguments, if any.\n        var args = [].slice.call(arguments, 2);\n        var renderPromise = $.Deferred().resolve().promise();\n\n        Object.keys(routes[namespace]).forEach(function(route) {\n            var config = routes[namespace][route];\n            var isMatch = route === newRoute;\n\n            if (isMatch) {\n                newConfig = config;\n            }\n\n            config.parameters.forEach(function(element) {\n                // Some parameters may be null, or not an element.\n                if (typeof element !== 'object' || element === null) {\n                    return;\n                }\n\n                element.removeClass('previous');\n                element.attr('data-from-panel', false);\n\n                if (isMatch) {\n                    if (fromPanel) {\n                        // Set this attribute to let the conversation renderer know not to show a back button.\n                        element.attr('data-from-panel', true);\n                    }\n                    element.removeClass('hidden');\n                    Aria.unhide(element.get());\n                } else {\n                    // For the message index page elements in the left panel should not be hidden.\n                    if (!element.attr('data-in-panel')) {\n                        element.addClass('hidden');\n                        Aria.hide(element.get());\n                    } else if (newRoute == 'view-search' || newRoute == 'view-overview') {\n                        element.addClass('hidden');\n                        Aria.hide(element.get());\n                    }\n                }\n            });\n        });\n\n        if (newConfig) {\n            if (newConfig.onGo) {\n                renderPromise = newConfig.onGo.apply(undefined, newConfig.parameters.concat(args));\n                var currentFocusElement = $(document.activeElement);\n                var hasFocus = false;\n                var firstFocusable = null;\n\n                // No need to start at 0 as we know that is the namespace.\n                for (var i = 1; i < newConfig.parameters.length; i++) {\n                    var element = newConfig.parameters[i];\n\n                    // Some parameters may be null, or not an element.\n                    if (typeof element !== 'object' || element === null) {\n                        continue;\n                    }\n\n                    if (!firstFocusable) {\n                        firstFocusable = element;\n                    }\n\n                    if (element.has(currentFocusElement).length) {\n                        hasFocus = true;\n                        break;\n                    }\n                }\n\n                if (!hasFocus) {\n                    // This page doesn't have focus yet so focus the first focusable\n                    // element in the new view.\n                    firstFocusable.find(SELECTORS.CAN_RECEIVE_FOCUS).filter(':visible').first().focus();\n                }\n            }\n        }\n\n        var record = {\n            route: newRoute,\n            params: args,\n            renderPromise: renderPromise\n        };\n\n        PubSub.publish(MessageDrawerEvents.ROUTE_CHANGED, record);\n\n        return record;\n    };\n\n    /**\n     * Go to a defined route and store the route history.\n     *\n     * @param {String} namespace Unique identifier for the Routes\n     * @return {object} record Current route record with route config name and parameters.\n     */\n    var go = function(namespace) {\n        var currentFocusElement = $(document.activeElement);\n\n        var record = changeRoute.apply(namespace, arguments);\n        var inHistory = false;\n\n        if (!history[namespace]) {\n            history[namespace] = [];\n        }\n\n        // History stores a unique list of routes. Check to see if the new route\n        // is already in the history, if it is then forget all history after it.\n        // This ensures there are no duplicate routes in history and that it represents\n        // a linear path of routes (it never stores something like [foo, bar, foo])).\n        history[namespace] = history[namespace].reduce(function(carry, previous) {\n            if (previous.route === record.route) {\n                inHistory = true;\n            }\n\n            if (!inHistory) {\n                carry.push(previous);\n            }\n\n            return carry;\n        }, []);\n\n        var historylength = history[namespace].length;\n        var previousRecord = historylength ? history[namespace][historylength - 1] : null;\n\n        if (previousRecord) {\n            var prevConfig = routes[namespace][previousRecord.route];\n            var elements = prevConfig.parameters;\n\n            // The first one will be the namespace, skip it.\n            for (var i = 1; i < elements.length; i++) {\n                // Some parameters may be null, or not an element.\n                if (typeof elements[i] !== 'object' || elements[i] === null) {\n                    continue;\n                }\n\n                elements[i].addClass('previous');\n            }\n\n            previousRecord.focusElement = currentFocusElement;\n\n            if (prevConfig.getDescription) {\n                // If the route has a description then set it on the back button for\n                // the new page we're displaying.\n                prevConfig.getDescription.apply(null, prevConfig.parameters.concat(previousRecord.params))\n                    .then(function(description) {\n                        return Str.get_string('backto', 'core_message', description);\n                    })\n                    .then(function(label) {\n                        // Wait for the new page to finish rendering so that we know\n                        // that the back button is visible.\n                        return record.renderPromise.then(function() {\n                            // Find the elements for the new route we displayed.\n                            routes[namespace][record.route].parameters.forEach(function(element) {\n                                // Some parameters may be null, or not an element.\n                                if (typeof element !== 'object' || !element) {\n                                    return;\n                                }\n                                // Update the aria label for the back button.\n                                element.find(SELECTORS.ROUTES_BACK).attr('aria-label', label);\n                            });\n                        });\n                    })\n                    .catch(function() {\n                        // Silently ignore.\n                    });\n            }\n        }\n        history[namespace].push(record);\n        return record;\n    };\n\n    /**\n     * Go back to the previous route record stored in history.\n     *\n     * @param {String} namespace Unique identifier for the Routes\n     */\n    var back = function(namespace) {\n        if (history[namespace].length) {\n            // Remove the current route.\n            history[namespace].pop();\n            var previous = history[namespace].pop();\n\n            if (previous) {\n                // If we have a previous route then show it.\n                go.apply(undefined, [namespace, previous.route].concat(previous.params));\n                // Delay the focus 50 milliseconds otherwise it doesn't correctly\n                // focus the element for some reason...\n                window.setTimeout(function() {\n                    previous.focusElement.focus();\n                }, 50);\n            }\n        }\n    };\n\n    return {\n        add: add,\n        go: go,\n        back: back\n    };\n});\n"],"file":"message_drawer_router.min.js"}