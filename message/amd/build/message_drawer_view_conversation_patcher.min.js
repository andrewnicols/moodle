define ("core_message/message_drawer_view_conversation_patcher",["jquery","core/user_date","core_message/message_drawer_view_conversation_constants"],function($,UserDate,Constants){var sortMessagesByDay=function(messages,midnight){var messagesByDay=messages.reduce(function(carry,message){var timeCreated=message.timeCreated?message.timeCreated:midnight,dayTimestamp=UserDate.getUserMidnightForTimestamp(timeCreated,midnight);if(carry.hasOwnProperty(dayTimestamp)){carry[dayTimestamp].push(message)}else{carry[dayTimestamp]=[message]}return carry},{});return Object.keys(messagesByDay).map(function(dayTimestamp){return{timestamp:dayTimestamp,messages:messagesByDay[dayTimestamp]}})},diffArrays=function(a,b,matchFunction){b=b.slice();var missingFromA=[],missingFromB=[],matches=[];a.forEach(function(current){var found=!1,index=0;for(;index<b.length;index++){var next=b[index];if(matchFunction(current,next)){found=!0;matches.push({a:current,b:next});break}}if(found){b.splice(index,1)}else{missingFromB.push(current)}});missingFromA=b;return{missingFromA:missingFromA,missingFromB:missingFromB,matches:matches}},findPositionInArray=function(array,breakFunction){for(var before=null,i=0,candidate;i<array.length;i++){candidate=array[i];if(breakFunction(candidate)){return candidate}}return before},isArrayEqual=function(a,b){a=a.slice();b=b.slice();a.sort();b.sort();var aLength=a.length,bLength=b.length;if(1>aLength&&1>bLength){return!0}if(aLength!=bLength){return!1}return a.every(function(item,index){return item==b[index]})},isObjectEqual=function(a,b){var aKeys=Object.keys(a),bKeys=Object.keys(b);if(aKeys.length!=bKeys.length){return!1}return aKeys.every(function(key){var aVal=a[key],bVal=b[key],aType=typeof aVal,bType=typeof bVal;aType=null===aVal?"null":aType;bType=null===aVal?"null":bType;aType="object"===aType&&Array.isArray(aType)?"array":aType;bType="object"===bType&&Array.isArray(bType)?"array":bType;if(aType!==bType){return!1}switch(aType){case"object":return isObjectEqual(aVal,bVal);case"array":return isArrayEqual(aVal,bVal);default:return a[key]==b[key];}})},isMessageEqual=function(a,b){return isObjectEqual({id:a.id,state:a.sendState,text:a.text,timeCreated:a.timeCreated},{id:b.id,state:b.sendState,text:b.text,timeCreated:b.timeCreated})},buildDaysPatch=function(current,remove,add){return{remove:remove,add:add.map(function(day){var before=findPositionInArray(current,function(candidate){return day.timestamp<candidate.timestamp});return{before:before,value:day}})}},buildMessagesPatch=function(matchingDays){var remove=[],add=[],update=[];matchingDays.forEach(function(days){var dayCurrent=days.a,dayNext=days.b,messagesDiff=diffArrays(dayCurrent.messages,dayNext.messages,isMessageEqual),patch=diffArrays(messagesDiff.missingFromB,messagesDiff.missingFromA,function(a,b){return a.id==b.id||a.sendState!=b.sendState&&a.timeAdded==b.timeAdded});remove=remove.concat(patch.missingFromB);patch.missingFromA.forEach(function(message){var before=null;if(message.timeCreated){before=findPositionInArray(dayCurrent.messages,function(candidate){if(message.timeCreated==candidate.timeCreated){return message.id<candidate.id}else{return message.timeCreated<candidate.timeCreated}})}add.push({before:before,value:message,day:dayCurrent})});update=update.concat(patch.matches.map(function(message){return{before:message.a,after:message.b}}))});return{add:add,remove:remove,update:update}},buildConversationPatch=function(state,newState){var diff=diffArrays(state.messages,newState.messages,isMessageEqual);if(diff.missingFromA.length||diff.missingFromB.length){var current=sortMessagesByDay(state.messages,state.midnight),next=sortMessagesByDay(newState.messages,newState.midnight),daysDiff=diffArrays(current,next,function(dayCurrent,dayNext){return dayCurrent.timestamp==dayNext.timestamp});return{days:buildDaysPatch(current,daysDiff.missingFromB,daysDiff.missingFromA),messages:buildMessagesPatch(daysDiff.matches)}}else{return null}},buildHeaderPatchTypePrivate=function(state,newState){var requireAddContact=buildRequireAddContact(state,newState),confirmContactRequest=buildConfirmContactRequest(state,newState),oldOtherUser=getOtherUserFromState(state),newOtherUser=getOtherUserFromState(newState),requiresAddContact=requireAddContact&&requireAddContact.show&&!requireAddContact.hasMessages,requiredAddContact=requireAddContact&&!requireAddContact.show,shouldRenderHeader=!oldOtherUser&&newOtherUser;shouldRenderHeader=shouldRenderHeader||requiresAddContact||requiredAddContact;shouldRenderHeader=shouldRenderHeader||null!==confirmContactRequest;if(shouldRenderHeader){return{type:Constants.CONVERSATION_TYPES.PRIVATE,showControls:!requiresAddContact&&!confirmContactRequest,context:{id:newState.id,name:newState.name,subname:newState.subname,totalmembercount:newState.totalMemberCount,imageurl:newState.imageUrl,isfavourite:newState.isFavourite,ismuted:newState.isMuted,showfavourite:null!==newState.id,userid:newOtherUser.id,showonlinestatus:newOtherUser.showonlinestatus,isonline:newOtherUser.isonline,isblocked:newOtherUser.isblocked,iscontact:newOtherUser.iscontact}}}return null},buildHeaderPatchTypeSelf=function(state,newState){var shouldRenderHeader=null===state.name&&null!==newState.name;if(shouldRenderHeader){return{type:Constants.CONVERSATION_TYPES.SELF,showControls:!1,context:{id:newState.id,name:newState.name,subname:newState.subname,imageurl:newState.imageUrl,isfavourite:newState.isFavourite,showfavourite:null!==newState.id,showonlinestatus:!0}}}return null},buildHeaderPatchTypePublic=function(state,newState){var oldMemberCount=state.totalMemberCount,newMemberCount=newState.totalMemberCount;if(oldMemberCount!=newMemberCount){return{type:Constants.CONVERSATION_TYPES.PUBLIC,showControls:!0,context:{id:newState.id,name:newState.name,subname:newState.subname,totalmembercount:newState.totalMemberCount,imageurl:newState.imageUrl,isfavourite:newState.isFavourite,ismuted:newState.isMuted,showfavourite:null!==newState.id}}}else{return null}},buildScrollToMessagePatch=function(state,newState){var oldMessages=state.messages,newMessages=newState.messages;if(1>newMessages.length){return null}if(1>oldMessages.length){return newMessages[newMessages.length-1].id}var previousNewest=oldMessages[state.messages.length-1],currentNewest=newMessages[newMessages.length-1],previousOldest=oldMessages[0],currentOldest=newMessages[0];if(previousNewest.id!=currentNewest.id){return currentNewest.id}else if(previousOldest.id!=currentOldest.id){return previousOldest.id}return null},buildLoadingMembersPatch=function(state,newState){if(!state.loadingMembers&&newState.loadingMembers){return!0}else if(state.loadingMembers&&!newState.loadingMembers){return!1}else{return null}},buildLoadingFirstMessages=function(state,newState){if(state.hasTriedToLoadMessages===newState.hasTriedToLoadMessages){return null}else if(!newState.hasTriedToLoadMessages&&newState.loadingMessages){return!0}else if(newState.hasTriedToLoadMessages&&!newState.loadingMessages){return!1}else{return null}},buildLoadingMessages=function(state,newState){if(!state.loadingMessages&&newState.loadingMessages){return!0}else if(state.loadingMessages&&!newState.loadingMessages){return!1}else{return null}},buildShowEmojiPicker=function(state,newState){if(!state.showEmojiPicker&&newState.showEmojiPicker){return!0}else if(state.showEmojiPicker&&!newState.showEmojiPicker){return!1}else{return null}},buildShowEmojiAutoComplete=function(state,newState){if(!state.showEmojiAutoComplete&&newState.showEmojiAutoComplete){return!0}else if(state.showEmojiAutoComplete&&!newState.showEmojiAutoComplete){return!1}else{return null}},buildConfirmBlockUser=function(state,newState){if(newState.pendingBlockUserIds.length){var userId=newState.pendingBlockUserIds[0];return newState.members[userId]}else if(state.pendingBlockUserIds.length){return!1}return null},buildConfirmUnblockUser=function(state,newState){if(newState.pendingUnblockUserIds.length){var userId=newState.pendingUnblockUserIds[0];return newState.members[userId]}else if(state.pendingUnblockUserIds.length){return!1}return null},buildConfirmAddContact=function(state,newState){if(newState.pendingAddContactIds.length){var userId=newState.pendingAddContactIds[0];return newState.members[userId]}else if(state.pendingAddContactIds.length){return!1}return null},buildConfirmRemoveContact=function(state,newState){if(newState.pendingRemoveContactIds.length){var userId=newState.pendingRemoveContactIds[0];return newState.members[userId]}else if(state.pendingRemoveContactIds.length){return!1}return null},buildConfirmDeleteSelectedMessages=function(state,newState){var oldPendingCount=state.pendingDeleteMessageIds.length,newPendingCount=newState.pendingDeleteMessageIds.length;if(newPendingCount&&!oldPendingCount){return{show:!0,type:newState.type,canDeleteMessagesForAllUsers:newState.canDeleteMessagesForAllUsers}}else if(oldPendingCount&&!newPendingCount){return{show:!1}}return null},buildConfirmDeleteConversation=function(state,newState){if(!state.pendingDeleteConversation&&newState.pendingDeleteConversation){return newState.type}else if(state.pendingDeleteConversation&&!newState.pendingDeleteConversation){return!1}return null},buildConfirmContactRequest=function(state,newState){var loggedInUserId=state.loggedInUserId,oldOtherUser=getOtherUserFromState(state),newOtherUser=getOtherUserFromState(newState),oldReceivedRequests=!oldOtherUser?[]:oldOtherUser.contactrequests.filter(function(request){return request.requesteduserid==loggedInUserId&&request.userid==oldOtherUser.id}),newReceivedRequests=!newOtherUser?[]:newOtherUser.contactrequests.filter(function(request){return request.requesteduserid==loggedInUserId&&request.userid==newOtherUser.id}),oldRequest=oldReceivedRequests.length?oldReceivedRequests[0]:null,newRequest=newReceivedRequests.length?newReceivedRequests[0]:null;if(!oldRequest&&newRequest){return newOtherUser}else if(oldRequest&&!newRequest){return!1}else{return null}},buildIsBlocked=function(state,newState){var oldOtherUser=getOtherUserFromState(state),newOtherUser=getOtherUserFromState(newState);if(!oldOtherUser&&!newOtherUser){return null}else if(!oldOtherUser&&newOtherUser){return newOtherUser.isblocked?!0:null}else if(!newOtherUser&&oldOtherUser){return oldOtherUser.isblocked?!1:null}else if(oldOtherUser.isblocked&&!newOtherUser.isblocked){return!1}else if(!oldOtherUser.isblocked&&newOtherUser.isblocked){return!0}else{return null}},buildIsFavourite=function(state,newState){var oldIsFavourite=state.isFavourite,newIsFavourite=newState.isFavourite;if(null===state.id&&null===newState.id){return null}else if(null===state.id&&null!==newState.id){return"show-add"}else if(null!==state.id&&null===newState.id){return"hide"}else if(oldIsFavourite==newIsFavourite){return null}else if(!oldIsFavourite&&newIsFavourite){return"show-remove"}else if(oldIsFavourite&&!newIsFavourite){return"show-add"}else{return null}},buildIsMuted=function(state,newState){var oldIsMuted=state.isMuted,newIsMuted=newState.isMuted;if(null===state.id&&null===newState.id){return null}else if(null===state.id&&null!==newState.id){return"show-mute"}else if(null!==state.id&&null===newState.id){return"hide"}else if(oldIsMuted==newIsMuted){return null}else if(!oldIsMuted&&newIsMuted){return"show-unmute"}else if(oldIsMuted&&!newIsMuted){return"show-mute"}else{return null}},buildIsContact=function(state,newState){var loggedInUserId=state.loggedInUserId,oldOtherUser=getOtherUserFromState(state),newOtherUser=getOtherUserFromState(newState),oldContactRequests=!oldOtherUser?[]:oldOtherUser.contactrequests.filter(function(request){return request.userid==loggedInUserId&&request.requesteduserid==oldOtherUser.id||request.userid==oldOtherUser.id&&request.requesteduserid==loggedInUserId}),newContactRequests=!newOtherUser?[]:newOtherUser.contactrequests.filter(function(request){return request.userid==loggedInUserId&&request.requesteduserid==newOtherUser.id||request.userid==newOtherUser.id&&request.requesteduserid==loggedInUserId}),oldHasContactRequests=0<oldContactRequests.length,newHasContactRequests=0<newContactRequests.length;if(!oldOtherUser&&!newOtherUser){return null}else if(oldHasContactRequests&&newHasContactRequests){return null}else if(!oldHasContactRequests&&newHasContactRequests&&!newOtherUser.iscontact){return"pending-contact"}else if(!oldOtherUser&&newOtherUser){return newOtherUser.iscontact?"contact":null}else if(!newOtherUser&&oldOtherUser){return oldOtherUser.iscontact?"non-contact":null}else if(oldOtherUser.iscontact&&!newOtherUser.iscontact){return newHasContactRequests?"pending-contact":"non-contact"}else if(!oldOtherUser.iscontact&&newOtherUser.iscontact){return"contact"}else{return null}},buildLoadingConfirmationAction=function(state,newState){if(!state.loadingConfirmAction&&newState.loadingConfirmAction){return!0}else if(state.loadingConfirmAction&&!newState.loadingConfirmAction){return!1}else{return null}},buildInEditMode=function(state,newState){var oldHasSelectedMessages=0<state.selectedMessageIds.length,newHasSelectedMessages=0<newState.selectedMessageIds.length,numberOfMessagesHasChanged=state.messages.length!=newState.messages.length;if(!oldHasSelectedMessages&&newHasSelectedMessages){return!0}else if(oldHasSelectedMessages&&!newHasSelectedMessages){return!1}else if(oldHasSelectedMessages&&numberOfMessagesHasChanged){return!0}else{return null}},buildSelectedMessages=function(state,newState){var oldSelectedMessages=state.selectedMessageIds,newSelectedMessages=newState.selectedMessageIds;if(isArrayEqual(oldSelectedMessages,newSelectedMessages)){return null}var diff=diffArrays(oldSelectedMessages,newSelectedMessages,function(a,b){return a==b});return{count:newSelectedMessages.length,add:diff.missingFromA,remove:diff.missingFromB}},getOtherUserFromState=function(state){return Object.keys(state.members).reduce(function(carry,userId){if(userId!=state.loggedInUserId&&!carry){carry=state.members[userId]}return carry},null)},requiresContactRequest=function(loggedInUserId,user){if(user.canmessage){return!1}var contactRequests=user.contactrequests.filter(function(request){return request.userid==loggedInUserId||request.requesteduserid}),hasSentContactRequest=0<contactRequests.length;return user.requirescontact&&!user.iscontact&&!hasSentContactRequest},buildRequireAddContact=function(state,newState){var oldOtherUser=getOtherUserFromState(state),newOtherUser=getOtherUserFromState(newState),hadMessages=0<state.messages.length,hasMessages=0<newState.messages.length,loggedInUserId=newState.loggedInUserId,prevRequiresContactRequest=oldOtherUser&&requiresContactRequest(loggedInUserId,oldOtherUser),nextRequiresContactRequest=newOtherUser&&requiresContactRequest(loggedInUserId,newOtherUser),confirmAddContact=buildConfirmAddContact(state,newState);if(!state.hasTriedToLoadMessages&&!newState.hasTriedToLoadMessages){return null}if(!oldOtherUser&&!newOtherUser){return null}if(!oldOtherUser&&nextRequiresContactRequest){return{show:!0,hasMessages:hasMessages,user:newOtherUser}}if(!1===confirmAddContact&&nextRequiresContactRequest){return{show:!0,hasMessages:hasMessages,user:newOtherUser}}if(state.hasTriedToLoadMessages&&newState.hasTriedToLoadMessages){if(!prevRequiresContactRequest&&nextRequiresContactRequest){return{show:!0,hasMessages:hasMessages,user:newOtherUser}}if(prevRequiresContactRequest&&!nextRequiresContactRequest){return{show:!1,hasMessages:hasMessages}}}if(!state.hasTriedToLoadMessages&&newState.hasTriedToLoadMessages){if(nextRequiresContactRequest){return{show:!0,hasMessages:hasMessages,user:newOtherUser}}}if(state.hasTriedToLoadMessages&&!newState.hasTriedToLoadMessages){if(prevRequiresContactRequest){return{show:!1,hasMessages:hadMessages}}}return null},buildRequireUnblock=function(state,newState){var oldOtherUser=getOtherUserFromState(state),newOtherUser=getOtherUserFromState(newState);if(!oldOtherUser&&!newOtherUser){return null}else if(oldOtherUser&&!newOtherUser){return oldOtherUser.isblocked?!1:null}else if(!oldOtherUser&&newOtherUser){return newOtherUser.isblocked?!0:null}else if(!oldOtherUser.isblocked&&newOtherUser.isblocked){return!0}else if(oldOtherUser.isblocked&&!newOtherUser.isblocked){return!1}return null},buildUnableToMessage=function(state,newState){var oldOtherUser=getOtherUserFromState(state),newOtherUser=getOtherUserFromState(newState);if(newState.type==Constants.CONVERSATION_TYPES.SELF){return null}if(!oldOtherUser&&!newOtherUser){return null}else if(oldOtherUser&&!newOtherUser){return oldOtherUser.canmessage?null:!0}else if(!oldOtherUser&&newOtherUser){return newOtherUser.canmessage?null:!0}else if(!oldOtherUser.canmessage&&newOtherUser.canmessage){return!1}else if(oldOtherUser.canmessage&&!newOtherUser.canmessage){return!0}return null},buildFooterPatchTypePrivate=function(state,newState){var loadingFirstMessages=buildLoadingFirstMessages(state,newState),inEditMode=buildInEditMode(state,newState),requireAddContact=buildRequireAddContact(state,newState),requireUnblock=buildRequireUnblock(state,newState),unableToMessage=buildUnableToMessage(state,newState),showRequireAddContact=null!==requireAddContact?requireAddContact.show&&requireAddContact.hasMessages:null,otherUser=getOtherUserFromState(newState),generateReturnValue=function(checkValue,successReturn){if(checkValue){return successReturn}else if(null!==checkValue&&!checkValue){if(!otherUser){return{type:"content"}}else if(otherUser.isblocked){return{type:"unblock"}}else if(newState.messages.length&&requiresContactRequest(newState.loggedInUserId,otherUser)){return{type:"add-contact",user:otherUser}}else if(!otherUser.canmessage&&otherUser.requirescontact&&!otherUser.iscontact){return{type:"unable-to-message"}}}return null};if(null===loadingFirstMessages&&null===inEditMode&&null===requireAddContact&&null===requireUnblock){return null}for(var checks=[[loadingFirstMessages,{type:"placeholder"}],[inEditMode,{type:"edit-mode"}],[unableToMessage,{type:"unable-to-message"}],[requireUnblock,{type:"unblock"}],[showRequireAddContact,{type:"add-contact",user:otherUser}]],i=0;i<checks.length;i++){var checkValue=checks[i][0],successReturn=checks[i][1],result=generateReturnValue(checkValue,successReturn);if(null!==result){return result}}return{type:"content"}},buildFooterPatchTypePublic=function(state,newState){var loadingFirstMessages=buildLoadingFirstMessages(state,newState),inEditMode=buildInEditMode(state,newState);if(null===loadingFirstMessages&&null===inEditMode){return null}if(loadingFirstMessages){return{type:"placeholder"}}if(inEditMode){return{type:"edit-mode"}}return{type:"content"}},buildReset=function(state,newState){var oldType=state.type,newType=newState.type,oldConversationId=state.id,newConversationId=newState.id,oldMemberIds=Object.keys(state.members),newMemberIds=Object.keys(newState.members);oldMemberIds.sort();newMemberIds.sort();var membersUnchanged=oldMemberIds.every(function(id,index){return id==newMemberIds[index]});if(oldType!=newType){return!0}else if(oldConversationId&&!newConversationId){return!0}else if(oldConversationId&&newConversationId&&oldConversationId!=newConversationId){return!0}else if(!oldConversationId&&!newConversationId&&!membersUnchanged){return!0}return null},buildSelfConversationMessage=function(state,newState){if(state.type!=newState.type){return newState.type==Constants.CONVERSATION_TYPES.SELF}return null},buildContactRequestSent=function(state,newState){var loggedInUserId=newState.loggedInUserId,oldOtherUser=getOtherUserFromState(state),newOtherUser=getOtherUserFromState(newState),oldSentRequests=!oldOtherUser?[]:oldOtherUser.contactrequests.filter(function(request){return request.userid==loggedInUserId}),newSentRequests=!newOtherUser?[]:newOtherUser.contactrequests.filter(function(request){return request.userid==loggedInUserId}),oldRequest=0<oldSentRequests.length,newRequest=0<newSentRequests.length;if(!oldRequest&&newRequest&&!newOtherUser.iscontact){return newOtherUser.fullname}else if(oldOtherUser&&!oldOtherUser.iscontact&&newRequest&&newOtherUser.iscontact){return!1}else if(oldRequest&&!newRequest){return!1}else{return null}},buildPatch=function(state,newState){var config={all:{reset:buildReset,conversation:buildConversationPatch,scrollToMessage:buildScrollToMessagePatch,loadingMembers:buildLoadingMembersPatch,loadingFirstMessages:buildLoadingFirstMessages,loadingMessages:buildLoadingMessages,confirmDeleteSelectedMessages:buildConfirmDeleteSelectedMessages,inEditMode:buildInEditMode,selectedMessages:buildSelectedMessages,isFavourite:buildIsFavourite,isMuted:buildIsMuted,showEmojiPicker:buildShowEmojiPicker,showEmojiAutoComplete:buildShowEmojiAutoComplete}};config[Constants.CONVERSATION_TYPES.PRIVATE]={header:buildHeaderPatchTypePrivate,footer:buildFooterPatchTypePrivate,confirmBlockUser:buildConfirmBlockUser,confirmUnblockUser:buildConfirmUnblockUser,confirmAddContact:buildConfirmAddContact,confirmRemoveContact:buildConfirmRemoveContact,confirmContactRequest:buildConfirmContactRequest,confirmDeleteConversation:buildConfirmDeleteConversation,isBlocked:buildIsBlocked,isContact:buildIsContact,loadingConfirmAction:buildLoadingConfirmationAction,requireAddContact:buildRequireAddContact,contactRequestSent:buildContactRequestSent};config[Constants.CONVERSATION_TYPES.PUBLIC]={header:buildHeaderPatchTypePublic,footer:buildFooterPatchTypePublic};config[Constants.CONVERSATION_TYPES.SELF]={header:buildHeaderPatchTypeSelf,footer:buildFooterPatchTypePublic,confirmDeleteConversation:buildConfirmDeleteConversation,selfConversationMessage:buildSelfConversationMessage};var patchConfig=$.extend({},config.all);if(newState.type&&newState.type in config){patchConfig=$.extend(patchConfig,config[newState.type])}return Object.keys(patchConfig).reduce(function(patch,key){var buildFunc=patchConfig[key],value=buildFunc(state,newState);if(null!==value){patch[key]=value}return patch},{})};return{buildPatch:buildPatch}});
//# sourceMappingURL=message_drawer_view_conversation_patcher.min.js.map
