define ("core_message/message_drawer_view_settings",["jquery","core/notification","core/str","core/pubsub","core/templates","core_message/message_repository","core/custom_interaction_events","core_message/message_drawer_events"],function($,Notification,Str,PubSub,Templates,Repository,CustomEvents,MessageDrawerEvents){var SELECTORS={CHECKBOX:"input[type=\"checkbox\"]",SETTINGS:"[data-region=\"settings\"]",PRIVACY_PREFERENCE:"[data-preference=\"blocknoncontacts\"] input[type=\"radio\"]",NOTIFICATIONS_PREFERENCE:"[data-preference=\"notifications\"] input[type=\"checkbox\"]",ENTER_TO_SEND_PREFERENCE:"[data-preference=\"entertosend\"] input[type=\"checkbox\"]",NOTIFICATION_PREFERENCES_CONTAINER:"[data-region=\"notification-preference-container\"]",CONTENT_CONTAINER:"[data-region=\"content-container\"]",PLACEHOLDER_CONTAINER:"[data-region=\"placeholder-container\"]"},TEMPLATES={NOTIFICATION_PREFERENCES:"core_message/message_drawer_view_settings_body_content_notification_preferences"},setPrivacyPreference=function(body,value){var inputs=body.find(SELECTORS.PRIVACY_PREFERENCE);inputs.each(function(index,input){input=$(input);if(input.val()==value){input.prop("checked",!0)}else{input.prop("checked",!1)}})},setEnterToSend=function(body,value){var checkbox=body.find(SELECTORS.ENTER_TO_SEND_PREFERENCE);if(value){checkbox.prop("checked",!0)}else{checkbox.prop("checked",!1)}},savePreferences=function(loggedInUserId,preferences){return Repository.savePreferences(loggedInUserId,preferences).then(function(){PubSub.publish(MessageDrawerEvents.PREFERENCES_UPDATED,preferences)}).catch(Notification.exception)},registerEventListeners=function(body,loggedInUserId){var settingsContainer=body.find(SELECTORS.SETTINGS);CustomEvents.define(settingsContainer,[CustomEvents.events.activate]);settingsContainer.on(CustomEvents.events.activate,SELECTORS.NOTIFICATIONS_PREFERENCE,function(e){var container=$(e.target).closest(SELECTORS.NOTIFICATION_PREFERENCES_CONTAINER),checkboxes=container.find(SELECTORS.CHECKBOX);if(!checkboxes.length){return}var values=checkboxes.toArray().reduce(function(carry,checkbox){checkbox=$(checkbox);if(checkbox.prop("checked")){carry.push(checkbox.attr("data-name"))}return carry},[]),newValue=values.length?values.join(","):"none";savePreferences(loggedInUserId,[{type:"message_provider_moodle_instantmessage_loggedoff",value:newValue},{type:"message_provider_moodle_instantmessage_loggedin",value:newValue}])});settingsContainer.on("change",SELECTORS.PRIVACY_PREFERENCE,function(e){var newValue=$(e.target).val();savePreferences(loggedInUserId,[{type:"message_blocknoncontacts",value:newValue}])});settingsContainer.on(CustomEvents.events.activate,SELECTORS.ENTER_TO_SEND_PREFERENCE,function(e){var newValue=$(e.target).prop("checked");savePreferences(loggedInUserId,[{type:"message_entertosend",value:newValue}])})},init=function(body,loggedInUserId){Repository.getUserMessagePreferences(loggedInUserId).then(function(response){setPrivacyPreference(body,response.blocknoncontacts);setEnterToSend(body,response.entertosend);var notificationProcessors=[];if(response.preferences.components.length){response.preferences.components.forEach(function(component){if(component.notifications.length){var notificationPreferences=component.notifications.filter(function(notification){return notification.preferencekey=="message_provider_moodle_instantmessage"});if(notificationPreferences.length){var configuration=component.notifications[0];notificationProcessors=configuration.processors.map(function(processor){var checked=processor.loggedin.checked||processor.loggedoff.checked;return{displayname:processor.displayname,name:processor.name,checked:checked,locked:processor.locked,lockedmessage:processor.lockedmessage||null}})}}})}var container=body.find(SELECTORS.NOTIFICATION_PREFERENCES_CONTAINER);if(notificationProcessors.length){container.removeClass("hidden");return Templates.render(TEMPLATES.NOTIFICATION_PREFERENCES,{processors:notificationProcessors}).then(function(html){container.append(html);return html})}else{return!0}}).then(function(){body.find(SELECTORS.CONTENT_CONTAINER).removeClass("hidden");body.find(SELECTORS.PLACEHOLDER_CONTAINER).addClass("hidden");registerEventListeners(body,loggedInUserId)}).catch(Notification.exception)};return{show:function show(namespace,header,body,footer,loggedInUserId){if(!body.attr("data-init")){init(body,loggedInUserId);body.attr("data-init",!0)}return $.Deferred().resolve().promise()},description:function description(){return Str.get_string("messagedrawerviewsettings","core_message")}}});
//# sourceMappingURL=message_drawer_view_settings.min.js.map
