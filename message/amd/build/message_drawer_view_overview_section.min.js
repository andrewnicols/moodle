function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)})}}define ("core_message/message_drawer_view_overview_section",["jquery","core/custom_interaction_events","core/notification","core/pubsub","core/str","core/pending","core/templates","core/user_date","core_message/message_repository","core_message/message_drawer_events","core_message/message_drawer_router","core_message/message_drawer_routes","core_message/message_drawer_lazy_load_list","core_message/message_drawer_view_conversation_constants"],function($,CustomEvents,Notification,PubSub,Str,Pending,Templates,UserDate,MessageRepository,MessageDrawerEvents,MessageDrawerRouter,MessageDrawerRoutes,LazyLoadList,MessageDrawerViewConversationContants){var SELECTORS={TOGGLE:"[data-region=\"toggle\"]",CONVERSATION:"[data-conversation-id]",BLOCKED_ICON_CONTAINER:"[data-region=\"contact-icon-blocked\"]",LAST_MESSAGE:"[data-region=\"last-message\"]",LAST_MESSAGE_DATE:"[data-region=\"last-message-date\"]",MUTED_ICON_CONTAINER:"[data-region=\"muted-icon-container\"]",UNREAD_COUNT:"[data-region=\"unread-count\"]",SECTION_TOTAL_COUNT:"[data-region=\"section-total-count\"]",SECTION_TOTAL_COUNT_CONTAINER:"[data-region=\"section-total-count-container\"]",SECTION_UNREAD_COUNT:"[data-region=\"section-unread-count\"]",PLACEHOLDER_CONTAINER:"[data-region=\"placeholder-container\"]"},TEMPLATES={CONVERSATIONS_LIST:"core_message/message_drawer_conversations_list",CONVERSATIONS_LIST_ITEMS_PLACEHOLDER:"core_message/message_drawer_conversations_list_items_placeholder"},LOAD_LIMIT=50,loadedConversationsById={},deletedConversationsById={},loadedTotalCounts=!1,loadedUnreadCounts=!1,isVisible=function(root){return LazyLoadList.getRoot(root).hasClass("show")},setExpanded=function(root){root.addClass("expanded")},setCollapsed=function(root){root.removeClass("expanded")},renderTotalCount=function(root,count){var container=root.find(SELECTORS.SECTION_TOTAL_COUNT_CONTAINER),countElement=container.find(SELECTORS.SECTION_TOTAL_COUNT);countElement.text(count);container.removeClass("hidden");Str.get_string("totalconversations","core_message",count).done(function(string){container.attr("aria-label",string)});var numPlaceholders=20<count?20:count,placeholders=Array.apply(null,Array(numPlaceholders)).map(function(){return!0});Templates.render(TEMPLATES.CONVERSATIONS_LIST_ITEMS_PLACEHOLDER,{placeholders:placeholders}).then(function(html){var placeholderContainer=root.find(SELECTORS.PLACEHOLDER_CONTAINER);placeholderContainer.html(html)}).catch(function(){})},renderUnreadCount=function(root,count){var countElement=root.find(SELECTORS.SECTION_UNREAD_COUNT);countElement.text(count);Str.get_string("unreadconversations","core_message",count).done(function(string){countElement.attr("aria-label",string)});if(0<count){countElement.removeClass("hidden")}},formatConversationFromEvent=function(conversation){var recursivelyLowercaseKeys=function(object){return Object.keys(object).reduce(function(carry,key){if($.isArray(object[key])){carry[key.toLowerCase()]=object[key].map(recursivelyLowercaseKeys)}else{carry[key.toLowerCase()]=object[key]}return carry},{})},formatted=recursivelyLowercaseKeys(conversation);formatted.messages=formatted.messages.map(function(message){message.useridfrom=message.userfrom.id;return message});return formatted},render=function(conversations,userId){var pending=new Pending,formatMessagePreview=function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(lastMessage){var tmpElement,isMedia,messagePreview,pix,label,labelString,icon;return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:if(lastMessage){_context.next=2;break}return _context.abrupt("return",null);case 2:tmpElement=document.createElement("element");tmpElement.innerHTML=lastMessage.text.replace(/<img /g,"<noimg ");isMedia=tmpElement.querySelector("[src]")||!1;if(isMedia){_context.next=10;break}messagePreview=$(lastMessage.text).text();if(!messagePreview){_context.next=10;break}if(!(-1==messagePreview.indexOf("<"))){_context.next=10;break}return _context.abrupt("return",messagePreview);case 10:pix="i/messagecontentmultimediageneral";label="messagecontentmultimediageneral";if(lastMessage.text.includes("<img")){pix="i/messagecontentimage";label="messagecontentimage"}else if(lastMessage.text.includes("<video")){pix="i/messagecontentvideo";label="messagecontentvideo"}else if(lastMessage.text.includes("<audio")){pix="i/messagecontentaudio";label="messagecontentaudio"}_context.prev=13;_context.next=16;return Str.get_string(label,"core_message");case 16:labelString=_context.sent;_context.next=19;return Templates.renderPix(pix,"core",labelString);case 19:icon=_context.sent;return _context.abrupt("return",icon+" "+labelString);case 23:_context.prev=23;_context.t0=_context["catch"](13);Notification.exception(_context.t0);return _context.abrupt("return",null);case 27:case"end":return _context.stop();}}},_callee,null,[[13,23]])}));return function(){return _ref.apply(this,arguments)}}(),mapPromises=conversations.map(function(conversation){var lastMessage=conversation.messages.length?conversation.messages[conversation.messages.length-1]:null;return formatMessagePreview(lastMessage).then(function(messagePreview){var formattedConversation={id:conversation.id,imageurl:conversation.imageurl,name:conversation.name,subname:conversation.subname,unreadcount:conversation.unreadcount,ismuted:conversation.ismuted,lastmessagedate:lastMessage?lastMessage.timecreated:null,sentfromcurrentuser:lastMessage?lastMessage.useridfrom==userId:null,lastmessage:messagePreview},otherUser=null;if(conversation.type==MessageDrawerViewConversationContants.CONVERSATION_TYPES.SELF){otherUser=conversation.members[0]}else if(conversation.type==MessageDrawerViewConversationContants.CONVERSATION_TYPES.PRIVATE){otherUser=conversation.members.reduce(function(carry,member){if(!carry&&member.id!=userId){carry=member}return carry},null)}if(null!==otherUser){formattedConversation.userid=otherUser.id;formattedConversation.showonlinestatus=otherUser.showonlinestatus;formattedConversation.isonline=otherUser.isonline;formattedConversation.isblocked=otherUser.isblocked}if(conversation.type==MessageDrawerViewConversationContants.CONVERSATION_TYPES.PUBLIC){formattedConversation.lastsendername=conversation.members.reduce(function(carry,member){if(!carry&&lastMessage&&member.id==lastMessage.useridfrom){carry=member.fullname}return carry},null)}return formattedConversation}).catch(Notification.exception)});return Promise.all(mapPromises).then(function(formattedConversations){formattedConversations.forEach(function(conversation){if(new Date().toDateString()==new Date(1e3*conversation.lastmessagedate).toDateString()){conversation.istoday=!0}});return Templates.render(TEMPLATES.CONVERSATIONS_LIST,{conversations:formattedConversations})}).then(function(html,js){pending.resolve();return $.Deferred().resolve(html,js)}).catch(function(error){pending.resolve();Notification.exception(error)})},getLoadCallback=function(types,includeFavourites,offset){var type=null,includeSelfConversations=!0;if(types&&types.length){var nonSelfConversationTypes=types.filter(function(candidate){return candidate!=MessageDrawerViewConversationContants.CONVERSATION_TYPES.SELF});includeSelfConversations=types.length!=nonSelfConversationTypes.length;type=nonSelfConversationTypes[0]}return function(root,userId){return MessageRepository.getConversations(userId,type,LOAD_LIMIT+1,offset,includeFavourites,includeSelfConversations).then(function(response){var conversations=response.conversations;if(conversations.length>LOAD_LIMIT){conversations=conversations.slice(0,-1)}else{LazyLoadList.setLoadedAll(root,!0)}offset=offset+LOAD_LIMIT;conversations.forEach(function(conversation){loadedConversationsById[conversation.id]=conversation});return conversations}).catch(Notification.exception)}},getTotalConversationCountElement=function(root){return root.find(SELECTORS.SECTION_TOTAL_COUNT)},getTotalUnreadConversationCountElement=function(root){return root.find(SELECTORS.SECTION_UNREAD_COUNT)},incrementTotalConversationCount=function(root){if(loadedTotalCounts){var element=getTotalConversationCountElement(root),count=parseInt(element.text());count=count+1;element.text(count)}},decrementTotalConversationCount=function(root){if(loadedTotalCounts){var element=getTotalConversationCountElement(root),count=parseInt(element.text());count=count-1;element.text(count)}},decrementTotalUnreadConversationCount=function(root){if(loadedUnreadCounts){var element=getTotalUnreadConversationCountElement(root),count=parseInt(element.text());count=count-1;element.text(count);if(1>count){element.addClass("hidden")}}},getConversationElement=function(root,conversationId){return root.find("[data-conversation-id=\""+conversationId+"\"]")},getConversationElementFromUserId=function(root,userId){return root.find("[data-user-id=\""+userId+"\"]")},muteConversation=function(conversationElement){conversationElement.find(SELECTORS.MUTED_ICON_CONTAINER).removeClass("hidden")},unmuteConversation=function(conversationElement){conversationElement.find(SELECTORS.MUTED_ICON_CONTAINER).addClass("hidden")},blockContact=function(conversationElement){conversationElement.find(SELECTORS.BLOCKED_ICON_CONTAINER).removeClass("hidden")},unblockContact=function(conversationElement){conversationElement.find(SELECTORS.BLOCKED_ICON_CONTAINER).addClass("hidden")},createNewConversationFromEvent=function(root,conversation,userId){var existingConversations=root.find(SELECTORS.CONVERSATION);if(!existingConversations.length){var listRoot=LazyLoadList.getRoot(root);LazyLoadList.showContent(listRoot);LazyLoadList.hideEmptyMessage(listRoot)}loadedConversationsById[conversation.id]=conversation;return render([conversation],userId).then(function(html){var contentContainer=LazyLoadList.getContentContainer(root);return contentContainer.prepend(html)}).then(function(){return incrementTotalConversationCount(root)}).catch(Notification.exception)},deleteConversation=function(root,conversationElement){conversationElement.remove();decrementTotalConversationCount(root);var conversations=root.find(SELECTORS.CONVERSATION);if(!conversations.length){var listRoot=LazyLoadList.getRoot(root);LazyLoadList.hideContent(listRoot);LazyLoadList.showEmptyMessage(listRoot)}},markConversationAsRead=function(root,conversationElement){var unreadCount=conversationElement.find(SELECTORS.UNREAD_COUNT);unreadCount.text("0");unreadCount.addClass("hidden");decrementTotalUnreadConversationCount(root)},registerEventListeners=function(namespace,root,loadCallback,types,includeFavourites,fromPanel){var listRoot=LazyLoadList.getRoot(root),conversationBelongsToThisSection=function(conversation){var conversationType=parseInt(conversation.type,10);if(types&&0>types.indexOf(conversationType)||includeFavourites&&!conversation.isFavourite||!includeFavourites&&conversation.isFavourite){return!1}return!0},toggle=root.find(SELECTORS.TOGGLE);root.css("min-height",toggle.outerHeight());root.on("show.bs.collapse",function(){setExpanded(root);LazyLoadList.show(listRoot,loadCallback,function(contentContainer,conversations,userId){return render(conversations,userId).then(function(html){contentContainer.append(html);return html}).catch(Notification.exception)})});root.on("hidden.bs.collapse",function(){setCollapsed(root)});PubSub.subscribe(MessageDrawerEvents.CONTACT_BLOCKED,function(userId){var conversationElement=getConversationElementFromUserId(root,userId);if(conversationElement.length){blockContact(conversationElement)}});PubSub.subscribe(MessageDrawerEvents.CONTACT_UNBLOCKED,function(userId){var conversationElement=getConversationElementFromUserId(root,userId);if(conversationElement.length){unblockContact(conversationElement)}});PubSub.subscribe(MessageDrawerEvents.CONVERSATION_SET_MUTED,function(conversation){var conversationId=conversation.id,conversationElement=getConversationElement(root,conversationId);if(conversationElement.length){muteConversation(conversationElement)}});PubSub.subscribe(MessageDrawerEvents.CONVERSATION_UNSET_MUTED,function(conversation){var conversationId=conversation.id,conversationElement=getConversationElement(root,conversationId);if(conversationElement.length){unmuteConversation(conversationElement)}});PubSub.subscribe(MessageDrawerEvents.CONVERSATION_NEW_LAST_MESSAGE,function(conversation){if(!conversationBelongsToThisSection(conversation)){return}var pendingPromise=new Pending("core_message/message_drawer_view_overview_section:new"),loggedInUserId=conversation.loggedInUserId,conversationId=conversation.id,element=getConversationElement(root,conversationId);conversation=formatConversationFromEvent(conversation);if(element.length){var contentContainer=LazyLoadList.getContentContainer(root);render([conversation],loggedInUserId).then(function(html){if(deletedConversationsById[conversationId]){if(conversation.messages[0].timeadded<deletedConversationsById[conversationId]){return}}contentContainer.prepend(html);element.remove()}).then(pendingPromise.resolve).catch(Notification.exception)}else if(conversation.messages.length){createNewConversationFromEvent(root,conversation,loggedInUserId).then(pendingPromise.resolve).catch()}else{pendingPromise.resolve()}});PubSub.subscribe(MessageDrawerEvents.CONVERSATION_DELETED,function(conversationId){var conversationElement=getConversationElement(root,conversationId);delete loadedConversationsById[conversationId];deletedConversationsById[conversationId]=new Date;if(conversationElement.length){deleteConversation(root,conversationElement)}});PubSub.subscribe(MessageDrawerEvents.CONVERSATION_READ,function(conversationId){var conversationElement=getConversationElement(root,conversationId);if(conversationElement.length){markConversationAsRead(root,conversationElement)}});PubSub.subscribe(MessageDrawerEvents.CONVERSATION_SET_FAVOURITE,function(conversation){var conversationElement=null;if(conversationBelongsToThisSection(conversation)){conversationElement=getConversationElement(root,conversation.id);if(!conversationElement.length){createNewConversationFromEvent(root,formatConversationFromEvent(conversation),conversation.loggedInUserId)}}else{conversationElement=getConversationElement(root,conversation.id);if(conversationElement.length){deleteConversation(root,conversationElement)}}});PubSub.subscribe(MessageDrawerEvents.CONVERSATION_UNSET_FAVOURITE,function(conversation){var conversationElement=null;if(conversationBelongsToThisSection(conversation)){conversationElement=getConversationElement(root,conversation.id);if(!conversationElement.length){createNewConversationFromEvent(root,formatConversationFromEvent(conversation),conversation.loggedInUserId)}}else{conversationElement=getConversationElement(root,conversation.id);if(conversationElement.length){deleteConversation(root,conversationElement)}}});CustomEvents.define(root,[CustomEvents.events.activate]);root.on(CustomEvents.events.activate,SELECTORS.CONVERSATION,function(e,data){var conversationElement=$(e.target).closest(SELECTORS.CONVERSATION),conversationId=conversationElement.attr("data-conversation-id"),conversation=loadedConversationsById[conversationId];MessageDrawerRouter.go(namespace,MessageDrawerRoutes.VIEW_CONVERSATION,conversation,fromPanel);data.originalEvent.preventDefault()})};return{show:function show(namespace,header,body,footer,types,includeFavourites,totalCountPromise,unreadCountPromise,fromPanel){var root=$(body);if(!root.attr("data-init")){var loadCallback=getLoadCallback(types,includeFavourites,0);registerEventListeners(namespace,root,loadCallback,types,includeFavourites,fromPanel);if(isVisible(root)){setExpanded(root);var listRoot=LazyLoadList.getRoot(root);LazyLoadList.show(listRoot,loadCallback,function(contentContainer,conversations,userId){return render(conversations,userId).then(function(html){contentContainer.append(html);return html}).catch(Notification.exception)})}totalCountPromise.then(function(count){renderTotalCount(root,count);loadedTotalCounts=!0}).catch(function(){});unreadCountPromise.then(function(count){renderUnreadCount(root,count);loadedUnreadCounts=!0}).catch(function(){});root.attr("data-init",!0)}},isVisible:isVisible}});
//# sourceMappingURL=message_drawer_view_overview_section.min.js.map
