define ("report_insights/message_users",["jquery","core/str","core/log","core/modal_factory","core/modal_events","core/templates","core/notification","core/ajax"],function($,Str,Log,ModalFactory,ModalEvents,Templates,Notification,Ajax){var SELECTORS={BULKACTIONSELECT:"#formactionid"},MessageUsers=function(rootNode,actionName){this.actionName=actionName;this.attachEventListeners(rootNode)};MessageUsers.prototype.actionName=null;MessageUsers.prototype.modal=null;MessageUsers.prototype.attachEventListeners=function(rootNode){$(rootNode+" button[data-bulk-sendmessage]").on("click",function(e){e.preventDefault();var cTarget=$(e.currentTarget),users={},predictionToUserMapping=cTarget.data("prediction-to-user-id");$(".insights-list input[data-togglegroup^=\"insight-bulk-action\"][data-toggle=\"slave\"]:checked").each(function(index,value){var predictionId=$(value).closest("tr[data-prediction-id]").data("prediction-id");if("undefined"==typeof predictionToUserMapping[predictionId]){Log.error("Unknown user for prediction "+predictionId);return}var userId=predictionToUserMapping[predictionId];users[predictionId]=userId});if(0===Object.keys(users).length){return this}this.showSendMessage(users);return this}.bind(this))};MessageUsers.prototype.showSendMessage=function(users){var userIds=new Set(Object.values(users));if(0==userIds.length){return $.Deferred().resolve().promise()}var titlePromise=null;if(1==userIds.size){titlePromise=Str.get_string("sendbulkmessagesingle","core_message")}else{titlePromise=Str.get_string("sendbulkmessage","core_message",userIds.size)}return $.when(ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,body:Templates.render("core_user/send_bulk_message",{})}),titlePromise).then(function(modal,title){this.modal=modal;this.modal.setTitle(title);this.modal.setSaveButtonText(title);this.modal.getRoot().on(ModalEvents.hidden,function(){$(SELECTORS.BULKACTIONSELECT).focus();this.modal.getRoot().remove()}.bind(this));this.modal.getRoot().on(ModalEvents.save,this.submitSendMessage.bind(this,users));this.modal.show();return this.modal}.bind(this))};MessageUsers.prototype.submitSendMessage=function(users){var messageText=this.modal.getRoot().find("form textarea").val(),messages=[],userIds=new Set(Object.values(users));userIds.forEach(function(userId){messages.push({touserid:userId,text:messageText})});var actionName=this.actionName,message=null;return Ajax.call([{methodname:"core_message_send_instant_messages",args:{messages:messages}}])[0].then(function(messageIds){if(1==messageIds.length){return Str.get_string("sendbulkmessagesentsingle","core_message")}else{return Str.get_string("sendbulkmessagesent","core_message",messageIds.length)}}).then(function(msg){message=msg;return Ajax.call([{methodname:"report_insights_action_executed",args:{actionname:actionName,predictionids:Object.keys(users)}}])[0]}).then(function(){Notification.addNotification({message:message,type:"success"});return!0}).catch(Notification.exception)};return{init:function(rootNode,actionName){return new MessageUsers(rootNode,actionName)}}});
//# sourceMappingURL=message_users.min.js.map
