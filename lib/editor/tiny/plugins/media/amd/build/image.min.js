define("tiny_media/image",["exports","core/templates","core/str","core/modal_factory","editor_tiny/utils","tiny_media/selectors","tiny_media/imagemodal","tiny_media/options","./common"],(function(_exports,_templates,_str,ModalFactory,_utils,_selectors,_imagemodal,_options,_common){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.MediaImage=void 0,_templates=_interopRequireDefault(_templates),ModalFactory=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(ModalFactory),_selectors=_interopRequireDefault(_selectors),_imagemodal=_interopRequireDefault(_imagemodal);_exports.MediaImage=class{constructor(editor){_defineProperty(this,"DEFAULTS",{WIDTH:160,HEIGHT:160}),_defineProperty(this,"form",null),_defineProperty(this,"rawImageDimensions",null),_defineProperty(this,"canShowFilePicker",!1),_defineProperty(this,"editor",null),_defineProperty(this,"currentModal",null),_defineProperty(this,"selectedImage",null),_defineProperty(this,"imageAlignment",null);const permissions=(0,_options.getImagePermissions)(editor);this.canShowFilePicker=permissions.filepicker,this.editor=editor}async displayDialogue(){this.rawImageDimensions=null;let data={};const currentImageData=await this.getCurrentImageData();currentImageData&&Object.assign(data,currentImageData);const modal=await ModalFactory.create({type:_imagemodal.default.TYPE,title:(0,_str.get_string)("imageproperties","tiny_media"),templateContext:await this.getTemplateContext(data),removeOnClose:!0,large:!0});this.currentModal=modal,await this.registerEventListeners(modal),modal.show()}async getImageAlignment(){let selected=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const[alignmentTopString,alignmentMiddleString,alignmentBottomString,alignmentLeftString,alignmentRightString]=await(0,_str.get_strings)(["alignment_top","alignment_middle","alignment_bottom","alignment_left","alignment_right"].map((key=>({key:key,component:_common.component}))));let alignments=[{text:alignmentTopString,value:"text-top"},{text:alignmentMiddleString,value:"middle"},{text:alignmentBottomString,value:"text-bottom"},{text:alignmentLeftString,value:"left"},{text:alignmentRightString,value:"right"}];return selected&&alignments.forEach(((alignment,index,array)=>{alignment.value===selected&&(array[index].selected=!0)})),alignments}async getTemplateContext(data){return Object.assign({},{elementid:this.editor.id,showfilepicker:this.canShowFilePicker,alignoptions:await this.getImageAlignment()},data)}async getCurrentImageData(){const properties=this.getSelectedImageProperties();return!!properties&&(properties.align&&(properties.alignoptions=await this.getImageAlignment(properties.align)),properties.src&&(properties.haspreview=!0),properties.alt||(properties.presentation=!0),properties)}filePickerCallback(params,self){if(""!==params.url){self.form.querySelector(_selectors.default.IMAGE.elements.url).value=params.url,self.form.querySelector(_selectors.default.IMAGE.elements.width).value="",self.form.querySelector(_selectors.default.IMAGE.elements.height).value="",self.loadPreviewImage(params.url)}}loadPreviewImage(url){const image=new Image;image.onerror=()=>{this.form.querySelector(_selectors.default.IMAGE.elements.preview).style.display="none"},image.onload=()=>{let input,currentWidth,currentHeight,widthRatio,heightRatio;this.rawImageDimensions={width:image.width||this.DEFAULTS.WIDTH,height:image.height||this.DEFAULTS.HEIGHT},input=this.form.querySelector(_selectors.default.IMAGE.elements.width),currentWidth=input.value,""===currentWidth&&(input.value=this.rawImageDimensions.width,currentWidth=""+this.rawImageDimensions.width),input=this.form.querySelector(_selectors.default.IMAGE.elements.height),currentHeight=input.value,""===currentHeight&&(input.value=this.rawImageDimensions.height,currentHeight=""+this.rawImageDimensions.height),input=this.form.querySelector(_selectors.default.IMAGE.elements.preview),input.setAttribute("src",image.src),input.style.display="inline",input=this.form.querySelector(_selectors.default.IMAGE.elements.constrain),this.isPercentageValue(currentWidth)&&this.isPercentageValue(currentHeight)?input.checked=currentWidth===currentHeight:0===image.width||0===image.height?input.disabled="disabled":(widthRatio=Math.round(1e3*parseInt(currentWidth,10)/image.width),heightRatio=Math.round(1e3*parseInt(currentHeight,10)/image.height),input.checked=widthRatio===heightRatio)},image.src=url}urlChanged(){const input=this.form.querySelector(_selectors.default.IMAGE.elements.url);""!==input.value&&this.loadPreviewImage(input.value)}hasErrorUrlField(){const urlError=""===this.form.querySelector(_selectors.default.IMAGE.elements.url).value;return this.toggleVisibility(_selectors.default.IMAGE.elements.urlWarning,urlError),this.toggleAriaInvalid([_selectors.default.IMAGE.elements.url],urlError),urlError}hasErrorAltField(){const alt=this.form.querySelector(_selectors.default.IMAGE.elements.alt).value,presentation=this.form.querySelector(_selectors.default.IMAGE.elements.presentation).checked,imageAltError=""===alt&&!presentation;return this.toggleVisibility(_selectors.default.IMAGE.elements.altWarning,imageAltError),this.toggleAriaInvalid([_selectors.default.IMAGE.elements.alt,_selectors.default.IMAGE.elements.presentation],imageAltError),imageAltError}toggleVisibility(selector,predicate){this.form.querySelectorAll(selector).forEach((element=>{element.style.display=predicate?"block":"none"}))}toggleAriaInvalid(selectors,predicate){selectors.forEach((selector=>{this.form.querySelectorAll(selector).forEach((element=>{element.setAttribute("aria-invalid",predicate)}))}))}getAlignmentClass(alignment){return _selectors.default.IMAGE.elements.alignSettings+"_"+alignment}updateWarning(){const urlError=this.hasErrorUrlField(),imageAltError=this.hasErrorAltField();return urlError||imageAltError}setImage(){const url=this.form.querySelector(_selectors.default.IMAGE.elements.url).value,alt=this.form.querySelector(_selectors.default.IMAGE.elements.alt).value,width=this.form.querySelector(_selectors.default.IMAGE.elements.width).value,height=this.form.querySelector(_selectors.default.IMAGE.elements.height).value,alignment=this.getAlignmentClass(this.form.querySelector(_selectors.default.IMAGE.elements.alignment).value),presentation=this.form.querySelector(_selectors.default.IMAGE.elements.presentation).checked,constrain=this.form.querySelector(_selectors.default.IMAGE.elements.constrain).value,customStyle=this.form.querySelector(_selectors.default.IMAGE.elements.customStyle).value;let classList=[];if(!this.updateWarning()&&""!==url){if(constrain&&classList.push(_selectors.default.IMAGE.styles.responsive),classList.push(alignment),!this.isPercentageValue(width)&&isNaN(parseInt(width,10)))return void this.form.querySelector(_selectors.default.IMAGE.elements.width).focus();if(!this.isPercentageValue(height)&&isNaN(parseInt(height,10)))return void this.form.querySelector(_selectors.default.IMAGE.elements.height).focus();_templates.default.render("tiny_media/image",{url:url,alt:alt,width:width,height:height,presentation:presentation,customstyle:customStyle,classlist:classList.join(" ")}).then((html=>{this.editor.insertContent(html),this.currentModal.destroy()}))}}handleKeyupCharacterCount(){const alt=this.form.querySelector(_selectors.default.IMAGE.elements.alt).value;this.form.querySelector("#currentcount").innerHTML=alt.length}autoAdjustSize(e,forceHeight){forceHeight=forceHeight||!1;let rawPercentage,rawSize,keyField=this.form.querySelector(_selectors.default.IMAGE.elements.width),keyFieldType="width",subField=this.form.querySelector(_selectors.default.IMAGE.elements.height),subFieldType="height",constrainField=this.form.querySelector(_selectors.default.IMAGE.elements.constrain),keyFieldValue=keyField.value,subFieldValue=subField.value,imagePreview=this.form.querySelector(_selectors.default.IMAGE.elements.preview);if(this.rawImageDimensions)if(""===keyFieldValue&&(keyFieldValue=this.rawImageDimensions[keyFieldType],keyField.value=keyFieldValue,keyFieldValue=keyField.value),imagePreview.style.width=null,imagePreview.style.height=null,constrainField.checked){if(forceHeight){let temporaryValue;temporaryValue=keyField,subField=temporaryValue,temporaryValue=keyFieldType,keyFieldType=subFieldType,subFieldType=temporaryValue,temporaryValue=keyFieldValue,keyFieldValue=subFieldValue,subFieldValue=temporaryValue}this.isPercentageValue(keyFieldValue)?(subFieldValue=keyFieldValue,rawPercentage=parseInt(keyFieldValue,10),rawSize=this.rawImageDimensions.width/100*rawPercentage,imagePreview.style.width=rawSize,rawSize=this.rawImageDimensions.height/100*rawPercentage,imagePreview.style.height=rawSize):(subFieldValue=Math.round(keyFieldValue/this.rawImageDimensions[keyFieldType]*this.rawImageDimensions[subFieldType]),forceHeight?(imagePreview.style.width=subFieldValue,imagePreview.style.height=keyFieldValue):(imagePreview.style.width=keyFieldValue,imagePreview.style.height=subFieldValue)),subField.value=subFieldValue}else this.isPercentageValue(keyFieldValue)?(rawPercentage=parseInt(keyFieldValue,10),rawSize=this.rawImageDimensions.width/100*rawPercentage,imagePreview.style.width=rawSize+"px"):imagePreview.style.width=keyFieldValue+"px",this.isPercentageValue(subFieldValue)?(rawPercentage=parseInt(subFieldValue,10),rawSize=this.rawImageDimensions.height/100*rawPercentage,imagePreview.style.height=rawSize+"px"):imagePreview.style.height=subFieldValue+"px"}getSelectedImageProperties(){let width,height,style,properties={src:null,alt:null,width:null,height:null,align:"",presentation:!1},image=this.getSelectedImage();return image?(image=this.removeLegacyAlignment(image),this.selectedImage=image,style=image.style,properties.customstyle=style,width=image.width,this.isPercentageValue(String(width))||(width=parseInt(width,10)),height=image.height,this.isPercentageValue(String(height))||(height=parseInt(height,10)),0!==width&&(properties.width=width),0!==height&&(properties.height=height),this.getAlignmentProperties(image,properties),properties.src=image.getAttribute("src"),properties.alt=image.getAttribute("alt")||"",properties.presentation="presentation"===image.getAttribute("role"),properties):(this.selectedImage=null,!1)}removeLegacyAlignment(imageNode){return imageNode.style.margin?(_selectors.default.IMAGE.alignments.some((alignment=>{if(imageNode.style[alignment.name]!==alignment.value)return!1;const normalisedNode=document.createElement("div");return normalisedNode.style.margin=alignment.margin,imageNode.style.margin===normalisedNode.style.margin&&(imageNode.classList.add(this.getAlignmentClass(alignment.value)),imageNode.style[alignment.name]=null,imageNode.style.margin=null,!0)})),imageNode):imageNode}getAlignmentProperties(image,properties){let complete,defaultAlignment;complete=_selectors.default.IMAGE.alignments.some((alignment=>{const classname=this.getAlignmentClass(alignment.value);return image.classList.contains(classname)?(properties.align=alignment.value,!0):(alignment.isDefault&&(defaultAlignment=alignment.value),!1)})),!complete&&defaultAlignment&&(properties.align=defaultAlignment)}getSelectedImage(){const imgElm=this.editor.selection.getNode(),figureElm=this.editor.dom.getParent(imgElm,"figure.image");return figureElm?this.editor.dom.select("img",figureElm)[0]:imgElm&&("IMG"!==imgElm.nodeName||this.isPlaceholderImage(imgElm))?null:imgElm}isPlaceholderImage(imgElm){return"IMG"===imgElm.nodeName&&(imgElm.hasAttribute("data-mce-object")||imgElm.hasAttribute("data-mce-placeholder"))}isPercentageValue(value){return value.match(/\d+%/)}async registerEventListeners(modal){await modal.getBody();const root=modal.getRoot()[0];this.form=root.querySelector(_selectors.default.IMAGE.elements.form),root.addEventListener("click",(e=>{const submitAction=e.target.closest(_selectors.default.IMAGE.actions.submit),imageBrowserAction=e.target.closest(_selectors.default.IMAGE.actions.imageBrowser);submitAction&&(e.preventDefault(),this.setImage()),imageBrowserAction&&this.canShowFilePicker&&(e.preventDefault(),(0,_utils.displayFilepicker)(this.editor,"image").then((params=>{this.filePickerCallback(params,this)})).catch())})),root.addEventListener("change",(e=>{const urlEle=e.target.closest(_selectors.default.IMAGE.elements.url),presentationEle=e.target.closest(_selectors.default.IMAGE.elements.presentation),constrainEle=e.target.closest(_selectors.default.IMAGE.elements.constrain);urlEle&&this.hasErrorUrlField(),presentationEle&&this.hasErrorAltField(),constrainEle&&this.autoAdjustSize(e,!0)})),root.addEventListener("blur",(e=>{if(e.target.nodeType===Node.ELEMENT_NODE){const urlEle=e.target.closest(_selectors.default.IMAGE.elements.url),altEle=e.target.closest(_selectors.default.IMAGE.elements.alt),widthEle=e.target.closest(_selectors.default.IMAGE.elements.width),heightEle=e.target.closest(_selectors.default.IMAGE.elements.height);urlEle&&this.urlChanged(),altEle&&this.hasErrorAltField(),widthEle&&this.autoAdjustSize(e),heightEle&&this.autoAdjustSize(e,!0)}}),!0),root.addEventListener("keyup",(e=>{e.target.closest(_selectors.default.IMAGE.elements.alt)&&this.handleKeyupCharacterCount()}))}}}));

//# sourceMappingURL=image.min.js.map