function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define ("core_form/modalform",["exports","core/ajax","core_form/changechecker","core_form/events","core/fragment","core/modal_events","core/modal_factory","core/notification","core/pending"],function(_exports,_ajax,FormChangeChecker,FormEvents,_fragment,_modal_events,_modal_factory,_notification,_pending){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.default=void 0;_ajax=_interopRequireDefault(_ajax);FormChangeChecker=_interopRequireWildcard(FormChangeChecker);FormEvents=_interopRequireWildcard(FormEvents);_fragment=_interopRequireDefault(_fragment);_modal_events=_interopRequireDefault(_modal_events);_modal_factory=_interopRequireDefault(_modal_factory);_notification=_interopRequireDefault(_notification);_pending=_interopRequireDefault(_pending);function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)})}}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if("Object"===n&&o.constructor)n=o.constructor.name;if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}function _arrayLikeToArray(arr,len){if(null==len||len>arr.length)len=arr.length;for(var i=0,arr2=Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable})),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1,source;i<arguments.length;i++){source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach(function(key){_defineProperty(target,key,source[key])}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}return target}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0,descriptor;i<props.length;i++){descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1;descriptor.configurable=!0;if("value"in descriptor)descriptor.writable=!0;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:!1});return Constructor}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0})}else{obj[key]=value}return obj}var ModalForm=function(){function ModalForm(config){_classCallCheck(this,ModalForm);_defineProperty(this,"events",{FORM_SUBMITTED:"core_form_modalform_formsubmitted",FORM_CANCELLED:"core_form_modalform_formcancelled",CLIENT_VALIDATION_ERROR:"core_form_modalform_clientvalidationerror",SERVER_VALIDATION_ERROR:"core_form_modalform_validationerror",ERROR:"core_form_modalform_error",NOSUBMIT_BUTTON_PRESSED:"core_form_modalform_nosubmitbutton",SUBMIT_BUTTON_PRESSED:"core_form_modalform_submitbutton",CANCEL_BUTTON_PRESSED:"core_form_modalform_cancelbutton",LOADED:"core_form_modalform_loaded"});this.modal=null;this.config=config;this.config.modalConfig=_objectSpread({removeOnClose:!0,type:_modal_factory.default.types.SAVE_CANCEL,large:!0},this.config.modalConfig||{});this.config.args=this.config.args||{};this.futureListeners=[]}_createClass(ModalForm,[{key:"show",value:function show(){var _this=this,pendingPromise=new _pending.default("core_form/modalform:init");return _modal_factory.default.create(this.config.modalConfig).then(function(modal){_this.modal=modal;var formParams=new URLSearchParams(Object.entries(_this.config.args||{})),bodyContent=_this.getBody(formParams.toString());_this.modal.setBodyContent(bodyContent);bodyContent.catch(_notification.default.exception);_this.modal.getRoot().on(_modal_events.default.hidden,function(){_this.notifyResetFormChanges();_this.modal.destroy();if(_this.config.returnFocus){_this.config.returnFocus.focus()}});_this.modal.getModal().addClass("modal-form-dialogue");_this.modal.getRoot().on("click","form input[type=submit][data-no-submit]",function(e){e.preventDefault();var event=_this.trigger(_this.events.NOSUBMIT_BUTTON_PRESSED,e.target);if(!event.defaultPrevented){_this.processNoSubmitButton(e.target)}});_this.modal.getRoot().on("submit","form",function(e){e.preventDefault();var event=_this.trigger(_this.events.SUBMIT_BUTTON_PRESSED);if(!event.defaultPrevented){_this.submitFormAjax()}});if("undefined"!=typeof _this.config.saveButtonText&&"undefined"!=typeof _this.modal.setSaveButtonText){_this.modal.setSaveButtonText(_this.config.saveButtonText)}if("undefined"!=typeof _this.config.saveButtonClasses){_this.setSaveButtonClasses(_this.config.saveButtonClasses)}_this.modal.getRoot().on(_modal_events.default.save,function(e){e.preventDefault();_this.modal.getRoot().find("form").submit()});_this.modal.getRoot().on(_modal_events.default.cancel,function(e){var event=_this.trigger(_this.events.CANCEL_BUTTON_PRESSED);if(event.defaultPrevented){e.preventDefault()}});_this.futureListeners.forEach(function(args){var _this$modal$getRoot$;return(_this$modal$getRoot$=_this.modal.getRoot()[0]).addEventListener.apply(_this$modal$getRoot$,_toConsumableArray(args))});_this.futureListeners=[];_this.trigger(_this.events.LOADED,null,!1);return _this.modal.show()}).then(pendingPromise.resolve)}},{key:"trigger",value:function trigger(eventName){var detail=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,cancelable=2<arguments.length&&arguments[2]!==void 0?arguments[2]:!0,e=new CustomEvent(eventName,{detail:detail,cancelable:cancelable});this.modal.getRoot()[0].dispatchEvent(e);return e}},{key:"addEventListener",value:function addEventListener(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}if(!this.modal){this.futureListeners.push(args)}else{var _this$modal$getRoot$2;(_this$modal$getRoot$2=this.modal.getRoot()[0]).addEventListener.apply(_this$modal$getRoot$2,args)}}},{key:"getBody",value:function getBody(formDataString){var params={formdata:formDataString,form:this.config.formClass},pendingPromise=new _pending.default("core_form/modalform:form_body");return _ajax.default.call([{methodname:"core_form_dynamic_form",args:params}])[0].then(function(response){pendingPromise.resolve();return{html:response.html,js:_fragment.default.processCollectedJavascript(response.javascript)}})}},{key:"onSubmitError",value:function onSubmitError(exception){var event=this.trigger(this.events.ERROR,exception);if(event.defaultPrevented){return}_notification.default.exception(exception)}},{key:"notifyResetFormChanges",value:function notifyResetFormChanges(){var form=this.getFormNode();FormEvents.notifyFormSubmittedByJavascript(this.getFormNode(),!0);if(!form){return}FormChangeChecker.resetFormDirtyState(this.getFormNode())}},{key:"getFormNode",value:function getFormNode(){return this.modal.getRoot().find("form")[0]}},{key:"processNoSubmitButton",value:function processNoSubmitButton(button){var form=this.getFormNode();if(!form){return}FormEvents.notifyFormSubmittedByJavascript(form,!0);var formData=this.modal.getRoot().find("form").serialize();formData=formData+"&"+encodeURIComponent(button.getAttribute("name"))+"="+encodeURIComponent(button.getAttribute("value"));var bodyContent=this.getBody(formData);this.modal.setBodyContent(bodyContent);bodyContent.catch(_notification.default.exception)}},{key:"validateElements",value:function validateElements(){FormEvents.notifyFormSubmittedByJavascript(this.getFormNode());var invalid=this.modal.getRoot().find("[aria-invalid=\"true\"], .error");if(invalid.length){invalid.first().focus();return!1}return!0}},{key:"disableButtons",value:function disableButtons(){this.modal.getFooter().find("[data-action]").attr("disabled",!0)}},{key:"enableButtons",value:function enableButtons(){this.modal.getFooter().find("[data-action]").removeAttr("disabled")}},{key:"submitFormAjax",value:function(){var _submitFormAjax=_asyncToGenerator(regeneratorRuntime.mark(function _callee(){var _this2=this,formData;return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:if(this.validateElements()){_context.next=3;break}this.trigger(this.events.CLIENT_VALIDATION_ERROR,null,!1);return _context.abrupt("return");case 3:this.disableButtons();formData=this.modal.getRoot().find("form").serialize();_ajax.default.call([{methodname:"core_form_dynamic_form",args:{formdata:formData,form:this.config.formClass}}])[0].then(function(response){if(!response.submitted){var promise=new Promise(function(resolve){return resolve({html:response.html,js:_fragment.default.processCollectedJavascript(response.javascript)})});_this2.modal.setBodyContent(promise);_this2.enableButtons();_this2.trigger(_this2.events.SERVER_VALIDATION_ERROR)}else{var data=JSON.parse(response.data);_this2.notifyResetFormChanges();var event=_this2.trigger(_this2.events.FORM_SUBMITTED,data);if(!event.defaultPrevented){_this2.modal.hide()}}return null}).catch(function(exception){return _this2.onSubmitError(exception)});case 6:case"end":return _context.stop();}}},_callee,this)}));return function submitFormAjax(){return _submitFormAjax.apply(this,arguments)}}()},{key:"setSaveButtonClasses",value:function setSaveButtonClasses(value){var button=this.modal.getFooter().find("[data-action='save']");if(!button){throw new Error("Unable to find the 'save' button")}button.removeClass().addClass(value)}}]);return ModalForm}();_exports.default=ModalForm;return _exports.default});
//# sourceMappingURL=modalform.min.js.map
