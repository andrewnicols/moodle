define ("core_form/modalform",["exports","core/ajax","core_form/changechecker","core_form/events","core/fragment","core/modal_events","core/modal_factory","core/notification","core/pending"],function(_exports,_ajax,FormChangeChecker,FormEvents,_fragment,_modal_events,_modal_factory,_notification,_pending){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.default=void 0;_ajax=_interopRequireDefault(_ajax);FormChangeChecker=_interopRequireWildcard(FormChangeChecker);FormEvents=_interopRequireWildcard(FormEvents);_fragment=_interopRequireDefault(_fragment);_modal_events=_interopRequireDefault(_modal_events);_modal_factory=_interopRequireDefault(_modal_factory);_notification=_interopRequireDefault(_notification);_pending=_interopRequireDefault(_pending);function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!=typeof obj&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0})}else{obj[key]=value}return obj}_exports.default=class{constructor(config){_defineProperty(this,"events",{FORM_SUBMITTED:"core_form_modalform_formsubmitted",FORM_CANCELLED:"core_form_modalform_formcancelled",CLIENT_VALIDATION_ERROR:"core_form_modalform_clientvalidationerror",SERVER_VALIDATION_ERROR:"core_form_modalform_validationerror",ERROR:"core_form_modalform_error",NOSUBMIT_BUTTON_PRESSED:"core_form_modalform_nosubmitbutton",SUBMIT_BUTTON_PRESSED:"core_form_modalform_submitbutton",CANCEL_BUTTON_PRESSED:"core_form_modalform_cancelbutton",LOADED:"core_form_modalform_loaded"});this.modal=null;this.config=config;this.config.modalConfig={removeOnClose:!0,type:_modal_factory.default.types.SAVE_CANCEL,large:!0,...(this.config.modalConfig||{})};this.config.args=this.config.args||{};this.futureListeners=[]}show(){const pendingPromise=new _pending.default("core_form/modalform:init");return _modal_factory.default.create(this.config.modalConfig).then(modal=>{this.modal=modal;const formParams=new URLSearchParams(Object.entries(this.config.args||{})),bodyContent=this.getBody(formParams.toString());this.modal.setBodyContent(bodyContent);bodyContent.catch(_notification.default.exception);this.modal.getRoot().on(_modal_events.default.hidden,()=>{this.notifyResetFormChanges();this.modal.destroy();if(this.config.returnFocus){this.config.returnFocus.focus()}});this.modal.getModal().addClass("modal-form-dialogue");this.modal.getRoot().on("click","form input[type=submit][data-no-submit]",e=>{e.preventDefault();const event=this.trigger(this.events.NOSUBMIT_BUTTON_PRESSED,e.target);if(!event.defaultPrevented){this.processNoSubmitButton(e.target)}});this.modal.getRoot().on("submit","form",e=>{e.preventDefault();const event=this.trigger(this.events.SUBMIT_BUTTON_PRESSED);if(!event.defaultPrevented){this.submitFormAjax()}});if("undefined"!=typeof this.config.saveButtonText&&"undefined"!=typeof this.modal.setSaveButtonText){this.modal.setSaveButtonText(this.config.saveButtonText)}if("undefined"!=typeof this.config.saveButtonClasses){this.setSaveButtonClasses(this.config.saveButtonClasses)}this.modal.getRoot().on(_modal_events.default.save,e=>{e.preventDefault();this.modal.getRoot().find("form").submit()});this.modal.getRoot().on(_modal_events.default.cancel,e=>{const event=this.trigger(this.events.CANCEL_BUTTON_PRESSED);if(event.defaultPrevented){e.preventDefault()}});this.futureListeners.forEach(args=>this.modal.getRoot()[0].addEventListener(...args));this.futureListeners=[];this.trigger(this.events.LOADED,null,!1);return this.modal.show()}).then(pendingPromise.resolve)}trigger(eventName){let detail=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,cancelable=2<arguments.length&&arguments[2]!==void 0?arguments[2]:!0;const e=new CustomEvent(eventName,{detail,cancelable});this.modal.getRoot()[0].dispatchEvent(e);return e}addEventListener(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}if(!this.modal){this.futureListeners.push(args)}else{this.modal.getRoot()[0].addEventListener(...args)}}getBody(formDataString){const params={formdata:formDataString,form:this.config.formClass},pendingPromise=new _pending.default("core_form/modalform:form_body");return _ajax.default.call([{methodname:"core_form_dynamic_form",args:params}])[0].then(response=>{pendingPromise.resolve();return{html:response.html,js:_fragment.default.processCollectedJavascript(response.javascript)}})}onSubmitError(exception){const event=this.trigger(this.events.ERROR,exception);if(event.defaultPrevented){return}_notification.default.exception(exception)}notifyResetFormChanges(){const form=this.getFormNode();FormEvents.notifyFormSubmittedByJavascript(this.getFormNode(),!0);if(!form){return}FormChangeChecker.resetFormDirtyState(this.getFormNode())}getFormNode(){return this.modal.getRoot().find("form")[0]}processNoSubmitButton(button){const form=this.getFormNode();if(!form){return}FormEvents.notifyFormSubmittedByJavascript(form,!0);let formData=this.modal.getRoot().find("form").serialize();formData=formData+"&"+encodeURIComponent(button.getAttribute("name"))+"="+encodeURIComponent(button.getAttribute("value"));const bodyContent=this.getBody(formData);this.modal.setBodyContent(bodyContent);bodyContent.catch(_notification.default.exception)}validateElements(){FormEvents.notifyFormSubmittedByJavascript(this.getFormNode());const invalid=this.modal.getRoot().find("[aria-invalid=\"true\"], .error");if(invalid.length){invalid.first().focus();return!1}return!0}disableButtons(){this.modal.getFooter().find("[data-action]").attr("disabled",!0)}enableButtons(){this.modal.getFooter().find("[data-action]").removeAttr("disabled")}async submitFormAjax(){if(!this.validateElements()){this.trigger(this.events.CLIENT_VALIDATION_ERROR,null,!1);return}this.disableButtons();const formData=this.modal.getRoot().find("form").serialize();_ajax.default.call([{methodname:"core_form_dynamic_form",args:{formdata:formData,form:this.config.formClass}}])[0].then(response=>{if(!response.submitted){const promise=new Promise(resolve=>resolve({html:response.html,js:_fragment.default.processCollectedJavascript(response.javascript)}));this.modal.setBodyContent(promise);this.enableButtons();this.trigger(this.events.SERVER_VALIDATION_ERROR)}else{const data=JSON.parse(response.data);this.notifyResetFormChanges();const event=this.trigger(this.events.FORM_SUBMITTED,data);if(!event.defaultPrevented){this.modal.hide()}}return null}).catch(exception=>this.onSubmitError(exception))}setSaveButtonClasses(value){const button=this.modal.getFooter().find("[data-action='save']");if(!button){throw new Error("Unable to find the 'save' button")}button.removeClass().addClass(value)}};return _exports.default});
//# sourceMappingURL=modalform.min.js.map
