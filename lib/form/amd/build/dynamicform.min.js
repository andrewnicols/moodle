define ("core_form/dynamicform",["exports","core/ajax","core_form/events","core/fragment","core/notification","core/pending","core/templates","core/yui","core/str"],function(a,b,c,d,e,f,g,h,i){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=void 0;b=j(b);c=j(c);d=j(d);e=j(e);f=j(f);g=j(g);h=j(h);function j(a){return a&&a.__esModule?a:{default:a}}function k(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function l(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){k(h,d,e,f,g,"next",a)}function g(a){k(h,d,e,f,g,"throw",a)}f(void 0)})}}function m(a){return q(a)||p(a)||o(a)||n()}function n(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function o(a,b){if(!a)return;if("string"==typeof a)return r(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return r(a,b)}function p(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function q(a){if(Array.isArray(a))return r(a)}function r(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function s(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function t(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function u(a,b,c){if(b)t(a.prototype,b);if(c)t(a,c);return a}function v(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}var w=function(){function a(b,c){var d=this;s(this,a);v(this,"events",{FORM_SUBMITTED:"core_form_dynamicform_formsubmitted",FORM_CANCELLED:"core_form_dynamicform_formcancelled",CLIENT_VALIDATION_ERROR:"core_form_dynamicform_clientvalidationerror",SERVER_VALIDATION_ERROR:"core_form_dynamicform_validationerror",ERROR:"core_form_dynamicform_error",NOSUBMIT_BUTTON_PRESSED:"core_form_dynamicform_nosubmitbutton",SUBMIT_BUTTON_PRESSED:"core_form_dynamicform_submitbutton",CANCEL_BUTTON_PRESSED:"core_form_dynamicform_cancelbutton"});this.formClass=c;this.container=b;(0,i.get_strings)([{key:"collapseall",component:"moodle"},{key:"expandall",component:"moodle"}]).catch(e.default.exception);this.container.addEventListener("click",function(a){if(a.target.matches("form input[type=submit][data-cancel]")){a.preventDefault();var b=d.trigger(d.events.CANCEL_BUTTON_PRESSED,a.target);if(!b.defaultPrevented){d.processCancelButton()}}else if(a.target.matches("form input[type=submit][data-no-submit=\"1\"]")){a.preventDefault();var c=d.trigger(d.events.NOSUBMIT_BUTTON_PRESSED,a.target);if(!c.defaultPrevented){d.processNoSubmitButton(a.target)}}});this.container.addEventListener("submit",function(a){if(a.target.matches("form")){a.preventDefault();var b=d.trigger(d.events.SUBMIT_BUTTON_PRESSED);if(!b.defaultPrevented){d.submitFormAjax()}}})}u(a,[{key:"load",value:function load(){var a=this,b=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,c=new URLSearchParams(Object.entries(b||{})),d=new f.default("core_form/dynamicform:load");return this.getBody(c.toString()).then(function(b){return a.updateForm(b)}).then(d.resolve)}},{key:"trigger",value:function trigger(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:!0,d=new CustomEvent(a,{detail:b,cancelable:c});this.container.dispatchEvent(d);return d}},{key:"addEventListener",value:function addEventListener(){var a;(a=this.container).addEventListener.apply(a,arguments)}},{key:"getBody",value:function getBody(a){return b.default.call([{methodname:"core_form_dynamic_form",args:{formdata:a,form:this.formClass}}])[0].then(function(a){return{html:a.html,js:d.default.processCollectedJavascript(a.javascript)}})}},{key:"onSubmitSuccess",value:function onSubmitSuccess(a){var b=this.trigger(this.events.FORM_SUBMITTED,a);if(b.defaultPrevented){return}this.container.innerHTML=""}},{key:"onSubmitError",value:function onSubmitError(a){var b=this.trigger(this.events.ERROR,a);if(b.defaultPrevented){return}e.default.exception(a)}},{key:"processNoSubmitButton",value:function processNoSubmitButton(a){var b=new f.default("core_form/dynamicform:nosubmit"),d=this.getFormNode(),e=new URLSearchParams(m(new FormData(d).entries()));e.append(a.getAttribute("name"),a.getAttribute("value"));c.default.notifyFormSubmittedByJavascript(d,!0);this.disableButtons();this.getBody(e.toString()).then(this.updateForm).then(b.resolve).catch(this.onSubmitError)}},{key:"getFormNode",value:function getFormNode(){return this.container.querySelector("form")}},{key:"notifyResetFormChanges",value:function notifyResetFormChanges(){c.default.notifyFormSubmittedByJavascript(this.getFormNode(),!0);return new Promise(function(a){h.default.use("event","moodle-core-event","moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state();a()})})}},{key:"processCancelButton",value:function processCancelButton(){var a=this;this.notifyResetFormChanges().then(function(){var b=a.trigger(a.events.FORM_CANCELLED);if(!b.defaultPrevented){a.container.innerHTML=""}return null}).catch(null)}},{key:"updateForm",value:function updateForm(a){var b=a.html,c=a.js;return g.default.replaceNodeContents(this.container,b,c)}},{key:"validateElements",value:function validateElements(){c.default.notifyFormSubmittedByJavascript(this.getFormNode());var a=m(this.container.querySelectorAll("[aria-invalid=\"true\"], .error"));if(a.length){a[0].focus();return!1}return!0}},{key:"disableButtons",value:function disableButtons(){this.container.querySelectorAll("form input[type=\"submit\"]").forEach(function(a){return a.setAttribute("disabled",!0)})}},{key:"enableButtons",value:function enableButtons(){this.container.querySelectorAll("form input[type=\"submit\"]").forEach(function(a){return a.removeAttribute("disabled")})}},{key:"submitFormAjax",value:function(){var a=l(regeneratorRuntime.mark(function a(){var c=this,e,f;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return this.validateElements();case 2:if(a.sent){a.next=5;break}this.trigger(this.events.CLIENT_VALIDATION_ERROR,null,!1);return a.abrupt("return");case 5:this.disableButtons();e=this.container.querySelector("form");f=new URLSearchParams(m(new FormData(e).entries()));b.default.call([{methodname:"core_form_dynamic_form",args:{formdata:f.toString(),form:this.formClass}}])[0].then(function(a){if(!a.submitted){c.updateForm({html:a.html,js:d.default.processCollectedJavascript(a.javascript)});c.enableButtons();c.trigger(c.events.SERVER_VALIDATION_ERROR,null,!1)}else{var b=JSON.parse(a.data);c.enableButtons();c.notifyResetFormChanges().then(function(){return c.onSubmitSuccess(b)}).catch()}return null}).catch(this.onSubmitError);case 9:case"end":return a.stop();}}},a,this)}));return function submitFormAjax(){return a.apply(this,arguments)}}()}]);return a}();a.default=w;return a.default});
//# sourceMappingURL=dynamicform.min.js.map
