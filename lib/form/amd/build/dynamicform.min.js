define ("core_form/dynamicform",["exports","core_form/changechecker","core_form/events","core/ajax","core/fragment","core/notification","core/pending","core/templates","core/str"],function(_exports,FormChangeChecker,FormEvents,_ajax,_fragment,_notification,_pending,_templates,_str){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.default=void 0;FormChangeChecker=_interopRequireWildcard(FormChangeChecker);FormEvents=_interopRequireWildcard(FormEvents);_ajax=_interopRequireDefault(_ajax);_fragment=_interopRequireDefault(_fragment);_notification=_interopRequireDefault(_notification);_pending=_interopRequireDefault(_pending);_templates=_interopRequireDefault(_templates);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!=typeof obj&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0})}else{obj[key]=value}return obj}_exports.default=class{constructor(container,formClass){_defineProperty(this,"events",{FORM_SUBMITTED:"core_form_dynamicform_formsubmitted",FORM_CANCELLED:"core_form_dynamicform_formcancelled",CLIENT_VALIDATION_ERROR:"core_form_dynamicform_clientvalidationerror",SERVER_VALIDATION_ERROR:"core_form_dynamicform_validationerror",ERROR:"core_form_dynamicform_error",NOSUBMIT_BUTTON_PRESSED:"core_form_dynamicform_nosubmitbutton",SUBMIT_BUTTON_PRESSED:"core_form_dynamicform_submitbutton",CANCEL_BUTTON_PRESSED:"core_form_dynamicform_cancelbutton"});this.formClass=formClass;this.container=container;(0,_str.get_strings)([{key:"collapseall",component:"moodle"},{key:"expandall",component:"moodle"}]).catch(_notification.default.exception);this.container.addEventListener("click",e=>{if(e.target.matches("form input[type=submit][data-cancel]")){e.preventDefault();const event=this.trigger(this.events.CANCEL_BUTTON_PRESSED,e.target);if(!event.defaultPrevented){this.processCancelButton()}}else if(e.target.matches("form input[type=submit][data-no-submit=\"1\"]")){e.preventDefault();const event=this.trigger(this.events.NOSUBMIT_BUTTON_PRESSED,e.target);if(!event.defaultPrevented){this.processNoSubmitButton(e.target)}}});this.container.addEventListener("submit",e=>{if(e.target.matches("form")){e.preventDefault();const event=this.trigger(this.events.SUBMIT_BUTTON_PRESSED);if(!event.defaultPrevented){this.submitFormAjax()}}})}load(){let args=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null;const formData=new URLSearchParams(Object.entries(args||{})),pendingPromise=new _pending.default("core_form/dynamicform:load");return this.getBody(formData.toString()).then(resp=>this.updateForm(resp)).then(pendingPromise.resolve)}trigger(eventName){let detail=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,cancelable=2<arguments.length&&arguments[2]!==void 0?arguments[2]:!0;const e=new CustomEvent(eventName,{detail,cancelable});this.container.dispatchEvent(e);return e}addEventListener(){this.container.addEventListener(...arguments)}getBody(formDataString){return _ajax.default.call([{methodname:"core_form_dynamic_form",args:{formdata:formDataString,form:this.formClass}}])[0].then(response=>{return{html:response.html,js:_fragment.default.processCollectedJavascript(response.javascript)}})}onSubmitSuccess(response){const event=this.trigger(this.events.FORM_SUBMITTED,response);if(event.defaultPrevented){return}this.container.innerHTML=""}onSubmitError(exception){const event=this.trigger(this.events.ERROR,exception);if(event.defaultPrevented){return}_notification.default.exception(exception)}processNoSubmitButton(button){const pendingPromise=new _pending.default("core_form/dynamicform:nosubmit"),form=this.getFormNode(),formData=new URLSearchParams([...new FormData(form).entries()]);formData.append(button.getAttribute("name"),button.getAttribute("value"));FormEvents.notifyFormSubmittedByJavascript(form,!0);this.disableButtons();this.getBody(formData.toString()).then(this.updateForm).then(pendingPromise.resolve).catch(exception=>this.onSubmitError(exception))}getFormNode(){return this.container.querySelector("form")}notifyResetFormChanges(){FormEvents.notifyFormSubmittedByJavascript(this.getFormNode(),!0);FormChangeChecker.resetFormDirtyState(this.getFormNode())}processCancelButton(){this.notifyResetFormChanges();const event=this.trigger(this.events.FORM_CANCELLED);if(!event.defaultPrevented){this.container.innerHTML=""}}updateForm(_ref){let{html,js}=_ref;return _templates.default.replaceNodeContents(this.container,html,js)}validateElements(){FormEvents.notifyFormSubmittedByJavascript(this.getFormNode());const invalid=[...this.container.querySelectorAll("[aria-invalid=\"true\"], .error")];if(invalid.length){invalid[0].focus();return!1}return!0}disableButtons(){this.container.querySelectorAll("form input[type=\"submit\"]").forEach(el=>el.setAttribute("disabled",!0))}enableButtons(){this.container.querySelectorAll("form input[type=\"submit\"]").forEach(el=>el.removeAttribute("disabled"))}async submitFormAjax(){if(!(await this.validateElements())){this.trigger(this.events.CLIENT_VALIDATION_ERROR,null,!1);return}this.disableButtons();const form=this.container.querySelector("form"),formData=new URLSearchParams([...new FormData(form).entries()]);_ajax.default.call([{methodname:"core_form_dynamic_form",args:{formdata:formData.toString(),form:this.formClass}}])[0].then(response=>{if(!response.submitted){this.updateForm({html:response.html,js:_fragment.default.processCollectedJavascript(response.javascript)});this.enableButtons();this.trigger(this.events.SERVER_VALIDATION_ERROR,null,!1)}else{const data=JSON.parse(response.data);this.enableButtons();this.notifyResetFormChanges();this.onSubmitSuccess(data)}return null}).catch(exception=>this.onSubmitError(exception))}};return _exports.default});
//# sourceMappingURL=dynamicform.min.js.map
