define ("core/ajax",["jquery","core/config","core/log","core/url"],function($,config,Log,URL){var unloading=!1,requestSuccess=function(responses){var requests=this,exception=null,i=0,request,response,nosessionupdate;if(responses.error){for(;i<requests.length;i++){request=requests[i];request.deferred.reject(responses)}return}for(i=0;i<requests.length;i++){request=requests[i];response=responses[i];if("undefined"!=typeof response){if(!1===response.error){request.deferred.resolve(response.data)}else{exception=response.exception;nosessionupdate=requests[i].nosessionupdate;break}}else{exception=new Error("missing response");break}}if(null!==exception){if("servicerequireslogin"===exception.errorcode&&!nosessionupdate){window.location=URL.relativeUrl("/login/index.php")}else{requests.forEach(function(request){request.deferred.reject(exception)})}}},requestFail=function(jqXHR,textStatus,exception){var requests=this,i=0;for(i=0;i<requests.length;i++){var request=requests[i];if(unloading){Log.error("Page unloaded.");Log.error(exception)}else{request.deferred.reject(exception)}}};return{call:function(requests,async,loginrequired,nosessionupdate,timeout,cachekey){$(window).bind("beforeunload",function(){unloading=!0});var ajaxRequestData=[],i,promises=[],methodInfo=[],requestInfo="";if("undefined"==typeof loginrequired){loginrequired=!0}if("undefined"==typeof async){async=!0}if("undefined"==typeof timeout){timeout=0}if("undefined"==typeof cachekey){cachekey=null}else{cachekey=parseInt(cachekey);if(0>=cachekey){cachekey=null}else if(!cachekey){cachekey=null}}if("undefined"==typeof nosessionupdate){nosessionupdate=!1}for(i=0;i<requests.length;i++){var request=requests[i];ajaxRequestData.push({index:i,methodname:request.methodname,args:request.args});request.nosessionupdate=nosessionupdate;request.deferred=$.Deferred();promises.push(request.deferred.promise());if("undefined"!=typeof request.done){request.deferred.done(request.done)}if("undefined"!=typeof request.fail){request.deferred.fail(request.fail)}request.index=i;methodInfo.push(request.methodname)}if(5>=methodInfo.length){requestInfo=methodInfo.sort().join()}else{requestInfo=methodInfo.length+"-method-calls"}ajaxRequestData=JSON.stringify(ajaxRequestData);var settings={type:"POST",context:requests,dataType:"json",processData:!1,async:async,contentType:"application/json",timeout:timeout},script="service.php",url=config.wwwroot+"/lib/ajax/";if(!loginrequired){script="service-nologin.php";url+=script+"?info="+requestInfo;if(cachekey){url+="&cachekey="+cachekey;settings.type="GET"}}else{url+=script+"?sesskey="+config.sesskey+"&info="+requestInfo}if(nosessionupdate){url+="&nosessionupdate=true"}if("POST"===settings.type){settings.data=ajaxRequestData}else{var urlUseGet=url+"&args="+encodeURIComponent(ajaxRequestData);if(urlUseGet.length>2e3){settings.type="POST";settings.data=ajaxRequestData}else{url=urlUseGet}}if(async){$.ajax(url,settings).done(requestSuccess).fail(requestFail)}else{settings.success=requestSuccess;settings.error=requestFail;$.ajax(url,settings)}return promises}}});
//# sourceMappingURL=ajax.min.js.map
