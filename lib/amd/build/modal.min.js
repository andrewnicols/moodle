function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define ("core/modal",["jquery","core/templates","core/notification","core/key_codes","core/custom_interaction_events","core/modal_backdrop","core_filters/events","core/modal_events","core/local/aria/focuslock","core/pending","core/aria","core/fullscreen"],function($,Templates,Notification,KeyCodes,CustomEvents,ModalBackdrop,FilterEvents,ModalEvents,FocusLock,Pending,Aria,Fullscreen){var SELECTORS={CONTAINER:"[data-region=\"modal-container\"]",MODAL:"[data-region=\"modal\"]",HEADER:"[data-region=\"header\"]",TITLE:"[data-region=\"title\"]",BODY:"[data-region=\"body\"]",FOOTER:"[data-region=\"footer\"]",HIDE:"[data-action=\"hide\"]",DIALOG:"[role=dialog]",FORM:"form",MENU_BAR:"[role=menubar]",HAS_Z_INDEX:".moodle-has-zindex",CAN_RECEIVE_FOCUS:"input:not([type=\"hidden\"]), a[href], button, textarea, select, [tabindex]"},TEMPLATES={LOADING:"core/loading",BACKDROP:"core/modal_backdrop"},backdropPromise,modalCounter=0,Modal=function(root){this.root=$(root);this.modal=this.root.find(SELECTORS.MODAL);this.header=this.modal.find(SELECTORS.HEADER);this.headerPromise=$.Deferred();this.title=this.header.find(SELECTORS.TITLE);this.titlePromise=$.Deferred();this.body=this.modal.find(SELECTORS.BODY);this.bodyPromise=$.Deferred();this.footer=this.modal.find(SELECTORS.FOOTER);this.footerPromise=$.Deferred();this.hiddenSiblings=[];this.isAttached=!1;this.bodyJS=null;this.footerJS=null;this.modalCount=modalCounter++;this.attachmentPoint=document.createElement("div");document.body.append(this.attachmentPoint);if(!this.root.is(SELECTORS.CONTAINER)){Notification.exception({message:"Element is not a modal container"})}if(!this.modal.length){Notification.exception({message:"Container does not contain a modal"})}if(!this.header.length){Notification.exception({message:"Modal is missing a header region"})}if(!this.title.length){Notification.exception({message:"Modal header is missing a title region"})}if(!this.body.length){Notification.exception({message:"Modal is missing a body region"})}if(!this.footer.length){Notification.exception({message:"Modal is missing a footer region"})}this.registerEventListeners()};Modal.prototype.attachToDOM=function(){this.getAttachmentPoint().append(this.root);if(this.isAttached){return}FocusLock.trapFocus(this.root[0]);if(this.bodyJS){Templates.runTemplateJS(this.bodyJS);this.bodyJS=null}if(this.footerJS){Templates.runTemplateJS(this.footerJS);this.footerJS=null}this.isAttached=!0};Modal.prototype.countOtherVisibleModals=function(){var count=0;$("body").find(SELECTORS.CONTAINER).each(function(index,element){element=$(element);if(!this.root.is(element)&&element.hasClass("show")){count++}}.bind(this));return count};Modal.prototype.getBackdrop=function(){if(!backdropPromise){backdropPromise=Templates.render(TEMPLATES.BACKDROP,{}).then(function(html){var element=$(html);return new ModalBackdrop(element)}).fail(Notification.exception)}return backdropPromise};Modal.prototype.getRoot=function(){return this.root};Modal.prototype.getModal=function(){return this.modal};Modal.prototype.getTitle=function(){return this.title};Modal.prototype.getBody=function(){return this.body};Modal.prototype.getFooter=function(){return this.footer};Modal.prototype.getTitlePromise=function(){return this.titlePromise};Modal.prototype.getBodyPromise=function(){return this.bodyPromise};Modal.prototype.getFooterPromise=function(){return this.footerPromise};Modal.prototype.getModalCount=function(){return this.modalCount};Modal.prototype.setTitle=function(value){var title=this.getTitle();this.titlePromise=$.Deferred();this.asyncSet(value,title.html.bind(title)).then(function(){this.titlePromise.resolve(title)}.bind(this)).catch(Notification.exception)};Modal.prototype.setBody=function(value){this.bodyPromise=$.Deferred();var body=this.getBody();if("string"==typeof value){body.html(value);FilterEvents.notifyFilterContentUpdated(body);this.getRoot().trigger(ModalEvents.bodyRendered,this);this.bodyPromise.resolve(body)}else{var jsPendingId="amd-modal-js-pending-id-"+this.getModalCount();M.util.js_pending(jsPendingId);var contentPromise=null;body.css("overflow","hidden");value=$.when(value);if("pending"==value.state()){var height=body.innerHeight();if(100>height){height=100}body.animate({height:height+"px"},150);body.html("");contentPromise=Templates.render(TEMPLATES.LOADING,{}).then(function(html){var loadingIcon=$(html).hide();body.html(loadingIcon);loadingIcon.fadeIn(150);return $.when(loadingIcon.promise(),value)}).then(function(loadingIcon){return loadingIcon.fadeOut(100).promise()}).then(function(){return value})}else{contentPromise=value}contentPromise.then(function(html,js){var result=null;if(this.isVisible()){body.css("opacity",0);var currentHeight=body.innerHeight();body.html(html);body.css("height","");var newHeight=body.innerHeight();body.css("height",currentHeight+"px");result=body.animate({height:newHeight+"px",opacity:1},{duration:150,queue:!1}).promise()}else{body.html(html)}if(js){if(this.isAttached){Templates.runTemplateJS(js)}else{this.bodyJS=js}}return result}.bind(this)).then(function(result){FilterEvents.notifyFilterContentUpdated(body);this.getRoot().trigger(ModalEvents.bodyRendered,this);return result}.bind(this)).then(function(){this.bodyPromise.resolve(body)}.bind(this)).fail(Notification.exception).always(function(){body.css("height","");body.css("overflow","");body.css("opacity","");M.util.js_complete(jsPendingId)}).fail(Notification.exception)}};Modal.prototype.setBodyContent=function(promise){var _this=this;return promise.then(function(_ref){var html=_ref.html,js=_ref.js;return _this.setBody($.when(html,js))}).catch(function(exception){_this.hide();throw exception})};Modal.prototype.setFooter=function(value){this.showFooter();this.footerPromise=$.Deferred();var footer=this.getFooter();if("string"==typeof value){footer.html(value);this.footerPromise.resolve(footer)}else{Templates.render(TEMPLATES.LOADING,{}).then(function(html){footer.html(html);return value}).then(function(html,js){footer.html(html);if(js){if(this.isAttached){Templates.runTemplateJS(js)}else{this.footerJS=js}}return footer}.bind(this)).then(function(footer){this.footerPromise.resolve(footer)}.bind(this)).catch(Notification.exception)}};Modal.prototype.hasFooterContent=function(){return this.getFooter().children().length?!0:!1};Modal.prototype.hideFooter=function(){this.getFooter().addClass("hidden")};Modal.prototype.showFooter=function(){this.getFooter().removeClass("hidden")};Modal.prototype.setLarge=function(){if(this.isLarge()){return}this.getModal().addClass("modal-lg")};Modal.prototype.isLarge=function(){return this.getModal().hasClass("modal-lg")};Modal.prototype.setSmall=function(){if(this.isSmall()){return}this.getModal().removeClass("modal-lg")};Modal.prototype.isSmall=function(){return!this.getModal().hasClass("modal-lg")};Modal.prototype.setScrollable=function(value){if(!value){this.getModal()[0].classList.remove("modal-dialog-scrollable");return}this.getModal()[0].classList.add("modal-dialog-scrollable")};Modal.prototype.calculateZIndex=function(){var items=$(SELECTORS.DIALOG+", "+SELECTORS.MENU_BAR+", "+SELECTORS.HAS_Z_INDEX),zIndex=parseInt(this.root.css("z-index"));items.each(function(index,item){item=$(item);var itemZIndex=item.css("z-index")?parseInt(item.css("z-index")):0;if(itemZIndex>zIndex){zIndex=itemZIndex}});return zIndex};Modal.prototype.isVisible=function(){return this.root.hasClass("show")};Modal.prototype.hasFocus=function(){var target=$(document.activeElement);return this.root.is(target)||this.root.has(target).length};Modal.prototype.hasTransitions=function(){return this.getRoot().hasClass("fade")};Modal.prototype.getAttachmentPoint=function(){return $(Fullscreen.getElement()||this.attachmentPoint)};Modal.prototype.show=function(){if(this.isVisible()){return $.Deferred().resolve()}var pendingPromise=new Pending("core/modal:show");if(this.hasFooterContent()){this.showFooter()}else{this.hideFooter()}this.attachToDOM();return this.getBackdrop().then(function(backdrop){var currentIndex=this.calculateZIndex(),newIndex=currentIndex+2;this.root.css("z-index",newIndex);backdrop.setZIndex(newIndex-1);backdrop.show();this.root.removeClass("hide").addClass("show");this.accessibilityShow();this.getModal().focus();$("body").addClass("modal-open");this.root.trigger(ModalEvents.shown,this)}.bind(this)).then(pendingPromise.resolve)};Modal.prototype.hideIfNotForm=function(){var formElement=this.modal.find(SELECTORS.FORM);if(0==formElement.length){this.hide()}};Modal.prototype.hide=function(){this.getBackdrop().done(function(backdrop){FocusLock.untrapFocus();if(!this.countOtherVisibleModals()){backdrop.hide();$("body").removeClass("modal-open")}var currentIndex=parseInt(this.root.css("z-index"));this.root.css("z-index","");backdrop.setZIndex(currentIndex-3);this.accessibilityHide();if(this.hasTransitions()){this.getRoot().one("transitionend webkitTransitionEnd oTransitionEnd",function(){this.getRoot().removeClass("show").addClass("hide")}.bind(this))}else{this.getRoot().removeClass("show").addClass("hide")}if($(document.body).find(this.getRoot()).length){$(document.body).append(this.getRoot())}this.root.trigger(ModalEvents.hidden,this)}.bind(this))};Modal.prototype.destroy=function(){this.hide();this.root.remove();this.root.trigger(ModalEvents.destroyed,this);this.attachmentPoint.remove()};Modal.prototype.accessibilityShow=function(){Aria.unhide(this.root.get());Aria.hideSiblings(this.root.get()[0])};Modal.prototype.accessibilityHide=function(){Aria.unhideSiblings(this.root.get()[0]);Aria.hide(this.root.get())};Modal.prototype.registerEventListeners=function(){this.getRoot().on("keydown",function(e){if(!this.isVisible()){return}if(e.keyCode==KeyCodes.escape){if(this.removeOnClose){this.destroy()}else{this.hide()}}}.bind(this));this.getRoot().click(function(e){if(!$(e.target).closest(SELECTORS.MODAL).length){if($(e.target).closest(SELECTORS.CONTAINER).length){var outsideClickEvent=$.Event(ModalEvents.outsideClick);this.getRoot().trigger(outsideClickEvent,this);if(!outsideClickEvent.isDefaultPrevented()){this.hideIfNotForm()}}}}.bind(this));CustomEvents.define(this.getModal(),[CustomEvents.events.activate]);this.getModal().on(CustomEvents.events.activate,SELECTORS.HIDE,function(e,data){this.hide();data.originalEvent.preventDefault()}.bind(this))};Modal.prototype.registerCloseOnCancel=function(){this.getModal().on(CustomEvents.events.activate,this.getActionSelector("cancel"),function(e,data){var cancelEvent=$.Event(ModalEvents.cancel);this.getRoot().trigger(cancelEvent,this);if(!cancelEvent.isDefaultPrevented()){data.originalEvent.preventDefault();if(this.removeOnClose){this.destroy()}else{this.hide()}}}.bind(this))};Modal.prototype.registerCloseOnSave=function(){this.getModal().on(CustomEvents.events.activate,this.getActionSelector("save"),function(e,data){var saveEvent=$.Event(ModalEvents.save);this.getRoot().trigger(saveEvent,this);if(!saveEvent.isDefaultPrevented()){data.originalEvent.preventDefault();if(this.removeOnClose){this.destroy()}else{this.hide()}}}.bind(this))};Modal.prototype.asyncSet=function(value,setFunction){var p=value;if("object"!==_typeof(value)||!value.hasOwnProperty("then")){p=$.Deferred();p.resolve(value)}p.then(function(content){setFunction(content)}).fail(Notification.exception);return p};Modal.prototype.setButtonText=function(action,value){var button=this.getFooter().find(this.getActionSelector(action));if(!button){throw new Error("Unable to find the '"+action+"' button")}return this.asyncSet(value,button.text.bind(button))};Modal.prototype.getActionSelector=function(action){return"[data-action='"+action+"']"};Modal.prototype.setRemoveOnClose=function(remove){this.removeOnClose=remove};return Modal});
//# sourceMappingURL=modal.min.js.map
