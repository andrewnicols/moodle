define ("core/local/reactive/statemanager",["exports"],function(_exports){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.default=void 0;function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function _get(){if("undefined"!=typeof Reflect&&Reflect.get){_get=Reflect.get}else{_get=function(target,property,receiver){var base=_superPropBase(target,property);if(!base)return;var desc=Object.getOwnPropertyDescriptor(base,property);if(desc.get){return desc.get.call(3>arguments.length?target:receiver)}return desc.value}}return _get.apply(this,arguments)}function _superPropBase(object,property){while(!Object.prototype.hasOwnProperty.call(object,property)){object=_getPrototypeOf(object);if(null===object)break}return object}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}});Object.defineProperty(subClass,"prototype",{writable:!1});if(superClass)_setPrototypeOf(subClass,superClass)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call)){return call}else if(void 0!==call){throw new TypeError("Derived constructors may only return object or undefined")}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(void 0===self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _wrapNativeSuper(Class){var _cache="function"==typeof Map?new Map:void 0;_wrapNativeSuper=function(Class){if(null===Class||!_isNativeFunction(Class))return Class;if("function"!=typeof Class){throw new TypeError("Super expression must either be null or a function")}if("undefined"!=typeof _cache){if(_cache.has(Class))return _cache.get(Class);_cache.set(Class,Wrapper)}function Wrapper(){return _construct(Class,arguments,_getPrototypeOf(this).constructor)}Wrapper.prototype=Object.create(Class.prototype,{constructor:{value:Wrapper,enumerable:!1,writable:!0,configurable:!0}});return _setPrototypeOf(Wrapper,Class)};return _wrapNativeSuper(Class)}function _construct(){if(_isNativeReflectConstruct()){_construct=Reflect.construct}else{_construct=function(Parent,args,Class){var a=[null];a.push.apply(a,args);var Constructor=Function.bind.apply(Parent,a),instance=new Constructor;if(Class)_setPrototypeOf(instance,Class.prototype);return instance}}return _construct.apply(null,arguments)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return!0}catch(e){return!1}}function _isNativeFunction(fn){return-1!==Function.toString.call(fn).indexOf("[native code]")}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if("Object"===n&&o.constructor)n=o.constructor.name;if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(null==len||len>arr.length)len=arr.length;for(var i=0,arr2=Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _arr=[],_n=!0,_d=!1,_s,_e;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done);_n=!0){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=!0;_e=err}finally{try{if(!_n&&null!=_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0,descriptor;i<props.length;i++){descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1;descriptor.configurable=!0;if("value"in descriptor)descriptor.writable=!0;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:!1});return Constructor}var StateManager=function(){function StateManager(dispatchEvent,target){var _this=this;_classCallCheck(this,StateManager);this.dispatchEvent=dispatchEvent;this.target=null!==target&&void 0!==target?target:document;this.readonly=!1;this.eventsToPublish=[];this.updateTypes={create:this.defaultCreate.bind(this),update:this.defaultUpdate.bind(this),delete:this.defaultDelete.bind(this),put:this.defaultPut.bind(this),override:this.defaultOverride.bind(this),remove:this.defaultRemove.bind(this),prepareFields:this.defaultPrepareFields.bind(this)};this.initialPromise=new Promise(function(resolve){_this.target.addEventListener("state:loaded",function initialStateDone(event){resolve(event.detail.state)})})}_createClass(StateManager,[{key:"setInitialState",value:function setInitialState(initialState){if(this.state!==void 0){throw Error("Initial state can only be initialized ones")}for(var state=new Proxy({},new Handler("state",this,!0)),_i=0,_Object$entries=Object.entries(initialState);_i<_Object$entries.length;_i++){var _Object$entries$_i=_slicedToArray(_Object$entries[_i],2),prop=_Object$entries$_i[0],propValue=_Object$entries$_i[1];state[prop]=propValue}this.state=state;this.readonly=!0;this.dispatchEvent({action:"state:loaded",state:this.state},this.target)}},{key:"getInitialPromise",value:function getInitialPromise(){return this.initialPromise}},{key:"setReadOnly",value:function setReadOnly(readonly){this.readonly=readonly;var mode="off";if(this.readonly){mode="on";this._publishEvents()}this.dispatchEvent({action:"readmode:".concat(mode),state:this.state,element:null},this.target)}},{key:"addUpdateTypes",value:function addUpdateTypes(newFunctions){for(var _i2=0,_Object$entries2=Object.entries(newFunctions);_i2<_Object$entries2.length;_i2++){var _Object$entries2$_i=_slicedToArray(_Object$entries2[_i2],2),updateType=_Object$entries2$_i[0],updateFunction=_Object$entries2$_i[1];if("function"==typeof updateFunction){this.updateTypes[updateType]=updateFunction.bind(newFunctions)}}}},{key:"processUpdates",value:function processUpdates(updates,updateTypes){var _this2=this;if(!Array.isArray(updates)){throw Error("State updates must be an array")}this.setReadOnly(!1);updates.forEach(function(update){if(update.name===void 0){throw Error("Missing state update name")}_this2.processUpdate(update.name,update.action,update.fields,updateTypes)});this.setReadOnly(!0)}},{key:"processUpdate",value:function processUpdate(updateName,action,fields,updateTypes){var _action,_updateTypes$action,_updateTypes$prepareF;if(!fields){throw Error("Missing state update fields")}if(updateTypes===void 0){updateTypes={}}action=null!==(_action=action)&&void 0!==_action?_action:"update";var method=null!==(_updateTypes$action=updateTypes[action])&&void 0!==_updateTypes$action?_updateTypes$action:this.updateTypes[action];if(method===void 0){throw Error("Unkown update action ".concat(action))}var prepareFields=null!==(_updateTypes$prepareF=updateTypes.prepareFields)&&void 0!==_updateTypes$prepareF?_updateTypes$prepareF:this.updateTypes.prepareFields;method(this,updateName,prepareFields(this,updateName,fields))}},{key:"defaultPrepareFields",value:function defaultPrepareFields(stateManager,updateName,fields){return fields}},{key:"defaultCreate",value:function defaultCreate(stateManager,updateName,fields){var state=stateManager.state;if(state[updateName]instanceof StateMap){state[updateName].add(fields);return}state[updateName]=fields}},{key:"defaultDelete",value:function defaultDelete(stateManager,updateName,fields){var current=stateManager.get(updateName,fields.id);if(!current){throw Error("Inexistent ".concat(updateName," ").concat(fields.id))}var state=stateManager.state;if(state[updateName]instanceof StateMap){state[updateName].delete(fields.id);return}delete state[updateName]}},{key:"defaultRemove",value:function defaultRemove(stateManager,updateName,fields){var current=stateManager.get(updateName,fields.id);if(!current){return}var state=stateManager.state;if(state[updateName]instanceof StateMap){state[updateName].delete(fields.id);return}delete state[updateName]}},{key:"defaultUpdate",value:function defaultUpdate(stateManager,updateName,fields){var current=stateManager.get(updateName,fields.id);if(!current){throw Error("Inexistent ".concat(updateName," ").concat(fields.id))}for(var _i3=0,_Object$entries3=Object.entries(fields);_i3<_Object$entries3.length;_i3++){var _Object$entries3$_i=_slicedToArray(_Object$entries3[_i3],2),fieldName=_Object$entries3$_i[0],fieldValue=_Object$entries3$_i[1];current[fieldName]=fieldValue}}},{key:"defaultPut",value:function defaultPut(stateManager,updateName,fields){var current=stateManager.get(updateName,fields.id);if(current){for(var _i4=0,_Object$entries4=Object.entries(fields);_i4<_Object$entries4.length;_i4++){var _Object$entries4$_i=_slicedToArray(_Object$entries4[_i4],2),fieldName=_Object$entries4$_i[0],fieldValue=_Object$entries4$_i[1];current[fieldName]=fieldValue}}else{var state=stateManager.state;if(state[updateName]instanceof StateMap){state[updateName].add(fields);return}state[updateName]=fields}}},{key:"defaultOverride",value:function defaultOverride(stateManager,updateName,fields){var current=stateManager.get(updateName,fields.id);if(current){for(var _i5=0,_Object$entries5=Object.entries(current);_i5<_Object$entries5.length;_i5++){var _Object$entries5$_i=_slicedToArray(_Object$entries5[_i5],1),fieldName=_Object$entries5$_i[0];if(fields[fieldName]===void 0){delete current[fieldName]}}for(var _i6=0,_Object$entries6=Object.entries(fields);_i6<_Object$entries6.length;_i6++){var _Object$entries6$_i=_slicedToArray(_Object$entries6[_i6],2),_fieldName=_Object$entries6$_i[0],fieldValue=_Object$entries6$_i[1];current[_fieldName]=fieldValue}}else{var state=stateManager.state;if(state[updateName]instanceof StateMap){state[updateName].add(fields);return}state[updateName]=fields}}},{key:"get",value:function get(name,id){var state=this.state,current=state[name];if(current instanceof StateMap){if(id===void 0){throw Error("Missing id for ".concat(name," state update"))}current=state[name].get(id)}return current}},{key:"registerStateAction",value:function registerStateAction(field,prop,action,data){var parentAction="updated";if(null!==prop){this.eventsToPublish.push({eventName:"".concat(field,".").concat(prop,":").concat(action),eventData:data,action:action})}else{parentAction=action}if(data.id!==void 0){if(null!==prop){this.eventsToPublish.push({eventName:"".concat(field,"[").concat(data.id,"].").concat(prop,":").concat(action),eventData:data,action:action})}this.eventsToPublish.push({eventName:"".concat(field,"[").concat(data.id,"]:").concat(parentAction),eventData:data,action:parentAction})}this.eventsToPublish.push({eventName:"".concat(field,":").concat(parentAction),eventData:data,action:parentAction});this.eventsToPublish.push({eventName:"state:updated",eventData:data,action:"updated"})}},{key:"_publishEvents",value:function _publishEvents(){var _this3=this,fieldChanges=this.eventsToPublish;this.eventsToPublish=[];this.dispatchEvent({action:"transaction:start",state:this.state,element:null,changes:fieldChanges},this.target);fieldChanges.sort(function(a,b){var _weights$a$action,_weights$b$action,weights={created:0,updated:1,deleted:2},aweight=null!==(_weights$a$action=weights[a.action])&&void 0!==_weights$a$action?_weights$a$action:0,bweight=null!==(_weights$b$action=weights[b.action])&&void 0!==_weights$b$action?_weights$b$action:0;if(aweight===bweight){return a.eventName.length-b.eventName.length}return aweight-bweight});var publishedEvents=new Set;fieldChanges.forEach(function(event){var _event$eventData$id,eventkey="".concat(event.eventName,".").concat(null!==(_event$eventData$id=event.eventData.id)&&void 0!==_event$eventData$id?_event$eventData$id:0);if(!publishedEvents.has(eventkey)){_this3.dispatchEvent({action:event.eventName,state:_this3.state,element:event.eventData},_this3.target);publishedEvents.add(eventkey)}});this.dispatchEvent({action:"transaction:end",state:this.state,element:null},this.target)}}]);return StateManager}();_exports.default=StateManager;var Handler=function(){function Handler(name,stateManager,proxyValues){_classCallCheck(this,Handler);this.name=name;this.stateManager=stateManager;this.proxyValues=null!==proxyValues&&void 0!==proxyValues?proxyValues:!1}_createClass(Handler,[{key:"set",value:function set(obj,prop,value,receiver){if(this.stateManager.readonly){throw new Error("State locked. Use mutations to change ".concat(prop," value in ").concat(this.name,"."))}if(JSON.stringify(obj[prop])===JSON.stringify(value)){return!0}var action=obj[prop]!==void 0?"updated":"created";if(this.proxyValues){if(Array.isArray(value)){obj[prop]=new StateMap(prop,this.stateManager).loadValues(value)}else{obj[prop]=new Proxy(value,new Handler(prop,this.stateManager))}}else{obj[prop]=value}if(this.stateManager.state===void 0){return!0}this.stateManager.registerStateAction(this.name,prop,action,receiver);return!0}},{key:"deleteProperty",value:function deleteProperty(obj,prop){if(this.stateManager.readonly){throw new Error("State locked. Use mutations to delete ".concat(prop," in ").concat(this.name,"."))}if(prop in obj){delete obj[prop];this.stateManager.registerStateAction(this.name,prop,"deleted",obj)}return!0}}]);return Handler}(),StateMap=function(_Map){_inherits(StateMap,_Map);var _super=_createSuper(StateMap);function StateMap(name,stateManager,iterable){var _this4;_classCallCheck(this,StateMap);_this4=_super.call(this,iterable);_this4.name=name;_this4.stateManager=stateManager;return _this4}_createClass(StateMap,[{key:"set",value:function set(key,value){if(this.stateManager.readonly){throw new Error("State locked. Use mutations to change ".concat(key," value in ").concat(this.name,"."))}key=this.normalizeKey(key);this.checkValue(value);if(key===void 0||null===key){throw Error("State lists keys cannot be null or undefined")}if(this.normalizeKey(value.id)!==key){throw new Error("State error: ".concat(this.name," list element ID (").concat(value.id,") and key (").concat(key,") mismatch"))}var action=_get(_getPrototypeOf(StateMap.prototype),"has",this).call(this,key)?"updated":"created",result=_get(_getPrototypeOf(StateMap.prototype),"set",this).call(this,key,new Proxy(value,new Handler(this.name,this.stateManager)));if(this.stateManager.state===void 0){return result}this.stateManager.registerStateAction(this.name,null,action,_get(_getPrototypeOf(StateMap.prototype),"get",this).call(this,key));return result}},{key:"checkValue",value:function checkValue(value){if("object"===!_typeof(value)&&null!==value){throw Error("State lists can contain objects only")}if(value.id===void 0){throw Error("State lists elements must contain at least an id attribute")}}},{key:"normalizeKey",value:function normalizeKey(key){return(key+"").valueOf()}},{key:"add",value:function add(value){this.checkValue(value);return this.set(value.id,value)}},{key:"get",value:function get(key){return _get(_getPrototypeOf(StateMap.prototype),"get",this).call(this,this.normalizeKey(key))}},{key:"has",value:function has(key){return _get(_getPrototypeOf(StateMap.prototype),"has",this).call(this,this.normalizeKey(key))}},{key:"delete",value:function _delete(key){key=this.normalizeKey(key);if(this.stateManager.readonly){throw new Error("State locked. Use mutations to change ".concat(key," value in ").concat(this.name,"."))}var previous=_get(_getPrototypeOf(StateMap.prototype),"get",this).call(this,key),result=_get(_getPrototypeOf(StateMap.prototype),"delete",this).call(this,key);if(!result){return result}this.stateManager.registerStateAction(this.name,null,"deleted",previous);return result}},{key:"toJSON",value:function toJSON(){var result=[];this.forEach(function(value){result.push(value)});return result}},{key:"loadValues",value:function loadValues(values){var _this5=this;values.forEach(function(data){_this5.checkValue(data);var key=data.id,newvalue=new Proxy(data,new Handler(_this5.name,_this5.stateManager));_this5.set(key,newvalue)});return this}}]);return StateMap}(_wrapNativeSuper(Map));return _exports.default});
//# sourceMappingURL=statemanager.min.js.map
