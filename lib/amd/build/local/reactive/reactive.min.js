define ("core/local/reactive/reactive",["exports","core/log","core/local/reactive/statemanager","core/pending"],function(_exports,_log,_statemanager,_pending){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.default=void 0;_log=_interopRequireDefault(_log);_statemanager=_interopRequireDefault(_statemanager);_pending=_interopRequireDefault(_pending);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)})}}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if("Object"===n&&o.constructor)n=o.constructor.name;if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(null==len||len>arr.length)len=arr.length;for(var i=0,arr2=Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _arr=[],_n=!0,_d=!1,_s,_e;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done);_n=!0){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=!0;_e=err}finally{try{if(!_n&&null!=_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0,descriptor;i<props.length;i++){descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1;descriptor.configurable=!0;if("value"in descriptor)descriptor.writable=!0;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:!1});return Constructor}var pendingCount=0,_default=function(){function _default(description){var _description$target,_description$mutation;_classCallCheck(this,_default);if(description.eventName===void 0||description.eventDispatch===void 0){throw new Error("Reactivity event required")}if(description.name!==void 0){this.name=description.name}this.target=null!==(_description$target=description.target)&&void 0!==_description$target?_description$target:document.createTextNode(null);this.eventName=description.eventName;this.eventDispatch=description.eventDispatch;this.stateManager=new _statemanager.default(this.eventDispatch,this.target);this.watchers=new Map([]);this.components=new Set([]);this.mutations=null!==(_description$mutation=description.mutations)&&void 0!==_description$mutation?_description$mutation:{};this.target.addEventListener(this.eventName,this.callWatchersHandler.bind(this));this.pendingState=new _pending.default("core/reactive:registerInstance".concat(pendingCount++));if(description.state!==void 0){this.setInitialState(description.state)}if(M.reactive!==void 0){M.reactive.registerNewInstance(this)}}_createClass(_default,[{key:"callWatchersHandler",value:function callWatchersHandler(event){this.target.dispatchEvent(new CustomEvent(event.detail.action,{bubbles:!1,detail:event.detail}))}},{key:"setInitialState",value:function setInitialState(stateData){this.pendingState.resolve();this.stateManager.setInitialState(stateData)}},{key:"addMutations",value:function addMutations(newFunctions){if(newFunctions.init!==void 0){newFunctions.init(this.stateManager)}for(var _i=0,_Object$entries=Object.entries(newFunctions);_i<_Object$entries.length;_i++){var _Object$entries$_i=_slicedToArray(_Object$entries[_i],2),mutation=_Object$entries$_i[0],mutationFunction=_Object$entries$_i[1];this.mutations[mutation]=mutationFunction.bind(newFunctions)}}},{key:"setMutations",value:function setMutations(manager){this.mutations=manager;if(manager.init!==void 0){manager.init(this.stateManager)}}},{key:"state",get:function get(){return this.stateManager.state}},{key:"get",value:function get(name,id){return this.stateManager.get(name,id)}},{key:"getInitialStatePromise",value:function getInitialStatePromise(){return this.stateManager.getInitialPromise()}},{key:"registerComponent",value:function registerComponent(component){var _component$name,_this=this,componentName=null!==(_component$name=component.name)&&void 0!==_component$name?_component$name:"Unkown component",dispatchSuccess=function(){},dispatchFail=dispatchSuccess;if(component.dispatchRegistrationSuccess!==void 0){dispatchSuccess=component.dispatchRegistrationSuccess.bind(component)}if(component.dispatchRegistrationFail!==void 0){dispatchFail=component.dispatchRegistrationFail.bind(component)}if(this.components.has(component)){dispatchSuccess();return component}var pendingPromise=new _pending.default("core/reactive:registerComponent".concat(pendingCount++)),listeners=[],handlers=[];if(component.getWatchers!==void 0){handlers=component.getWatchers()}handlers.forEach(function(_ref){var watch=_ref.watch,handler=_ref.handler;if(watch===void 0){dispatchFail();throw new Error("Missing watch attribute in ".concat(componentName," watcher"))}if(handler===void 0){dispatchFail();throw new Error("Missing handler for watcher ".concat(watch," in ").concat(componentName))}var listener=function(event){var currentFocus=document.activeElement;handler.apply(component,[event.detail]);if(document.activeElement===document.body&&document.body.contains(currentFocus)){currentFocus.focus()}};listeners.push({target:_this.target,watch:watch,listener:listener});_this.target.addEventListener(watch,listener)});if(component.stateReady!==void 0){this.getInitialStatePromise().then(function(state){component.stateReady(state);pendingPromise.resolve();return!0}).catch(function(reason){pendingPromise.resolve();_log.default.error("Initial state in ".concat(componentName," rejected due to: ").concat(reason));_log.default.error(reason)})}this.watchers.set(component,listeners);this.components.add(component);this.target.dispatchEvent(new CustomEvent("registerComponent:success",{bubbles:!1,detail:{component:component}}));dispatchSuccess();return component}},{key:"unregisterComponent",value:function unregisterComponent(component){if(!this.components.has(component)){return component}this.components.delete(component);var listeners=this.watchers.get(component);if(listeners===void 0){return component}listeners.forEach(function(_ref2){var target=_ref2.target,watch=_ref2.watch,listener=_ref2.listener;target.removeEventListener(watch,listener)});this.watchers.delete(component);return component}},{key:"dispatch",value:function(){var _dispatch=_asyncToGenerator(regeneratorRuntime.mark(function _callee(actionName){var pendingPromise,mutationFunction,_len,params,_key,_args=arguments;return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:if(!("string"!=typeof actionName)){_context.next=2;break}throw new Error("Dispatch action name must be a string");case 2:if(!("_"===actionName.charAt(0))){_context.next=4;break}throw new Error("Illegal Private ".concat(actionName," mutation method dispatch"));case 4:if(!(this.mutations[actionName]===void 0)){_context.next=6;break}throw new Error("Unkown ".concat(actionName," mutation"));case 6:pendingPromise=new _pending.default("core/reactive:".concat(actionName).concat(pendingCount++));mutationFunction=this.mutations[actionName];_context.prev=8;for(_len=_args.length,params=Array(1<_len?_len-1:0),_key=1;_key<_len;_key++){params[_key-1]=_args[_key]}_context.next=12;return mutationFunction.apply(this.mutations,[this.stateManager].concat(params));case 12:pendingPromise.resolve();_context.next=20;break;case 15:_context.prev=15;_context.t0=_context["catch"](8);this.stateManager.setReadOnly(!0);pendingPromise.resolve();throw _context.t0;case 20:case"end":return _context.stop();}}},_callee,this,[[8,15]])}));return function dispatch(){return _dispatch.apply(this,arguments)}}()}]);return _default}();_exports.default=_default;return _exports.default});
//# sourceMappingURL=reactive.min.js.map
