define ("core/local/reactive/debugpanel",["exports","core/reactive","core/log","core/utils"],function(_exports,_reactive,_log,_utils){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.initsubpanel=_exports.init=void 0;_log=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(_log);_exports.init=(target,selectors)=>{const element=document.getElementById(target);if(_reactive.debug===void 0){element.remove();return}new GlobalDebugPanel({element,reactive:_reactive.debug,selectors})};_exports.initsubpanel=(target,selectors)=>{const element=document.getElementById(target);if(_reactive.debug===void 0){element.remove();return}new DebugInstanceSubpanel({element,reactive:_reactive.debug,selectors})};class GlobalDebugPanel extends _reactive.BaseComponent{create(){this.name="GlobalDebugPanel";this.selectors={LOADERS:"[data-for='loaders']",SUBPANEL:"[data-for='subpanel']",LOG:"[data-for='log']"}}stateReady(state){if(0<state.reactives.size){this.getElement(this.selectors.LOADERS).innerHTML=""}state.reactives.forEach(instance=>{this._createLoader(instance)});this.getElement(this.selectors.SUBPANEL).innerHTML=""}_createLoader(instance){const loaders=this.getElement(this.selectors.LOADERS),btn=document.createElement("button");btn.innerHTML=instance.id;btn.dataset.id=instance.id;loaders.appendChild(btn);this.addEventListener(btn,"click",()=>this._openPanel(btn,instance))}async _openPanel(btn,instance){try{const target=this.getElement(this.selectors.SUBPANEL),data={...instance};await this.renderComponent(target,"core/local/reactive/debuginstancepanel",data)}catch(error){_log.default.error("Cannot load reactive debug subpanel");throw error}}}class DebugInstanceSubpanel extends _reactive.BaseComponent{create(){this.name="DebugInstanceSubpanel";this.selectors={NAME:"[data-for='name']",CLOSE:"[data-for='close']",READMODE:"[data-for='readmode']",HIGHLIGHT:"[data-for='highlight']",LOG:"[data-for='log']",STATE:"[data-for='state']",CLEAN:"[data-for='clean']",PIN:"[data-for='pin']",SAVE:"[data-for='save']",INVALID:"[data-for='invalid']"};this.id=this.element.dataset.id;this.controller=M.reactive[this.id];this.draggable=!1;this.relativeDrag=!0;this.strings={savewarning:""}}stateReady(){var _this$getElement$inne,_this$getElement;this.dragdrop=new _reactive.DragDrop(this);this.addEventListener(this.getElement(this.selectors.CLOSE),"click",this.remove);if(this.controller.highlight){this._toggleButtonText(this.getElement(this.selectors.HIGHLIGHT))}this.addEventListener(this.getElement(this.selectors.HIGHLIGHT),"click",()=>{this.controller.highlight=!this.controller.highlight;this._toggleButtonText(this.getElement(this.selectors.HIGHLIGHT))});this.addEventListener(this.getElement(this.selectors.READMODE),"click",this._toggleEditMode);this.addEventListener(this.getElement(this.selectors.CLEAN),"click",this._cleanAreas);this.addEventListener(this.getElement(this.selectors.PIN),"click",this._togglePin);this.getElement(this.selectors.SAVE).disabled=!0;this.addEventListener(this.getElement(this.selectors.STATE),"keyup",(0,_utils.debounce)(this._checkJSON,500));this.addEventListener(this.getElement(this.selectors.SAVE),"click",this._saveState);this.strings.savewarning=null!==(_this$getElement$inne=null===(_this$getElement=this.getElement(this.selectors.INVALID))||void 0===_this$getElement?void 0:_this$getElement.innerHTML)&&void 0!==_this$getElement$inne?_this$getElement$inne:"";this._refreshState()}destroy(){if(this.dragdrop!==void 0){this.dragdrop.unregister()}}getWatchers(){return[{watch:"reactives[".concat(this.id,"].lastChanges:updated"),handler:this._refreshLog},{watch:"reactives[".concat(this.id,"].modified:updated"),handler:this._refreshState},{watch:"reactives[".concat(this.id,"].readOnly:updated"),handler:this._refreshReadOnly}]}_refreshLog(_ref){var _element$lastChanges;let{element}=_ref;const list=null!==(_element$lastChanges=null===element||void 0===element?void 0:element.lastChanges)&&void 0!==_element$lastChanges?_element$lastChanges:[],logContent=list.join("\n"),target=this.getElement(this.selectors.LOG);target.value+="\n\n= Transaction =\n ".concat(logContent);target.scrollTop=target.scrollHeight}_cleanAreas(){let target=this.getElement(this.selectors.LOG);target.value="";this._refreshState()}_refreshState(){const target=this.getElement(this.selectors.STATE);target.value=JSON.stringify(this.controller.state,null,4)}_refreshReadOnly(){const target=this.getElement(this.selectors.READMODE);if(target.dataset.readonly===void 0){target.dataset.readonly=target.innerHTML}if(this.controller.readOnly){target.innerHTML=target.dataset.readonly}else{target.innerHTML=target.dataset.alt}}_toggleEditMode(){this.controller.readOnly=!this.controller.readOnly}_checkJSON(){const invalid=this.getElement(this.selectors.INVALID),save=this.getElement(this.selectors.SAVE),edited=this.getElement(this.selectors.STATE).value,currentStateData=this.controller.stateData;if(edited==JSON.stringify(this.controller.state,null,4)){invalid.style.color="";invalid.innerHTML="";save.disabled=!0;return}try{const newState=JSON.parse(edited),result=this._generateStateUpdates(currentStateData,newState);invalid.style.color="";invalid.innerHTML=this.strings.savewarning;save.disabled=!1;return result}catch(error){var _error$message;invalid.style.color="red";invalid.innerHTML=null!==(_error$message=error.message)&&void 0!==_error$message?_error$message:"Invalid JSON sctructure";save.disabled=!0}}_saveState(){const updates=this._checkJSON();if(!updates){return}this.controller.processUpdates(updates)}_generateStateUpdates(currentStateData,newStateData){const updates=[],ids={};for(const[key,newValue]of Object.entries(newStateData)){if(Array.isArray(newValue)){ids[key]={};newValue.forEach(element=>{if(element.id===void 0){throw Error("Array ".concat(key," element without id attribute"))}updates.push({name:key,action:"override",fields:element});const index=(element.id+"").valueOf();ids[key][index]=!0})}else{updates.push({name:key,action:"override",fields:newValue})}}for(const[key,oldValue]of Object.entries(currentStateData)){let deleteField=!1;if(newStateData[key]===void 0){deleteField=!0}if(Array.isArray(oldValue)){if(!deleteField&&ids[key]===void 0){throw Error("Array ".concat(key," cannot change to object."))}oldValue.forEach(element=>{const index=(element.id+"").valueOf();let deleteEntry=deleteField;if(!deleteEntry&&ids[key][index]===void 0){deleteEntry=!0}if(deleteEntry){updates.push({name:key,action:"delete",fields:element})}})}else{if(!deleteField&&ids[key]!==void 0){throw Error("Object ".concat(key," cannot change to array."))}if(deleteField){updates.push({name:key,action:"delete",fields:oldValue})}}}return updates}getDraggableData(){return this.draggable}dragEnd(dropdata,event){this.element.style.top="".concat(event.newFixedTop,"px");this.element.style.left="".concat(event.newFixedLeft,"px")}_togglePin(){this.draggable=!this.draggable;this.dragdrop.setDraggable(this.draggable);if(this.draggable){this._unpin()}else{this._pin()}}_unpin(){const pageCenterY=window.innerHeight/2,pageCenterX=window.innerWidth/2,style={position:"fixed",resize:"both",overflow:"auto",height:"400px",width:"400px",top:"".concat(pageCenterY-200,"px"),left:"".concat(pageCenterX-200,"px")};Object.assign(this.element.style,style);this.getElement(this.selectors.STATE).style.height="50px";this.getElement(this.selectors.LOG).style.height="50px";this._toggleButtonText(this.getElement(this.selectors.PIN))}_pin(){["position","resize","overflow","top","left","height","width"].forEach(prop=>this.element.style.removeProperty(prop));this._toggleButtonText(this.getElement(this.selectors.PIN))}_toggleButtonText(element){[element.innerHTML,element.dataset.alt]=[element.dataset.alt,element.innerHTML]}}});
//# sourceMappingURL=debugpanel.min.js.map
