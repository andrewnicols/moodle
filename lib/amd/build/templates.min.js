define ("core/templates",["core/mustache","jquery","core/ajax","core/str","core/notification","core/url","core/config","core/localstorage","core/icon_system","core_filters/events","core/yui","core/log","core/truncate","core/user_date","core/pending"],function(mustache,$,ajax,str,notification,coreurl,config,storage,IconSystem,filterEvents,Y,Log,Truncate,UserDate,Pending){var uniqInstances=0,templateCache={},templatePromises={},cachePartialPromises={},iconSystem={},loadTemplateBuffer=[],isLoadingTemplates=!1,disallowedNestedHelpers=["js"],getNormalisedComponent=function(component){if(component){if("moodle"!==component&&"core"!==component){return component}}return"core"},getTemplatePromiseFromCache=function(searchKey){if(searchKey in templatePromises){return templatePromises[searchKey]}if(searchKey in templateCache){templatePromises[searchKey]=$.Deferred().resolve(templateCache[searchKey]).promise();return templatePromises[searchKey]}if(0>=M.cfg.templaterev){return null}var cached=storage.get("core_template/"+M.cfg.templaterev+":"+searchKey);if(cached){templateCache[searchKey]=cached;templatePromises[searchKey]=$.Deferred().resolve(cached).promise();return templatePromises[searchKey]}return null},processLoadTemplateBuffer=function(){if(!loadTemplateBuffer.length){return}if(isLoadingTemplates){return}isLoadingTemplates=!0;var templatesToLoad=loadTemplateBuffer.slice(),serverRequestsDeferred=$.Deferred(),requests=[],templatePromises=templatesToLoad.map(function(templateData){var component=getNormalisedComponent(templateData.component),name=templateData.name,searchKey=templateData.searchKey,theme=templateData.theme,templateDeferred=templateData.deferred,promise=null,cachedPromise=getTemplatePromiseFromCache(searchKey);if(cachedPromise){promise=cachedPromise}else{requests.push({methodname:"core_output_load_template_with_dependencies",args:{component:component,template:name,themename:theme,lang:$("html").attr("lang").replace(/-/g,"_")}});var index=requests.length-1;promise=serverRequestsDeferred.promise().then(function(promises){templatePromises[searchKey]=promises[index].then(function(response){var templateSource=null;response.templates.forEach(function(data){data.component=getNormalisedComponent(data.component);var tempSearchKey=[theme,data.component,data.name].join("/");templateCache[tempSearchKey]=data.value;if(0<M.cfg.templaterev){storage.set("core_template/"+M.cfg.templaterev+":"+tempSearchKey,data.value)}if(data.component==component&&data.name==name){templateSource=data.value}});if(response.strings.length){str.cache_strings(response.strings.map(function(data){return{component:getNormalisedComponent(data.component),key:data.name,value:data.value}}))}return templateSource});return templatePromises[searchKey]})}return promise.then(function(source){return templateDeferred.resolve(source)}).catch(function(error){templateDeferred.reject(error);throw error})});if(requests.length){serverRequestsDeferred.resolve(ajax.call(requests,!0,!1,!1,0,M.cfg.templaterev))}else{serverRequestsDeferred.resolve()}$.when.apply(null,templatePromises).then(function(){loadTemplateBuffer.splice(0,templatesToLoad.length);isLoadingTemplates=!1;processLoadTemplateBuffer()}).catch(function(){loadTemplateBuffer.splice(0,templatesToLoad.length);isLoadingTemplates=!1;processLoadTemplateBuffer()})},Renderer=function(){this.requiredStrings=[];this.requiredJS=[];this.requiredDates=[];this.currentThemeName=""};Renderer.prototype.requiredStrings=null;Renderer.prototype.requiredDates=[];Renderer.prototype.requiredJS=null;Renderer.prototype.currentThemeName="";Renderer.prototype.getTemplate=function(templateName){var currentTheme=this.currentThemeName,searchKey=currentTheme+"/"+templateName,cachedPromise=getTemplatePromiseFromCache(searchKey);if(cachedPromise){return cachedPromise}var existingBufferRecords=loadTemplateBuffer.filter(function(record){return record.searchKey==searchKey});if(existingBufferRecords.length){return existingBufferRecords[0].deferred.promise()}var parts=templateName.split("/"),component=getNormalisedComponent(parts.shift()),name=parts.join("/"),deferred=$.Deferred();loadTemplateBuffer.push({component:component,name:name,theme:currentTheme,searchKey:searchKey,deferred:deferred});processLoadTemplateBuffer();return deferred.promise()};Renderer.prototype.prefetchTemplates=function(templateNames,currentTheme){templateNames.forEach(function(templateName){var searchKey=currentTheme+"/"+templateName;if(getTemplatePromiseFromCache(searchKey)){return}var existingBufferRecords=loadTemplateBuffer.filter(function(record){return record.searchKey==searchKey});if(existingBufferRecords.length){return}var parts=templateName.split("/"),component=getNormalisedComponent(parts.shift()),name=parts.join("/");loadTemplateBuffer.push({component:component,name:name,theme:currentTheme,searchKey:searchKey,deferred:$.Deferred()})});processLoadTemplateBuffer()};Renderer.prototype.partialHelper=function(name){var searchKey=this.currentThemeName+"/"+name;if(!(searchKey in templateCache)){notification.exception(new Error("Failed to pre-fetch the template: "+name))}return templateCache[searchKey]};Renderer.prototype.renderIcon=function(key,component,title){var modulename=config.iconsystemmodule;component=getNormalisedComponent(component);var ready=$.Deferred();require([modulename],function(System){var system=new System;if(!(system instanceof IconSystem)){ready.reject("Invalid icon system specified"+config.iconsystemmodule)}else{iconSystem=system;system.init().then(ready.resolve).catch(notification.exception)}});return ready.then(function(iconSystem){return this.getTemplate(iconSystem.getTemplateName())}.bind(this)).then(function(template){return iconSystem.renderIcon(key,component,title,template)})};Renderer.prototype.pixHelper=function(context,sectionText,helper){var parts=sectionText.split(","),key="",component="",text="";if(0<parts.length){key=helper(parts.shift().trim(),context)}if(0<parts.length){component=helper(parts.shift().trim(),context)}if(0<parts.length){text=helper(parts.join(",").trim(),context)}var templateName=iconSystem.getTemplateName(),searchKey=this.currentThemeName+"/"+templateName,template=templateCache[searchKey];component=getNormalisedComponent(component);key=key.replace(/&#x2F;/gi,"/");return iconSystem.renderIcon(key,component,text,template)};Renderer.prototype.jsHelper=function(context,sectionText,helper){this.requiredJS.push(helper(sectionText,context));return""};Renderer.prototype.stringHelper=function(context,sectionText,helper){var parts=sectionText.split(","),key="",component="",param="";if(0<parts.length){key=parts.shift().trim()}if(0<parts.length){component=parts.shift().trim()}if(0<parts.length){param=parts.join(",").trim()}component=getNormalisedComponent(component);if(""!==param){param=helper(param,context)}if(0===param.indexOf("{")&&0!==param.indexOf("{{")){param=JSON.parse(param)}var index=this.requiredStrings.length;this.requiredStrings.push({key:key,component:component,param:param});return"[[_s"+index+"]]"};Renderer.prototype.cleanStringHelper=function(context,sectionText,helper){var str=this.stringHelper(context,sectionText,helper);return str.replace("s","c")};Renderer.prototype.quoteHelper=function(context,sectionText,helper){var content=helper(sectionText.trim(),context);content=content.replace(/"/g,"\\\"").replace(/\t/g,"&#9;").replace(/([{}]{2,3})/g,"{{=<% %>=}}$1<%={{ }}=%>").replace(/(\r\n|\r|\n)/g,"&#x0a;");return"\""+content+"\""};Renderer.prototype.shortenTextHelper=function(context,sectionText,helper){var parts=sectionText.match(/(.*?),(.*)/),length=parts[1].trim(),text=parts[2].trim(),content=helper(text,context);return Truncate.truncate(content,{length:length,words:!0,ellipsis:"..."})};Renderer.prototype.userDateHelper=function(context,sectionText,helper){var parts=sectionText.match(/(.*?),(.*)/),timestamp=helper(parts[1].trim(),context),format=helper(parts[2].trim(),context),index=this.requiredDates.length;this.requiredDates.push({timestamp:timestamp,format:format});return"[[_t_"+index+"]]"};Renderer.prototype.addHelperFunction=function(helperFunction,context){return function(){return function(sectionText,helper){var originalHelpers=disallowedNestedHelpers.reduce(function(carry,name){if(context.hasOwnProperty(name)){carry[name]=context[name]}return carry},{});disallowedNestedHelpers.forEach(function(helperName){context[helperName]=function(){return""}});var result=helperFunction.apply(this,[context,sectionText,helper]);for(var name in originalHelpers){context[name]=originalHelpers[name]}return result}.bind(this)}.bind(this)};Renderer.prototype.addHelpers=function(context,themeName){this.currentThemeName=themeName;this.requiredStrings=[];this.requiredJS=[];context.uniqid=uniqInstances++;context.str=this.addHelperFunction(this.stringHelper,context);context.cleanstr=this.addHelperFunction(this.cleanStringHelper,context);context.pix=this.addHelperFunction(this.pixHelper,context);context.js=this.addHelperFunction(this.jsHelper,context);context.quote=this.addHelperFunction(this.quoteHelper,context);context.shortentext=this.addHelperFunction(this.shortenTextHelper,context);context.userdate=this.addHelperFunction(this.userDateHelper,context);context.globals={config:config};context.currentTheme=themeName};Renderer.prototype.getJS=function(){var js="";if(0<this.requiredJS.length){js=this.requiredJS.join(";\n")}return js};Renderer.prototype.treatStringsInContent=function(content,strings){var pattern=/\[\[_(s|c)\d+\]\]/,treated,index,strIndex,walker,char,strFinal,isClean;do{treated="";index=content.search(pattern);while(-1<index){treated+=content.substring(0,index);content=content.substr(index);isClean="c"==content[3];strIndex="";walker=4;char=content.substr(walker,1);do{strIndex+=char;walker++;char=content.substr(walker,1)}while("]"!=char);strFinal=strings[parseInt(strIndex,10)];if("undefined"==typeof strFinal){Log.debug("Could not find string for pattern [[_"+(isClean?"c":"s")+strIndex+"]].");strFinal=""}if(isClean){strFinal=mustache.escape(strFinal)}treated+=strFinal;content=content.substr(6+strIndex.length);index=content.search(pattern)}content=treated+content;index=content.search(pattern)}while(-1<index);return content};Renderer.prototype.treatDatesInContent=function(content,dates){dates.forEach(function(date,index){var re=new RegExp("\\[\\[_t_"+index+"\\]\\]","g");content=content.replace(re,date)});return content};Renderer.prototype.doRender=function(templateSource,context,themeName){this.currentThemeName=themeName;var iconTemplate=iconSystem.getTemplateName(),pendingPromise=new Pending("core/templates:doRender");return this.getTemplate(iconTemplate).then(function(){this.addHelpers(context,themeName);var result=mustache.render(templateSource,context,this.partialHelper.bind(this));return $.Deferred().resolve(result.trim(),this.getJS()).promise()}.bind(this)).then(function(html,js){if(0<this.requiredStrings.length){return str.get_strings(this.requiredStrings).then(function(strings){this.requiredDates=this.requiredDates.map(function(date){return{timestamp:this.treatStringsInContent(date.timestamp,strings),format:this.treatStringsInContent(date.format,strings)}}.bind(this));html=this.treatStringsInContent(html,strings);js=this.treatStringsInContent(js,strings);return $.Deferred().resolve(html,js).promise()}.bind(this))}return $.Deferred().resolve(html,js).promise()}.bind(this)).then(function(html,js){if(0<this.requiredDates.length){return UserDate.get(this.requiredDates).then(function(dates){html=this.treatDatesInContent(html,dates);js=this.treatDatesInContent(js,dates);return $.Deferred().resolve(html,js).promise()}.bind(this))}return $.Deferred().resolve(html,js).promise()}.bind(this)).then(function(html,js){pendingPromise.resolve();return $.Deferred().resolve(html,js).promise()})};var runTemplateJS=function(source){if(""!==source.trim()){var newscript=$("<script>").attr("type","text/javascript").html(source);$("head").append(newscript)}},domReplace=function(element,newHTML,newJS,replaceChildNodes){var replaceNode=$(element);if(replaceNode.length){var newNodes=$(newHTML),yuiNodes=null;if(replaceChildNodes){yuiNodes=new Y.NodeList(replaceNode.children().get());yuiNodes.destroy(!0);replaceNode.empty();replaceNode.append(newNodes)}else{yuiNodes=new Y.NodeList(replaceNode.get());yuiNodes.destroy(!0);replaceNode.replaceWith(newNodes)}runTemplateJS(newJS);filterEvents.notifyFilterContentUpdated(newNodes);return newNodes.get()}return[]};Renderer.prototype.scanForPartials=function(templateSource){var tokens=mustache.parse(templateSource),partials=[],findPartial=function(tokens,partials){var i,token;for(i=0;i<tokens.length;i++){token=tokens[i];if(">"==token[0]||"<"==token[0]){partials.push(token[1])}if(4<token.length){findPartial(token[4],partials)}}};findPartial(tokens,partials);return partials};Renderer.prototype.cachePartials=function(templateName,parentage){var searchKey=this.currentThemeName+"/"+templateName;if(searchKey in cachePartialPromises){return cachePartialPromises[searchKey]}parentage=parentage||[searchKey];cachePartialPromises[searchKey]=$.Deferred();this.getTemplate(templateName).then(function(templateSource){var partials=this.scanForPartials(templateSource),uniquePartials=partials.filter(function(partialName){if(0<=parentage.indexOf(this.currentThemeName+"/"+partialName)){return!1}return partialName!=templateName}.bind(this)),fetchThemAll=uniquePartials.map(function(partialName){parentage.push(this.currentThemeName+"/"+partialName);return this.cachePartials(partialName,parentage)}.bind(this));return $.when.apply($,fetchThemAll).then(function(){return cachePartialPromises[searchKey].resolve(templateSource)})}.bind(this)).catch(cachePartialPromises[searchKey].reject);return cachePartialPromises[searchKey]};Renderer.prototype.render=function(templateName,context,themeName){if("undefined"==typeof themeName){themeName=config.theme}this.currentThemeName=themeName;var modulename=config.iconsystemmodule,ready=$.Deferred();require([modulename],function(System){var system=new System;if(!(system instanceof IconSystem)){ready.reject("Invalid icon system specified"+config.iconsystem)}else{iconSystem=system;system.init().then(ready.resolve).catch(notification.exception)}});return ready.then(function(){return this.cachePartials(templateName)}.bind(this)).then(function(templateSource){return this.doRender(templateSource,context,themeName)}.bind(this))};var domPrepend=function(element,html,js){var node=$(element);if(node.length){var newContent=$(html);node.prepend(newContent);runTemplateJS(js);filterEvents.notifyFilterContentUpdated(node);return newContent.get()}return[]},domAppend=function(element,html,js){var node=$(element);if(node.length){var newContent=$(html);node.append(newContent);runTemplateJS(js);filterEvents.notifyFilterContentUpdated(node);return newContent.get()}return[]};return{render:function render(templateName,context,themeName){var renderer=new Renderer;return renderer.render(templateName,context,themeName)},prefetchTemplates:function prefetchTemplates(templateNames,themeName){var renderer=new Renderer;if("undefined"==typeof themeName){themeName=config.theme}return renderer.prefetchTemplates(templateNames,themeName)},renderForPromise:function renderForPromise(templateName,context,themeName){var renderer=new Renderer;return renderer.render(templateName,context,themeName).then(function(html,js){return{html:html,js:js}})},renderPix:function renderPix(key,component,title){var renderer=new Renderer;return renderer.renderIcon(key,getNormalisedComponent(component),title)},runTemplateJS:runTemplateJS,replaceNodeContents:function replaceNodeContents(element,newHTML,newJS){return domReplace(element,newHTML,newJS,!0)},replaceNode:function replaceNode(element,newHTML,newJS){return domReplace(element,newHTML,newJS,!1)},prependNodeContents:function prependNodeContents(element,html,js){return domPrepend(element,html,js)},appendNodeContents:function appendNodeContents(element,html,js){return domAppend(element,html,js)}}});
//# sourceMappingURL=templates.min.js.map
