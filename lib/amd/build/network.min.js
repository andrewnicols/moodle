define ("core/network",["jquery","core/ajax","core/config","core/notification","core/str"],function($,Ajax,Config,Notification,Str){var started=!1,warningDisplayed=!1,keepAliveFrequency=0,requestTimeout=0,keepAliveMessage=!1,sessionTimeout=!1,checkFrequency=1e3*Math.min(Config.sessiontimeout/10,600),timeoutSessionExpired=function(){sessionTimeout=!0},touchSession=function(){if(sessionTimeout){return Str.get_strings([{key:"sessionexpired",component:"error"},{key:"sessionerroruser",component:"error"}]).then(function(strings){Notification.alert(strings[0],strings[1]);return!0}).fail(Notification.exception)}else{return Ajax.call([{methodname:"core_session_touch",args:{}}],!0,!0,!1,requestTimeout)[0].then(function(){if(0<keepAliveFrequency){setTimeout(touchSession,keepAliveFrequency)}return!0}).fail(function(){Notification.alert("",keepAliveMessage)})}},checkSession=function(){sessionTimeout=!1;return Ajax.call([{methodname:"core_session_time_remaining",args:{}}],!0,!0,!0)[0].then(function(args){if(0>=args.userid){return!1}if(0>args.timeremaining){Str.get_strings([{key:"sessionexpired",component:"error"},{key:"sessionerroruser",component:"error"}]).then(function(strings){Notification.alert(strings[0],strings[1]);return!0}).fail(Notification.exception)}else if(1e3*args.timeremaining<2*checkFrequency&&!warningDisplayed){setTimeout(timeoutSessionExpired,1e3*args.timeremaining);warningDisplayed=!0;Str.get_strings([{key:"norecentactivity",component:"moodle"},{key:"sessiontimeoutsoon",component:"moodle"},{key:"extendsession",component:"moodle"},{key:"cancel",component:"moodle"}]).then(function(strings){Notification.confirm(strings[0],strings[1],strings[2],strings[3],function(){touchSession();warningDisplayed=!1;setTimeout(checkSession,5*checkFrequency);return!0},function(){warningDisplayed=!1;setTimeout(checkSession,checkFrequency)});return!0}).fail(Notification.exception)}else{setTimeout(checkSession,checkFrequency)}return!0})},start=function(){if(0<keepAliveFrequency){setTimeout(touchSession,keepAliveFrequency)}else{setTimeout(checkSession,5*checkFrequency)}},isMoodleIframe=function(){if(window.parent===window){return!1}var parentUrl;try{parentUrl=window.parent.location.href}catch(e){return!1}return parentUrl.startsWith(M.cfg.wwwroot)},init=function(){if(started){return}started=!0;if(isMoodleIframe()){window.console.log("Not starting Moodle session timeout warning in this iframe.");return}window.console.log("Starting Moodle session timeout warning.");start()},keepalive=function(freq,timeout,message){if(started){window.console.warn("Ignoring session keep-alive. The core/network module was already initialised.");return}started=!0;if(isMoodleIframe()){window.console.warn("Ignoring session keep-alive in this iframe inside another Moodle page.");return}window.console.log("Starting Moodle session keep-alive.");keepAliveFrequency=1e3*freq;keepAliveMessage=message;requestTimeout=1e3*timeout;start()};return{keepalive:keepalive,init:init}});
//# sourceMappingURL=network.min.js.map
