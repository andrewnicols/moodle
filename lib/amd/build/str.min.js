define ("core/str",["exports","jquery","core/ajax","core/localstorage"],function(_exports,_jquery,_ajax,_localstorage){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.get_strings=_exports.get_string=_exports.cache_strings=void 0;_jquery=_interopRequireDefault(_jquery);_ajax=_interopRequireDefault(_ajax);_localstorage=_interopRequireDefault(_localstorage);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}let promiseCache=[];_exports.get_string=(key,component,param,lang)=>{return get_strings([{key,component,param,lang}]).then(results=>results[0])};const get_strings=requests=>{let requestData=[];const pageLang=(0,_jquery.default)("html").attr("lang").replace(/-/g,"_"),getCacheKey=_ref=>{let{key,component,lang=pageLang}=_ref;if(!component){component="core"}return"core_str/".concat(key,"/").concat(component,"/").concat(lang)},stringPromises=requests.map(request=>{const cacheKey=getCacheKey(request),{component,key,param,lang=pageLang}=request,buildReturn=promise=>{promiseCache[cacheKey]=promise;return promise};if(component in M.str&&key in M.str[component]){return buildReturn(new Promise(resolve=>{resolve(M.util.get_string(key,component,param,lang))}))}const cached=_localstorage.default.get(cacheKey);if(cached){M.str[component]={...M.str[component],[key]:cached};return buildReturn(new Promise(resolve=>{resolve(M.util.get_string(key,component,param,lang))}))}if(cacheKey in promiseCache){return buildReturn(promiseCache[cacheKey]).then(()=>{return M.util.get_string(key,component,param,lang)})}else{return buildReturn(new Promise((resolve,reject)=>{requestData.push({methodname:"core_get_string",args:{stringid:key,stringparams:[],component,lang},done:str=>{M.str[component]={...M.str[component],[key]:str};_localstorage.default.set(cacheKey,str);resolve(M.util.get_string(key,component,param,lang))},fail:reject})}))}});if(requestData.length){_ajax.default.call(requestData,!0,!1,!1,0,M.cfg.langrev)}return _jquery.default.when.apply(_jquery.default,stringPromises).then(function(){for(var _len=arguments.length,strings=Array(_len),_key=0;_key<_len;_key++){strings[_key]=arguments[_key]}return strings})};_exports.get_strings=get_strings;const cache_strings=strings=>{const defaultLang=(0,_jquery.default)("html").attr("lang").replace(/-/g,"_");strings.forEach(_ref2=>{let{key,component,value,lang=defaultLang}=_ref2;const cacheKey=["core_str",key,component,lang].join("/");if(!(component in M.str)||!(key in M.str[component])){if(!(component in M.str)){M.str[component]={}}M.str[component][key]=value}if(!_localstorage.default.get(cacheKey)){_localstorage.default.set(cacheKey,value)}if(!(cacheKey in promiseCache)){promiseCache[cacheKey]=_jquery.default.Deferred().resolve(value).promise()}})};_exports.cache_strings=cache_strings});
//# sourceMappingURL=str.min.js.map
