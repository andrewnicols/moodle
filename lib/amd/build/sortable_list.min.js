function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define ("core/sortable_list",["jquery","core/log","core/autoscroll","core/str","core/modal_factory","core/modal_events","core/notification"],function($,log,autoScroll,str,ModalFactory,ModalEvents,Notification){var defaultParameters={targetListSelector:null,moveHandlerSelector:"[data-drag-type=move]",isHorizontal:!1,autoScroll:!0},CSS={keyboardDragClass:"dragdrop-keyboard-drag",isDraggedClass:"sortable-list-is-dragged",currentPositionClass:"sortable-list-current-position",sourceListClass:"sortable-list-source",targetListClass:"sortable-list-target",overElementClass:"sortable-list-over-element"},registerNotPassiveListeners=function(eventname){return{setup:function setup(x,ns,handle){if(ns.includes("notPassive")){this.addEventListener(eventname,handle,{passive:!1});return!0}else{return!1}}}};if(function eventListenerOptionsSupported(){var passivesupported=!1,options;try{options=Object.defineProperty({},"passive",{get:function get(){passivesupported=!0}});document.addEventListener("testpassiveeventoptions",options,options);document.removeEventListener("testpassiveeventoptions",options,options)}catch(err){passivesupported=!1}return passivesupported}){$.event.special.touchstart=registerNotPassiveListeners("touchstart");$.event.special.touchmove=registerNotPassiveListeners("touchmove");$.event.special.touchend=registerNotPassiveListeners("touchend")}var SortableList=function(root,config){this.info=null;this.proxy=null;this.proxyDelta=null;this.dragCounter=0;this.lastEvent=null;this.config=$.extend({},defaultParameters,config||{});this.config.listSelector=root;if(!this.config.targetListSelector){this.config.targetListSelector=root}if("object"===_typeof(this.config.listSelector)){$(this.config.listSelector).on("mousedown touchstart.notPassive",$.proxy(this.dragStartHandler,this))}else{$("body").on("mousedown touchstart.notPassive",this.config.listSelector,$.proxy(this.dragStartHandler,this))}if(null!==this.config.moveHandlerSelector){$("body").on("click keypress",this.config.moveHandlerSelector,$.proxy(this.clickHandler,this))}};SortableList.EVENTS={DRAGSTART:"sortablelist-dragstart",DRAG:"sortablelist-drag",DROP:"sortablelist-drop",DRAGEND:"sortablelist-dragend"};SortableList.prototype.resetDraggedClasses=function(){var classes=[CSS.isDraggedClass,CSS.currentPositionClass,CSS.overElementClass,CSS.targetListClass];for(var i in classes){$("."+classes[i]).removeClass(classes[i])}if(this.proxy){this.proxy.remove();this.proxy=$()}};SortableList.prototype.calculatePositionOnPage=function(evt){if(evt.originalEvent&&evt.originalEvent.touches&&evt.originalEvent.touches[0]!==void 0){var touch=evt.originalEvent.touches[0];evt.pageX=touch.pageX;evt.pageY=touch.pageY}if(evt.pageX===void 0){evt.pageX=this.lastEvent.pageX;evt.pageY=this.lastEvent.pageY}else{this.lastEvent=evt}if(evt.clientX===void 0){evt.clientX=Math.round(evt.pageX-$(window).scrollLeft());evt.clientY=Math.round(evt.pageY-$(window).scrollTop())}};SortableList.prototype.dragStartHandler=function(evt){if(null!==this.info){if("click"===this.info.type||"touchend"===this.info.type){return}this.moveElement(this.info.sourceList,this.info.sourceNextElement);this.finishDragging()}if("mousedown"===evt.type&&1!==evt.which){return}this.calculatePositionOnPage(evt);var movedElement=$(evt.target).closest($(evt.currentTarget).children());if(!movedElement.length){return}if(null!==this.config.moveHandlerSelector){if(!$(evt.target).closest(this.config.moveHandlerSelector,movedElement).length){return}}evt.stopPropagation();evt.preventDefault();this.dragCounter++;this.info={element:movedElement,sourceNextElement:movedElement.next(),sourceList:movedElement.parent(),targetNextElement:movedElement.next(),targetList:movedElement.parent(),type:evt.type,dropped:!1,startX:evt.pageX,startY:evt.pageY,startTime:new Date().getTime()};$(this.config.targetListSelector).addClass(CSS.targetListClass);var offset=movedElement.offset();movedElement.addClass(CSS.currentPositionClass);this.proxyDelta={x:offset.left-evt.pageX,y:offset.top-evt.pageY};this.proxy=$();var thisDragCounter=this.dragCounter;setTimeout($.proxy(function(){if(null===this.info||"click"===this.info.type||"keypress"===this.info.type||this.dragCounter!==thisDragCounter){return}this.createProxy()},this),500);$(window).on("mousemove touchmove.notPassive mouseup touchend.notPassive",$.proxy(this.dragHandler,this));$(window).on("keypress",$.proxy(this.dragcancelHandler,this));if(this.config.autoScroll){autoScroll.start(function(){$(window).trigger("mousemove")})}this.executeCallback(SortableList.EVENTS.DRAGSTART)};SortableList.prototype.createProxy=function(){this.proxy=this.info.element.clone();this.info.sourceList.append(this.proxy);this.proxy.removeAttr("id").removeClass(CSS.currentPositionClass).addClass(CSS.isDraggedClass).css({position:"fixed"});this.proxy.offset({top:this.proxyDelta.y+this.lastEvent.pageY,left:this.proxyDelta.x+this.lastEvent.pageX})};SortableList.prototype.clickHandler=function(evt){if("keypress"===evt.type&&13!==evt.originalEvent.keyCode&&32!==evt.originalEvent.keyCode){return}if(null!==this.info){return}var clickedElement=$(evt.target).closest(this.config.moveHandlerSelector),sourceList=clickedElement.closest(this.config.listSelector),movedElement=clickedElement.closest(sourceList.children());if(!movedElement.length){return}evt.preventDefault();evt.stopPropagation();this.dragCounter++;this.info={element:movedElement,sourceNextElement:movedElement.next(),sourceList:sourceList,targetNextElement:movedElement.next(),targetList:sourceList,dropped:!1,type:evt.type,startTime:new Date().getTime()};this.executeCallback(SortableList.EVENTS.DRAGSTART);this.displayMoveDialogue(clickedElement)};SortableList.prototype.getPositionInNode=function(pageX,pageY,element){if(!element.length){return null}var node=element[0],rect=node.getBoundingClientRect(),y=pageY-(rect.top+window.scrollY),x=pageX-(rect.left+window.scrollX);if(x>=-0&&x<=rect.width+0&&y>=-0&&y<=rect.height+0){return{x:x,y:y,xRatio:rect.width?x/rect.width:0,yRatio:rect.height?y/rect.height:0}}return null};SortableList.prototype.isListHorizontal=function(element){var isHorizontal=this.config.isHorizontal;if(!0===isHorizontal||!1===isHorizontal){return isHorizontal}return isHorizontal(element)};SortableList.prototype.dragHandler=function(evt){evt.preventDefault();evt.stopPropagation();this.calculatePositionOnPage(evt);this.proxy.offset({top:-1e3,left:-1e3});var element=$(document.elementFromPoint(evt.clientX,evt.clientY)),mainElement=this.info.element[0],isNotSelf=function(){return this!==mainElement},current=element.closest("."+CSS.targetListClass+" > :not(."+CSS.isDraggedClass+")").filter(isNotSelf),currentList=element.closest("."+CSS.targetListClass),proxy=this.proxy,isNotProxy=function(){return!proxy||!proxy.length||this!==proxy[0]};$("."+CSS.overElementClass).removeClass(CSS.overElementClass);current.addClass(CSS.overElementClass);this.proxy.offset({top:this.proxyDelta.y+evt.pageY,left:this.proxyDelta.x+evt.pageX});if(currentList.length&&!currentList.children().filter(isNotProxy).length){this.moveElement(currentList,$())}else if(1===current.length&&!this.info.element.find(current[0]).length){var coordinates=this.getPositionInNode(evt.pageX,evt.pageY,current);if(coordinates){var parent=current.parent(),ratio=this.isListHorizontal(parent)?coordinates.xRatio:coordinates.yRatio,subList=current.find("."+CSS.targetListClass),subListEmpty=!subList.children().filter(isNotProxy).filter(isNotSelf).length;if(subList.length&&subListEmpty&&.2<ratio&&.8>ratio){this.moveElement(subList,$())}else if(.5<ratio){this.moveElement(parent,current.next().filter(isNotProxy))}else{this.moveElement(parent,current)}}}if("mouseup"===evt.type||"touchend"===evt.type){this.info.endX=evt.pageX;this.info.endY=evt.pageY;this.info.endTime=new Date().getTime();this.info.dropped=!0;this.info.positionChanged=this.hasPositionChanged(this.info);var oldinfo=this.info;this.executeCallback(SortableList.EVENTS.DROP);this.finishDragging();if("touchend"===evt.type&&null!==this.config.moveHandlerSelector&&500>oldinfo.endTime-oldinfo.startTime&&!oldinfo.positionChanged){this.clickHandler(evt)}}};SortableList.prototype.hasPositionChanged=function(info){return info.sourceList[0]!==info.targetList[0]||info.sourceNextElement.length!==info.targetNextElement.length||info.sourceNextElement.length&&info.sourceNextElement[0]!==info.targetNextElement[0]};SortableList.prototype.moveElement=function(parentElement,beforeElement){var dragEl=this.info.element;if(beforeElement.length&&beforeElement[0]===dragEl[0]){return}if(parentElement[0]===this.info.targetList[0]&&beforeElement.length===this.info.targetNextElement.length&&beforeElement[0]===this.info.targetNextElement[0]){return}if(beforeElement.length){parentElement[0].insertBefore(dragEl[0],beforeElement[0])}else if(this.proxy&&this.proxy.parent().length&&this.proxy.parent()[0]===parentElement[0]){parentElement[0].insertBefore(dragEl[0],this.proxy[0])}else{parentElement[0].appendChild(dragEl[0])}this.info.targetList=parentElement;this.info.targetNextElement=beforeElement;this.executeCallback(SortableList.EVENTS.DRAG)};SortableList.prototype.finishDragging=function(){this.resetDraggedClasses();if(this.config.autoScroll){autoScroll.stop()}$(window).off("mousemove touchmove.notPassive mouseup touchend.notPassive",$.proxy(this.dragHandler,this));$(window).off("keypress",$.proxy(this.dragcancelHandler,this));this.executeCallback(SortableList.EVENTS.DRAGEND);this.info=null};SortableList.prototype.executeCallback=function(eventName){this.info.element.trigger(eventName,this.info)};SortableList.prototype.dragcancelHandler=function(evt){if("keypress"!==evt.type||27!==evt.originalEvent.keyCode){return}this.moveElement(this.info.sourceList,this.info.sourceNextElement);this.finishDragging()};SortableList.prototype.getElementName=function(element){return $.Deferred().resolve(element.text())};SortableList.prototype.getDestinationName=function(parentElement,afterElement){if(!afterElement.length){return str.get_string("movecontenttothetop","moodle")}else{return this.getElementName(afterElement).then(function(name){return str.get_string("movecontentafter","moodle",name)})}};SortableList.prototype.getMoveDialogueTitle=function(element,handler){if(handler.attr("title")){return $.Deferred().resolve(handler.attr("title"))}return this.getElementName(element).then(function(name){return str.get_string("movecontent","moodle",name)})};SortableList.prototype.getDestinationsList=function(){var addedLists=[],targets=$(this.config.targetListSelector),destinations=$("<ul/>").addClass(CSS.keyboardDragClass),result=$.when().then(function(){return destinations}),createLink=$.proxy(function(parentElement,beforeElement,afterElement){if(beforeElement.is(this.info.element)||afterElement.is(this.info.element)){return}if($.contains(this.info.element[0],parentElement[0])){return}result=result.then($.proxy(function(){return this.getDestinationName(parentElement,afterElement)},this)).then(function(txt){var li=$("<li/>").appendTo(destinations),a=$("<a href=\"#\"/>").attr("data-core_sortable_list-quickmove",1).appendTo(li);a.data("parent-element",parentElement).data("before-element",beforeElement).text(txt);return destinations})},this),addList=function(){if(-1!==$.inArray(this,addedLists)){return}addedLists.push(this);var list=$(this),children=list.children();children.each(function(){var element=$(this);createLink(list,element,element.prev());element.find(targets).each(addList)});createLink(list,$(),children.last())};targets.each(addList);return result};SortableList.prototype.displayMoveDialogue=function(clickedElement){ModalFactory.create({type:ModalFactory.types.CANCEL,title:this.getMoveDialogueTitle(this.info.element,clickedElement),body:this.getDestinationsList()}).then($.proxy(function(modal){var quickMoveHandler=$.proxy(function(e){e.preventDefault();e.stopPropagation();this.moveElement($(e.currentTarget).data("parent-element"),$(e.currentTarget).data("before-element"));this.info.endTime=new Date().getTime();this.info.positionChanged=this.hasPositionChanged(this.info);this.info.dropped=!0;clickedElement.focus();this.executeCallback(SortableList.EVENTS.DROP);modal.hide()},this);modal.getRoot().on("click","[data-core_sortable_list-quickmove]",quickMoveHandler);modal.getRoot().on(ModalEvents.hidden,$.proxy(function(){modal.getRoot().off("click","[data-core_sortable_list-quickmove]",quickMoveHandler);modal.destroy();this.finishDragging()},this));modal.setLarge();modal.show();return modal},this)).catch(Notification.exception)};return SortableList});
//# sourceMappingURL=sortable_list.min.js.map
