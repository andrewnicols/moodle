define ("core/form-autocomplete",["jquery","core/log","core/str","core/templates","core/notification","core/loadingicon","core/aria","core_form/changechecker"],function($,log,str,templates,notification,LoadingIcon,Aria,FormChangeChecker){var KEYS={DOWN:40,ENTER:13,SPACE:32,ESCAPE:27,COMMA:44,UP:38,LEFT:37,RIGHT:39},uniqueId=Date.now(),activateSelection=function(index,state){var selectionElement=$(document.getElementById(state.selectionId)),length=selectionElement.children("[aria-selected=true]").length;index=index%length;while(0>index){index+=length}var element=$(selectionElement.children("[aria-selected=true]").get(index)),itemId=state.selectionId+"-"+index;selectionElement.children().attr("data-active-selection",null).attr("id","");element.attr("data-active-selection",!0).attr("id",itemId);selectionElement.attr("aria-activedescendant",itemId);selectionElement.attr("data-active-value",element.attr("data-value"));return $.Deferred().resolve()},getActiveElementFromState=function(state){var _selectionRegion$attr,selectionRegion=$(document.getElementById(state.selectionId)),activeId=selectionRegion.attr("aria-activedescendant");if(activeId){var activeElement=$(document.getElementById(activeId));if(activeElement.length){return activeElement}}var activeValue=null===(_selectionRegion$attr=selectionRegion.attr("data-active-value"))||void 0===_selectionRegion$attr?void 0:_selectionRegion$attr.replace(/"/g,"\\\"");return selectionRegion.find("[data-value=\""+activeValue+"\"]")},updateActiveSelectionFromState=function(state){var activeElement=getActiveElementFromState(state),activeValue=activeElement.attr("data-value"),selectionRegion=$(document.getElementById(state.selectionId));if(activeValue){var activeIndex=selectionRegion.find("[aria-selected=true]").index(activeElement);if(-1!==activeIndex){activateSelection(activeIndex,state);return}}activateSelection(0,state)},updateSelectionList=function(options,state,originalSelect){var pendingKey="form-autocomplete-updateSelectionList-"+state.inputId;M.util.js_pending(pendingKey);var items=[],newSelection=$(document.getElementById(state.selectionId));originalSelect.children("option").each(function(index,ele){if($(ele).prop("selected")){var label;if($(ele).data("html")){label=$(ele).data("html")}else{label=$(ele).html()}if(""!==label){items.push({label:label,value:$(ele).attr("value")})}}});if(!hasItemListChanged(state,items)){M.util.js_complete(pendingKey);return Promise.resolve()}state.items=items;var context=$.extend(options,state);return templates.render(options.templates.items,context).then(function(html,js){templates.replaceNodeContents(newSelection,html,js);updateActiveSelectionFromState(state)}).then(function(){return M.util.js_complete(pendingKey)}).catch(notification.exception)},hasItemListChanged=function(state,items){if(state.items.length!==items.length){return!0}return 0<state.items.filter(function(item){return-1===items.indexOf(item)}).length},notifyChange=function(originalSelect){FormChangeChecker.markFormChangedFromNode(originalSelect[0]);originalSelect[0].dispatchEvent(new Event("change"))},deselectItem=function(options,state,item,originalSelect){var selectedItemValue=$(item).attr("data-value");originalSelect.children("option").each(function(index,ele){if($(ele).attr("value")==selectedItemValue){$(ele).prop("selected",!1);if($(ele).attr("data-iscustom")){$(ele).remove()}}});return updateSelectionList(options,state,originalSelect).then(function(){notifyChange(originalSelect)})},activateItem=function(index,state){var inputElement=$(document.getElementById(state.inputId)),suggestionsElement=$(document.getElementById(state.suggestionsId)),length=suggestionsElement.children(":not([aria-hidden])").length;index=index%length;while(0>index){index+=length}var element=$(suggestionsElement.children(":not([aria-hidden])").get(index)),globalIndex=$(suggestionsElement.children("[role=option]")).index(element),itemId=state.suggestionsId+"-"+globalIndex;suggestionsElement.children().attr("aria-selected",!1).attr("id","");element.attr("aria-selected",!0).attr("id",itemId);inputElement.attr("aria-activedescendant",itemId);var scrollPos=element.offset().top-suggestionsElement.offset().top+suggestionsElement.scrollTop()-suggestionsElement.height()/2;return suggestionsElement.animate({scrollTop:scrollPos},100).promise()},activateNextItem=function(state){var suggestionsElement=$(document.getElementById(state.suggestionsId)),element=suggestionsElement.children("[aria-selected=true]"),current=suggestionsElement.children(":not([aria-hidden])").index(element);return activateItem(current+1,state)},activatePreviousSelection=function(state){var selectionsElement=$(document.getElementById(state.selectionId)),element=selectionsElement.children("[data-active-selection]");if(!element){return activateSelection(0,state)}var current=selectionsElement.children("[aria-selected=true]").index(element);return activateSelection(current-1,state)},activateNextSelection=function(state){var selectionsElement=$(document.getElementById(state.selectionId)),element=selectionsElement.children("[data-active-selection]"),current=0;if(element){current=selectionsElement.children("[aria-selected=true]").index(element);current=current+1}else{current=0}return activateSelection(current,state)},activatePreviousItem=function(state){var suggestionsElement=$(document.getElementById(state.suggestionsId)),element=suggestionsElement.children("[aria-selected=true]"),current=suggestionsElement.children(":not([aria-hidden])").index(element);return activateItem(current-1,state)},closeSuggestions=function(state){var inputElement=$(document.getElementById(state.inputId)),suggestionsElement=$(document.getElementById(state.suggestionsId));if("true"===inputElement.attr("aria-expanded")){inputElement.attr("aria-expanded",!1)}inputElement.attr("aria-activedescendant",state.selectionId);Aria.hide(suggestionsElement.get());suggestionsElement.hide();return $.Deferred().resolve()},updateSuggestions=function(options,state,query,originalSelect){var pendingKey="form-autocomplete-updateSuggestions-"+state.inputId;M.util.js_pending(pendingKey);var inputElement=$(document.getElementById(state.inputId)),suggestionsElement=$(document.getElementById(state.suggestionsId)),matchingElements=!1,suggestions=[];originalSelect.children("option").each(function(index,option){if(!0!==$(option).prop("selected")){suggestions[suggestions.length]={label:option.innerHTML,value:$(option).attr("value")}}});var searchquery=state.caseSensitive?query:query.toLocaleLowerCase(),context=$.extend({options:suggestions},options,state),returnVal=templates.render("core/form_autocomplete_suggestions",context).then(function(html,js){templates.replaceNode(suggestionsElement,html,js);suggestionsElement=$(document.getElementById(state.suggestionsId));Aria.unhide(suggestionsElement.get());suggestionsElement.show();suggestionsElement.children().each(function(index,node){node=$(node);if(options.caseSensitive&&-1<node.text().indexOf(searchquery)||!options.caseSensitive&&-1<node.text().toLocaleLowerCase().indexOf(searchquery)){Aria.unhide(node.get());node.show();matchingElements=!0}else{node.hide();Aria.hide(node.get())}});inputElement.attr("aria-expanded",!0);if(originalSelect.attr("data-notice")){suggestionsElement.html(originalSelect.attr("data-notice"))}else if(matchingElements){if(!options.tags){activateItem(0,state)}}else{str.get_string("nosuggestions","form").done(function(nosuggestionsstr){suggestionsElement.html(nosuggestionsstr)})}return suggestionsElement}).then(function(){return M.util.js_complete(pendingKey)}).catch(notification.exception);return returnVal},createItem=function(options,state,originalSelect){var inputElement=$(document.getElementById(state.inputId)),query=inputElement.val(),tags=query.split(","),found=!1;$.each(tags,function(tagindex,tag){tag=tag.trim();if(""!==tag){if(!options.multiple){originalSelect.children("option").prop("selected",!1)}originalSelect.children("option").each(function(index,ele){if($(ele).attr("value")==tag){found=!0;$(ele).prop("selected",!0)}});if(!found){var option=$("<option>");option.append(document.createTextNode(tag));option.attr("value",tag);originalSelect.append(option);option.prop("selected",!0);option.attr("data-iscustom",!0)}}});return updateSelectionList(options,state,originalSelect).then(function(){notifyChange(originalSelect)}).then(function(){inputElement.val("")}).then(function(){return closeSuggestions(state)})},selectCurrentItem=function(options,state,originalSelect){var inputElement=$(document.getElementById(state.inputId)),suggestionsElement=$(document.getElementById(state.suggestionsId)),selectedItemValue=suggestionsElement.children("[aria-selected=true]").attr("data-value");if(!options.multiple){originalSelect.children("option").prop("selected",!1)}originalSelect.children("option").each(function(index,ele){if($(ele).attr("value")==selectedItemValue){$(ele).prop("selected",!0)}});return updateSelectionList(options,state,originalSelect).then(function(){notifyChange(originalSelect)}).then(function(){if(options.closeSuggestionsOnSelect){inputElement.val("");return closeSuggestions(state)}else{inputElement.focus();return updateSuggestions(options,state,inputElement.val(),originalSelect)}})},updateAjax=function(e,options,state,originalSelect,ajaxHandler){var pendingPromise=addPendingJSPromise("updateAjax"),parentElement=$(document.getElementById(state.selectId)).parent();LoadingIcon.addIconToContainerRemoveOnCompletion(parentElement,pendingPromise);var query=$(e.currentTarget).val();ajaxHandler.transport(options.selector,query,function(results){var processedResults=ajaxHandler.processResults(options.selector,results),existingValues=[];if(!options.multiple){originalSelect.children("option").remove()}originalSelect.children("option").each(function(optionIndex,option){option=$(option);if(!option.prop("selected")){option.remove()}else{existingValues.push(option.attr("value")+"")}});if(!options.multiple&&0===originalSelect.children("option").length){var option=$("<option>");originalSelect.append(option)}if($.isArray(processedResults)){$.each(processedResults,function(resultIndex,result){if(-1===existingValues.indexOf(result.value+"")){var option=$("<option>");option.append(result.label);option.attr("value",result.value);originalSelect.append(option)}});originalSelect.attr("data-notice","")}else{originalSelect.attr("data-notice",processedResults)}pendingPromise.resolve(updateSuggestions(options,state,"",originalSelect))},function(error){pendingPromise.reject(error)});return pendingPromise},addNavigation=function(options,state,originalSelect){var inputElement=$(document.getElementById(state.inputId));inputElement.on("keydown",function(e){var pendingJsPromise=addPendingJSPromise("addNavigation-"+state.inputId+"-"+e.keyCode);switch(e.keyCode){case KEYS.DOWN:if(!options.showSuggestions){pendingJsPromise.resolve();return!0}else if("true"===inputElement.attr("aria-expanded")){pendingJsPromise.resolve(activateNextItem(state))}else{if(!inputElement.val()&&options.ajax){require([options.ajax],function(ajaxHandler){pendingJsPromise.resolve(updateAjax(e,options,state,originalSelect,ajaxHandler))})}else{pendingJsPromise.resolve(updateSuggestions(options,state,inputElement.val(),originalSelect))}}e.preventDefault();return!1;case KEYS.UP:pendingJsPromise.resolve(activatePreviousItem(state));e.preventDefault();return!1;case KEYS.ENTER:var suggestionsElement=$(document.getElementById(state.suggestionsId));if("true"===inputElement.attr("aria-expanded")&&0<suggestionsElement.children("[aria-selected=true]").length){pendingJsPromise.resolve(selectCurrentItem(options,state,originalSelect))}else if(options.tags){pendingJsPromise.resolve(createItem(options,state,originalSelect))}else{pendingJsPromise.resolve()}e.preventDefault();return!1;case KEYS.ESCAPE:if("true"===inputElement.attr("aria-expanded")){pendingJsPromise.resolve(closeSuggestions(state))}else{pendingJsPromise.resolve()}e.preventDefault();return!1;}pendingJsPromise.resolve();return!0});inputElement.on("keypress",function(e){if(e.keyCode===KEYS.COMMA){if(options.tags){addPendingJSPromise("keypress-"+e.keyCode).resolve(createItem(options,state,originalSelect))}e.preventDefault();return!1}return!0});inputElement.closest("form").on("submit",function(){if(options.tags){addPendingJSPromise("form-autocomplete-submit").resolve(createItem(options,state,originalSelect))}return!0});inputElement.on("blur",function(){var pendingPromise=addPendingJSPromise("form-autocomplete-blur");window.setTimeout(function(){var focusElement=$(document.activeElement),timeoutPromise=$.Deferred();if(focusElement.is(document.getElementById(state.suggestionsId))){inputElement.focus()}else if(!focusElement.is(inputElement)&&$(document.getElementById(state.inputId)).length){if(options.tags){timeoutPromise.then(function(){return createItem(options,state,originalSelect)}).catch()}timeoutPromise.then(function(){return closeSuggestions(state)}).catch()}timeoutPromise.then(function(){return pendingPromise.resolve()}).catch();timeoutPromise.resolve()},500)});if(options.showSuggestions){var arrowElement=$(document.getElementById(state.downArrowId));arrowElement.on("click",function(e){var pendingPromise=addPendingJSPromise("form-autocomplete-show-suggestions");inputElement.focus();if(!inputElement.val()&&options.ajax){require([options.ajax],function(ajaxHandler){pendingPromise.resolve(updateAjax(e,options,state,originalSelect,ajaxHandler))})}else{pendingPromise.resolve(updateSuggestions(options,state,inputElement.val(),originalSelect))}})}var suggestionsElement=$(document.getElementById(state.suggestionsId));suggestionsElement.parent().prop("onclick",null).off("click");suggestionsElement.parent().on("click","#".concat(state.suggestionsId," [role=option]"),function(e){var pendingPromise=addPendingJSPromise("form-autocomplete-parent"),element=$(e.currentTarget).closest("[role=option]"),suggestionsElement=$(document.getElementById(state.suggestionsId)),current=suggestionsElement.children(":not([aria-hidden])").index(element);activateItem(current,state).then(function(){return selectCurrentItem(options,state,originalSelect)}).then(function(){return pendingPromise.resolve()}).catch()});var selectionElement=$(document.getElementById(state.selectionId));selectionElement.on("click","[role=option]",function(e){var pendingPromise=addPendingJSPromise("form-autocomplete-clicks");pendingPromise.resolve(deselectItem(options,state,$(e.currentTarget),originalSelect))});selectionElement.on("focus",function(){updateActiveSelectionFromState(state)});selectionElement.on("keydown",function(e){var pendingPromise=addPendingJSPromise("form-autocomplete-keydown-"+e.keyCode);switch(e.keyCode){case KEYS.RIGHT:case KEYS.DOWN:e.preventDefault();pendingPromise.resolve(activateNextSelection(state));return;case KEYS.LEFT:case KEYS.UP:e.preventDefault();pendingPromise.resolve(activatePreviousSelection(state));return;case KEYS.SPACE:case KEYS.ENTER:var selectedItem=$(document.getElementById(state.selectionId)).children("[data-active-selection]");if(selectedItem){e.preventDefault();pendingPromise.resolve(deselectItem(options,state,selectedItem,originalSelect))}return;}pendingPromise.resolve()});if(options.showSuggestions){inputElement.on("focus",function(e){var query=$(e.currentTarget).val();$(e.currentTarget).data("last-value",query)});if(options.ajax){require([options.ajax],function(ajaxHandler){var throttleTimeout=null,inProgress=!1,pendingKey="autocomplete-throttledhandler",handler=function(e){throttleTimeout=null;inProgress=!0;updateAjax(e,options,state,originalSelect,ajaxHandler).then(function(){if(null===throttleTimeout){M.util.js_complete(pendingKey)}inProgress=!1;return arguments[0]}).catch(notification.exception)},throttledHandler=function(e){window.clearTimeout(throttleTimeout);if(inProgress){throttleTimeout=window.setTimeout(throttledHandler.bind(this,e),100);return}if(null===throttleTimeout){M.util.js_pending(pendingKey)}throttleTimeout=window.setTimeout(handler.bind(this,e),300)};inputElement.on("input",function(e){var query=$(e.currentTarget).val(),last=$(e.currentTarget).data("last-value");if(last!==query){throttledHandler(e)}$(e.currentTarget).data("last-value",query)})})}else{inputElement.on("input",function(e){var query=$(e.currentTarget).val(),last=$(e.currentTarget).data("last-value");if(last!==query){updateSuggestions(options,state,query,originalSelect)}$(e.currentTarget).data("last-value",query)})}}},addPendingJSPromise=function(key){var pendingKey="form-autocomplete:"+key;M.util.js_pending(pendingKey);var pendingPromise=$.Deferred();pendingPromise.then(function(){M.util.js_complete(pendingKey);return arguments[0]}).catch(notification.exception);return pendingPromise};return{enhance:function enhance(selector,tags,ajax,placeholder,caseSensitive,showSuggestions,noSelectionString,closeSuggestionsOnSelect,templateOverrides){var options={selector:selector,tags:!1,ajax:!1,placeholder:placeholder,caseSensitive:!1,showSuggestions:!0,noSelectionString:noSelectionString,templates:$.extend({input:"core/form_autocomplete_input",items:"core/form_autocomplete_selection_items",layout:"core/form_autocomplete_layout",selection:"core/form_autocomplete_selection",suggestions:"core/form_autocomplete_suggestions"},templateOverrides)},pendingKey="autocomplete-setup-"+selector;M.util.js_pending(pendingKey);if("undefined"!=typeof tags){options.tags=tags}if("undefined"!=typeof ajax){options.ajax=ajax}if("undefined"!=typeof caseSensitive){options.caseSensitive=caseSensitive}if("undefined"!=typeof showSuggestions){options.showSuggestions=showSuggestions}if("undefined"==typeof noSelectionString){str.get_string("noselection","form").done(function(result){options.noSelectionString=result}).fail(notification.exception)}var originalSelect=$(selector);if(!originalSelect){log.debug("Selector not found: "+selector);M.util.js_complete(pendingKey);return!1}if("enhanced"===originalSelect.data("enhanced")){M.util.js_complete(pendingKey);return!1}originalSelect.data("enhanced","enhanced");Aria.hide(originalSelect.get());originalSelect.css("visibility","hidden");var state={selectId:originalSelect.attr("id"),inputId:"form_autocomplete_input-"+uniqueId,suggestionsId:"form_autocomplete_suggestions-"+uniqueId,selectionId:"form_autocomplete_selection-"+uniqueId,downArrowId:"form_autocomplete_downarrow-"+uniqueId,items:[]};uniqueId++;options.multiple=originalSelect.attr("multiple");if(!options.multiple){originalSelect.prepend("<option>")}if("undefined"!=typeof closeSuggestionsOnSelect){options.closeSuggestionsOnSelect=closeSuggestionsOnSelect}else{options.closeSuggestionsOnSelect=!options.multiple}var originalLabel=$("[for="+state.selectId+"]"),suggestions=[];originalSelect.children("option").each(function(index,option){suggestions[index]={label:option.innerHTML,value:$(option).attr("value")}});var context=$.extend({},options,state);context.options=suggestions;context.items=[];var collectedjs="",renderLayout=templates.render(options.templates.layout,{}).then(function(html){return $(html)}),renderInput=templates.render(options.templates.input,context).then(function(html,js){collectedjs+=js;return $(html)}),renderDatalist=templates.render(options.templates.suggestions,context).then(function(html,js){collectedjs+=js;return $(html)}),renderSelection=templates.render(options.templates.selection,context).then(function(html,js){collectedjs+=js;return $(html)});return $.when(renderLayout,renderInput,renderDatalist,renderSelection).then(function(layout,input,suggestions,selection){originalSelect.hide();var container=originalSelect.parent();input.find("input").attr("data-fieldtype","autocomplete");container.append(layout);container.find("[data-region=\"form_autocomplete-input\"]").replaceWith(input);container.find("[data-region=\"form_autocomplete-suggestions\"]").replaceWith(suggestions);container.find("[data-region=\"form_autocomplete-selection\"]").replaceWith(selection);templates.runTemplateJS(collectedjs);originalLabel.attr("for",state.inputId);addNavigation(options,state,originalSelect);var suggestionsElement=$(document.getElementById(state.suggestionsId));suggestionsElement.hide();Aria.hide(suggestionsElement.get())}).then(function(){return updateSelectionList(options,state,originalSelect)}).then(function(){return M.util.js_complete(pendingKey)}).catch(function(error){M.util.js_complete(pendingKey);notification.exception(error)})}}});
//# sourceMappingURL=form-autocomplete.min.js.map
