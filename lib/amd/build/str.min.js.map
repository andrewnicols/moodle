{"version":3,"file":"str.min.js","sources":["../src/str.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Fetch and render language strings.\n * Hooks into the old M.str global - but can also fetch missing strings on the fly.\n *\n * @module     core/str\n * @class      str\n * @package    core\n * @copyright  2015 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      2.9\n */\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport LocalStorage from 'core/localstorage';\n\n// Module cache for the promises so that we don't make multiple\n// unnecessary requests.\nlet promiseCache = [];\n\n/**\n * Return a promise object that will be resolved into a string eventually (maybe immediately).\n *\n * @method get_string\n * @param {string} key The language string key\n * @param {string} component The language string component\n * @param {string} param The param for variable expansion in the string.\n * @param {string} lang The users language - if not passed it is deduced.\n * @return {Promise}\n */\nexport const get_string = (key, component, param, lang) => {\n    return get_strings([{key, component, param, lang}])\n        .then(results => results[0]);\n};\n\n/**\n * Make a batch request to load a set of strings\n *\n * @method get_strings\n * @param {Object[]} requests Array of { key: key, component: component, param: param, lang: lang };\n *                                      See get_string for more info on these args.\n * @return {Promise}\n */\nexport const get_strings = (requests) => {\n    let requestData = [];\n    const pageLang = $('html').attr('lang').replace(/-/g, '_');\n    // Helper function to construct the cache key.\n    const getCacheKey = ({key, component, lang = pageLang}) => {\n        if (!component) {\n            component = 'core';\n        }\n        return `core_str/${key}/${component}/${lang}`;\n    };\n\n    const stringPromises = requests.map((request) => {\n        const cacheKey = getCacheKey(request);\n        const {component, key, param, lang = pageLang} = request;\n        // Helper function to add the promise to cache.\n        const buildReturn = (promise) => {\n            // Make sure the promise cache contains our promise.\n            promiseCache[cacheKey] = promise;\n            return promise;\n        };\n\n        // Check if we can serve the string straight from M.str.\n        if (component in M.str && key in M.str[component]) {\n            return buildReturn(new Promise((resolve) => {\n                resolve(M.util.get_string(key, component, param, lang));\n            }));\n        }\n\n        // Check if the string is in the browser's local storage.\n        const cached = LocalStorage.get(cacheKey);\n        if (cached) {\n            M.str[component] = {...M.str[component], [key]: cached};\n            return buildReturn(new Promise((resolve) => {\n                resolve(M.util.get_string(key, component, param, lang));\n            }));\n        }\n\n        // Check if we've already loaded this string from the server.\n        if (cacheKey in promiseCache) {\n            return buildReturn(promiseCache[cacheKey]).then(() => {\n                return M.util.get_string(key, component, param, lang);\n            });\n        } else {\n            // We're going to have to ask the server for the string so\n            // add this string to the list of requests to be sent.\n            return buildReturn(new Promise((resolve, reject) => {\n                requestData.push({\n                    methodname: 'core_get_string',\n                    args: {\n                        stringid: key,\n                        stringparams: [],\n                        component,\n                        lang,\n                    },\n                    done: (str) => {\n                        // When we get the response from the server\n                        // we should update M.str and the browser's\n                        // local storage before resolving this promise.\n                        M.str[component] = {...M.str[component], [key]: str};\n                        LocalStorage.set(cacheKey, str);\n                        resolve(M.util.get_string(key, component, param, lang));\n                    },\n                    fail: reject\n                });\n            }));\n        }\n    });\n\n    if (requestData.length) {\n        // If we need to load any strings from the server then send\n        // off the request.\n        Ajax.call(requestData, true, false, false, 0, M.cfg.langrev);\n    }\n\n    // We need to use jQuery here because some calling code uses the\n    // .done handler instead of the .then handler.\n    return $.when.apply($, stringPromises)\n        .then((...strings) => strings);\n};\n\n/**\n * Add a list of strings to the caches.\n *\n * @method cache_strings\n * @param {Object[]} strings Array of { key: key, component: component, lang: lang, value: value }\n */\nexport const cache_strings = (strings) => {\n    const defaultLang = $('html').attr('lang').replace(/-/g, '_');\n\n    strings.forEach(({key, component, value, lang = defaultLang}) => {\n        const cacheKey = ['core_str', key, component, lang].join('/');\n\n        // Check M.str caching.\n        if (!(component in M.str) || !(key in M.str[component])) {\n            if (!(component in M.str)) {\n                M.str[component] = {};\n            }\n\n            M.str[component][key] = value;\n        }\n\n        // Check local storage.\n        if (!LocalStorage.get(cacheKey)) {\n            LocalStorage.set(cacheKey, value);\n        }\n\n        // Check the promises cache.\n        if (!(cacheKey in promiseCache)) {\n            promiseCache[cacheKey] = $.Deferred().resolve(value).promise();\n        }\n    });\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","_typeof","Symbol","iterator","constructor","prototype","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","value","arg","input","hint","prim","toPrimitive","undefined","res","call","TypeError","String","Number","_toPrimitive","_toPropertyKey","configurable","writable","_jquery","_ajax","_localstorage","promiseCache","_exports","get_string","component","param","lang","get_strings","then","results","requests","requestData","pageLang","$","attr","replace","stringPromises","map","request","cacheKey","_ref","_ref$lang","concat","getCacheKey","_request$lang","buildReturn","promise","M","str","Promise","resolve","util","cached","LocalStorage","get","reject","methodname","args","stringid","stringparams","done","set","fail","Ajax","cfg","langrev","when","_len","strings","Array","_key","cache_strings","defaultLang","_ref2","_ref2$lang","join","Deferred"],"mappings":"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"}