define ("core/notification",["exports","core/pending","core/log"],function(_exports,_pending,_log){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.saveCancelPromise=_exports.saveCancel=_exports.init=_exports.fetchNotifications=_exports.exception=_exports.default=_exports.confirm=_exports.alert=_exports.addNotification=void 0;_pending=_interopRequireDefault(_pending);_log=_interopRequireDefault(_log);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}let currentContextId=M.cfg.contextid;const notificationTypes={success:"core/notification_success",info:"core/notification_info",warning:"core/notification_warning",error:"core/notification_error"},notificationRegionId="user-notifications",Selectors={notificationRegion:"#".concat(notificationRegionId),fallbackRegionParents:["#region-main","[role=\"main\"]","body"]},setupTargetRegion=()=>{let targetRegion=getNotificationRegion();if(targetRegion){return!1}const newRegion=document.createElement("span");newRegion.id=notificationRegionId;return Selectors.fallbackRegionParents.some(selector=>{const targetRegion=document.querySelector(selector);if(targetRegion){targetRegion.prepend(newRegion);return!0}return!1})},fetchNotifications=async()=>{const Ajax=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise(function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/ajax"],resolve,reject)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(("core/ajax"))):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/ajax"]));return Ajax.call([{methodname:"core_fetch_notifications",args:{contextid:currentContextId}}])[0].then(addNotifications)};_exports.fetchNotifications=fetchNotifications;const addNotifications=notifications=>{if(!notifications.length){return Promise.resolve()}const pendingPromise=new _pending.default("core/notification:addNotifications");notifications.forEach(notification=>renderNotification(notification.template,notification.variables));return pendingPromise.resolve()},addNotification=notification=>{const pendingPromise=new _pending.default("core/notification:addNotifications");let template=notificationTypes.error;notification={closebutton:!0,announce:!0,type:"error",...notification};if(notification.template){template=notification.template;delete notification.template}else if(notification.type){if("undefined"!=typeof notificationTypes[notification.type]){template=notificationTypes[notification.type]}delete notification.type}return renderNotification(template,notification).then(pendingPromise.resolve)};_exports.addNotification=addNotification;const renderNotification=async(template,variables)=>{if("undefined"==typeof variables.message||!variables.message){_log.default.debug("Notification received without content. Skipping.");return}const pendingPromise=new _pending.default("core/notification:renderNotification"),Templates=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise(function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/templates"],resolve,reject)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(("core/templates"))):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/templates"]));Templates.renderForPromise(template,variables).then(_ref=>{let{html,js=""}=_ref;Templates.prependNodeContents(getNotificationRegion(),html,js)}).then(pendingPromise.resolve).catch(exception)},getNotificationRegion=()=>document.querySelector(Selectors.notificationRegion),alert=async(title,message,cancelText)=>{var pendingPromise=new _pending.default("core/notification:alert");const ModalFactory=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise(function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/modal_factory"],resolve,reject)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(("core/modal_factory"))):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/modal_factory"]));return ModalFactory.create({type:ModalFactory.types.ALERT,body:message,title:title,buttons:{cancel:cancelText},removeOnClose:!0}).then(function(modal){modal.show();pendingPromise.resolve();return modal})};_exports.alert=alert;const confirm=(title,question,saveLabel,noLabel,saveCallback,cancelCallback)=>saveCancel(title,question,saveLabel,saveCallback,cancelCallback);_exports.confirm=confirm;const saveCancel=async function(title,question,saveLabel,saveCallback,cancelCallback){let{triggerElement=null}=5<arguments.length&&arguments[5]!==void 0?arguments[5]:{};const pendingPromise=new _pending.default("core/notification:confirm"),[ModalFactory,ModalEvents]=await Promise.all(["function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise(function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/modal_factory"],resolve,reject)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(("core/modal_factory"))):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/modal_factory"]),"function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise(function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/modal_events"],resolve,reject)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(("core/modal_events"))):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/modal_events"])]);return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:title,body:question,buttons:{save:saveLabel},removeOnClose:!0}).then(function(modal){modal.show();modal.getRoot().on(ModalEvents.save,saveCallback);modal.getRoot().on(ModalEvents.cancel,cancelCallback);modal.getRoot().on(ModalEvents.hidden,()=>null===triggerElement||void 0===triggerElement?void 0:triggerElement.focus());pendingPromise.resolve();return modal})};_exports.saveCancel=saveCancel;const saveCancelPromise=function(title,question,saveLabel){let{triggerElement=null}=3<arguments.length&&arguments[3]!==void 0?arguments[3]:{};return new Promise((resolve,reject)=>{saveCancel(title,question,saveLabel,resolve,reject,{triggerElement})})};_exports.saveCancelPromise=saveCancelPromise;const exception=async ex=>{const pendingPromise=new _pending.default("core/notification:displayException");if(!ex.stack){ex.stack=""}if(ex.debuginfo){ex.stack+=ex.debuginfo+"\n"}if(!ex.backtrace&&ex.stacktrace){ex.backtrace=ex.stacktrace}if(ex.backtrace){ex.stack+=ex.backtrace;const ln=ex.backtrace.match(/line ([^ ]*) of/),fn=ex.backtrace.match(/ of ([^:]*): /);if(ln&&ln[1]){ex.lineNumber=ln[1]}if(fn&&fn[1]){ex.fileName=fn[1];if(30<ex.fileName.length){ex.fileName="..."+ex.fileName.substr(ex.fileName.length-27)}}}if("undefined"==typeof ex.name&&ex.errorcode){ex.name=ex.errorcode}const Y=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise(function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/yui"],resolve,reject)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(("core/yui"))):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/yui"]));Y.use("moodle-core-notification-exception",function(){var modal=new M.core.exception(ex);modal.show();pendingPromise.resolve()})};_exports.exception=exception;const init=(contextId,notificationList)=>{currentContextId=contextId;setupTargetRegion();addNotifications(notificationList)};_exports.init=init;_exports.default={init,fetchNotifications,addNotification,alert,confirm,saveCancel,saveCancelPromise,exception};return _exports.default});
//# sourceMappingURL=notification.min.js.map
