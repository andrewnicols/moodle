define ("core/tree",["jquery"],function($){var SELECTORS={ITEM:"[role=treeitem]",GROUP:"[role=treeitem]:has([role=group]), [role=treeitem][aria-owns], [role=treeitem][data-requires-ajax=true]",CLOSED_GROUP:"[role=treeitem]:has([role=group])[aria-expanded=false], [role=treeitem][aria-owns][aria-expanded=false], [role=treeitem][data-requires-ajax=true][aria-expanded=false]",FIRST_ITEM:"[role=treeitem]:first",VISIBLE_ITEM:"[role=treeitem]:visible",UNLOADED_AJAX_ITEM:"[role=treeitem][data-requires-ajax=true][data-loaded=false][aria-expanded=true]"},Tree=function(selector,selectCallback){this.treeRoot=$(selector);this.treeRoot.data("activeItem",null);this.selectCallback=selectCallback;this.keys={tab:9,enter:13,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,asterisk:106};this.initialiseNodes(this.treeRoot);this.setActiveItem(this.treeRoot.find(SELECTORS.FIRST_ITEM));this.refreshVisibleItemsCache();this.bindEventHandlers()};Tree.prototype.registerEnterCallback=function(callback){this.enterCallback=callback};Tree.prototype.refreshVisibleItemsCache=function(){this.treeRoot.data("visibleItems",this.treeRoot.find(SELECTORS.VISIBLE_ITEM))};Tree.prototype.getVisibleItems=function(){return this.treeRoot.data("visibleItems")};Tree.prototype.setActiveItem=function(item){var currentActive=this.treeRoot.data("activeItem");if(item===currentActive){return}if(currentActive){currentActive.attr("tabindex","-1");currentActive.attr("aria-selected","false")}item.attr("tabindex","0");item.attr("aria-selected","true");this.treeRoot.data("activeItem",item);if("function"==typeof this.selectCallback){this.selectCallback(item)}};Tree.prototype.isGroupItem=function(item){return item.is(SELECTORS.GROUP)};Tree.prototype.getGroupFromItem=function(item){var ariaowns=this.treeRoot.find("#"+item.attr("aria-owns")),plain=item.children("[role=group]");if(ariaowns.length>plain.length){return ariaowns}else{return plain}};Tree.prototype.isGroupCollapsed=function(item){return"false"===item.attr("aria-expanded")};Tree.prototype.isGroupCollapsible=function(item){return"false"!==item.attr("data-collapsible")};Tree.prototype.initialiseNodes=function(node){this.removeAllFromTabOrder(node);this.setAriaSelectedFalseOnItems(node);var thisTree=this;node.find(SELECTORS.UNLOADED_AJAX_ITEM).each(function(){var unloadedNode=$(this);thisTree.collapseGroup(unloadedNode);thisTree.expandGroup(unloadedNode)})};Tree.prototype.removeAllFromTabOrder=function(node){node.find("*").attr("tabindex","-1");this.getGroupFromItem($(node)).find("*").attr("tabindex","-1")};Tree.prototype.setAriaSelectedFalseOnItems=function(node){node.find(SELECTORS.ITEM).attr("aria-selected","false")};Tree.prototype.expandAllGroups=function(){var thisTree=this;this.treeRoot.find(SELECTORS.CLOSED_GROUP).each(function(){var groupNode=$(this);thisTree.expandGroup($(this)).done(function(){thisTree.expandAllChildGroups(groupNode)})})};Tree.prototype.expandAllChildGroups=function(item){var thisTree=this;this.getGroupFromItem(item).find(SELECTORS.CLOSED_GROUP).each(function(){var groupNode=$(this);thisTree.expandGroup($(this)).done(function(){thisTree.expandAllChildGroups(groupNode)})})};Tree.prototype.expandGroup=function(item){var promise=$.Deferred();if("false"!==item.attr("data-expandable")&&this.isGroupCollapsed(item)){if("true"===item.attr("data-requires-ajax")&&"true"!==item.attr("data-loaded")){item.attr("data-loaded",!1);var moduleName=item.closest("[data-ajax-loader]").attr("data-ajax-loader"),thisTree=this,p=item.find("p");p.addClass("loading");require([moduleName],function(loader){loader.load(item).done(function(){item.attr("data-loaded",!0);thisTree.initialiseNodes(item);thisTree.finishExpandingGroup(item);p.removeClass("loading");promise.resolve()})})}else{this.finishExpandingGroup(item);promise.resolve()}}else{promise.resolve()}return promise};Tree.prototype.finishExpandingGroup=function(item){var group=this.getGroupFromItem(item);group.removeAttr("aria-hidden");item.attr("aria-expanded","true");this.refreshVisibleItemsCache()};Tree.prototype.collapseGroup=function(item){if(!this.isGroupCollapsible(item)||this.isGroupCollapsed(item)){return}var group=this.getGroupFromItem(item);group.attr("aria-hidden","true");item.attr("aria-expanded","false");this.refreshVisibleItemsCache()};Tree.prototype.toggleGroup=function(item){if("true"===item.attr("aria-expanded")){this.collapseGroup(item)}else{this.expandGroup(item)}};Tree.prototype.handleKeyDown=function(e){var _this$getVisibleItems,item=$(e.target),currentIndex=null===(_this$getVisibleItems=this.getVisibleItems())||void 0===_this$getVisibleItems?void 0:_this$getVisibleItems.index(item);if(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey&&e.keyCode!=this.keys.tab){return}switch(e.keyCode){case this.keys.home:{this.getVisibleItems().first().focus();e.preventDefault();return}case this.keys.end:{this.getVisibleItems().last().focus();e.preventDefault();return}case this.keys.enter:{var links=item.children("a").length?item.children("a"):item.children().not(SELECTORS.GROUP).find("a");if(links.length){if(links.first().data("overrides-tree-activation-key-handler")){links.first().triggerHandler(e)}else if("function"==typeof this.enterCallback){this.enterCallback(item)}else{window.location.href=links.first().attr("href")}}else if(this.isGroupItem(item)){this.toggleGroup(item,!0)}e.preventDefault();return}case this.keys.space:{if(this.isGroupItem(item)){this.toggleGroup(item,!0)}else if(item.children("a").length){var firstLink=item.children("a").first();if(firstLink.data("overrides-tree-activation-key-handler")){firstLink.triggerHandler(e)}}e.preventDefault();return}case this.keys.left:{var focusParent=function(tree){tree.getVisibleItems().filter(function(){return tree.getGroupFromItem($(this)).has(item).length}).focus()};if(this.isGroupItem(item)){if(this.isGroupCollapsed(item)){focusParent(this)}else{this.collapseGroup(item)}}else{focusParent(this)}e.preventDefault();return}case this.keys.right:{if(this.isGroupItem(item)){if(this.isGroupCollapsed(item)){this.expandGroup(item)}else{this.getGroupFromItem(item).find(SELECTORS.ITEM).first().focus()}}e.preventDefault();return}case this.keys.up:{if(0<currentIndex){var prev=this.getVisibleItems().eq(currentIndex-1);prev.focus()}e.preventDefault();return}case this.keys.down:{if(currentIndex<this.getVisibleItems().length-1){var next=this.getVisibleItems().eq(currentIndex+1);next.focus()}e.preventDefault();return}case this.keys.asterisk:{this.expandAllGroups();e.preventDefault()}}};Tree.prototype.handleClick=function(e){if(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey){return}var item=$(e.target).closest("[role=\"treeitem\"]");if(!item.is(e.currentTarget)){return}item.focus();if(this.isGroupItem(item)){this.toggleGroup(item)}};Tree.prototype.handleFocus=function(e){this.setActiveItem($(e.target))};Tree.prototype.bindEventHandlers=function(){this.treeRoot.on({click:this.handleClick.bind(this),keydown:this.handleKeyDown.bind(this),focus:this.handleFocus.bind(this)},SELECTORS.ITEM)};return Tree});
//# sourceMappingURL=tree.min.js.map
