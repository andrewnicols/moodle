define ("core_backup/async_backup",["jquery","core/ajax","core/str","core/notification","core/templates"],function($,ajax,Str,notification,Templates){var STATUS_FINISHED_ERR=900,STATUS_FINISHED_OK=1e3,Asyncbackup={},checkdelayoriginal=15e3,checkdelay=15e3,checkdelaymultipler=1.5,backupid,contextid,restoreurl,typeid,backupintervalid,allbackupintervalid,allcopyintervalid,timeout=2e3;function updateElement(backupid,type,percentage){var percentagewidth=Math.round(percentage)+"%",elementbar=document.querySelectorAll("[data-"+type+"id="+CSS.escape(backupid)+"]")[0],percentagetext=percentage.toFixed(2)+"%";elementbar.setAttribute("aria-valuenow",percentagewidth);elementbar.style.width=percentagewidth;elementbar.innerHTML=percentagetext}function updateInterval(intervalid,callback,value){clearInterval(intervalid);return setInterval(callback,value)}function updateBackupTableRow(backupid){var statuscell=$("#"+backupid+"_bar").parent().parent(),tablerow=statuscell.parent(),cellsiblings=statuscell.siblings(),timecell=cellsiblings[1],timevalue=$(timecell).text(),filenamecell=cellsiblings[0],filename=$(filenamecell).text();ajax.call([{methodname:"core_backup_get_async_backup_links_backup",args:{filename:filename,contextid:contextid}}])[0].done(function(response){var context={filename:filename,time:timevalue,size:response.filesize,fileurl:response.fileurl,restoreurl:response.restoreurl};Templates.render("core/async_backup_progress_row",context).then(function(html,js){Templates.replaceNodeContents(tablerow,html,js)}).fail(function(){notification.exception(new Error("Failed to load table row"))})})}function updateRestoreTableRow(backupid){var statuscell=$("#"+backupid+"_bar").parent().parent(),tablerow=statuscell.parent(),cellsiblings=statuscell.siblings(),coursecell=cellsiblings[0],timecell=cellsiblings[1],timevalue=$(timecell).text();ajax.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:backupid,contextid:contextid}}])[0].done(function(response){var resourcename=$(coursecell).text(),context={resourcename:resourcename,restoreurl:response.restoreurl,time:timevalue};Templates.render("core/async_restore_progress_row",context).then(function(html,js){Templates.replaceNodeContents(tablerow,html,js)}).fail(function(){notification.exception(new Error("Failed to load table row"))})})}function updateCopyTableRow(backupid){var elementbar=document.querySelectorAll("[data-restoreid="+CSS.escape(backupid)+"]")[0],restorecourse=elementbar.closest("tr").children[1],coursename=restorecourse.innerHTML,courselink=document.createElement("a"),elementbarparent=elementbar.closest("td"),operation=elementbarparent.previousElementSibling;Str.get_string("complete").then(function(content){operation.innerHTML=content}).catch(function(){notification.exception(new Error("Failed to load string: complete"))});Templates.render("core/async_copy_complete_cell",{}).then(function(html,js){Templates.replaceNodeContents(elementbarparent,html,js)}).fail(function(){notification.exception(new Error("Failed to load table cell"))});ajax.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:backupid,contextid:0}}])[0].done(function(response){courselink.setAttribute("href",response.restoreurl);courselink.innerHTML=coursename;restorecourse.innerHTML=null;restorecourse.appendChild(courselink)}).fail(function(){notification.exception(new Error("Failed to update table row"))})}function updateProgress(progress){var percentage=100*progress.progress,type="backup",elementbar=document.querySelectorAll("[data-"+type+"id="+CSS.escape(backupid)+"]")[0],elementstatus=$("#"+backupid+"_status"),elementdetail=$("#"+backupid+"_detail"),elementbutton=$("#"+backupid+"_button"),stringRequests;if(progress.status==800){elementbar.classList.add("bg-success");updateElement(backupid,type,percentage);var strProcessing="async"+typeid+"processing";Str.get_string(strProcessing,"backup").then(function(title){elementstatus.text(title)}).catch(function(){notification.exception(new Error("Failed to load string: backup "+strProcessing))})}else if(progress.status==STATUS_FINISHED_ERR){elementbar.classList.add("bg-danger");elementbar.classList.remove("bg-success");updateElement(backupid,type,100);var strStatus="async"+typeid+"error",strStatusDetail="async"+typeid+"errordetail";stringRequests=[{key:strStatus,component:"backup"},{key:strStatusDetail,component:"backup"}];Str.get_strings(stringRequests).then(function(strings){elementstatus.text(strings[0]);elementdetail.text(strings[1])}).catch(function(){notification.exception(new Error("Failed to load string"))});$(".backup_progress").children("span").removeClass("backup_stage_current");$(".backup_progress").children("span").last().addClass("backup_stage_current");clearInterval(backupintervalid)}else if(progress.status==STATUS_FINISHED_OK){elementbar.classList.add("bg-success");updateElement(backupid,type,100);var strComplete="async"+typeid+"complete";Str.get_string(strComplete,"backup").then(function(title){elementstatus.text(title)}).catch(function(){notification.exception(new Error("Failed to load string: backup "+strComplete))});if("restore"==typeid){ajax.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:backupid,contextid:contextid}}])[0].done(function(response){var strDetail="async"+typeid+"completedetail",strButton="async"+typeid+"completebutton",stringRequests=[{key:strDetail,component:"backup",param:response.restoreurl},{key:strButton,component:"backup"}];Str.get_strings(stringRequests).then(function(strings){elementdetail.html(strings[0]);elementbutton.text(strings[1]);elementbutton.attr("href",response.restoreurl)}).catch(function(){notification.exception(new Error("Failed to load string"))})})}else{var strDetail="async"+typeid+"completedetail",strButton="async"+typeid+"completebutton";stringRequests=[{key:strDetail,component:"backup",param:restoreurl},{key:strButton,component:"backup"}];Str.get_strings(stringRequests).then(function(strings){elementdetail.html(strings[0]);elementbutton.text(strings[1]);elementbutton.attr("href",restoreurl)}).catch(function(){notification.exception(new Error("Failed to load string"))})}$(".backup_progress").children("span").removeClass("backup_stage_current");$(".backup_progress").children("span").last().addClass("backup_stage_current");clearInterval(backupintervalid)}}function updateProgressAll(progress){progress.forEach(function(element){var percentage=100*element.progress,backupid=element.backupid,type=element.operation,elementbar=document.querySelectorAll("[data-"+type+"id="+CSS.escape(backupid)+"]")[0];if(element.status==800){elementbar.classList.add("bg-success");updateElement(backupid,type,percentage)}else if(element.status==STATUS_FINISHED_ERR){elementbar.classList.add("bg-danger");elementbar.classList.add("complete");elementbar.classList.remove("bg-success");updateElement(backupid,type,100)}else if(element.status==STATUS_FINISHED_OK){elementbar.classList.add("bg-success");elementbar.classList.add("complete");updateElement(backupid,type,100);if("backup"==type){updateBackupTableRow(backupid)}else{updateRestoreTableRow(backupid)}}})}function updateProgressCopy(progress){progress.forEach(function(element){var percentage=100*element.progress,backupid=element.backupid,type=element.operation,elementbar=document.querySelectorAll("[data-"+type+"id="+CSS.escape(backupid)+"]")[0];if("restore"==type){let restorecell=elementbar.closest("tr").children[3];Str.get_string("restore").then(function(content){restorecell.innerHTML=content}).catch(function(){notification.exception(new Error("Failed to load string: restore"))})}if(element.status==800){elementbar.classList.add("bg-success");updateElement(backupid,type,percentage)}else if(element.status==STATUS_FINISHED_ERR){elementbar.classList.add("bg-danger");elementbar.classList.add("complete");elementbar.classList.remove("bg-success");updateElement(backupid,type,100)}else if(element.status==STATUS_FINISHED_OK&&"restore"==type){elementbar.classList.add("bg-success");elementbar.classList.add("complete");updateElement(backupid,type,100);updateCopyTableRow(backupid)}})}function getBackupProgress(){ajax.call([{methodname:"core_backup_get_async_backup_progress",args:{backupids:[backupid],contextid:contextid}}],!0,!0,!1,timeout)[0].done(function(response){updateProgress(response[0]);checkdelay=checkdelayoriginal;backupintervalid=updateInterval(backupintervalid,getBackupProgress,checkdelayoriginal)}).fail(function(){checkdelay=checkdelay*checkdelaymultipler;backupintervalid=updateInterval(backupintervalid,getBackupProgress,checkdelay)})}function getAllBackupProgress(){var backupids=[],progressbars=$(".progress").find(".progress-bar").not(".complete");progressbars.each(function(){backupids.push(this.id.substring(0,32))});if(0<backupids.length){ajax.call([{methodname:"core_backup_get_async_backup_progress",args:{backupids:backupids,contextid:contextid}}],!0,!0,!1,timeout)[0].done(function(response){updateProgressAll(response);checkdelay=checkdelayoriginal;allbackupintervalid=updateInterval(allbackupintervalid,getAllBackupProgress,checkdelayoriginal)}).fail(function(){checkdelay=checkdelay*checkdelaymultipler;allbackupintervalid=updateInterval(allbackupintervalid,getAllBackupProgress,checkdelay)})}else{clearInterval(allbackupintervalid)}}function getAllCopyProgress(){var copyids=[],progressbars=$(".progress").find(".progress-bar[data-operation][data-backupid][data-restoreid]").not(".complete");progressbars.each(function(){let progressvars={backupid:this.dataset.backupid,restoreid:this.dataset.restoreid,operation:this.dataset.operation};copyids.push(progressvars)});if(0<copyids.length){ajax.call([{methodname:"core_backup_get_copy_progress",args:{copies:copyids}}],!0,!0,!1,timeout)[0].done(function(response){updateProgressCopy(response);checkdelay=checkdelayoriginal;allcopyintervalid=updateInterval(allcopyintervalid,getAllCopyProgress,checkdelayoriginal)}).fail(function(){checkdelay=checkdelay*checkdelaymultipler;allcopyintervalid=updateInterval(allcopyintervalid,getAllCopyProgress,checkdelay)})}else{clearInterval(allcopyintervalid)}}Asyncbackup.asyncBackupAllStatus=function(context){contextid=context;allbackupintervalid=setInterval(getAllBackupProgress,checkdelay)};Asyncbackup.asyncCopyAllStatus=function(){allcopyintervalid=setInterval(getAllCopyProgress,checkdelay)};Asyncbackup.asyncBackupStatus=function(backup,context,restore,type){backupid=backup;contextid=context;restoreurl=restore;if("backup"==type){typeid="backup"}else{typeid="restore"}$(".backup_progress").children("a").removeAttr("href");backupintervalid=setInterval(getBackupProgress,checkdelay)};return Asyncbackup});
//# sourceMappingURL=async_backup.min.js.map
