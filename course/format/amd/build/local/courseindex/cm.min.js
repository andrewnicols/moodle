define ("core_courseformat/local/courseindex/cm",["exports","core_courseformat/local/courseeditor/dndcmitem","core/templates","core/prefetch","core/config"],function(_exports,_dndcmitem,_templates,_prefetch,_config){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.default=void 0;_dndcmitem=_interopRequireDefault(_dndcmitem);_templates=_interopRequireDefault(_templates);_prefetch=_interopRequireDefault(_prefetch);_config=_interopRequireDefault(_config);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const completionTemplate="core_courseformat/local/courseindex/cmcompletion";_prefetch.default.prefetchTemplate(completionTemplate);class Component extends _dndcmitem.default{create(){this.name="courseindex_cm";this.selectors={CM_NAME:"[data-for='cm_name']",CM_COMPLETION:"[data-for='cm_completion']"};this.classes={CMHIDDEN:"dimmed",LOCKED:"editinprogress",RESTRICTIONS:"rectrictions",PAGEITEM:"pageitem"};this.id=this.element.dataset.id}static init(target,selectors){return new Component({element:document.getElementById(target),selectors})}stateReady(state){this.configDragDrop(this.id);const cm=state.cm.get(this.id),course=state.course;this._refreshCompletion({state,element:cm});if(window.location.href==cm.url||window.location.href=="".concat(course.baseurl,"#").concat(cm.anchor)){this.reactive.dispatch("setPageItem","cm",this.id);this.element.scrollIntoView({block:"center"})}if(_config.default.contextid!=_config.default.courseContextId&&_config.default.contextInstanceId==this.id){this.reactive.dispatch("setPageItem","cm",this.id,!0);this.element.scrollIntoView({block:"center"})}if(!cm.uservisible){this.addEventListener(this.getElement(this.selectors.CM_NAME),"click",this._activityAnchor)}}getWatchers(){return[{watch:"cm[".concat(this.id,"]:deleted"),handler:this.remove},{watch:"cm[".concat(this.id,"]:updated"),handler:this._refreshCm},{watch:"cm[".concat(this.id,"].completionstate:updated"),handler:this._refreshCompletion},{watch:"course.pageItem:updated",handler:this._refreshPageItem}]}_refreshCm(_ref){var _element$dragging,_element$locked,_element$hascmrectric;let{element}=_ref;this.element.classList.toggle(this.classes.CMHIDDEN,!element.visible);this.getElement(this.selectors.CM_NAME).innerHTML=element.name;this.element.classList.toggle(this.classes.DRAGGING,null!==(_element$dragging=element.dragging)&&void 0!==_element$dragging?_element$dragging:!1);this.element.classList.toggle(this.classes.LOCKED,null!==(_element$locked=element.locked)&&void 0!==_element$locked?_element$locked:!1);this.element.classList.toggle(this.classes.RESTRICTIONS,null!==(_element$hascmrectric=element.hascmrectrictions)&&void 0!==_element$hascmrectric?_element$hascmrectric:!1);this.locked=element.locked}_refreshPageItem(_ref2){let{element}=_ref2;if(!element.pageItem){return}const isPageId="cm"==element.pageItem.type&&element.pageItem.id==this.id;this.element.classList.toggle(this.classes.PAGEITEM,isPageId);if(isPageId&&!this.reactive.isEditing){this.element.scrollIntoView({block:"nearest"})}}async _refreshCompletion(_ref3){let{state,element}=_ref3;if(this.reactive.isEditing||!element.istrackeduser){return}const completionElement=this.getElement(this.selectors.CM_COMPLETION);if(completionElement.dataset.value==element.completionstate){return}const exporter=this.reactive.getExporter(),data=exporter.cmCompletion(state,element);try{const{html,js}=await _templates.default.renderForPromise(completionTemplate,data);_templates.default.replaceNode(completionElement,html,js)}catch(error){throw error}}_activityAnchor(event){const cm=this.reactive.get("cm",this.id),element=document.getElementById(cm.anchor);if(element){setTimeout(()=>{this.reactive.dispatch("setPageItem","cm",cm.id)},50);return}const course=this.reactive.get("course"),section=this.reactive.get("section",cm.sectionid);if(!section){return}const url="".concat(course.baseurl,"&section=").concat(section.number,"#").concat(cm.anchor);event.preventDefault();window.location=url}}_exports.default=Component;return _exports.default});
//# sourceMappingURL=cm.min.js.map
