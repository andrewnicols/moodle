define ("core_courseformat/local/content",["exports","core/reactive","core_courseformat/courseeditor","core/inplace_editable","core_courseformat/local/content/section","core_courseformat/local/content/section/cmitem","core_course/actions","core_courseformat/local/content/actions","core_course/events"],function(_exports,_reactive,_courseeditor,_inplace_editable,_section,_cmitem,_actions,_actions2,CourseEvents){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.default=void 0;_inplace_editable=_interopRequireDefault(_inplace_editable);_section=_interopRequireDefault(_section);_cmitem=_interopRequireDefault(_cmitem);_actions=_interopRequireDefault(_actions);_actions2=_interopRequireDefault(_actions2);CourseEvents=_interopRequireWildcard(CourseEvents);function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!=typeof obj&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}class Component extends _reactive.BaseComponent{create(descriptor){var _descriptor$sectionRe;this.name="course_format";this.selectors={SECTION:"[data-for='section']",SECTION_ITEM:"[data-for='section_title']",SECTION_CMLIST:"[data-for='cmlist']",COURSE_SECTIONLIST:"[data-for='course_sectionlist']",CM:"[data-for='cmitem']",PAGE:"#page",TOGGLER:"[data-action=\"togglecoursecontentsection\"]",COLLAPSE:"[data-toggle=\"collapse\"]",TOGGLEALL:"[data-toggle=\"toggleall\"]",ACTIVITYTAG:"li",SECTIONTAG:"li"};this.classes={COLLAPSED:"collapsed",ACTIVITY:"activity",STATEDREADY:"stateready",SECTION:"section"};this.dettachedCms={};this.dettachedSections={};this.sections={};this.cms={};this.sectionReturn=null!==(_descriptor$sectionRe=descriptor.sectionReturn)&&void 0!==_descriptor$sectionRe?_descriptor$sectionRe:0}static init(target,selectors,sectionReturn){return new Component({element:document.getElementById(target),reactive:(0,_courseeditor.getCurrentCourseEditor)(),selectors,sectionReturn})}stateReady(state){this._indexContents();this.addEventListener(this.element,"click",this._sectionTogglers);const toogleAll=this.getElement(this.selectors.TOGGLEALL);if(toogleAll){this.addEventListener(toogleAll,"click",this._allSectionToggler);this._refreshAllSectionsToggler(state)}if(this.reactive.supportComponents){if(this.reactive.isEditing){new _actions2.default(this)}this.element.classList.add(this.classes.STATEDREADY)}this.addEventListener(this.element,CourseEvents.manualCompletionToggled,this._completionHandler);this.addEventListener(document.querySelector(this.selectors.PAGE),"scroll",this._scrollHandler)}_sectionTogglers(event){const sectionlink=event.target.closest(this.selectors.TOGGLER),isChevron=event.target.closest(this.selectors.COLLAPSE);if(sectionlink||isChevron){var _toggler$classList$co;const section=event.target.closest(this.selectors.SECTION),toggler=section.querySelector(this.selectors.COLLAPSE),isCollapsed=null!==(_toggler$classList$co=null===toggler||void 0===toggler?void 0:toggler.classList.contains(this.classes.COLLAPSED))&&void 0!==_toggler$classList$co?_toggler$classList$co:!1;if(isChevron||isCollapsed){const sectionId=section.getAttribute("data-id");this.reactive.dispatch("sectionPreferences",[sectionId],{contentcollapsed:!isCollapsed})}}}_allSectionToggler(event){var _course$sectionlist;event.preventDefault();const target=event.target.closest(this.selectors.TOGGLEALL),isAllCollapsed=target.classList.contains(this.classes.COLLAPSED),course=this.reactive.get("course");this.reactive.dispatch("sectionPreferences",null!==(_course$sectionlist=course.sectionlist)&&void 0!==_course$sectionlist?_course$sectionlist:[],{contentcollapsed:!isAllCollapsed})}getWatchers(){this.reactive.sectionReturn=this.sectionReturn;if(!this.reactive.supportComponents){return[]}return[{watch:"cm.visible:updated",handler:this._reloadCm},{watch:"section.number:updated",handler:this._refreshSectionNumber},{watch:"section.contentcollapsed:updated",handler:this._refreshSectionCollapsed},{watch:"transaction:start",handler:this._startProcessing},{watch:"course.sectionlist:updated",handler:this._refreshCourseSectionlist},{watch:"section.cmlist:updated",handler:this._refreshSectionCmlist},{watch:"state:updated",handler:this._indexContents},{watch:"cm.visible:updated",handler:this._reloadCm},{watch:"cm.sectionid:updated",handler:this._reloadCm}]}_refreshSectionCollapsed(_ref){var _toggler$classList$co2;let{state,element}=_ref;const target=this.getElement(this.selectors.SECTION,element.id);if(!target){throw new Error("Unknown section with ID ".concat(element.id))}const toggler=target.querySelector(this.selectors.COLLAPSE),isCollapsed=null!==(_toggler$classList$co2=null===toggler||void 0===toggler?void 0:toggler.classList.contains(this.classes.COLLAPSED))&&void 0!==_toggler$classList$co2?_toggler$classList$co2:!1;if(element.contentcollapsed!==isCollapsed){toggler.click()}this._refreshAllSectionsToggler(state)}_refreshAllSectionsToggler(state){const target=this.getElement(this.selectors.TOGGLEALL);if(!target){return}let allcollapsed=!0,allexpanded=!0;state.section.forEach(section=>{allcollapsed=allcollapsed&&section.contentcollapsed;allexpanded=allexpanded&&!section.contentcollapsed});if(allcollapsed){target.classList.add(this.classes.COLLAPSED)}if(allexpanded){target.classList.remove(this.classes.COLLAPSED)}}_startProcessing(){this.dettachedCms={};this.dettachedSections={}}_completionHandler(_ref2){let{detail}=_ref2;if(detail===void 0){return}this.reactive.dispatch("cmCompletion",[detail.cmid],detail.completed)}_scrollHandler(){const pageOffset=document.querySelector(this.selectors.PAGE).scrollTop,items=this.reactive.getExporter().allItemsArray(this.reactive.state);let pageItem=null;items.every(item=>{const index="section"===item.type?this.sections:this.cms;if(index[item.id]===void 0){return!0}const element=index[item.id].element;if("cm"===item.type&&!item.url&&!this.reactive.isEditing){return pageOffset>=element.offsetTop}pageItem=item;return pageOffset>=element.offsetTop});if(pageItem){this.reactive.dispatch("setPageItem",pageItem.type,pageItem.id)}}_refreshSectionNumber(_ref3){let{element}=_ref3;const target=this.getElement(this.selectors.SECTION,element.id);if(!target){return}target.id="section-".concat(element.number);target.dataset.sectionid=element.number;target.dataset.number=element.number;const inplace=_inplace_editable.default.getInplaceEditable(target.querySelector(this.selectors.SECTION_ITEM));if(inplace){const currentvalue=inplace.getValue(),currentitemid=inplace.getItemId();if(""===inplace.getValue()){if(currentitemid==element.id&&(currentvalue!=element.rawtitle||""==element.rawtitle)){inplace.setValue(element.rawtitle)}}}}_refreshSectionCmlist(_ref4){var _element$cmlist;let{element}=_ref4;const cmlist=null!==(_element$cmlist=element.cmlist)&&void 0!==_element$cmlist?_element$cmlist:[],section=this.getElement(this.selectors.SECTION,element.id),listparent=null===section||void 0===section?void 0:section.querySelector(this.selectors.SECTION_CMLIST),createCm=this._createCmItem.bind(this);if(listparent){this._fixOrder(listparent,cmlist,this.selectors.CM,this.dettachedCms,createCm)}}_refreshCourseSectionlist(_ref5){var _element$sectionlist;let{element}=_ref5;if(0!=this.reactive.sectionReturn){return}const sectionlist=null!==(_element$sectionlist=element.sectionlist)&&void 0!==_element$sectionlist?_element$sectionlist:[],listparent=this.getElement(this.selectors.COURSE_SECTIONLIST),createSection=this._createSectionItem.bind(this);if(listparent){this._fixOrder(listparent,sectionlist,this.selectors.SECTION,this.dettachedSections,createSection)}}_indexContents(){this._scanIndex(this.selectors.SECTION,this.sections,item=>{return new _section.default(item)});this._scanIndex(this.selectors.CM,this.cms,item=>{return new _cmitem.default(item)})}_scanIndex(selector,index,creationhandler){const items=this.getElements("".concat(selector,":not([data-indexed])"));items.forEach(item=>{var _item$dataset;if(!(null!==item&&void 0!==item&&null!==(_item$dataset=item.dataset)&&void 0!==_item$dataset&&_item$dataset.id)){return}if(index[item.dataset.id]!==void 0){index[item.dataset.id].unregister()}index[item.dataset.id]=creationhandler({...this,element:item});item.dataset.indexed=!0})}_reloadCm(_ref6){let{element}=_ref6;const cmitem=this.getElement(this.selectors.CM,element.id);if(cmitem){const promise=_actions.default.refreshModule(cmitem,element.id);promise.then(()=>{this._indexContents()}).catch()}}_reloadSection(_ref7){let{element}=_ref7;const sectionitem=this.getElement(this.selectors.SECTION,element.id);if(sectionitem){const promise=_actions.default.refreshSection(sectionitem,element.id);promise.then(()=>{this._indexContents()}).catch()}}_createCmItem(container,cmid){const newItem=document.createElement(this.selectors.ACTIVITYTAG);newItem.dataset.for="cmitem";newItem.dataset.id=cmid;newItem.id="module-".concat(cmid);newItem.classList.add(this.classes.ACTIVITY);container.append(newItem);this._reloadCm({element:this.reactive.get("cm",cmid)});return newItem}_createSectionItem(container,sectionid){const section=this.reactive.get("section",sectionid),newItem=document.createElement(this.selectors.SECTIONTAG);newItem.dataset.for="section";newItem.dataset.id=sectionid;newItem.dataset.number=section.number;newItem.id="section-".concat(sectionid);newItem.classList.add(this.classes.SECTION);container.append(newItem);this._reloadSection({element:section});return newItem}async _fixOrder(container,neworder,selector,dettachedelements,createMethod){if(container===void 0){return}if(!neworder.length){container.classList.add("hidden");container.innerHTML="";return}container.classList.remove("hidden");neworder.forEach((itemid,index)=>{var _ref8,_this$getElement;let item=null!==(_ref8=null!==(_this$getElement=this.getElement(selector,itemid))&&void 0!==_this$getElement?_this$getElement:dettachedelements[itemid])&&void 0!==_ref8?_ref8:createMethod(container,itemid);if(item===void 0){return}const currentitem=container.children[index];if(currentitem===void 0){container.append(item);return}if(currentitem!==item){container.insertBefore(item,currentitem)}});let dndFakeActivity;while(container.children.length>neworder.length){var _lastchild$classList;const lastchild=container.lastChild;if(null!==lastchild&&void 0!==lastchild&&null!==(_lastchild$classList=lastchild.classList)&&void 0!==_lastchild$classList&&_lastchild$classList.contains("dndupload-preview")){dndFakeActivity=lastchild}else{var _lastchild$dataset$id,_lastchild$dataset;dettachedelements[null!==(_lastchild$dataset$id=null===lastchild||void 0===lastchild?void 0:null===(_lastchild$dataset=lastchild.dataset)||void 0===_lastchild$dataset?void 0:_lastchild$dataset.id)&&void 0!==_lastchild$dataset$id?_lastchild$dataset$id:0]=lastchild}container.removeChild(lastchild)}if(dndFakeActivity){container.append(dndFakeActivity)}}}_exports.default=Component;return _exports.default});
//# sourceMappingURL=content.min.js.map
