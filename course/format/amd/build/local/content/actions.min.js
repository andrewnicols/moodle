function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define ("core_courseformat/local/content/actions",["exports","core/reactive","core/modal_factory","core/modal_events","core/templates","core/prefetch","core/str","core/normalise","core_course/events","core/pending","core_courseformat/local/courseeditor/contenttree","jquery"],function(_exports,_reactive,_modal_factory,_modal_events,_templates,_prefetch,_str,_normalise,CourseEvents,_pending,_contenttree,_jquery){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.default=void 0;_modal_factory=_interopRequireDefault(_modal_factory);_modal_events=_interopRequireDefault(_modal_events);_templates=_interopRequireDefault(_templates);CourseEvents=_interopRequireWildcard(CourseEvents);_pending=_interopRequireDefault(_pending);_contenttree=_interopRequireDefault(_contenttree);_jquery=_interopRequireDefault(_jquery);function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)})}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0,descriptor;i<props.length;i++){descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1;descriptor.configurable=!0;if("value"in descriptor)descriptor.writable=!0;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:!1});return Constructor}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}});Object.defineProperty(subClass,"prototype",{writable:!1});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call)){return call}else if(void 0!==call){throw new TypeError("Derived constructors may only return object or undefined")}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(void 0===self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return!0}catch(e){return!1}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}(0,_prefetch.prefetchStrings)("core",["movecoursesection","movecoursemodule","confirm","delete"]);var _default=function(_BaseComponent){_inherits(_default,_BaseComponent);var _super=_createSuper(_default);function _default(){_classCallCheck(this,_default);return _super.apply(this,arguments)}_createClass(_default,[{key:"create",value:function create(){this.name="content_actions";this.selectors={ACTIONLINK:"[data-action]",SECTIONLINK:"[data-for='section']",CMLINK:"[data-for='cm']",SECTIONNODE:"[data-for='sectionnode']",MODALTOGGLER:"[data-toggle='collapse']",ADDSECTION:"[data-action='addSection']",CONTENTTREE:"#destination-selector",ACTIONMENU:".action-menu",ACTIONMENUTOGGLER:"[data-toggle=\"dropdown\"]"};this.classes={DISABLED:"disabled"}}},{key:"stateReady",value:function stateReady(state){var _this=this;this.addEventListener(this.element,"click",this._dispatchClick);this._checkSectionlist({state:state});this.addEventListener(this.element,CourseEvents.sectionRefreshed,function(){return _this._checkSectionlist({state:state})})}},{key:"getWatchers",value:function getWatchers(){return[{watch:"course.sectionlist:updated",handler:this._checkSectionlist}]}},{key:"_dispatchClick",value:function _dispatchClick(event){var target=event.target.closest(this.selectors.ACTIONLINK);if(!target){return}if(target.classList.contains(this.classes.DISABLED)){event.preventDefault();return}var methodName=this._actionMethodName(target.dataset.action);if(this[methodName]!==void 0){this[methodName](target,event)}}},{key:"_actionMethodName",value:function _actionMethodName(name){var requestName=name.charAt(0).toUpperCase()+name.slice(1);return"_request".concat(requestName)}},{key:"_checkSectionlist",value:function _checkSectionlist(_ref){var state=_ref.state;this._setAddSectionLocked(state.course.sectionlist.length>state.course.maxsections)}},{key:"_requestMoveSection",value:function(){var _requestMoveSection2=_asyncToGenerator(regeneratorRuntime.mark(function _callee(target,event){var _this2=this,sectionId,sectionInfo,editTools,exporter,data,modalParams,modal,modalBody,currentElement,generalSection;return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:sectionId=target.dataset.id;if(sectionId){_context.next=3;break}return _context.abrupt("return");case 3:sectionInfo=this.reactive.get("section",sectionId);event.preventDefault();editTools=this._getClosestActionMenuToogler(target);exporter=this.reactive.getExporter();data=exporter.course(this.reactive.state);data.sectionid=sectionInfo.id;data.sectiontitle=sectionInfo.title;modalParams={title:(0,_str.get_string)("movecoursesection","core"),body:_templates.default.render("core_courseformat/local/content/movesection",data)};_context.next=13;return this._modalBodyRenderedPromise(modalParams);case 13:modal=_context.sent;modalBody=(0,_normalise.getList)(modal.getBody())[0];currentElement=modalBody.querySelector("".concat(this.selectors.SECTIONLINK,"[data-id='").concat(sectionId,"']"));this._disableLink(currentElement);generalSection=modalBody.querySelector("".concat(this.selectors.SECTIONLINK,"[data-number='0']"));this._disableLink(generalSection);new _contenttree.default(modalBody.querySelector(this.selectors.CONTENTTREE),{SECTION:this.selectors.SECTIONNODE,TOGGLER:this.selectors.MODALTOGGLER,COLLAPSE:this.selectors.MODALTOGGLER},!0);modalBody.addEventListener("click",function(event){var target=event.target;if(!target.matches("a")||"section"!=target.dataset.for||target.dataset.id===void 0){return}if(target.getAttribute("aria-disabled")){return}event.preventDefault();_this2.reactive.dispatch("sectionMove",[sectionId],target.dataset.id);_this2._destroyModal(modal,editTools)});case 21:case"end":return _context.stop();}}},_callee,this)}));return function _requestMoveSection(){return _requestMoveSection2.apply(this,arguments)}}()},{key:"_requestMoveCm",value:function(){var _requestMoveCm2=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(target,event){var _toggler$data,_this3=this,cmId,cmInfo,editTools,exporter,data,modalParams,modal,modalBody,currentElement,sectionnode,toggler,collapsibleId;return regeneratorRuntime.wrap(function(_context2){while(1){switch(_context2.prev=_context2.next){case 0:cmId=target.dataset.id;if(cmId){_context2.next=3;break}return _context2.abrupt("return");case 3:cmInfo=this.reactive.get("cm",cmId);event.preventDefault();editTools=this._getClosestActionMenuToogler(target);exporter=this.reactive.getExporter();data=exporter.course(this.reactive.state);data.cmid=cmInfo.id;data.cmname=cmInfo.name;modalParams={title:(0,_str.get_string)("movecoursemodule","core"),body:_templates.default.render("core_courseformat/local/content/movecm",data)};_context2.next=13;return this._modalBodyRenderedPromise(modalParams);case 13:modal=_context2.sent;modalBody=(0,_normalise.getList)(modal.getBody())[0];currentElement=modalBody.querySelector("".concat(this.selectors.CMLINK,"[data-id='").concat(cmId,"']"));this._disableLink(currentElement);new _contenttree.default(modalBody.querySelector(this.selectors.CONTENTTREE),{SECTION:this.selectors.SECTIONNODE,TOGGLER:this.selectors.MODALTOGGLER,COLLAPSE:this.selectors.MODALTOGGLER,ENTER:this.selectors.SECTIONLINK});sectionnode=currentElement.closest(this.selectors.SECTIONNODE);toggler=(0,_jquery.default)(sectionnode).find(this.selectors.MODALTOGGLER);collapsibleId=null!==(_toggler$data=toggler.data("target"))&&void 0!==_toggler$data?_toggler$data:toggler.attr("href");if(collapsibleId){collapsibleId=collapsibleId.replace("#","");(0,_jquery.default)("#".concat(collapsibleId)).collapse("toggle")}modalBody.addEventListener("click",function(event){var target=event.target;if(!target.matches("a")||target.dataset.for===void 0||target.dataset.id===void 0){return}if(target.getAttribute("aria-disabled")){return}event.preventDefault();var targetSectionId,targetCmId;if("cm"==target.dataset.for){var dropData=exporter.cmDraggableData(_this3.reactive.state,target.dataset.id);targetSectionId=dropData.sectionid;targetCmId=dropData.nextcmid}else{var section=_this3.reactive.get("section",target.dataset.id);targetSectionId=target.dataset.id;targetCmId=null===section||void 0===section?void 0:section.cmlist[0]}_this3.reactive.dispatch("cmMove",[cmId],targetSectionId,targetCmId);_this3._destroyModal(modal,editTools)});case 23:case"end":return _context2.stop();}}},_callee2,this)}));return function _requestMoveCm(){return _requestMoveCm2.apply(this,arguments)}}()},{key:"_requestAddSection",value:function(){var _requestAddSection2=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(target,event){var _target$dataset$id;return regeneratorRuntime.wrap(function(_context3){while(1){switch(_context3.prev=_context3.next){case 0:event.preventDefault();this.reactive.dispatch("addSection",null!==(_target$dataset$id=target.dataset.id)&&void 0!==_target$dataset$id?_target$dataset$id:0);case 2:case"end":return _context3.stop();}}},_callee3,this)}));return function _requestAddSection(){return _requestAddSection2.apply(this,arguments)}}()},{key:"_requestDeleteSection",value:function(){var _requestDeleteSection2=_asyncToGenerator(regeneratorRuntime.mark(function _callee4(target,event){var _sectionInfo$cmlist,_this4=this,sectionId,sectionInfo,cmList,modalParams,modal;return regeneratorRuntime.wrap(function(_context4){while(1){switch(_context4.prev=_context4.next){case 0:sectionId=target.dataset.id;if(sectionId){_context4.next=3;break}return _context4.abrupt("return");case 3:sectionInfo=this.reactive.get("section",sectionId);event.preventDefault();cmList=null!==(_sectionInfo$cmlist=sectionInfo.cmlist)&&void 0!==_sectionInfo$cmlist?_sectionInfo$cmlist:[];if(!(cmList.length||sectionInfo.hassummary||sectionInfo.rawtitle)){_context4.next=15;break}modalParams={title:(0,_str.get_string)("confirm","core"),body:(0,_str.get_string)("confirmdeletesection","moodle",sectionInfo.title),saveButtonText:(0,_str.get_string)("delete","core"),type:_modal_factory.default.types.SAVE_CANCEL};_context4.next=10;return this._modalBodyRenderedPromise(modalParams);case 10:modal=_context4.sent;modal.getRoot().on(_modal_events.default.save,function(e){e.preventDefault();modal.destroy();_this4.reactive.dispatch("sectionDelete",[sectionId])});return _context4.abrupt("return");case 15:this.reactive.dispatch("sectionDelete",[sectionId]);case 16:case"end":return _context4.stop();}}},_callee4,this)}));return function _requestDeleteSection(){return _requestDeleteSection2.apply(this,arguments)}}()},{key:"_setAddSectionLocked",value:function _setAddSectionLocked(locked){var _this5=this,targets=this.getElements(this.selectors.ADDSECTION);targets.forEach(function(element){element.classList.toggle(_this5.classes.DISABLED,locked);_this5.setElementLocked(element,locked)})}},{key:"_disableLink",value:function _disableLink(element){if(element){element.style.pointerEvents="none";element.style.userSelect="none";element.classList.add(this.classes.DISABLED);element.setAttribute("aria-disabled",!0);element.addEventListener("click",function(event){return event.preventDefault()})}}},{key:"_modalBodyRenderedPromise",value:function _modalBodyRenderedPromise(modalParams){return new Promise(function(resolve,reject){_modal_factory.default.create(modalParams).then(function(modal){modal.setRemoveOnClose(!0);modal.getRoot().on(_modal_events.default.bodyRendered,function(){resolve(modal)});if(modalParams.saveButtonText!==void 0){modal.setSaveButtonText(modalParams.saveButtonText)}modal.show()}).catch(function(){reject("Cannot load modal content")})})}},{key:"_destroyModal",value:function _destroyModal(modal,element){modal.hide();var pendingDestroy=new _pending.default("courseformat/actions:destroyModal");if(element){element.focus()}setTimeout(function(){modal.destroy();pendingDestroy.resolve()},500)}},{key:"_getClosestActionMenuToogler",value:function _getClosestActionMenuToogler(element){var actionMenu=element.closest(this.selectors.ACTIONMENU);if(!actionMenu){return}return actionMenu.querySelector(this.selectors.ACTIONMENUTOGGLER)}}]);return _default}(_reactive.BaseComponent);_exports.default=_default;return _exports.default});
//# sourceMappingURL=actions.min.js.map
