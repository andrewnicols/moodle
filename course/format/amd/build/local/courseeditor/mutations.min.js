define ("core_courseformat/local/courseeditor/mutations",["exports","core/ajax"],function(_exports,_ajax){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.default=void 0;_ajax=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(_ajax);function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)})}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0,descriptor;i<props.length;i++){descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1;descriptor.configurable=!0;if("value"in descriptor)descriptor.writable=!0;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:!1});return Constructor}var _default=function(){function _default(){_classCallCheck(this,_default)}_createClass(_default,[{key:"_callEditWebservice",value:function(){var _callEditWebservice2=_asyncToGenerator(regeneratorRuntime.mark(function _callee(action,courseId,ids,targetSectionId,targetCmId){var args,ajaxresult;return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:args={action:action,courseid:courseId,ids:ids};if(targetSectionId){args.targetsectionid=targetSectionId}if(targetCmId){args.targetcmid=targetCmId}_context.next=5;return _ajax.default.call([{methodname:"core_courseformat_update_course",args:args}])[0];case 5:ajaxresult=_context.sent;return _context.abrupt("return",JSON.parse(ajaxresult));case 7:case"end":return _context.stop();}}},_callee)}));return function _callEditWebservice(){return _callEditWebservice2.apply(this,arguments)}}()},{key:"init",value:function init(stateManager){stateManager.addUpdateTypes({prepareFields:this._prepareFields})}},{key:"_prepareFields",value:function _prepareFields(stateManager,updateName,fields){fields.locked=!1;return fields}},{key:"cmMove",value:function(){var _cmMove=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(stateManager,cmids,targetSectionId,targetCmId){var course,updates;return regeneratorRuntime.wrap(function(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!(!targetSectionId&&!targetCmId)){_context2.next=2;break}throw new Error("Mutation cmMove requires targetSectionId or targetCmId");case 2:course=stateManager.get("course");this.cmLock(stateManager,cmids,!0);_context2.next=6;return this._callEditWebservice("cm_move",course.id,cmids,targetSectionId,targetCmId);case 6:updates=_context2.sent;stateManager.processUpdates(updates);this.cmLock(stateManager,cmids,!1);case 9:case"end":return _context2.stop();}}},_callee2,this)}));return function cmMove(){return _cmMove.apply(this,arguments)}}()},{key:"sectionMove",value:function(){var _sectionMove=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(stateManager,sectionIds,targetSectionId){var course,updates;return regeneratorRuntime.wrap(function(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(targetSectionId){_context3.next=2;break}throw new Error("Mutation sectionMove requires targetSectionId");case 2:course=stateManager.get("course");this.sectionLock(stateManager,sectionIds,!0);_context3.next=6;return this._callEditWebservice("section_move",course.id,sectionIds,targetSectionId);case 6:updates=_context3.sent;stateManager.processUpdates(updates);this.sectionLock(stateManager,sectionIds,!1);case 9:case"end":return _context3.stop();}}},_callee3,this)}));return function sectionMove(){return _sectionMove.apply(this,arguments)}}()},{key:"addSection",value:function(){var _addSection=_asyncToGenerator(regeneratorRuntime.mark(function _callee4(stateManager,targetSectionId){var course,updates;return regeneratorRuntime.wrap(function(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!targetSectionId){targetSectionId=0}course=stateManager.get("course");_context4.next=4;return this._callEditWebservice("section_add",course.id,[],targetSectionId);case 4:updates=_context4.sent;stateManager.processUpdates(updates);case 6:case"end":return _context4.stop();}}},_callee4,this)}));return function addSection(){return _addSection.apply(this,arguments)}}()},{key:"sectionDelete",value:function(){var _sectionDelete=_asyncToGenerator(regeneratorRuntime.mark(function _callee5(stateManager,sectionIds){var course,updates;return regeneratorRuntime.wrap(function(_context5){while(1){switch(_context5.prev=_context5.next){case 0:course=stateManager.get("course");_context5.next=3;return this._callEditWebservice("section_delete",course.id,sectionIds);case 3:updates=_context5.sent;stateManager.processUpdates(updates);case 5:case"end":return _context5.stop();}}},_callee5,this)}));return function sectionDelete(){return _sectionDelete.apply(this,arguments)}}()},{key:"cmDrag",value:function cmDrag(stateManager,cmIds,dragValue){this.setPageItem(stateManager);this._setElementsValue(stateManager,"cm",cmIds,"dragging",dragValue)}},{key:"sectionDrag",value:function sectionDrag(stateManager,sectionIds,dragValue){this.setPageItem(stateManager);this._setElementsValue(stateManager,"section",sectionIds,"dragging",dragValue)}},{key:"cmCompletion",value:function cmCompletion(stateManager,cmIds,complete){var newValue=complete?1:0;this._setElementsValue(stateManager,"cm",cmIds,"completionstate",newValue)}},{key:"cmLock",value:function cmLock(stateManager,cmIds,lockValue){this._setElementsValue(stateManager,"cm",cmIds,"locked",lockValue)}},{key:"sectionLock",value:function sectionLock(stateManager,sectionIds,lockValue){this._setElementsValue(stateManager,"section",sectionIds,"locked",lockValue)}},{key:"_setElementsValue",value:function _setElementsValue(stateManager,name,ids,fieldName,newValue){stateManager.setReadOnly(!1);ids.forEach(function(id){var element=stateManager.get(name,id);if(element){element[fieldName]=newValue}});stateManager.setReadOnly(!0)}},{key:"setPageItem",value:function setPageItem(stateManager,type,id,isStatic){var newPageItem;if(type!==void 0){newPageItem=stateManager.get(type,id);if(!newPageItem){return}}stateManager.setReadOnly(!1);var course=stateManager.get("course");course.pageItem=null;if(newPageItem){course.pageItem={id:id,type:type,sectionId:"section"==type?newPageItem.id:newPageItem.sectionid,isStatic:isStatic}}stateManager.setReadOnly(!0)}},{key:"unlockAll",value:function unlockAll(stateManager){var state=stateManager.state;stateManager.setReadOnly(!1);state.section.forEach(function(section){section.locked=!1});state.cm.forEach(function(cm){cm.locked=!1});stateManager.setReadOnly(!0)}},{key:"sectionPreferences",value:function(){var _sectionPreferences=_asyncToGenerator(regeneratorRuntime.mark(function _callee6(stateManager,sectionIds,preferences){var updatePreferences,course,state,prefKey,_preferences,jsonString;return regeneratorRuntime.wrap(function(_context6){while(1){switch(_context6.prev=_context6.next){case 0:stateManager.setReadOnly(!1);updatePreferences=!1;sectionIds.forEach(function(sectionId){var _preferences$contentc,_preferences$indexcol,section=stateManager.get("section",sectionId);if(section===void 0){return}var newValue=null!==(_preferences$contentc=preferences.contentcollapsed)&&void 0!==_preferences$contentc?_preferences$contentc:section.contentcollapsed;if(section.contentcollapsed!=newValue){section.contentcollapsed=newValue;updatePreferences=!0}newValue=null!==(_preferences$indexcol=preferences.indexcollapsed)&&void 0!==_preferences$indexcol?_preferences$indexcol:section.indexcollapsed;if(section.indexcollapsed!=newValue){section.indexcollapsed=newValue;updatePreferences=!0}});stateManager.setReadOnly(!0);if(updatePreferences){course=stateManager.get("course");state=stateManager.state;prefKey="coursesectionspreferences_".concat(course.id);_preferences={contentcollapsed:[],indexcollapsed:[]};state.section.forEach(function(section){if(section.contentcollapsed){_preferences.contentcollapsed.push(section.id)}if(section.indexcollapsed){_preferences.indexcollapsed.push(section.id)}});jsonString=JSON.stringify(_preferences);M.util.set_user_preference(prefKey,jsonString)}case 5:case"end":return _context6.stop();}}},_callee6)}));return function sectionPreferences(){return _sectionPreferences.apply(this,arguments)}}()},{key:"cmState",value:function(){var _cmState=_asyncToGenerator(regeneratorRuntime.mark(function _callee7(stateManager,cmids){var course,updates;return regeneratorRuntime.wrap(function(_context7){while(1){switch(_context7.prev=_context7.next){case 0:this.cmLock(stateManager,cmids,!0);course=stateManager.get("course");_context7.next=4;return this._callEditWebservice("cm_state",course.id,cmids);case 4:updates=_context7.sent;stateManager.processUpdates(updates);this.cmLock(stateManager,cmids,!1);case 7:case"end":return _context7.stop();}}},_callee7,this)}));return function cmState(){return _cmState.apply(this,arguments)}}()},{key:"sectionState",value:function(){var _sectionState=_asyncToGenerator(regeneratorRuntime.mark(function _callee8(stateManager,sectionIds){var course,updates;return regeneratorRuntime.wrap(function(_context8){while(1){switch(_context8.prev=_context8.next){case 0:this.sectionLock(stateManager,sectionIds,!0);course=stateManager.get("course");_context8.next=4;return this._callEditWebservice("section_state",course.id,sectionIds);case 4:updates=_context8.sent;stateManager.processUpdates(updates);this.sectionLock(stateManager,sectionIds,!1);case 7:case"end":return _context8.stop();}}},_callee8,this)}));return function sectionState(){return _sectionState.apply(this,arguments)}}()},{key:"courseState",value:function(){var _courseState=_asyncToGenerator(regeneratorRuntime.mark(function _callee9(stateManager){var course,updates;return regeneratorRuntime.wrap(function(_context9){while(1){switch(_context9.prev=_context9.next){case 0:course=stateManager.get("course");_context9.next=3;return this._callEditWebservice("course_state",course.id);case 3:updates=_context9.sent;stateManager.processUpdates(updates);case 5:case"end":return _context9.stop();}}},_callee9,this)}));return function courseState(){return _courseState.apply(this,arguments)}}()}]);return _default}();_exports.default=_default;return _exports.default});
//# sourceMappingURL=mutations.min.js.map
