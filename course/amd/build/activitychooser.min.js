function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define ("core_course/activitychooser",["exports","core_course/local/activitychooser/dialogue","core_course/local/activitychooser/repository","core_course/local/activitychooser/selectors","core/custom_interaction_events","core/templates","core/modal_factory","core/str","core/pending"],function(_exports,ChooserDialogue,Repository,_selectors,_custom_interaction_events,Templates,ModalFactory,_str,_pending){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.init=void 0;ChooserDialogue=_interopRequireWildcard(ChooserDialogue);Repository=_interopRequireWildcard(Repository);_selectors=_interopRequireDefault(_selectors);_custom_interaction_events=_interopRequireDefault(_custom_interaction_events);Templates=_interopRequireWildcard(Templates);ModalFactory=_interopRequireWildcard(ModalFactory);_pending=_interopRequireDefault(_pending);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)})}}var ACTIVITIESRESOURCES=2,init=function(courseId,chooserConfig){var pendingPromise=new _pending.default;registerListenerEvents(courseId,chooserConfig);pendingPromise.resolve()};_exports.init=init;var registerListenerEvents=function(courseId,chooserConfig){var events=["click",_custom_interaction_events.default.events.activate,_custom_interaction_events.default.events.keyboardActivate],fetchModuleData=function(){var innerPromise=null;return function(){if(!innerPromise){innerPromise=new Promise(function(resolve){resolve(Repository.activityModules(courseId))})}return innerPromise}}(),fetchFooterData=function(){var footerInnerPromise=null;return function(sectionId){if(!footerInnerPromise){footerInnerPromise=new Promise(function(resolve){resolve(Repository.fetchFooterData(courseId,sectionId))})}return footerInnerPromise}}();_custom_interaction_events.default.define(document,events);events.forEach(function(event){document.addEventListener(event,function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(e){var caller,sectionDiv,button,bodyPromiseResolver,bodyPromise,footerData,sectionModal,data,builtModuleData;return regeneratorRuntime.wrap(function(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!e.target.closest(_selectors.default.elements.sectionmodchooser)){_context2.next=21;break}sectionDiv=e.target.closest(_selectors.default.elements.section);button=e.target.closest(_selectors.default.elements.sectionmodchooser);if(null!==sectionDiv&&sectionDiv.hasAttribute("data-sectionid")){caller=sectionDiv}else{caller=button}bodyPromise=new Promise(function(resolve){bodyPromiseResolver=resolve});_context2.next=7;return fetchFooterData(caller.dataset.sectionid);case 7:footerData=_context2.sent;sectionModal=buildModal(bodyPromise,footerData);_context2.next=11;return fetchModuleData().catch(function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee(e){var errorTemplateData;return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:errorTemplateData={errormessage:e.message};_context.t0=bodyPromiseResolver;_context.next=4;return Templates.render("core_course/local/activitychooser/error",errorTemplateData);case 4:_context.t1=_context.sent;(0,_context.t0)(_context.t1);case 6:case"end":return _context.stop();}}},_callee)}));return function(){return _ref2.apply(this,arguments)}}());case 11:data=_context2.sent;if(data){_context2.next=14;break}return _context2.abrupt("return");case 14:builtModuleData=sectionIdMapper(data,caller.dataset.sectionid,caller.dataset.sectionreturnid);ChooserDialogue.displayChooser(sectionModal,builtModuleData,partiallyAppliedFavouriteManager(data,caller.dataset.sectionid),footerData);_context2.t0=bodyPromiseResolver;_context2.next=19;return Templates.render("core_course/activitychooser",templateDataBuilder(builtModuleData,chooserConfig));case 19:_context2.t1=_context2.sent;(0,_context2.t0)(_context2.t1);case 21:case"end":return _context2.stop();}}},_callee2)}));return function(){return _ref.apply(this,arguments)}}())})},sectionIdMapper=function(webServiceData,id,sectionreturnid){var newData=JSON.parse(JSON.stringify(webServiceData));newData.content_items.forEach(function(module){module.link+="&section="+id+"&sr="+(null!==sectionreturnid&&void 0!==sectionreturnid?sectionreturnid:0)});return newData.content_items},templateDataBuilder=function(data,chooserConfig){var activities=[],resources=[],showAll=!0,showActivities=!1,showResources=!1,tabMode=parseInt(chooserConfig.tabmode),favourites=data.filter(function(mod){return!0===mod.favourite}),recommended=data.filter(function(mod){return!0===mod.recommended});if((tabMode===0||tabMode===ACTIVITIESRESOURCES)&&tabMode!==1){activities=data.filter(function(mod){return mod.archetype===0});resources=data.filter(function(mod){return mod.archetype===1});showActivities=!0;showResources=!0;if(tabMode===ACTIVITIESRESOURCES){showAll=!1}}var favouritesFirst=!!favourites.length,activitiesFirst=!1===showAll&&!1===favouritesFirst,fallback=!0===showAll&&!1===favouritesFirst;return{default:data,showAll:showAll,activities:activities,showActivities:showActivities,activitiesFirst:activitiesFirst,resources:resources,showResources:showResources,favourites:favourites,recommended:recommended,favouritesFirst:favouritesFirst,fallback:fallback}},buildModal=function(bodyPromise,footer){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:(0,_str.get_string)("addresourceoractivity"),body:bodyPromise,footer:footer.customfootertemplate,large:!0,scrollable:!1,templateContext:{classes:"modchooser"}}).then(function(modal){modal.show();return modal})},nullFavouriteDomManager=function(favouriteTabNav,modalBody){favouriteTabNav.tabIndex=-1;favouriteTabNav.classList.add("d-none");if(favouriteTabNav.classList.contains("active")){favouriteTabNav.classList.remove("active");favouriteTabNav.setAttribute("aria-selected","false");var favouriteTab=modalBody.querySelector(_selectors.default.regions.favouriteTab);favouriteTab.classList.remove("active");var defaultTabNav=modalBody.querySelector(_selectors.default.regions.defaultTabNav),activitiesTabNav=modalBody.querySelector(_selectors.default.regions.activityTabNav);if(!1===defaultTabNav.classList.contains("d-none")){defaultTabNav.classList.add("active");defaultTabNav.setAttribute("aria-selected","true");defaultTabNav.tabIndex=0;defaultTabNav.focus();var defaultTab=modalBody.querySelector(_selectors.default.regions.defaultTab);defaultTab.classList.add("active")}else{activitiesTabNav.classList.add("active");activitiesTabNav.setAttribute("aria-selected","true");activitiesTabNav.tabIndex=0;activitiesTabNav.focus();var activitiesTab=modalBody.querySelector(_selectors.default.regions.activityTab);activitiesTab.classList.add("active")}}},partiallyAppliedFavouriteManager=function(moduleData,sectionId){return function(){var _ref3=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(internal,favourite,modalBody){var favouriteArea,favouriteButtons,favouriteTabNav,result,newFaves,builtFaves,_yield$Templates$rend,html,js,nodeToRemove,_newFaves;return regeneratorRuntime.wrap(function(_context3){while(1){switch(_context3.prev=_context3.next){case 0:favouriteArea=modalBody.querySelector(_selectors.default.render.favourites);favouriteButtons=modalBody.querySelectorAll("[data-internal=\"".concat(internal,"\"] ").concat(_selectors.default.actions.optionActions.manageFavourite));favouriteTabNav=modalBody.querySelector(_selectors.default.regions.favouriteTabNav);result=moduleData.content_items.find(function(_ref4){var name=_ref4.name;return name===internal});newFaves={};if(!result){_context3.next=27;break}if(!favourite){_context3.next=21;break}result.favourite=!0;newFaves.content_items=moduleData.content_items.filter(function(mod){return!0===mod.favourite});builtFaves=sectionIdMapper(newFaves,sectionId);_context3.next=12;return Templates.renderForPromise("core_course/local/activitychooser/favourites",{favourites:builtFaves});case 12:_yield$Templates$rend=_context3.sent;html=_yield$Templates$rend.html;js=_yield$Templates$rend.js;_context3.next=17;return Templates.replaceNodeContents(favouriteArea,html,js);case 17:Array.from(favouriteButtons).forEach(function(element){element.classList.remove("text-muted");element.classList.add("text-primary");element.dataset.favourited="true";element.setAttribute("aria-pressed",!0);element.firstElementChild.classList.remove("fa-star-o");element.firstElementChild.classList.add("fa-star")});favouriteTabNav.classList.remove("d-none");_context3.next=27;break;case 21:result.favourite=!1;nodeToRemove=favouriteArea.querySelector("[data-internal=\"".concat(internal,"\"]"));nodeToRemove.parentNode.removeChild(nodeToRemove);Array.from(favouriteButtons).forEach(function(element){element.classList.add("text-muted");element.classList.remove("text-primary");element.dataset.favourited="false";element.setAttribute("aria-pressed",!1);element.firstElementChild.classList.remove("fa-star");element.firstElementChild.classList.add("fa-star-o")});_newFaves=moduleData.content_items.filter(function(mod){return!0===mod.favourite});if(0===_newFaves.length){nullFavouriteDomManager(favouriteTabNav,modalBody)}case 27:case"end":return _context3.stop();}}},_callee3)}));return function(){return _ref3.apply(this,arguments)}}()}});
//# sourceMappingURL=activitychooser.min.js.map
