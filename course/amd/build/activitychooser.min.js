define ("core_course/activitychooser",["exports","core_course/local/activitychooser/dialogue","core_course/local/activitychooser/repository","core_course/local/activitychooser/selectors","core/custom_interaction_events","core/templates","core/modal_factory","core/str","core/pending"],function(_exports,ChooserDialogue,Repository,_selectors,_custom_interaction_events,Templates,ModalFactory,_str,_pending){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.init=void 0;ChooserDialogue=_interopRequireWildcard(ChooserDialogue);Repository=_interopRequireWildcard(Repository);_selectors=_interopRequireDefault(_selectors);_custom_interaction_events=_interopRequireDefault(_custom_interaction_events);Templates=_interopRequireWildcard(Templates);ModalFactory=_interopRequireWildcard(ModalFactory);_pending=_interopRequireDefault(_pending);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!=typeof obj&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}const ACTIVITIESRESOURCES=2,init=(courseId,chooserConfig)=>{const pendingPromise=new _pending.default;registerListenerEvents(courseId,chooserConfig);pendingPromise.resolve()};_exports.init=init;const registerListenerEvents=(courseId,chooserConfig)=>{const events=["click",_custom_interaction_events.default.events.activate,_custom_interaction_events.default.events.keyboardActivate],fetchModuleData=(()=>{let innerPromise=null;return()=>{if(!innerPromise){innerPromise=new Promise(resolve=>{resolve(Repository.activityModules(courseId))})}return innerPromise}})(),fetchFooterData=(()=>{let footerInnerPromise=null;return sectionId=>{if(!footerInnerPromise){footerInnerPromise=new Promise(resolve=>{resolve(Repository.fetchFooterData(courseId,sectionId))})}return footerInnerPromise}})();_custom_interaction_events.default.define(document,events);events.forEach(event=>{document.addEventListener(event,async e=>{if(e.target.closest(_selectors.default.elements.sectionmodchooser)){let caller;const sectionDiv=e.target.closest(_selectors.default.elements.section),button=e.target.closest(_selectors.default.elements.sectionmodchooser);if(null!==sectionDiv&&sectionDiv.hasAttribute("data-sectionid")){caller=sectionDiv}else{caller=button}let bodyPromiseResolver;const bodyPromise=new Promise(resolve=>{bodyPromiseResolver=resolve}),footerData=await fetchFooterData(caller.dataset.sectionid),sectionModal=buildModal(bodyPromise,footerData),data=await fetchModuleData().catch(async e=>{const errorTemplateData={errormessage:e.message};bodyPromiseResolver(await Templates.render("core_course/local/activitychooser/error",errorTemplateData))});if(!data){return}const builtModuleData=sectionIdMapper(data,caller.dataset.sectionid,caller.dataset.sectionreturnid);ChooserDialogue.displayChooser(sectionModal,builtModuleData,partiallyAppliedFavouriteManager(data,caller.dataset.sectionid),footerData);bodyPromiseResolver(await Templates.render("core_course/activitychooser",templateDataBuilder(builtModuleData,chooserConfig)))}})})},sectionIdMapper=(webServiceData,id,sectionreturnid)=>{const newData=JSON.parse(JSON.stringify(webServiceData));newData.content_items.forEach(module=>{module.link+="&section="+id+"&sr="+(null!==sectionreturnid&&void 0!==sectionreturnid?sectionreturnid:0)});return newData.content_items},templateDataBuilder=(data,chooserConfig)=>{let activities=[],resources=[],showAll=!0,showActivities=!1,showResources=!1;const tabMode=parseInt(chooserConfig.tabmode),favourites=data.filter(mod=>!0===mod.favourite),recommended=data.filter(mod=>!0===mod.recommended);if((tabMode===0||tabMode===ACTIVITIESRESOURCES)&&tabMode!==1){activities=data.filter(mod=>mod.archetype===0);resources=data.filter(mod=>mod.archetype===1);showActivities=!0;showResources=!0;if(tabMode===ACTIVITIESRESOURCES){showAll=!1}}const favouritesFirst=!!favourites.length,activitiesFirst=!1===showAll&&!1===favouritesFirst,fallback=!0===showAll&&!1===favouritesFirst;return{default:data,showAll:showAll,activities:activities,showActivities:showActivities,activitiesFirst:activitiesFirst,resources:resources,showResources:showResources,favourites:favourites,recommended:recommended,favouritesFirst:favouritesFirst,fallback:fallback}},buildModal=(bodyPromise,footer)=>{return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:(0,_str.get_string)("addresourceoractivity"),body:bodyPromise,footer:footer.customfootertemplate,large:!0,scrollable:!1,templateContext:{classes:"modchooser"}}).then(modal=>{modal.show();return modal})},nullFavouriteDomManager=(favouriteTabNav,modalBody)=>{favouriteTabNav.tabIndex=-1;favouriteTabNav.classList.add("d-none");if(favouriteTabNav.classList.contains("active")){favouriteTabNav.classList.remove("active");favouriteTabNav.setAttribute("aria-selected","false");const favouriteTab=modalBody.querySelector(_selectors.default.regions.favouriteTab);favouriteTab.classList.remove("active");const defaultTabNav=modalBody.querySelector(_selectors.default.regions.defaultTabNav),activitiesTabNav=modalBody.querySelector(_selectors.default.regions.activityTabNav);if(!1===defaultTabNav.classList.contains("d-none")){defaultTabNav.classList.add("active");defaultTabNav.setAttribute("aria-selected","true");defaultTabNav.tabIndex=0;defaultTabNav.focus();const defaultTab=modalBody.querySelector(_selectors.default.regions.defaultTab);defaultTab.classList.add("active")}else{activitiesTabNav.classList.add("active");activitiesTabNav.setAttribute("aria-selected","true");activitiesTabNav.tabIndex=0;activitiesTabNav.focus();const activitiesTab=modalBody.querySelector(_selectors.default.regions.activityTab);activitiesTab.classList.add("active")}}},partiallyAppliedFavouriteManager=(moduleData,sectionId)=>{return async(internal,favourite,modalBody)=>{const favouriteArea=modalBody.querySelector(_selectors.default.render.favourites),favouriteButtons=modalBody.querySelectorAll("[data-internal=\"".concat(internal,"\"] ").concat(_selectors.default.actions.optionActions.manageFavourite)),favouriteTabNav=modalBody.querySelector(_selectors.default.regions.favouriteTabNav),result=moduleData.content_items.find(_ref=>{let{name}=_ref;return name===internal}),newFaves={};if(result){if(favourite){result.favourite=!0;newFaves.content_items=moduleData.content_items.filter(mod=>!0===mod.favourite);const builtFaves=sectionIdMapper(newFaves,sectionId),{html,js}=await Templates.renderForPromise("core_course/local/activitychooser/favourites",{favourites:builtFaves});await Templates.replaceNodeContents(favouriteArea,html,js);Array.from(favouriteButtons).forEach(element=>{element.classList.remove("text-muted");element.classList.add("text-primary");element.dataset.favourited="true";element.setAttribute("aria-pressed",!0);element.firstElementChild.classList.remove("fa-star-o");element.firstElementChild.classList.add("fa-star")});favouriteTabNav.classList.remove("d-none")}else{result.favourite=!1;const nodeToRemove=favouriteArea.querySelector("[data-internal=\"".concat(internal,"\"]"));nodeToRemove.parentNode.removeChild(nodeToRemove);Array.from(favouriteButtons).forEach(element=>{element.classList.add("text-muted");element.classList.remove("text-primary");element.dataset.favourited="false";element.setAttribute("aria-pressed",!1);element.firstElementChild.classList.remove("fa-star");element.firstElementChild.classList.add("fa-star-o")});const newFaves=moduleData.content_items.filter(mod=>!0===mod.favourite);if(0===newFaves.length){nullFavouriteDomManager(favouriteTabNav,modalBody)}}}}}});
//# sourceMappingURL=activitychooser.min.js.map
