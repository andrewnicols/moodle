define ("core_course/actions",["jquery","core/ajax","core/templates","core/notification","core/str","core/url","core/yui","core/modal_factory","core/modal_events","core/key_codes","core/log","core_courseformat/courseeditor","core/event_dispatcher","core_course/events"],function($,ajax,templates,notification,str,url,Y,ModalFactory,ModalEvents,KeyCodes,log,editor,EventDispatcher,CourseEvents){const componentActions=["moveSection","moveCm","addSection","deleteSection"],courseeditor=editor.getCurrentCourseEditor();let formatname;var CSS={EDITINPROGRESS:"editinprogress",SECTIONDRAGGABLE:"sectiondraggable",EDITINGMOVE:"editing_move"},SELECTOR={ACTIVITYLI:"li.activity",ACTIONAREA:".actions",ACTIVITYACTION:"a.cm-edit-action",MENU:".moodle-actionmenu[data-enhance=moodle-core-actionmenu]",TOGGLE:".toggle-display,.dropdown-toggle",SECTIONLI:"li.section",SECTIONACTIONMENU:".section_action_menu",ADDSECTIONS:".changenumsections [data-add-sections]",SECTIONBADGES:"[data-region=\"sectionbadges\"]"};Y.use("moodle-course-coursebase",function(){var courseformatselector=M.course.format.get_section_selector();if(courseformatselector){SELECTOR.SECTIONLI=courseformatselector}});const dispatchEvent=function(eventName,detail,container,options){if(!(container instanceof Element)&&container.get!==void 0){container=container.get(0)}return EventDispatcher.dispatchEvent(eventName,detail,container,options)};var getModuleId=function(element){const item=element.get(0);if(item.dataset.id){return item.dataset.id}let id;Y.use("moodle-course-util",function(Y){id=Y.Moodle.core_course.util.cm.getId(Y.Node(item))});return id},getModuleName=function(element){var name;Y.use("moodle-course-util",function(Y){name=Y.Moodle.core_course.util.cm.getName(Y.Node(element.get(0)))});const state=courseeditor.state,cmid=getModuleId(element);if(!name&&state&&cmid){var _state$cm$get;name=null===(_state$cm$get=state.cm.get(cmid))||void 0===_state$cm$get?void 0:_state$cm$get.name}return name},addActivitySpinner=function(activity){activity.addClass(CSS.EDITINPROGRESS);var actionarea=activity.find(SELECTOR.ACTIONAREA).get(0);if(actionarea){var spinner=M.util.add_spinner(Y,Y.Node(actionarea));spinner.show();if(activity.data("id")!==void 0){courseeditor.dispatch("cmLock",[activity.data("id")],!0)}return spinner}return null},addSectionSpinner=function(sectionelement){sectionelement.addClass(CSS.EDITINPROGRESS);var actionarea=sectionelement.find(SELECTOR.SECTIONACTIONMENU).get(0);if(actionarea){var spinner=M.util.add_spinner(Y,Y.Node(actionarea));spinner.show();if(sectionelement.data("id")!==void 0){courseeditor.dispatch("sectionLock",[sectionelement.data("id")],!0)}return spinner}return null},addSectionLightbox=function(sectionelement){const item=sectionelement.get(0);var lightbox=M.util.add_lightbox(Y,Y.Node(item));if("section"==item.dataset.for&&item.dataset.id){courseeditor.dispatch("sectionLock",[item.dataset.id],!0);lightbox.setAttribute("data-state","section");lightbox.setAttribute("data-state-id",item.dataset.id)}lightbox.show();return lightbox},removeSpinner=function(element,spinner,delay){window.setTimeout(function(){element.removeClass(CSS.EDITINPROGRESS);if(spinner){spinner.hide()}if(element.data("id")!==void 0){const mutation="section"===element.data("for")?"sectionLock":"cmLock";courseeditor.dispatch(mutation,[element.data("id")],!1)}},delay)},removeLightbox=function(lightbox,delay){if(lightbox){window.setTimeout(function(){lightbox.hide();if(lightbox.getAttribute("data-state")){courseeditor.dispatch("".concat(lightbox.getAttribute("data-state"),"Lock"),[lightbox.getAttribute("data-state-id")],!1)}},delay)}},initActionMenu=function(elementid){Y.use("moodle-course-coursebase",function(){M.course.coursebase.invoke_function("setup_for_resource","#"+elementid)});if(M.core.actionmenu&&M.core.actionmenu.newDOMNode){M.core.actionmenu.newDOMNode(Y.one("#"+elementid))}},focusActionItem=function(elementId,action){var mainelement=$("#"+elementId),selector="[data-action="+action+"]";if("groupsseparate"===action||"groupsvisible"===action||"groupsnone"===action){selector="[data-action=groupsseparate],[data-action=groupsvisible],[data-action=groupsnone]"}if(mainelement.find(selector).is(":visible")){mainelement.find(selector).focus()}else{mainelement.find(SELECTOR.MENU).find(SELECTOR.TOGGLE).focus()}},findNextFocusable=function(mainElement){var tabables=$("a:visible"),isInside=!1,foundElement=null;tabables.each(function(){if($.contains(mainElement[0],this)){isInside=!0}else if(isInside){foundElement=this;return!1}return!0});return foundElement},editModule=function(moduleElement,cmid,target){var action=target.attr("data-action"),spinner=addActivitySpinner(moduleElement),promises=ajax.call([{methodname:"core_course_edit_module",args:{id:cmid,action:action,sectionreturn:target.attr("data-sectionreturn")?target.attr("data-sectionreturn"):0}}],!0),lightbox;if("duplicate"===action){lightbox=addSectionLightbox(target.closest(SELECTOR.SECTIONLI))}$.when.apply($,promises).done(function(data){var elementToFocus=findNextFocusable(moduleElement);moduleElement.replaceWith(data);let affectedids=[];$("<div>"+data+"</div>").find(SELECTOR.ACTIVITYLI).each(function(index){initActionMenu($(this).attr("id"));if(0===index){focusActionItem($(this).attr("id"),action);elementToFocus=null}affectedids.push(getModuleId($(this)))});if(elementToFocus){elementToFocus.focus()}removeSpinner(moduleElement,spinner,400);removeLightbox(lightbox,400);moduleElement.trigger($.Event("coursemoduleedited",{ajaxreturn:data,action:action}));courseeditor.dispatch("legacyActivityAction",action,cmid,affectedids)}).fail(function(ex){removeSpinner(moduleElement,spinner);removeLightbox(lightbox);var e=$.Event("coursemoduleeditfailed",{exception:ex,action:action});moduleElement.trigger(e);if(!e.isDefaultPrevented()){notification.exception(ex)}})},refreshModule=function(element,cmid,sectionreturn){if(sectionreturn===void 0){sectionreturn=courseeditor.sectionReturn}const activityElement=$(element);var spinner=addActivitySpinner(activityElement),promises=ajax.call([{methodname:"core_course_get_module",args:{id:cmid,sectionreturn:sectionreturn}}],!0);return new Promise((resolve,reject)=>{$.when.apply($,promises).done(function(data){removeSpinner(activityElement,spinner,400);replaceActivityHtmlWith(data);resolve(data)}).fail(function(){removeSpinner(activityElement,spinner);reject()})})},confirmDeleteModule=function(mainelement,onconfirm){var modtypename=mainelement.attr("class").match(/modtype_([^\s]*)/)[1],modulename=getModuleName(mainelement);str.get_string("pluginname",modtypename).done(function(pluginname){str.get_strings([{key:"confirm",component:"core"},{key:null===modulename?"deletechecktype":"deletechecktypename",param:{type:pluginname,name:modulename}},{key:"yes"},{key:"no"}]).done(function(s){notification.confirm(s[0],s[1],s[2],s[3],onconfirm)})})},confirmEditSection=function(message,onconfirm){str.get_strings([{key:"confirm"},{key:"yes"},{key:"no"}]).done(function(s){notification.confirm(s[0],message,s[1],s[2],onconfirm)})},replaceActionItem=function(actionitem,image,stringname,stringcomponent,newaction){return str.get_strings([{key:stringname,component:stringcomponent}]).then(function(strings){actionitem.find("span.menu-action-text").html(strings[0]);return templates.renderPix(image,"core")}).then(function(pixhtml){actionitem.find(".icon").replaceWith(pixhtml);actionitem.attr("data-action",newaction)}).catch(notification.exception)},defaultEditSectionHandler=function(sectionElement,actionItem,data,courseformat,sectionid){var action=actionItem.attr("data-action");if("hide"===action||"show"===action){if("hide"===action){sectionElement.addClass("hidden");setSectionBadge(sectionElement[0],"hiddenfromstudents",!0);replaceActionItem(actionItem,"i/show","showfromothers","format_"+courseformat,"show")}else{setSectionBadge(sectionElement[0],"hiddenfromstudents",!1);sectionElement.removeClass("hidden");replaceActionItem(actionItem,"i/hide","hidefromothers","format_"+courseformat,"hide")}if(data.modules!==void 0){for(var i in data.modules){replaceActivityHtmlWith(data.modules[i])}}if(data.section_availability!==void 0){sectionElement.find(".section_availability").first().replaceWith(data.section_availability)}const section=courseeditor.state.section.get(sectionid);if(section!==void 0){courseeditor.dispatch("sectionState",[sectionid])}}else if("setmarker"===action){var oldmarker=$(SELECTOR.SECTIONLI+".current"),oldActionItem=oldmarker.find(SELECTOR.SECTIONACTIONMENU+" a[data-action=removemarker]");oldmarker.removeClass("current");replaceActionItem(oldActionItem,"i/marker","highlight","core","setmarker");sectionElement.addClass("current");replaceActionItem(actionItem,"i/marked","highlightoff","core","removemarker");courseeditor.dispatch("legacySectionAction",action,sectionid);setSectionBadge(sectionElement[0],"highlighted",!0)}else if("removemarker"===action){sectionElement.removeClass("current");replaceActionItem(actionItem,"i/marker","highlight","core","setmarker");courseeditor.dispatch("legacySectionAction",action,sectionid);setSectionBadge(sectionElement[0],"highlighted",!1)}};const getActivityFocusedElement=function(id){const element=document.getElementById(id);if(!element||!element.contains(document.activeElement)){return}if(element.querySelector(SELECTOR.ACTIONAREA).contains(document.activeElement)){return"".concat(SELECTOR.ACTIONAREA," [tabindex=\"0\"]")}if(document.activeElement.id){return"#".concat(document.activeElement.id)}};var replaceActivityHtmlWith=function(activityHTML){$("<div>"+activityHTML+"</div>").find(SELECTOR.ACTIVITYLI).each(function(){var id=$(this).attr("id");let focusedPath=getActivityFocusedElement(id);$(SELECTOR.ACTIVITYLI+"#"+id).replaceWith(activityHTML);initActionMenu(id);if(focusedPath){var _newItem$querySelecto;const newItem=document.getElementById(id);null===(_newItem$querySelecto=newItem.querySelector(focusedPath))||void 0===_newItem$querySelecto?void 0:_newItem$querySelecto.focus()}})},editSection=function(sectionElement,sectionid,target,courseformat){var action=target.attr("data-action"),sectionreturn=target.attr("data-sectionreturn")?target.attr("data-sectionreturn"):0;if(courseeditor.supportComponents&&componentActions.includes(action)){return!1}var spinner=addSectionSpinner(sectionElement),promises=ajax.call([{methodname:"core_course_edit_section",args:{id:sectionid,action:action,sectionreturn:sectionreturn}}],!0),lightbox=addSectionLightbox(sectionElement);$.when.apply($,promises).done(function(dataencoded){var data=$.parseJSON(dataencoded);removeSpinner(sectionElement,spinner);removeLightbox(lightbox);sectionElement.find(SELECTOR.SECTIONACTIONMENU).find(SELECTOR.TOGGLE).focus();var e=$.Event("coursesectionedited",{ajaxreturn:data,action:action});sectionElement.trigger(e);if(!e.isDefaultPrevented()){defaultEditSectionHandler(sectionElement,target,data,courseformat,sectionid)}}).fail(function(ex){removeSpinner(sectionElement,spinner);removeLightbox(lightbox);var e=$.Event("coursesectioneditfailed",{exception:ex,action:action});sectionElement.trigger(e);if(!e.isDefaultPrevented()){notification.exception(ex)}});return!0},setSectionBadge=function(sectionElement,badgetype,add){const sectionbadges=sectionElement.querySelector(SELECTOR.SECTIONBADGES);if(!sectionbadges){return}if(add){templates.render("core_courseformat/local/content/section/badges",{[badgetype]:1}).then(function(html,js){templates.prependNodeContents(sectionbadges,html,js);return!0}).catch(notification.exception)}else{const badge=sectionbadges.querySelector("[data-type=\""+badgetype+"\"]");badge.remove()}};Y.use("moodle-course-coursebase",function(){M.course.coursebase.register_module({set_visibility_resource_ui:function(args){var mainelement=$(args.element.getDOMNode()),cmid=getModuleId(mainelement);if(cmid){var sectionreturn=mainelement.find("."+CSS.EDITINGMOVE).attr("data-sectionreturn");refreshModule(mainelement,cmid,sectionreturn)}},updateMovedCmState:params=>{const state=courseeditor.state,cm=state.cm.get(params.cmid);if(cm!==void 0){courseeditor.dispatch("sectionState",[cm.sectionid])}courseeditor.dispatch("cmState",[params.cmid])},updateMovedSectionState:()=>{courseeditor.dispatch("courseState")}})});courseeditor.addMutations({legacyActivityAction:function(statemanager,action,cmid,affectedids){const state=statemanager.state,cm=state.cm.get(cmid);if(cm===void 0){return}const section=state.section.get(cm.sectionid);if(section===void 0){return}courseeditor.dispatch("cmLock",[cm.id],!0);statemanager.setReadOnly(!1);cm.locked=!1;switch(action){case"delete":section.cmlist=section.cmlist.reduce((cmlist,current)=>{if(current!=cmid){cmlist.push(current)}return cmlist},[]);state.cm.delete(cmid);break;case"hide":case"show":cm.visible="show"===action?!0:!1;break;case"duplicate":courseeditor.dispatch("cmState",affectedids);break;}statemanager.setReadOnly(!0)},legacySectionAction:function(statemanager,action,sectionid){const state=statemanager.state,section=state.section.get(sectionid);if(section===void 0){return}statemanager.setReadOnly(!1);section.locked=!0;statemanager.setReadOnly(!0);statemanager.setReadOnly(!1);section.locked=!1;switch(action){case"setmarker":state.section.forEach(current=>{if(current.id!=sectionid){current.current=!1}});section.current=!0;break;case"removemarker":section.current=!1;break;}statemanager.setReadOnly(!0)}});return{initCoursePage:function(courseformat){formatname=courseformat;$("body").on("click keypress",SELECTOR.ACTIVITYLI+" "+SELECTOR.ACTIVITYACTION+"[data-action]",function(e){if("keypress"===e.type&&13!==e.keyCode){return}var actionItem=$(this),moduleElement=actionItem.closest(SELECTOR.ACTIVITYLI),action=actionItem.attr("data-action"),moduleId=getModuleId(moduleElement);switch(action){case"moveleft":case"moveright":case"delete":case"duplicate":case"hide":case"stealth":case"show":case"groupsseparate":case"groupsvisible":case"groupsnone":break;default:return;}if(!moduleId){return}e.preventDefault();if("delete"===action){confirmDeleteModule(moduleElement,function(){editModule(moduleElement,moduleId,actionItem)})}else{editModule(moduleElement,moduleId,actionItem)}});$("body").on("click keypress",SELECTOR.SECTIONLI+" "+SELECTOR.SECTIONACTIONMENU+"[data-sectionid] a[data-action]",function(e){if("keypress"===e.type&&13!==e.keyCode){return}var actionItem=$(this),sectionElement=actionItem.closest(SELECTOR.SECTIONLI),sectionId=actionItem.closest(SELECTOR.SECTIONACTIONMENU).attr("data-sectionid");let isExecuted=!0;if(actionItem.attr("data-confirm")){confirmEditSection(actionItem.attr("data-confirm"),function(){isExecuted=editSection(sectionElement,sectionId,actionItem,courseformat)})}else{isExecuted=editSection(sectionElement,sectionId,actionItem,courseformat)}if(isExecuted){e.preventDefault()}});$("body").on("updated","".concat(SELECTOR.SECTIONLI," [data-inplaceeditable]"),function(e){if(e.ajaxreturn&&e.ajaxreturn.itemid){const state=courseeditor.state,section=state.section.get(e.ajaxreturn.itemid);if(section!==void 0){courseeditor.dispatch("sectionState",[e.ajaxreturn.itemid])}}});$("body").on("updated","".concat(SELECTOR.ACTIVITYLI," [data-inplaceeditable]"),function(e){if(e.ajaxreturn&&e.ajaxreturn.itemid){courseeditor.dispatch("cmState",[e.ajaxreturn.itemid])}});if(courseeditor.supportComponents&&componentActions.includes("addSection")){return}str.get_string("numberweeks").done(function(strNumberSections){var trigger=$(SELECTOR.ADDSECTIONS),modalTitle=trigger.attr("data-add-sections"),newSections=trigger.attr("data-new-sections"),modalBody=$("<div><label for=\"add_section_numsections\"></label> <input id=\"add_section_numsections\" type=\"number\" min=\"1\" max=\""+newSections+"\" value=\"1\"></div>");modalBody.find("label").html(strNumberSections);ModalFactory.create({title:modalTitle,type:ModalFactory.types.SAVE_CANCEL,body:modalBody.html()},trigger).done(function(modal){var numSections=$(modal.getBody()).find("#add_section_numsections"),addSections=function(){if(""+parseInt(numSections.val())===numSections.val()&&1<=parseInt(numSections.val())){document.location=trigger.attr("href")+"&numsections="+parseInt(numSections.val())}};modal.setSaveButtonText(modalTitle);modal.getRoot().on(ModalEvents.shown,function(){numSections.focus().select().on("keydown",function(e){if(e.keyCode===KeyCodes.enter){addSections()}})});modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault();addSections()})})})},replaceSectionActionItem:function(sectionelement,selector,image,stringname,stringcomponent,newaction){log.debug("replaceSectionActionItem() is deprecated and will be removed.");var actionitem=sectionelement.find(SELECTOR.SECTIONACTIONMENU+" "+selector);replaceActionItem(actionitem,image,stringname,stringcomponent,newaction)},refreshModule,refreshSection:function(element,sectionid,sectionreturn){if(sectionreturn===void 0){sectionreturn=courseeditor.sectionReturn}const sectionElement=$(element),action="refresh",promises=ajax.call([{methodname:"core_course_edit_section",args:{id:sectionid,action,sectionreturn}}],!0);var spinner=addSectionSpinner(sectionElement);return new Promise((resolve,reject)=>{$.when.apply($,promises).done(dataencoded=>{removeSpinner(sectionElement,spinner);const data=$.parseJSON(dataencoded),newSectionElement=$(data.content);sectionElement.replaceWith(newSectionElement);$("".concat(SELECTOR.SECTIONLI,"#").concat(sectionid," ").concat(SELECTOR.ACTIVITYLI)).each((index,activity)=>{initActionMenu(activity.data("id"))});const event=dispatchEvent(CourseEvents.sectionRefreshed,{ajaxreturn:data,action:action,newSectionElement:newSectionElement.get(0)},newSectionElement);if(!event.defaultPrevented){defaultEditSectionHandler(newSectionElement,$(SELECTOR.SECTIONLI+"#"+sectionid),data,formatname,sectionid)}resolve(data)}).fail(ex=>{const event=dispatchEvent("coursesectionrefreshfailed",{exception:ex,action:action},sectionElement);if(!event.defaultPrevented){notification.exception(ex)}reject()})})}}});
//# sourceMappingURL=actions.min.js.map
