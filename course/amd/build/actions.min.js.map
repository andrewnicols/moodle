{"version":3,"sources":["../src/actions.js"],"names":["define","$","ajax","templates","notification","str","url","Y","ModalFactory","ModalEvents","KeyCodes","log","editor","EventDispatcher","CourseEvents","componentActions","courseeditor","getCurrentCourseEditor","formatname","CSS","EDITINPROGRESS","SECTIONDRAGGABLE","EDITINGMOVE","SELECTOR","ACTIVITYLI","ACTIONAREA","ACTIVITYACTION","MENU","TOGGLE","SECTIONLI","SECTIONACTIONMENU","ADDSECTIONS","SECTIONBADGES","use","courseformatselector","M","course","format","get_section_selector","dispatchEvent","eventName","detail","container","options","Element","get","getModuleId","element","item","dataset","id","Moodle","core_course","util","cm","getId","Node","getModuleName","name","getName","state","cmid","addActivitySpinner","activity","addClass","actionarea","find","spinner","add_spinner","show","data","dispatch","addSectionSpinner","sectionelement","addSectionLightbox","lightbox","add_lightbox","for","setAttribute","removeSpinner","delay","window","setTimeout","removeClass","hide","mutation","removeLightbox","getAttribute","initActionMenu","elementid","coursebase","invoke_function","core","actionmenu","newDOMNode","one","focusActionItem","elementId","action","mainelement","selector","is","focus","findNextFocusable","mainElement","tabables","isInside","foundElement","each","contains","editModule","moduleElement","target","attr","promises","call","methodname","args","sectionreturn","closest","when","apply","done","elementToFocus","replaceWith","affectedids","index","push","trigger","Event","ajaxreturn","fail","ex","e","exception","isDefaultPrevented","refreshModule","sectionReturn","activityElement","Promise","resolve","reject","replaceActivityHtmlWith","confirmDeleteModule","onconfirm","modtypename","match","modulename","get_string","pluginname","get_strings","key","component","param","type","s","confirm","confirmEditSection","message","replaceActionItem","actionitem","image","stringname","stringcomponent","newaction","then","strings","html","renderPix","pixhtml","catch","defaultEditSectionHandler","sectionElement","actionItem","courseformat","sectionid","setSectionBadge","modules","i","section_availability","first","section","oldmarker","oldActionItem","getActivityFocusedElement","document","getElementById","activeElement","querySelector","activityHTML","focusedPath","newItem","editSection","supportComponents","includes","dataencoded","parseJSON","badgetype","add","sectionbadges","render","js","prependNodeContents","badge","remove","register_module","set_visibility_resource_ui","getDOMNode","updateMovedCmState","params","updateMovedSectionState","addMutations","legacyActivityAction","statemanager","setReadOnly","locked","cmlist","reduce","current","delete","visible","legacySectionAction","forEach","initCoursePage","on","keyCode","moduleId","preventDefault","sectionId","isExecuted","itemid","strNumberSections","modalTitle","newSections","modalBody","create","title","types","SAVE_CANCEL","body","modal","numSections","getBody","addSections","parseInt","val","location","setSaveButtonText","getRoot","shown","select","enter","save","replaceSectionActionItem","debug","refreshSection","newSectionElement","content","event","sectionRefreshed","defaultPrevented"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Various actions on modules and sections in the editing mode - hiding, duplicating, deleting, etc.\n *\n * @module     core_course/actions\n * @copyright  2016 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.3\n */\ndefine(\n    [\n        'jquery',\n        'core/ajax',\n        'core/templates',\n        'core/notification',\n        'core/str',\n        'core/url',\n        'core/yui',\n        'core/modal_factory',\n        'core/modal_events',\n        'core/key_codes',\n        'core/log',\n        'core_courseformat/courseeditor',\n        'core/event_dispatcher',\n        'core_course/events'\n    ],\n    function(\n        $,\n        ajax,\n        templates,\n        notification,\n        str,\n        url,\n        Y,\n        ModalFactory,\n        ModalEvents,\n        KeyCodes,\n        log,\n        editor,\n        EventDispatcher,\n        CourseEvents\n    ) {\n\n        // Eventually, core_courseformat/local/content/actions will handle all actions for\n        // component compatible formats and the default actions.js won't be necessary anymore.\n        // Meanwhile, we filter the migrated actions.\n        const componentActions = ['moveSection', 'moveCm', 'addSection', 'deleteSection'];\n\n        // The course reactive instance.\n        const courseeditor = editor.getCurrentCourseEditor();\n\n        // The current course format name (loaded on init).\n        let formatname;\n\n        var CSS = {\n            EDITINPROGRESS: 'editinprogress',\n            SECTIONDRAGGABLE: 'sectiondraggable',\n            EDITINGMOVE: 'editing_move'\n        };\n        var SELECTOR = {\n            ACTIVITYLI: 'li.activity',\n            ACTIONAREA: '.actions',\n            ACTIVITYACTION: 'a.cm-edit-action',\n            MENU: '.moodle-actionmenu[data-enhance=moodle-core-actionmenu]',\n            TOGGLE: '.toggle-display,.dropdown-toggle',\n            SECTIONLI: 'li.section',\n            SECTIONACTIONMENU: '.section_action_menu',\n            ADDSECTIONS: '.changenumsections [data-add-sections]',\n            SECTIONBADGES: '[data-region=\"sectionbadges\"]',\n        };\n\n        Y.use('moodle-course-coursebase', function() {\n            var courseformatselector = M.course.format.get_section_selector();\n            if (courseformatselector) {\n                SELECTOR.SECTIONLI = courseformatselector;\n            }\n        });\n\n        /**\n         * Dispatch event wrapper.\n         *\n         * Old jQuery events will be replaced by native events gradually.\n         *\n         * @method dispatchEvent\n         * @param {String} eventName The name of the event\n         * @param {Object} detail Any additional details to pass into the eveent\n         * @param {Node|HTMLElement} container The point at which to dispatch the event\n         * @param {Object} options\n         * @param {Boolean} options.bubbles Whether to bubble up the DOM\n         * @param {Boolean} options.cancelable Whether preventDefault() can be called\n         * @param {Boolean} options.composed Whether the event can bubble across the ShadowDOM boundary\n         * @returns {CustomEvent}\n         */\n        const dispatchEvent = function(eventName, detail, container, options) {\n            // Most actions still uses jQuery node instead of regular HTMLElement.\n            if (!(container instanceof Element) && container.get !== undefined) {\n                container = container.get(0);\n            }\n            return EventDispatcher.dispatchEvent(eventName, detail, container, options);\n        };\n\n        /**\n         * Wrapper for Y.Moodle.core_course.util.cm.getId\n         *\n         * @param {JQuery} element\n         * @returns {Integer}\n         */\n        var getModuleId = function(element) {\n            // Check if we have a data-id first.\n            const item = element.get(0);\n            if (item.dataset.id) {\n                return item.dataset.id;\n            }\n            // Use YUI way if data-id is not present.\n            let id;\n            Y.use('moodle-course-util', function(Y) {\n                id = Y.Moodle.core_course.util.cm.getId(Y.Node(item));\n            });\n            return id;\n        };\n\n        /**\n         * Wrapper for Y.Moodle.core_course.util.cm.getName\n         *\n         * @param {JQuery} element\n         * @returns {String}\n         */\n        var getModuleName = function(element) {\n            var name;\n            Y.use('moodle-course-util', function(Y) {\n                name = Y.Moodle.core_course.util.cm.getName(Y.Node(element.get(0)));\n            });\n            // Check if we have the name in the course state.\n            const state = courseeditor.state;\n            const cmid = getModuleId(element);\n            if (!name && state && cmid) {\n                name = state.cm.get(cmid)?.name;\n            }\n            return name;\n        };\n\n        /**\n         * Wrapper for M.util.add_spinner for an activity\n         *\n         * @param {JQuery} activity\n         * @returns {Node}\n         */\n        var addActivitySpinner = function(activity) {\n            activity.addClass(CSS.EDITINPROGRESS);\n            var actionarea = activity.find(SELECTOR.ACTIONAREA).get(0);\n            if (actionarea) {\n                var spinner = M.util.add_spinner(Y, Y.Node(actionarea));\n                spinner.show();\n                // Lock the activity state element.\n                if (activity.data('id') !== undefined) {\n                    courseeditor.dispatch('cmLock', [activity.data('id')], true);\n                }\n                return spinner;\n            }\n            return null;\n        };\n\n        /**\n         * Wrapper for M.util.add_spinner for a section\n         *\n         * @param {JQuery} sectionelement\n         * @returns {Node}\n         */\n        var addSectionSpinner = function(sectionelement) {\n            sectionelement.addClass(CSS.EDITINPROGRESS);\n            var actionarea = sectionelement.find(SELECTOR.SECTIONACTIONMENU).get(0);\n            if (actionarea) {\n                var spinner = M.util.add_spinner(Y, Y.Node(actionarea));\n                spinner.show();\n                // Lock the section state element.\n                if (sectionelement.data('id') !== undefined) {\n                    courseeditor.dispatch('sectionLock', [sectionelement.data('id')], true);\n                }\n                return spinner;\n            }\n            return null;\n        };\n\n        /**\n         * Wrapper for M.util.add_lightbox\n         *\n         * @param {JQuery} sectionelement\n         * @returns {Node}\n         */\n        var addSectionLightbox = function(sectionelement) {\n            const item = sectionelement.get(0);\n            var lightbox = M.util.add_lightbox(Y, Y.Node(item));\n            if (item.dataset.for == 'section' && item.dataset.id) {\n                courseeditor.dispatch('sectionLock', [item.dataset.id], true);\n                lightbox.setAttribute('data-state', 'section');\n                lightbox.setAttribute('data-state-id', item.dataset.id);\n            }\n            lightbox.show();\n            return lightbox;\n        };\n\n        /**\n         * Removes the spinner element\n         *\n         * @param {JQuery} element\n         * @param {Node} spinner\n         * @param {Number} delay\n         */\n        var removeSpinner = function(element, spinner, delay) {\n            window.setTimeout(function() {\n                element.removeClass(CSS.EDITINPROGRESS);\n                if (spinner) {\n                    spinner.hide();\n                }\n                // Unlock the state element.\n                if (element.data('id') !== undefined) {\n                    const mutation = (element.data('for') === 'section') ? 'sectionLock' : 'cmLock';\n                    courseeditor.dispatch(mutation, [element.data('id')], false);\n                }\n            }, delay);\n        };\n\n        /**\n         * Removes the lightbox element\n         *\n         * @param {Node} lightbox lighbox YUI element returned by addSectionLightbox\n         * @param {Number} delay\n         */\n        var removeLightbox = function(lightbox, delay) {\n            if (lightbox) {\n                window.setTimeout(function() {\n                    lightbox.hide();\n                    // Unlock state if necessary.\n                    if (lightbox.getAttribute('data-state')) {\n                        courseeditor.dispatch(\n                            `${lightbox.getAttribute('data-state')}Lock`,\n                            [lightbox.getAttribute('data-state-id')],\n                            false\n                        );\n                    }\n                }, delay);\n            }\n        };\n\n        /**\n         * Initialise action menu for the element (section or module)\n         *\n         * @param {String} elementid CSS id attribute of the element\n         */\n        var initActionMenu = function(elementid) {\n            // Initialise action menu in the new activity.\n            Y.use('moodle-course-coursebase', function() {\n                M.course.coursebase.invoke_function('setup_for_resource', '#' + elementid);\n            });\n            if (M.core.actionmenu && M.core.actionmenu.newDOMNode) {\n                M.core.actionmenu.newDOMNode(Y.one('#' + elementid));\n            }\n        };\n\n        /**\n         * Returns focus to the element that was clicked or \"Edit\" link if element is no longer visible.\n         *\n         * @param {String} elementId CSS id attribute of the element\n         * @param {String} action data-action property of the element that was clicked\n         */\n        var focusActionItem = function(elementId, action) {\n            var mainelement = $('#' + elementId);\n            var selector = '[data-action=' + action + ']';\n            if (action === 'groupsseparate' || action === 'groupsvisible' || action === 'groupsnone') {\n                // New element will have different data-action.\n                selector = '[data-action=groupsseparate],[data-action=groupsvisible],[data-action=groupsnone]';\n            }\n            if (mainelement.find(selector).is(':visible')) {\n                mainelement.find(selector).focus();\n            } else {\n                // Element not visible, focus the \"Edit\" link.\n                mainelement.find(SELECTOR.MENU).find(SELECTOR.TOGGLE).focus();\n            }\n        };\n\n        /**\n         * Find next <a> after the element\n         *\n         * @param {JQuery} mainElement element that is about to be deleted\n         * @returns {JQuery}\n         */\n        var findNextFocusable = function(mainElement) {\n            var tabables = $(\"a:visible\");\n            var isInside = false;\n            var foundElement = null;\n            tabables.each(function() {\n                if ($.contains(mainElement[0], this)) {\n                    isInside = true;\n                } else if (isInside) {\n                    foundElement = this;\n                    return false; // Returning false in .each() is equivalent to \"break;\" inside the loop in php.\n                }\n                return true;\n            });\n            return foundElement;\n        };\n\n        /**\n         * Performs an action on a module (moving, deleting, duplicating, hiding, etc.)\n         *\n         * @param {JQuery} moduleElement activity element we perform action on\n         * @param {Number} cmid\n         * @param {JQuery} target the element (menu item) that was clicked\n         */\n        var editModule = function(moduleElement, cmid, target) {\n            var action = target.attr('data-action');\n            var spinner = addActivitySpinner(moduleElement);\n            var promises = ajax.call([{\n                methodname: 'core_course_edit_module',\n                args: {id: cmid,\n                    action: action,\n                    sectionreturn: target.attr('data-sectionreturn') ? target.attr('data-sectionreturn') : 0\n                }\n            }], true);\n\n            var lightbox;\n            if (action === 'duplicate') {\n                lightbox = addSectionLightbox(target.closest(SELECTOR.SECTIONLI));\n            }\n            $.when.apply($, promises)\n                .done(function(data) {\n                    var elementToFocus = findNextFocusable(moduleElement);\n                    moduleElement.replaceWith(data);\n                    let affectedids = [];\n                    // Initialise action menu for activity(ies) added as a result of this.\n                    $('<div>' + data + '</div>').find(SELECTOR.ACTIVITYLI).each(function(index) {\n                        initActionMenu($(this).attr('id'));\n                        if (index === 0) {\n                            focusActionItem($(this).attr('id'), action);\n                            elementToFocus = null;\n                        }\n                        // Save any activity id in cmids.\n                        affectedids.push(getModuleId($(this)));\n                    });\n                    // In case of activity deletion focus the next focusable element.\n                    if (elementToFocus) {\n                        elementToFocus.focus();\n                    }\n                    // Remove spinner and lightbox with a delay.\n                    removeSpinner(moduleElement, spinner, 400);\n                    removeLightbox(lightbox, 400);\n                    // Trigger event that can be observed by course formats.\n                    moduleElement.trigger($.Event('coursemoduleedited', {ajaxreturn: data, action: action}));\n\n                    // Modify cm state.\n                    courseeditor.dispatch('legacyActivityAction', action, cmid, affectedids);\n\n                }).fail(function(ex) {\n                    // Remove spinner and lightbox.\n                    removeSpinner(moduleElement, spinner);\n                    removeLightbox(lightbox);\n                    // Trigger event that can be observed by course formats.\n                    var e = $.Event('coursemoduleeditfailed', {exception: ex, action: action});\n                    moduleElement.trigger(e);\n                    if (!e.isDefaultPrevented()) {\n                        notification.exception(ex);\n                    }\n                });\n        };\n\n        /**\n         * Requests html for the module via WS core_course_get_module and updates the module on the course page\n         *\n         * Used after d&d of the module to another section\n         *\n         * @param {JQuery|Element} element\n         * @param {Number} cmid\n         * @param {Number} sectionreturn\n         * @return {Promise} the refresh promise\n         */\n        var refreshModule = function(element, cmid, sectionreturn) {\n\n            if (sectionreturn === undefined) {\n                sectionreturn = courseeditor.sectionReturn;\n            }\n\n            const activityElement = $(element);\n            var spinner = addActivitySpinner(activityElement);\n            var promises = ajax.call([{\n                methodname: 'core_course_get_module',\n                args: {id: cmid, sectionreturn: sectionreturn}\n            }], true);\n\n            return new Promise((resolve, reject) => {\n                $.when.apply($, promises)\n                    .done(function(data) {\n                        removeSpinner(activityElement, spinner, 400);\n                        replaceActivityHtmlWith(data);\n                        resolve(data);\n                    }).fail(function() {\n                        removeSpinner(activityElement, spinner);\n                        reject();\n                    });\n            });\n        };\n\n        /**\n         * Requests html for the section via WS core_course_edit_section and updates the section on the course page\n         *\n         * @param {JQuery|Element} element\n         * @param {Number} sectionid\n         * @param {Number} sectionreturn\n         * @return {Promise} the refresh promise\n         */\n        var refreshSection = function(element, sectionid, sectionreturn) {\n\n            if (sectionreturn === undefined) {\n                sectionreturn = courseeditor.sectionReturn;\n            }\n\n            const sectionElement = $(element);\n            const action = 'refresh';\n            const promises = ajax.call([{\n                methodname: 'core_course_edit_section',\n                args: {id: sectionid, action, sectionreturn},\n            }], true);\n\n            var spinner = addSectionSpinner(sectionElement);\n            return new Promise((resolve, reject) => {\n                $.when.apply($, promises)\n                    .done(dataencoded => {\n\n                        removeSpinner(sectionElement, spinner);\n                        const data = $.parseJSON(dataencoded);\n\n                        const newSectionElement = $(data.content);\n                        sectionElement.replaceWith(newSectionElement);\n\n                        // Init modules menus.\n                        $(`${SELECTOR.SECTIONLI}#${sectionid} ${SELECTOR.ACTIVITYLI}`).each(\n                            (index, activity) => {\n                                initActionMenu(activity.data('id'));\n                            }\n                        );\n\n                        // Trigger event that can be observed by course formats.\n                        const event = dispatchEvent(\n                            CourseEvents.sectionRefreshed,\n                            {\n                                ajaxreturn: data,\n                                action: action,\n                                newSectionElement: newSectionElement.get(0),\n                            },\n                            newSectionElement\n                        );\n\n                        if (!event.defaultPrevented) {\n                            defaultEditSectionHandler(\n                                newSectionElement, $(SELECTOR.SECTIONLI + '#' + sectionid),\n                                data,\n                                formatname,\n                                sectionid\n                            );\n                        }\n                        resolve(data);\n                    }).fail(ex => {\n                        // Trigger event that can be observed by course formats.\n                        const event = dispatchEvent(\n                            'coursesectionrefreshfailed',\n                            {exception: ex, action: action},\n                            sectionElement\n                        );\n                        if (!event.defaultPrevented) {\n                            notification.exception(ex);\n                        }\n                        reject();\n                    });\n            });\n        };\n\n        /**\n         * Displays the delete confirmation to delete a module\n         *\n         * @param {JQuery} mainelement activity element we perform action on\n         * @param {function} onconfirm function to execute on confirm\n         */\n        var confirmDeleteModule = function(mainelement, onconfirm) {\n            var modtypename = mainelement.attr('class').match(/modtype_([^\\s]*)/)[1];\n            var modulename = getModuleName(mainelement);\n\n            str.get_string('pluginname', modtypename).done(function(pluginname) {\n                var plugindata = {\n                    type: pluginname,\n                    name: modulename\n                };\n                str.get_strings([\n                    {key: 'confirm', component: 'core'},\n                    {key: modulename === null ? 'deletechecktype' : 'deletechecktypename', param: plugindata},\n                    {key: 'yes'},\n                    {key: 'no'}\n                ]).done(function(s) {\n                        notification.confirm(s[0], s[1], s[2], s[3], onconfirm);\n                    }\n                );\n            });\n        };\n\n        /**\n         * Displays the delete confirmation to delete a section\n         *\n         * @param {String} message confirmation message\n         * @param {function} onconfirm function to execute on confirm\n         */\n        var confirmEditSection = function(message, onconfirm) {\n            str.get_strings([\n                {key: 'confirm'}, // TODO link text\n                {key: 'yes'},\n                {key: 'no'}\n            ]).done(function(s) {\n                    notification.confirm(s[0], message, s[1], s[2], onconfirm);\n                }\n            );\n        };\n\n        /**\n         * Replaces an action menu item with another one (for example Show->Hide, Set marker->Remove marker)\n         *\n         * @param {JQuery} actionitem\n         * @param {String} image new image name (\"i/show\", \"i/hide\", etc.)\n         * @param {String} stringname new string for the action menu item\n         * @param {String} stringcomponent\n         * @param {String} newaction new value for data-action attribute of the link\n         * @return {Promise} promise which is resolved when the replacement has completed\n         */\n        var replaceActionItem = function(actionitem, image, stringname,\n                                           stringcomponent, newaction) {\n\n            var stringRequests = [{key: stringname, component: stringcomponent}];\n            // Do not provide an icon with duplicate, different text to the menu item.\n\n            return str.get_strings(stringRequests).then(function(strings) {\n                actionitem.find('span.menu-action-text').html(strings[0]);\n\n                return templates.renderPix(image, 'core');\n            }).then(function(pixhtml) {\n                actionitem.find('.icon').replaceWith(pixhtml);\n                actionitem.attr('data-action', newaction);\n                return;\n            }).catch(notification.exception);\n        };\n\n        /**\n         * Default post-processing for section AJAX edit actions.\n         *\n         * This can be overridden in course formats by listening to event coursesectionedited:\n         *\n         * $('body').on('coursesectionedited', 'li.section', function(e) {\n         *     var action = e.action,\n         *         sectionElement = $(e.target),\n         *         data = e.ajaxreturn;\n         *     // ... Do some processing here.\n         *     e.preventDefault(); // Prevent default handler.\n         * });\n         *\n         * @param {JQuery} sectionElement\n         * @param {JQuery} actionItem\n         * @param {Object} data\n         * @param {String} courseformat\n         * @param {Number} sectionid\n         */\n        var defaultEditSectionHandler = function(sectionElement, actionItem, data, courseformat, sectionid) {\n            var action = actionItem.attr('data-action');\n            if (action === 'hide' || action === 'show') {\n                if (action === 'hide') {\n                    sectionElement.addClass('hidden');\n                    setSectionBadge(sectionElement[0], 'hiddenfromstudents', true);\n                    replaceActionItem(actionItem, 'i/show',\n                        'showfromothers', 'format_' + courseformat, 'show');\n                } else {\n                    setSectionBadge(sectionElement[0], 'hiddenfromstudents', false);\n                    sectionElement.removeClass('hidden');\n                    replaceActionItem(actionItem, 'i/hide',\n                        'hidefromothers', 'format_' + courseformat, 'hide');\n                }\n                // Replace the modules with new html (that indicates that they are now hidden or not hidden).\n                if (data.modules !== undefined) {\n                    for (var i in data.modules) {\n                        replaceActivityHtmlWith(data.modules[i]);\n                    }\n                }\n                // Replace the section availability information.\n                if (data.section_availability !== undefined) {\n                    sectionElement.find('.section_availability').first().replaceWith(data.section_availability);\n                }\n                // Modify course state.\n                const section = courseeditor.state.section.get(sectionid);\n                if (section !== undefined) {\n                    courseeditor.dispatch('sectionState', [sectionid]);\n                }\n            } else if (action === 'setmarker') {\n                var oldmarker = $(SELECTOR.SECTIONLI + '.current'),\n                    oldActionItem = oldmarker.find(SELECTOR.SECTIONACTIONMENU + ' ' + 'a[data-action=removemarker]');\n                oldmarker.removeClass('current');\n                replaceActionItem(oldActionItem, 'i/marker',\n                    'highlight', 'core', 'setmarker');\n                sectionElement.addClass('current');\n                replaceActionItem(actionItem, 'i/marked',\n                    'highlightoff', 'core', 'removemarker');\n                courseeditor.dispatch('legacySectionAction', action, sectionid);\n                setSectionBadge(sectionElement[0], 'highlighted', true);\n            } else if (action === 'removemarker') {\n                sectionElement.removeClass('current');\n                replaceActionItem(actionItem, 'i/marker',\n                    'highlight', 'core', 'setmarker');\n                courseeditor.dispatch('legacySectionAction', action, sectionid);\n                setSectionBadge(sectionElement[0], 'highlighted', false);\n            }\n        };\n\n        /**\n         * Get the focused element path in an activity if any.\n         *\n         * This method is used to restore focus when the activity HTML is refreshed.\n         * Only the main course editor elements can be refocused as they are always present\n         * even if the activity content changes.\n         *\n         * @param {String} id the element id the activity element\n         * @return {String|undefined} the inner path of the focused element or undefined\n         */\n        const getActivityFocusedElement = function(id) {\n            const element = document.getElementById(id);\n            if (!element || !element.contains(document.activeElement)) {\n                return undefined;\n            }\n            // Check if the actions menu toggler is focused.\n            if (element.querySelector(SELECTOR.ACTIONAREA).contains(document.activeElement)) {\n                return `${SELECTOR.ACTIONAREA} [tabindex=\"0\"]`;\n            }\n            // Return the current element id if any.\n            if (document.activeElement.id) {\n                return `#${document.activeElement.id}`;\n            }\n            return undefined;\n        };\n\n        /**\n         * Replaces the course module with the new html (used to update module after it was edited or its visibility was changed).\n         *\n         * @param {String} activityHTML\n         */\n        var replaceActivityHtmlWith = function(activityHTML) {\n            $('<div>' + activityHTML + '</div>').find(SELECTOR.ACTIVITYLI).each(function() {\n                // Extract id from the new activity html.\n                var id = $(this).attr('id');\n                // Check if the current focused element is inside the activity.\n                let focusedPath = getActivityFocusedElement(id);\n                // Find the existing element with the same id and replace its contents with new html.\n                $(SELECTOR.ACTIVITYLI + '#' + id).replaceWith(activityHTML);\n                // Initialise action menu.\n                initActionMenu(id);\n                // Re-focus the previous elements.\n                if (focusedPath) {\n                    const newItem = document.getElementById(id);\n                    newItem.querySelector(focusedPath)?.focus();\n                }\n\n            });\n        };\n\n        /**\n         * Performs an action on a module (moving, deleting, duplicating, hiding, etc.)\n         *\n         * @param {JQuery} sectionElement section element we perform action on\n         * @param {Nunmber} sectionid\n         * @param {JQuery} target the element (menu item) that was clicked\n         * @param {String} courseformat\n         * @return {boolean} true the action call is sent to the server or false if it is ignored.\n         */\n        var editSection = function(sectionElement, sectionid, target, courseformat) {\n            var action = target.attr('data-action'),\n                sectionreturn = target.attr('data-sectionreturn') ? target.attr('data-sectionreturn') : 0;\n\n            // Filter direct component handled actions.\n            if (courseeditor.supportComponents && componentActions.includes(action)) {\n                return false;\n            }\n\n            var spinner = addSectionSpinner(sectionElement);\n            var promises = ajax.call([{\n                methodname: 'core_course_edit_section',\n                args: {id: sectionid, action: action, sectionreturn: sectionreturn}\n            }], true);\n\n            var lightbox = addSectionLightbox(sectionElement);\n            $.when.apply($, promises)\n                .done(function(dataencoded) {\n                    var data = $.parseJSON(dataencoded);\n                    removeSpinner(sectionElement, spinner);\n                    removeLightbox(lightbox);\n                    sectionElement.find(SELECTOR.SECTIONACTIONMENU).find(SELECTOR.TOGGLE).focus();\n                    // Trigger event that can be observed by course formats.\n                    var e = $.Event('coursesectionedited', {ajaxreturn: data, action: action});\n                    sectionElement.trigger(e);\n                    if (!e.isDefaultPrevented()) {\n                        defaultEditSectionHandler(sectionElement, target, data, courseformat, sectionid);\n                    }\n                }).fail(function(ex) {\n                    // Remove spinner and lightbox.\n                    removeSpinner(sectionElement, spinner);\n                    removeLightbox(lightbox);\n                    // Trigger event that can be observed by course formats.\n                    var e = $.Event('coursesectioneditfailed', {exception: ex, action: action});\n                    sectionElement.trigger(e);\n                    if (!e.isDefaultPrevented()) {\n                        notification.exception(ex);\n                    }\n                });\n            return true;\n        };\n\n        /**\n         * Sets the section badge in the section header.\n         *\n         * @param {JQuery} sectionElement section element we perform action on\n         * @param {String} badgetype the type of badge this is for\n         * @param {bool} add true to add, false to remove\n         */\n        var setSectionBadge = function(sectionElement, badgetype, add) {\n            const sectionbadges = sectionElement.querySelector(SELECTOR.SECTIONBADGES);\n            if (!sectionbadges) {\n                return;\n            }\n            if (add) {\n                templates.render('core_courseformat/local/content/section/badges', {[badgetype]: 1})\n                .then(function(html, js) {\n                    templates.prependNodeContents(sectionbadges, html, js);\n                    return true;\n                }).catch(notification.exception);\n            } else {\n                const badge = sectionbadges.querySelector('[data-type=\"' + badgetype + '\"]');\n                badge.remove();\n            }\n        };\n\n        // Register a function to be executed after D&D of an activity.\n        Y.use('moodle-course-coursebase', function() {\n            M.course.coursebase.register_module({\n                // Ignore camelcase eslint rule for the next line because it is an expected name of the callback.\n                // eslint-disable-next-line camelcase\n                set_visibility_resource_ui: function(args) {\n                    var mainelement = $(args.element.getDOMNode());\n                    var cmid = getModuleId(mainelement);\n                    if (cmid) {\n                        var sectionreturn = mainelement.find('.' + CSS.EDITINGMOVE).attr('data-sectionreturn');\n                        refreshModule(mainelement, cmid, sectionreturn);\n                    }\n                },\n                /**\n                 * Update the course state when some cm is moved via YUI.\n                 * @param {*} params\n                 */\n                updateMovedCmState: (params) => {\n                    const state = courseeditor.state;\n\n                    // Update old section.\n                    const cm = state.cm.get(params.cmid);\n                    if (cm !== undefined) {\n                        courseeditor.dispatch('sectionState', [cm.sectionid]);\n                    }\n                    // Update cm state.\n                    courseeditor.dispatch('cmState', [params.cmid]);\n                },\n                /**\n                 * Update the course state when some section is moved via YUI.\n                 */\n                updateMovedSectionState: () => {\n                    courseeditor.dispatch('courseState');\n                },\n            });\n        });\n\n        // From Moodle 4.0 all edit actions are being re-implemented as state mutation.\n        // This means all method from this \"actions\" module will be deprecated when all the course\n        // interface is migrated to reactive components.\n        // Most legacy actions did not provide enough information to regenarate the course so they\n        // use the mutations courseState, sectionState and cmState to get the updated state from\n        // the server. However, some activity actions where we can prevent an extra webservice\n        // call by implementing an adhoc mutation.\n        courseeditor.addMutations({\n            /**\n             * Compatibility function to update Moodle 4.0 course state using legacy actions.\n             *\n             * This method only updates some actions which does not require to use cmState mutation\n             * to get updated data form the server.\n             *\n             * @param {Object} statemanager the current state in read write mode\n             * @param {String} action the performed action\n             * @param {Number} cmid the affected course module id\n             * @param {Array} affectedids all affected cm ids (for duplicate action)\n             */\n            legacyActivityAction: function(statemanager, action, cmid, affectedids) {\n\n                const state = statemanager.state;\n                const cm = state.cm.get(cmid);\n                if (cm === undefined) {\n                    return;\n                }\n                const section = state.section.get(cm.sectionid);\n                if (section === undefined) {\n                    return;\n                }\n\n                // Send the element is locked.\n                courseeditor.dispatch('cmLock', [cm.id], true);\n\n                // Now we do the real mutation.\n                statemanager.setReadOnly(false);\n\n                // This unlocked will take effect when the read only is restored.\n                cm.locked = false;\n\n                switch (action) {\n                    case 'delete':\n                        // Remove from section.\n                        section.cmlist = section.cmlist.reduce(\n                            (cmlist, current) => {\n                                if (current != cmid) {\n                                    cmlist.push(current);\n                                }\n                                return cmlist;\n                            },\n                            []\n                        );\n                        // Delete form list.\n                        state.cm.delete(cmid);\n                        break;\n\n                    case 'hide':\n                    case 'show':\n                        cm.visible = (action === 'show') ? true : false;\n                        break;\n\n                    case 'duplicate':\n                        // Duplicate requires to get extra data from the server.\n                        courseeditor.dispatch('cmState', affectedids);\n                        break;\n                }\n                statemanager.setReadOnly(true);\n            },\n            legacySectionAction: function(statemanager, action, sectionid) {\n\n                const state = statemanager.state;\n                const section = state.section.get(sectionid);\n                if (section === undefined) {\n                    return;\n                }\n\n                // Send the element is locked. Reactive events are only triggered when the state\n                // read only mode is restored. We want to notify the interface the element is\n                // locked so we need to do a quick lock operation before performing the rest\n                // of the mutation.\n                statemanager.setReadOnly(false);\n                section.locked = true;\n                statemanager.setReadOnly(true);\n\n                // Now we do the real mutation.\n                statemanager.setReadOnly(false);\n\n                // This locked will take effect when the read only is restored.\n                section.locked = false;\n\n                switch (action) {\n                    case 'setmarker':\n                        // Remove previous marker.\n                        state.section.forEach((current) => {\n                            if (current.id != sectionid) {\n                                current.current = false;\n                            }\n                        });\n                        section.current = true;\n                        break;\n\n                    case 'removemarker':\n                        section.current = false;\n                        break;\n                }\n                statemanager.setReadOnly(true);\n            },\n        });\n\n        return /** @alias module:core_course/actions */ {\n\n            /**\n             * Initialises course page\n             *\n             * @method init\n             * @param {String} courseformat name of the current course format (for fetching strings)\n             */\n            initCoursePage: function(courseformat) {\n\n                formatname = courseformat;\n\n                // Add a handler for course module actions.\n                $('body').on('click keypress', SELECTOR.ACTIVITYLI + ' ' +\n                        SELECTOR.ACTIVITYACTION + '[data-action]', function(e) {\n                    if (e.type === 'keypress' && e.keyCode !== 13) {\n                        return;\n                    }\n                    var actionItem = $(this),\n                        moduleElement = actionItem.closest(SELECTOR.ACTIVITYLI),\n                        action = actionItem.attr('data-action'),\n                        moduleId = getModuleId(moduleElement);\n                    switch (action) {\n                        case 'moveleft':\n                        case 'moveright':\n                        case 'delete':\n                        case 'duplicate':\n                        case 'hide':\n                        case 'stealth':\n                        case 'show':\n                        case 'groupsseparate':\n                        case 'groupsvisible':\n                        case 'groupsnone':\n                            break;\n                        default:\n                            // Nothing to do here!\n                            return;\n                    }\n                    if (!moduleId) {\n                        return;\n                    }\n                    e.preventDefault();\n                    if (action === 'delete') {\n                        // Deleting requires confirmation.\n                        confirmDeleteModule(moduleElement, function() {\n                            editModule(moduleElement, moduleId, actionItem);\n                        });\n                    } else {\n                        editModule(moduleElement, moduleId, actionItem);\n                    }\n                });\n\n                // Add a handler for section show/hide actions.\n                $('body').on('click keypress', SELECTOR.SECTIONLI + ' ' +\n                            SELECTOR.SECTIONACTIONMENU + '[data-sectionid] ' +\n                            'a[data-action]', function(e) {\n                    if (e.type === 'keypress' && e.keyCode !== 13) {\n                        return;\n                    }\n                    var actionItem = $(this),\n                        sectionElement = actionItem.closest(SELECTOR.SECTIONLI),\n                        sectionId = actionItem.closest(SELECTOR.SECTIONACTIONMENU).attr('data-sectionid');\n\n                    let isExecuted = true;\n                    if (actionItem.attr('data-confirm')) {\n                        // Action requires confirmation.\n                        confirmEditSection(actionItem.attr('data-confirm'), function() {\n                            isExecuted = editSection(sectionElement, sectionId, actionItem, courseformat);\n                        });\n                    } else {\n                        isExecuted = editSection(sectionElement, sectionId, actionItem, courseformat);\n                    }\n                    // Prevent any other module from capturing the action if it is already in execution.\n                    if (isExecuted) {\n                        e.preventDefault();\n                    }\n                });\n\n                // The section and activity names are edited using inplace editable.\n                // The \"update\" jQuery event must be captured in order to update the course state.\n                $('body').on('updated', `${SELECTOR.SECTIONLI} [data-inplaceeditable]`, function(e) {\n                    if (e.ajaxreturn && e.ajaxreturn.itemid) {\n                        const state = courseeditor.state;\n                        const section = state.section.get(e.ajaxreturn.itemid);\n                        if (section !== undefined) {\n                            courseeditor.dispatch('sectionState', [e.ajaxreturn.itemid]);\n                        }\n                    }\n                });\n                $('body').on('updated', `${SELECTOR.ACTIVITYLI} [data-inplaceeditable]`, function(e) {\n                    if (e.ajaxreturn && e.ajaxreturn.itemid) {\n                        courseeditor.dispatch('cmState', [e.ajaxreturn.itemid]);\n                    }\n                });\n\n                // Component-based formats don't use modals to create sections.\n                if (courseeditor.supportComponents && componentActions.includes('addSection')) {\n                    return;\n                }\n\n                // Add a handler for \"Add sections\" link to ask for a number of sections to add.\n                str.get_string('numberweeks').done(function(strNumberSections) {\n                    var trigger = $(SELECTOR.ADDSECTIONS),\n                        modalTitle = trigger.attr('data-add-sections'),\n                        newSections = trigger.attr('data-new-sections');\n                    var modalBody = $('<div><label for=\"add_section_numsections\"></label> ' +\n                        '<input id=\"add_section_numsections\" type=\"number\" min=\"1\" max=\"' + newSections + '\" value=\"1\"></div>');\n                    modalBody.find('label').html(strNumberSections);\n                    ModalFactory.create({\n                        title: modalTitle,\n                        type: ModalFactory.types.SAVE_CANCEL,\n                        body: modalBody.html()\n                    }, trigger)\n                    .done(function(modal) {\n                        var numSections = $(modal.getBody()).find('#add_section_numsections'),\n                        addSections = function() {\n                            // Check if value of the \"Number of sections\" is a valid positive integer and redirect\n                            // to adding a section script.\n                            if ('' + parseInt(numSections.val()) === numSections.val() && parseInt(numSections.val()) >= 1) {\n                                document.location = trigger.attr('href') + '&numsections=' + parseInt(numSections.val());\n                            }\n                        };\n                        modal.setSaveButtonText(modalTitle);\n                        modal.getRoot().on(ModalEvents.shown, function() {\n                            // When modal is shown focus and select the input and add a listener to keypress of \"Enter\".\n                            numSections.focus().select().on('keydown', function(e) {\n                                if (e.keyCode === KeyCodes.enter) {\n                                    addSections();\n                                }\n                            });\n                        });\n                        modal.getRoot().on(ModalEvents.save, function(e) {\n                            // When modal \"Add\" button is pressed.\n                            e.preventDefault();\n                            addSections();\n                        });\n                    });\n                });\n            },\n\n            /**\n             * Replaces a section action menu item with another one (for example Show->Hide, Set marker->Remove marker)\n             *\n             * This method can be used by course formats in their listener to the coursesectionedited event\n             *\n             * @deprecated since Moodle 3.9\n             * @param {JQuery} sectionelement\n             * @param {String} selector CSS selector inside the section element, for example \"a[data-action=show]\"\n             * @param {String} image new image name (\"i/show\", \"i/hide\", etc.)\n             * @param {String} stringname new string for the action menu item\n             * @param {String} stringcomponent\n             * @param {String} newaction new value for data-action attribute of the link\n             */\n            replaceSectionActionItem: function(sectionelement, selector, image, stringname,\n                                                    stringcomponent, newaction) {\n                log.debug('replaceSectionActionItem() is deprecated and will be removed.');\n                var actionitem = sectionelement.find(SELECTOR.SECTIONACTIONMENU + ' ' + selector);\n                replaceActionItem(actionitem, image, stringname, stringcomponent, newaction);\n            },\n            // Method to refresh a module.\n            refreshModule,\n            refreshSection,\n        };\n    });\n"],"file":"actions.min.js"}