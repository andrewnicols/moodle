function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define ("core_course/local/activitychooser/dialogue",["exports","jquery","core/modal_events","core_course/local/activitychooser/selectors","core/templates","core/key_codes","core/loadingicon","core_course/local/activitychooser/repository","core/notification","core/utils"],function(_exports,_jquery,ModalEvents,_selectors,Templates,_key_codes,_loadingicon,Repository,_notification,_utils){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.displayChooser=void 0;_jquery=_interopRequireDefault(_jquery);ModalEvents=_interopRequireWildcard(ModalEvents);_selectors=_interopRequireDefault(_selectors);Templates=_interopRequireWildcard(Templates);Repository=_interopRequireWildcard(Repository);_notification=_interopRequireDefault(_notification);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)})}}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if("Object"===n&&o.constructor)n=o.constructor.name;if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(null==len||len>arr.length)len=arr.length;for(var i=0,arr2=Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _arr=[],_n=!0,_d=!1,_s,_e;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done);_n=!0){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=!0;_e=err}finally{try{if(!_n&&null!=_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}var getPlugin=function(pluginName){return"function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise(function(resolve,reject){_systemImportTransformerGlobalIdentifier.require([pluginName],resolve,reject)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require((pluginName))):Promise.resolve(_systemImportTransformerGlobalIdentifier[pluginName])},showModuleHelp=function(carousel,moduleData){var modal=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(null!==modal&&!0===moduleData.showFooter){modal.setFooter(Templates.render("core_course/local/activitychooser/footer_partial",moduleData))}var help=carousel.find(_selectors.default.regions.help)[0];help.innerHTML="";help.classList.add("m-auto");var spinnerPromise=(0,_loadingicon.addIconToContainer)(help),transitionPromiseResolver=null,transitionPromise=new Promise(function(resolve){transitionPromiseResolver=resolve}),contentPromise=Templates.renderForPromise("core_course/local/activitychooser/help",moduleData);Promise.all([contentPromise,spinnerPromise,transitionPromise]).then(function(_ref){var _ref2=_slicedToArray(_ref,1),_ref2$=_ref2[0],html=_ref2$.html,js=_ref2$.js;return Templates.replaceNodeContents(help,html,js)}).then(function(){help.querySelector(_selectors.default.regions.chooserSummary.header).focus();return help}).catch(_notification.default.exception);carousel.one("slid.bs.carousel",function(){transitionPromiseResolver()});carousel.carousel("next")},manageFavouriteState=function(){var _ref3=_asyncToGenerator(regeneratorRuntime.mark(function _callee(modalBody,caller,partialFavourite){var isFavourite,id,name,internal;return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:isFavourite=caller.dataset.favourited;id=caller.dataset.id;name=caller.dataset.name;internal=caller.dataset.internal;if(!("true"===isFavourite)){_context.next=10;break}_context.next=7;return Repository.unfavouriteModule(name,id);case 7:partialFavourite(internal,!1,modalBody);_context.next=13;break;case 10:_context.next=12;return Repository.favouriteModule(name,id);case 12:partialFavourite(internal,!0,modalBody);case 13:case"end":return _context.stop();}}},_callee)}));return function(){return _ref3.apply(this,arguments)}}(),registerListenerEvents=function(modal,mappedModules,partialFavourite,footerData){var bodyClickListener=function(){var _ref4=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(e){var carousel,module,moduleName,moduleData,caller,activeSectionId,sectionChooserOptions,firstChooserOption,_carousel,searchInput;return regeneratorRuntime.wrap(function(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(e.target.closest(_selectors.default.actions.optionActions.showSummary)){carousel=(0,_jquery.default)(modal.getBody()[0].querySelector(_selectors.default.regions.carousel));module=e.target.closest(_selectors.default.regions.chooserOption.container);moduleName=module.dataset.modname;moduleData=mappedModules.get(moduleName);moduleData.showFooter=modal.hasFooterContent();showModuleHelp(carousel,moduleData,modal)}if(!e.target.closest(_selectors.default.actions.optionActions.manageFavourite)){_context2.next=10;break}caller=e.target.closest(_selectors.default.actions.optionActions.manageFavourite);_context2.next=5;return manageFavouriteState(modal.getBody()[0],caller,partialFavourite);case 5:activeSectionId=modal.getBody()[0].querySelector(_selectors.default.elements.activetab).getAttribute("href");sectionChooserOptions=modal.getBody()[0].querySelector(_selectors.default.regions.getSectionChooserOptions(activeSectionId));firstChooserOption=sectionChooserOptions.querySelector(_selectors.default.regions.chooserOption.container);toggleFocusableChooserOption(firstChooserOption,!0);initChooserOptionsKeyboardNavigation(modal.getBody()[0],mappedModules,sectionChooserOptions,modal);case 10:if(e.target.matches(_selectors.default.actions.closeOption)){_carousel=(0,_jquery.default)(modal.getBody()[0].querySelector(_selectors.default.regions.carousel));_carousel.carousel("prev");_carousel.on("slid.bs.carousel",function(){var allModules=modal.getBody()[0].querySelector(_selectors.default.regions.modules),caller=allModules.querySelector(_selectors.default.regions.getModuleSelector(e.target.dataset.modname));caller.focus()})}if(e.target.closest(_selectors.default.actions.clearSearch)){searchInput=modal.getBody()[0].querySelector(_selectors.default.actions.search);searchInput.value="";searchInput.focus();toggleSearchResultsView(modal,mappedModules,searchInput.value)}case 12:case"end":return _context2.stop();}}},_callee2)}));return function(){return _ref4.apply(this,arguments)}}(),footerClickListener=function(){var _ref5=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(e){var footerjs;return regeneratorRuntime.wrap(function(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!(!0===footerData.footer)){_context3.next=6;break}_context3.next=3;return getPlugin(footerData.customfooterjs);case 3:footerjs=_context3.sent;_context3.next=6;return footerjs.footerClickListener(e,footerData,modal);case 6:case"end":return _context3.stop();}}},_callee3)}));return function(){return _ref5.apply(this,arguments)}}();modal.getBodyPromise().then(function(body){return body[0]}).then(function(body){(0,_jquery.default)(body.querySelector(_selectors.default.regions.carousel)).carousel({interval:!1,pause:!0,keyboard:!1});return body}).then(function(body){body.addEventListener("click",bodyClickListener);return body}).then(function(body){var searchInput=body.querySelector(_selectors.default.actions.search);searchInput.addEventListener("input",(0,_utils.debounce)(function(){toggleSearchResultsView(modal,mappedModules,searchInput.value)},300));return body}).then(function(body){var activeSectionId=body.querySelector(_selectors.default.elements.activetab).getAttribute("href"),sectionChooserOptions=body.querySelector(_selectors.default.regions.getSectionChooserOptions(activeSectionId)),firstChooserOption=sectionChooserOptions.querySelector(_selectors.default.regions.chooserOption.container);toggleFocusableChooserOption(firstChooserOption,!0);initChooserOptionsKeyboardNavigation(body,mappedModules,sectionChooserOptions,modal);return body}).catch();modal.getFooterPromise().then(function(footer){return footer[0]}).then(function(footer){footer.addEventListener("click",footerClickListener);return footer}).catch()},initChooserOptionsKeyboardNavigation=function(body,mappedModules,chooserOptionsContainer){var modal=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null,chooserOptions=chooserOptionsContainer.querySelectorAll(_selectors.default.regions.chooserOption.container);Array.from(chooserOptions).forEach(function(element){return element.addEventListener("keydown",function(e){if(e.keyCode===_key_codes.enter||e.keyCode===_key_codes.space){if(e.target.matches(_selectors.default.actions.optionActions.showSummary)){e.preventDefault();var module=e.target.closest(_selectors.default.regions.chooserOption.container),moduleName=module.dataset.modname,moduleData=mappedModules.get(moduleName),carousel=(0,_jquery.default)(body.querySelector(_selectors.default.regions.carousel));carousel.carousel({interval:!1,pause:!0,keyboard:!1});moduleData.showFooter=modal.hasFooterContent();showModuleHelp(carousel,moduleData,modal)}}if(e.keyCode===_key_codes.arrowRight){e.preventDefault();var currentOption=e.target.closest(_selectors.default.regions.chooserOption.container),nextOption=currentOption.nextElementSibling,firstOption=chooserOptionsContainer.firstElementChild,toFocusOption=clickErrorHandler(nextOption,firstOption);focusChooserOption(toFocusOption,currentOption)}if(e.keyCode===_key_codes.arrowLeft){e.preventDefault();var _currentOption=e.target.closest(_selectors.default.regions.chooserOption.container),previousOption=_currentOption.previousElementSibling,lastOption=chooserOptionsContainer.lastElementChild,_toFocusOption=clickErrorHandler(previousOption,lastOption);focusChooserOption(_toFocusOption,_currentOption)}if(e.keyCode===_key_codes.home){e.preventDefault();var _currentOption2=e.target.closest(_selectors.default.regions.chooserOption.container),_firstOption=chooserOptionsContainer.firstElementChild;focusChooserOption(_firstOption,_currentOption2)}if(e.keyCode===_key_codes.end){e.preventDefault();var _currentOption3=e.target.closest(_selectors.default.regions.chooserOption.container),_lastOption=chooserOptionsContainer.lastElementChild;focusChooserOption(_lastOption,_currentOption3)}})})},focusChooserOption=function(currentChooserOption){var previousChooserOption=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null;if(null!==previousChooserOption){toggleFocusableChooserOption(previousChooserOption,!1)}toggleFocusableChooserOption(currentChooserOption,!0);currentChooserOption.focus()},toggleFocusableChooserOption=function(chooserOption,isFocusable){var chooserOptionLink=chooserOption.querySelector(_selectors.default.actions.addChooser),chooserOptionHelp=chooserOption.querySelector(_selectors.default.actions.optionActions.showSummary),chooserOptionFavourite=chooserOption.querySelector(_selectors.default.actions.optionActions.manageFavourite);if(isFocusable){chooserOption.tabIndex=0;chooserOptionLink.tabIndex=0;chooserOptionHelp.tabIndex=0;chooserOptionFavourite.tabIndex=0}else{chooserOption.tabIndex=-1;chooserOptionLink.tabIndex=-1;chooserOptionHelp.tabIndex=-1;chooserOptionFavourite.tabIndex=-1}},clickErrorHandler=function(item,fallback){if(null!==item){return item}else{return fallback}},renderSearchResults=function(){var _ref6=_asyncToGenerator(regeneratorRuntime.mark(function _callee4(searchResultsContainer,searchResultsData){var templateData,_yield$Templates$rend,html,js;return regeneratorRuntime.wrap(function(_context4){while(1){switch(_context4.prev=_context4.next){case 0:templateData={searchresultsnumber:searchResultsData.length,searchresults:searchResultsData};_context4.next=3;return Templates.renderForPromise("core_course/local/activitychooser/search_results",templateData);case 3:_yield$Templates$rend=_context4.sent;html=_yield$Templates$rend.html;js=_yield$Templates$rend.js;_context4.next=8;return Templates.replaceNodeContents(searchResultsContainer,html,js);case 8:case"end":return _context4.stop();}}},_callee4)}));return function(){return _ref6.apply(this,arguments)}}(),toggleSearchResultsView=function(){var _ref7=_asyncToGenerator(regeneratorRuntime.mark(function _callee5(modal,mappedModules,searchQuery){var modalBody,searchResultsContainer,chooserContainer,clearSearchButton,searchResultsData,searchResultItemsContainer,firstSearchResultItem;return regeneratorRuntime.wrap(function(_context5){while(1){switch(_context5.prev=_context5.next){case 0:modalBody=modal.getBody()[0];searchResultsContainer=modalBody.querySelector(_selectors.default.regions.searchResults);chooserContainer=modalBody.querySelector(_selectors.default.regions.chooser);clearSearchButton=modalBody.querySelector(_selectors.default.actions.clearSearch);if(!(0<searchQuery.length)){_context5.next=16;break}searchResultsData=searchModules(mappedModules,searchQuery);_context5.next=8;return renderSearchResults(searchResultsContainer,searchResultsData);case 8:searchResultItemsContainer=searchResultsContainer.querySelector(_selectors.default.regions.searchResultItems);firstSearchResultItem=searchResultItemsContainer.querySelector(_selectors.default.regions.chooserOption.container);if(firstSearchResultItem){toggleFocusableChooserOption(firstSearchResultItem,!0);initChooserOptionsKeyboardNavigation(modalBody,mappedModules,searchResultItemsContainer,modal)}clearSearchButton.classList.remove("d-none");chooserContainer.setAttribute("hidden","hidden");searchResultsContainer.removeAttribute("hidden");_context5.next=19;break;case 16:clearSearchButton.classList.add("d-none");searchResultsContainer.setAttribute("hidden","hidden");chooserContainer.removeAttribute("hidden");case 19:case"end":return _context5.stop();}}},_callee5)}));return function(){return _ref7.apply(this,arguments)}}(),searchModules=function(modules,searchTerm){if(""===searchTerm){return modules}searchTerm=searchTerm.toLowerCase();var searchResults=[];modules.forEach(function(activity){var activityName=activity.title.toLowerCase(),activityDesc=activity.help.toLowerCase();if(activityName.includes(searchTerm)||activityDesc.includes(searchTerm)){searchResults.push(activity)}});return searchResults},setupKeyboardAccessibility=function(modal,mappedModules){modal.getModal()[0].tabIndex=-1;modal.getBodyPromise().then(function(body){(0,_jquery.default)(_selectors.default.elements.tab).on("shown.bs.tab",function(e){var activeSectionId=e.target.getAttribute("href"),activeSectionChooserOptions=body[0].querySelector(_selectors.default.regions.getSectionChooserOptions(activeSectionId)),firstChooserOption=activeSectionChooserOptions.querySelector(_selectors.default.regions.chooserOption.container),prevActiveSectionId=e.relatedTarget.getAttribute("href"),prevActiveSectionChooserOptions=body[0].querySelector(_selectors.default.regions.getSectionChooserOptions(prevActiveSectionId));disableFocusAllChooserOptions(prevActiveSectionChooserOptions);toggleFocusableChooserOption(firstChooserOption,!0);initChooserOptionsKeyboardNavigation(body[0],mappedModules,activeSectionChooserOptions,modal)})}).catch(_notification.default.exception)},disableFocusAllChooserOptions=function(sectionChooserOptions){var allChooserOptions=sectionChooserOptions.querySelectorAll(_selectors.default.regions.chooserOption.container);allChooserOptions.forEach(function(chooserOption){toggleFocusableChooserOption(chooserOption,!1)})};_exports.displayChooser=function displayChooser(modalPromise,sectionModules,partialFavourite,footerData){var mappedModules=new Map;sectionModules.forEach(function(module){mappedModules.set(module.componentname+"_"+module.link,module)});modalPromise.then(function(modal){registerListenerEvents(modal,mappedModules,partialFavourite,footerData);setupKeyboardAccessibility(modal,mappedModules);modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy()});return modal}).catch()}});
//# sourceMappingURL=dialogue.min.js.map
