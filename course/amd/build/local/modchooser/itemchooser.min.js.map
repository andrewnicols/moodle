{"version":3,"sources":["../../../src/local/modchooser/itemchooser.js"],"names":["courseId","tabName","items","length","item","archetype","itemName","state","get","window","location","href","link","sectionId","tabMode","_tabMode","caller","dataset","sectionid","then","tabList","getPopulatedTab","activitiesTab","resourcesTab","name","titleIdentifier","titleComponent","data","JSON","parse","stringify","content_items","forEach","module","sectionReturnId","Promise","resolve","ItemChooser"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A type of itemchooser used as for choosing modules in a course.\n *\n * @module     core_course/local/modchooser/itemchooser\n * @copyright  2021 Andrew Lyons <andrew@nicols.co.uk>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ItemChooser from 'core/itemchooser';\nimport {get_string as getString} from 'core/str';\nimport {prefetchStrings} from 'core/prefetch';\nimport {\n    activityModules as getModuleData,\n    fetchFooterData,\n} from 'core_course/local/activitychooser/repository';\n\n// Prefetch the strings.\nprefetchStrings('core', [\n    'activities',\n    'addresourceoractivity',\n    'resources',\n]);\n\n// Module types.\nconst ACTIVITY = 0;\nconst RESOURCE = 1;\n\nexport default class extends ItemChooser {\n\n    /**\n     * @property {string} The name of the itemchooser type.\n     */\n    static name = 'coursechooser';\n\n    /**\n     * Constructor to configure the chooser.\n     *\n     * @param {Number} courseId\n     */\n    constructor(courseId) {\n        super();\n\n        this.courseId = courseId;\n    }\n\n    /**\n     * Set the tab mode.\n     *\n     * @param {number} tabMode\n     */\n    set tabMode(tabMode) {\n        this._tabMode = tabMode;\n    }\n\n    /**\n     * Get the tab mode.\n     *\n     * @return {number}\n     */\n    get tabMode() {\n        return this._tabMode;\n    }\n\n    /**\n     * Get the id of the section.\n     *\n     * @return {null|number}\n     */\n    get sectionId() {\n        return this.caller?.dataset.sectionid;\n    }\n\n\n    /**\n     * Get the title for the item chooser dialogue.\n     *\n     * @returns {Promise<string>}\n     */\n    get dialogueTitle() {\n        return getString('addresourceoractivity', 'core');\n    }\n\n    /**\n     * Get a list of named tabs for this chooser, which match the tab order.\n     *\n     * To be extended by the child class.\n     *\n     * @returns {Promise<tabConfig>}\n     */\n    get tabList() {\n        return super.tabList.then(async tabList => {\n            return {\n                ...tabList,\n                activitiesTab: await this.getPopulatedTab(this.activitiesTab),\n                resourcesTab: await this.getPopulatedTab(this.resourcesTab),\n            };\n        });\n    }\n\n    /**\n     * Get the tab order.\n     *\n     * @returns {string[]}\n     */\n    get tabOrder() {\n        if (this.tabMode == \"0\") {\n            // Favourites, Recommended, All, Activities only, Resources only.\n            return [\n                'favouriteTab',\n                'recommendedTab',\n                'allItemsTab',\n                'activitiesTab',\n                'resourcesTab',\n            ];\n        }\n\n        if (this.tabMode == \"1\") {\n            // Favourites, Recommended, All, Activities only, Resources only.\n            return [\n                'favouriteTab',\n                'recommendedTab',\n                'allItemsTab',\n            ];\n        }\n\n        // Favourites, Recommended, All, Activities only, Resources only.\n        return [\n            'favouriteTab',\n            'recommendedTab',\n            'activitiesTab',\n            'resourcesTab',\n        ];\n    }\n\n    /**\n     * Get the data for the recommended items tab.\n     *\n     * @returns {tabConfig}\n     */\n    get activitiesTab() {\n        return {\n            name: 'activities',\n            titleIdentifier: 'activities',\n            titleComponent: 'core',\n        };\n    }\n\n    /**\n     * Get the data for the recommended items tab.\n     *\n     * @returns {tabConfig}\n     */\n    get resourcesTab() {\n        return {\n            name: 'resources',\n            titleIdentifier: 'resources',\n            titleComponent: 'core',\n        };\n    }\n\n    /**\n     * Get any context data for the dialogue.\n     *\n     * @returns {object}\n     */\n    get chooserTemplateContext() {\n        return super.chooserTemplateContext;\n    }\n\n    /**\n     * Fetch the cached data.\n     *\n     * @returns {Promise<object>}\n     */\n    get cachedData() {\n        return super.cachedData.then(data => JSON.parse(JSON.stringify(data)))\n        .then(data => {\n            data.content_items.forEach(module => {\n                if (this.sectionId) {\n                    module.link += `&section=${this.sectionId}`;\n                }\n\n                module.link += `&sr=${this.sectionReturnId ?? 0}`;\n            });\n\n            return data.content_items;\n        });\n    }\n\n    /**\n     * Fetch the data to display.\n     *\n     * @returns {Promise<object>}\n     */\n    get data() {\n        return getModuleData(this.courseId);\n    }\n\n    /**\n     * Get the Chooser footer.\n     *\n     * @returns {Promise<string>}\n     */\n    get chooserFooter() {\n        if (this.sectionId) {\n            return fetchFooterData(this.courseId, this.sectionId);\n        }\n        return Promise.resolve('');\n    }\n\n    /**\n     * Get the tab visibility controller function for the named tab.\n     *\n     * @param {string} tabName\n     * @return {function|null}\n     */\n    getTabVisibilityFunction(tabName) {\n        switch (tabName) {\n            case 'activities':\n            case 'resources':\n                return ({items}) => !!items.length;\n            default:\n                return super.getTabVisibilityFunction(tabName);\n        }\n    }\n\n    /**\n     * Get the tab visibility controller function for the named tab.\n     *\n     * @param {string} tabName\n     * @return {function|null}\n     */\n    getTabFilterFunction(tabName) {\n        switch (tabName) {\n            case 'activities':\n                return item => item.archetype === ACTIVITY;\n            case 'resources':\n                return item => item.archetype === RESOURCE;\n            default:\n                return super.getTabFilterFunction(tabName);\n        }\n    }\n\n    /**\n     * Handle selection of the item.\n     *\n     * @param {string} itemName\n     */\n    handleItemSelection(itemName) {\n        const item = this.state.items.get(itemName);\n        window.location.href = `${item.link}&section=${this.sectionId}`;\n    }\n}\n"],"file":"itemchooser.min.js"}