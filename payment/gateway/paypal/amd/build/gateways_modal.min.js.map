{"version":3,"sources":["../src/gateways_modal.js"],"names":["showModalWithPlaceholder","modal","ModalFactory","create","body","Templates","render","show","process","component","paymentArea","itemId","description","Promise","all","Repository","getConfigForJs","then","paypalConfig","getRoot","on","ModalEvents","hidden","destroy","switchSdk","clientid","currency","setBody","resolve","window","paypal","Buttons","createOrder","data","actions","order","purchase_units","amount","currency_code","value","cost","Truncate","truncate","length","stripTags","application_context","shipping_preference","brand_name","brandname","onApprove","outsideClick","e","preventDefault","markTransactionComplete","orderID","res","hide","getBody","success","message","reject","clientId","sdkUrl","currentlyloaded","suspectedScript","document","querySelector","parentNode","removeChild","script","createElement","readyState","onreadystatechange","onload","setAttribute","head","appendChild"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for PayPal content in the gateways modal.\n *\n * @module     paygw_paypal/gateway_modal\n * @copyright  2020 Shamim Rezaie <shamim@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Templates from 'core/templates';\nimport Truncate from 'core/truncate';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async() => {\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_paypal/paypal_button_placeholder', {})\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n        showModalWithPlaceholder(),\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([modal, paypalConfig]) => {\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            // Destroy when hidden.\n            modal.destroy();\n        });\n\n        return Promise.all([\n            modal,\n            paypalConfig,\n            switchSdk(paypalConfig.clientid, paypalConfig.currency),\n        ]);\n    })\n    .then(([modal, paypalConfig]) => {\n        // We have to clear the body. The render method in paypal.Buttons will render everything.\n        modal.setBody('');\n\n        return new Promise(resolve => {\n            window.paypal.Buttons({\n                // Set up the transaction.\n                createOrder: function(data, actions) {\n                    return actions.order.create({\n                        purchase_units: [{ // eslint-disable-line\n                            amount: {\n                                currency_code: paypalConfig.currency_code, // eslint-disable-line\n                                value: paypalConfig.cost,\n                            },\n                            description: Truncate.truncate(description, {length: 127, stripTags: true}),\n                        }],\n                        application_context: { // eslint-disable-line\n                            shipping_preference: 'NO_SHIPPING', // eslint-disable-line\n                            brand_name: Truncate.truncate(paypalConfig.brandname, {length: 127, stripTags: true}), // eslint-disable-line\n                        },\n                    });\n                },\n                // Finalise the transaction.\n                onApprove: function(data) {\n                    modal.getRoot().on(ModalEvents.outsideClick, (e) => {\n                        // Prevent closing the modal when clicking outside of it.\n                        e.preventDefault();\n                    });\n\n                    modal.setBody(getString('authorising', 'paygw_paypal'));\n\n                    Repository.markTransactionComplete(component, paymentArea, itemId, data.orderID)\n                    .then(res => {\n                        modal.hide();\n                        return res;\n                    })\n                    .then(resolve);\n                }\n            }).render(modal.getBody()[0]);\n        });\n    })\n    .then(res => {\n        if (res.success) {\n            return Promise.resolve(res.message);\n        }\n\n        return Promise.reject(res.message);\n    });\n};\n\n/**\n * Unloads the previously loaded PayPal JavaScript SDK, and loads a new one.\n *\n * @param {string} clientId PayPal client ID\n * @param {string} currency The currency\n * @returns {Promise}\n */\nconst switchSdk = (clientId, currency) => {\n    const sdkUrl = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=${currency}`;\n\n    // Check to see if this file has already been loaded. If so just go straight to the func.\n    if (switchSdk.currentlyloaded === sdkUrl) {\n        return Promise.resolve();\n    }\n\n    // PayPal can only work with one currency at the same time. We have to unload the previously loaded script\n    // if it was loaded for a different currency. Weird way indeed, but the only way.\n    // See: https://github.com/paypal/paypal-checkout-components/issues/1180\n    if (switchSdk.currentlyloaded) {\n        const suspectedScript = document.querySelector(`script[src=\"${switchSdk.currentlyloaded}\"]`);\n        if (suspectedScript) {\n            suspectedScript.parentNode.removeChild(suspectedScript);\n        }\n    }\n\n    const script = document.createElement('script');\n\n    return new Promise(resolve => {\n        if (script.readyState) {\n            script.onreadystatechange = function() {\n                if (this.readyState == 'complete' || this.readyState == 'loaded') {\n                    this.onreadystatechange = null;\n                    resolve();\n                }\n            };\n        } else {\n            script.onload = function() {\n                resolve();\n            };\n        }\n\n        script.setAttribute('src', sdkUrl);\n        document.head.appendChild(script);\n\n        switchSdk.currentlyloaded = sdkUrl;\n    });\n};\n\n/**\n * Holds the full url of loaded PayPal JavaScript SDK.\n *\n * @static\n * @type {string}\n */\nswitchSdk.currentlyloaded = '';\n"],"file":"gateways_modal.min.js"}