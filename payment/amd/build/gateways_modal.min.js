define ("core_payment/gateways_modal",["exports","core/modal_factory","core/templates","core/str","./repository","./selectors","core/modal_events","core_payment/events","core/toast","core/notification","./modal_gateways"],function(_exports,_modal_factory,_templates,_str,_repository,_selectors,_modal_events,_events,_toast,_notification,_modal_gateways){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.init=void 0;_modal_factory=_interopRequireDefault(_modal_factory);_templates=_interopRequireDefault(_templates);_selectors=_interopRequireDefault(_selectors);_modal_events=_interopRequireDefault(_modal_events);_events=_interopRequireDefault(_events);_notification=_interopRequireDefault(_notification);_modal_gateways=_interopRequireDefault(_modal_gateways);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const registerEventListeners=()=>{document.addEventListener("click",e=>{const gatewayTrigger=e.target.closest("[data-action=\"core_payment/triggerPayment\"]");if(gatewayTrigger){e.preventDefault();show(gatewayTrigger,{focusOnClose:e.target})}})},show=async function(rootNode){let{focusOnClose=null}=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{};const modal=await _modal_factory.default.create({type:_modal_gateways.default.TYPE,title:await(0,_str.get_string)("selectpaymenttype","core_payment"),body:await _templates.default.render("core_payment/gateways_modal",{})}),rootElement=modal.getRoot()[0];(0,_toast.addToastRegion)(rootElement);modal.show();modal.getRoot().on(_modal_events.default.hidden,()=>{modal.destroy();try{focusOnClose.focus()}catch(e){}});modal.getRoot().on(_events.default.proceed,e=>{const gateway=(rootElement.querySelector(_selectors.default.values.gateway)||{value:""}).value;if(gateway){processPayment(gateway,rootNode.dataset.component,rootNode.dataset.paymentarea,rootNode.dataset.itemid,rootNode.dataset.description).then(message=>{modal.hide();_notification.default.addNotification({message:message,type:"success"});location.href=rootNode.dataset.successurl;return message}).catch(message=>_notification.default.alert("",message))}else{(0,_str.get_string)("nogatewayselected","core_payment").then(message=>(0,_toast.add)(message,{type:"warning"})).catch()}e.preventDefault()});rootElement.addEventListener("change",e=>{if(e.target.matches(_selectors.default.elements.gateways)){updateCostRegion(rootElement,rootNode.dataset.cost)}});const gateways=await(0,_repository.getAvailableGateways)(rootNode.dataset.component,rootNode.dataset.paymentarea,rootNode.dataset.itemid),{html,js}=await _templates.default.renderForPromise("core_payment/gateways",{gateways});_templates.default.replaceNodeContents(rootElement.querySelector(_selectors.default.regions.gatewaysContainer),html,js);selectSingleGateway(rootElement);await updateCostRegion(rootElement,rootNode.dataset.cost)},selectSingleGateway=root=>{const gateways=root.querySelectorAll(_selectors.default.elements.gateways);if(1==gateways.length){gateways[0].checked=!0}},updateCostRegion=async function(root){let defaultCost=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"";const gatewayElement=root.querySelector(_selectors.default.values.gateway),surcharge=parseInt((gatewayElement||{dataset:{surcharge:0}}).dataset.surcharge),cost=(gatewayElement||{dataset:{cost:defaultCost}}).dataset.cost,{html,js}=await _templates.default.renderForPromise("core_payment/fee_breakdown",{fee:cost,surcharge});_templates.default.replaceNodeContents(root.querySelector(_selectors.default.regions.costContainer),html,js)},processPayment=async(gateway,component,paymentArea,itemId,description)=>{const paymentMethod=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise(function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["paygw_".concat(gateway,"/gateways_modal")],resolve,reject)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(("paygw_".concat(gateway,"/gateways_modal")))):Promise.resolve(_systemImportTransformerGlobalIdentifier["paygw_".concat(gateway,"/gateways_modal")]));return paymentMethod.process(component,paymentArea,itemId,description)},init=()=>{if(!init.initialised){init.initialised=!0;registerEventListeners()}};_exports.init=init;init.initialised=!1});
//# sourceMappingURL=gateways_modal.min.js.map
