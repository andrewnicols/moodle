{"version":3,"sources":["../src/form.js"],"names":["define","$","Str","Notification","Ajax","Templates","SortableList","Pending","confirmDelete","id","type","component","area","itemid","pendingPromise","get_strings","then","s","confirm","pendingDeletePromise","func","call","methodname","args","response","render","html","js","replaceNode","resolve","catch","exception","createNewCategory","promises","categoryid","window","location","href","Promise","all","init","mainlist","attr","on","e","preventDefault","categoryName","element","closest","find","sortCat","moveHandlerSelector","getElementName","el","Deferred","evt","info","positionChanged","data","beforeid","targetNextElement","stopPropagation","sort","getDestinationName","parentElement","afterElement","length","get_string","targetList","children","each","fields","nofields","append","remove","setTimeout","width"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module depends on the real jquery - and returns the non-global version of it.\n *\n * @module     core_customfield/form\n * @copyright  2018 Toni Barbera\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/str',\n    'core/notification',\n    'core/ajax',\n    'core/templates',\n    'core/sortable_list',\n    'core/pending',\n    'core/inplace_editable',\n], function($, Str, Notification, Ajax, Templates, SortableList, Pending) {\n\n    /**\n     * Display confirmation dialogue\n     *\n     * @param {Number} id\n     * @param {String} type\n     * @param {String} component\n     * @param {String} area\n     * @param {Number} itemid\n     */\n    var confirmDelete = function(id, type, component, area, itemid) {\n        var pendingPromise = new Pending('core_customfield/form:confirmDelete');\n        Str.get_strings([\n            {'key': 'confirm'},\n            {'key': 'confirmdelete' + type, component: 'core_customfield'},\n            {'key': 'yes'},\n            {'key': 'no'},\n        ])\n        .then(function(s) {\n            Notification.confirm(s[0], s[1], s[2], s[3], function() {\n                var pendingDeletePromise = new Pending('core_customfield/form:confirmDelete');\n                var func = (type === 'field') ? 'core_customfield_delete_field' : 'core_customfield_delete_category';\n                Ajax.call([\n                    {methodname: func, args: {id: id}},\n                    {methodname: 'core_customfield_reload_template', args: {component: component, area: area, itemid: itemid}}\n                ])[1]\n                .then(function(response) {\n                    return Templates.render('core_customfield/list', response);\n                })\n                .then(function(html, js) {\n                    Templates.replaceNode($('[data-region=\"list-page\"]'), html, js);\n                    return null;\n                })\n                .then(pendingDeletePromise.resolve)\n                .catch(Notification.exception);\n            });\n\n            return;\n        })\n        .then(pendingPromise.resolve)\n        .catch(Notification.exception);\n    };\n\n    /**\n     * Creates a new custom fields category with default name and updates the list\n     *\n     * @param {String} component\n     * @param {String} area\n     * @param {Number} itemid\n     */\n    var createNewCategory = function(component, area, itemid) {\n        var pendingPromise = new Pending('core_customfield/form:confirmDelete');\n        var promises = Ajax.call([\n            {methodname: 'core_customfield_create_category', args: {component: component, area: area, itemid: itemid}},\n            {methodname: 'core_customfield_reload_template', args: {component: component, area: area, itemid: itemid}}\n        ]);\n        var categoryid;\n\n        promises[0].then(function(response) {\n            categoryid = response;\n            return null;\n        }).catch(Notification.exception);\n\n        promises[1].then(function(response) {\n            return Templates.render('core_customfield/list', response);\n        })\n        .then(function(html, js) {\n            Templates.replaceNode($('[data-region=\"list-page\"]'), html, js);\n            window.location.href = '#category-' + categoryid;\n            return null;\n        })\n        .catch(Notification.exception);\n\n        Promise.all(promises)\n        .then(pendingPromise.resolve)\n        .catch();\n    };\n\n    return {\n        /**\n         * Initialise the custom fields manager\n         */\n        init: function() {\n            var mainlist = $('#customfield_catlist');\n            var component = mainlist.attr('data-component');\n            var area = mainlist.attr('data-area');\n            var itemid = mainlist.attr('data-itemid');\n\n            $(\"[data-role=deletefield]\").on('click', function(e) {\n                confirmDelete($(this).attr('data-id'), 'field', component, area, itemid);\n                e.preventDefault();\n            });\n\n            $(\"[data-role=deletecategory]\").on('click', function(e) {\n                confirmDelete($(this).attr('data-id'), 'category', component, area, itemid);\n                e.preventDefault();\n            });\n\n            $('[data-role=addnewcategory]').on('click', function() {\n                createNewCategory(component, area, itemid);\n            });\n\n            var categoryName = function(element) {\n                return element\n                    .closest('[data-category-id]')\n                    .find('[data-inplaceeditable][data-itemtype=category][data-component=core_customfield]')\n                    .attr('data-value');\n            };\n\n            // Sort category.\n            var sortCat = new SortableList(\n                $('#customfield_catlist .categorieslist'),\n                {moveHandlerSelector: '.movecategory [data-drag-type=move]'}\n            );\n\n            sortCat.getElementName = function(el) {\n                return $.Deferred().resolve(categoryName(el));\n            };\n\n            $('[data-category-id]').on('sortablelist-drop', function(evt, info) {\n                if (info.positionChanged) {\n                    var pendingPromise = new Pending('core_customfield/form:categoryid:on:sortablelist-drop');\n                    Ajax.call([\n                        {\n                            methodname: 'core_customfield_move_category',\n                            args: {\n                                id: info.element.data('category-id'),\n                                beforeid: info.targetNextElement.data('category-id')\n                            }\n\n                        },\n                    ])[0]\n                    .then(pendingPromise.resolve)\n                    .catch(Notification.exception);\n                }\n                evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n            });\n\n            // Sort fields.\n            var sort = new SortableList(\n                $('#customfield_catlist .fieldslist tbody'),\n                {moveHandlerSelector: '.movefield [data-drag-type=move]'}\n            );\n\n            sort.getDestinationName = function(parentElement, afterElement) {\n                if (!afterElement.length) {\n                    return Str.get_string('totopofcategory', 'customfield', categoryName(parentElement));\n                } else if (afterElement.attr('data-field-name')) {\n                    return Str.get_string('afterfield', 'customfield', afterElement.attr('data-field-name'));\n                } else {\n                    return $.Deferred().resolve('');\n                }\n            };\n\n            $('[data-field-name]').on('sortablelist-drop', function(evt, info) {\n                evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n                if (info.positionChanged) {\n                    var pendingPromise = new Pending('core_customfield/form:fieldname:on:sortablelist-drop');\n                    Ajax.call([\n                        {\n                            methodname: 'core_customfield_move_field',\n                            args: {\n                                id: info.element.data('field-id'),\n                                beforeid: info.targetNextElement.data('field-id'),\n                                categoryid: Number(info.targetList.closest('[data-category-id]').attr('data-category-id'))\n                            },\n                        },\n                    ])[0]\n                    .then(pendingPromise.resolve)\n                    .catch(Notification.exception);\n                }\n            });\n\n            $('[data-field-name]').on('sortablelist-drag', function(evt) {\n                var pendingPromise = new Pending('core_customfield/form:fieldname:on:sortablelist-drag');\n\n                evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n\n                // Refreshing fields tables.\n                Str.get_string('therearenofields', 'core_customfield').then(function(s) {\n                    $('#customfield_catlist .categorieslist').children().each(function() {\n                        var fields = $(this).find($('.field')),\n                            nofields = $(this).find($('.nofields'));\n                        if (!fields.length && !nofields.length) {\n                            $(this).find('tbody').append(\n                                '<tr class=\"nofields\"><td colspan=\"5\">' + s + '</td></tr>'\n                            );\n                        }\n                        if (fields.length && nofields.length) {\n                            nofields.remove();\n                        }\n                    });\n                    return null;\n                })\n                .then(pendingPromise.resolve)\n                .catch(Notification.exception);\n            });\n\n            $('[data-category-id], [data-field-name]').on('sortablelist-dragstart',\n                function(evt, info) {\n                    setTimeout(function() {\n                        $('.sortable-list-is-dragged').width(info.element.width());\n                    }, 501);\n                }\n            );\n\n        }\n    };\n});\n"],"file":"form.min.js"}