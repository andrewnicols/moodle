{"version":3,"sources":["../../../src/local/editor/columns.js"],"names":["init","initialized","document","addEventListener","event","reportAddColumn","target","closest","reportSelectors","actions","preventDefault","pendingPromise","Pending","reportElement","regions","report","dataset","reportId","uniqueIdentifier","then","data","reportEvents","publish","reportColumnsUpdated","name","addToast","tableReload","preservePagination","resolve","catch","Notification","exception","reportRemoveColumn","columnHeader","columnName","saveCancelPromise","triggerElement","columnId","columnSortableList","SortableList","reportTable","isHorizontal","getElementName","element","Promise","on","EVENTS","DRAG","info","columnPosition","targetColumnPosition","targetNextElement","find","each","cell","children","beforeCell","insertBefore","appendChild","DROP","positionChanged","siblings","length","inplaceEditableEvents","elementUpdated","columnAggregation","columnAggregationLink","itemid","preserveTriggerElement"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Report builder columns editor\n *\n * @module      core_reportbuilder/local/editor/columns\n * @copyright   2021 Paul Holden <paulh@moodle.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\"use strict\";\n\nimport $ from 'jquery';\nimport {dispatchEvent} from 'core/event_dispatcher';\nimport 'core/inplace_editable';\nimport {eventTypes as inplaceEditableEvents} from 'core/local/inplace_editable/events';\nimport Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport {prefetchStrings} from 'core/prefetch';\nimport {publish} from 'core/pubsub';\nimport SortableList from 'core/sortable_list';\nimport {get_string as getString} from 'core/str';\nimport {add as addToast} from 'core/toast';\nimport * as reportEvents from 'core_reportbuilder/local/events';\nimport * as reportSelectors from 'core_reportbuilder/local/selectors';\nimport {addColumn, deleteColumn, reorderColumn} from 'core_reportbuilder/local/repository/columns';\nimport {getColumnSorting} from 'core_reportbuilder/local/repository/sorting';\n\n/**\n * Initialise module, prefetch all required strings\n *\n * @param {Boolean} initialized Ensure we only add our listeners once\n */\nexport const init = initialized => {\n    prefetchStrings('core_reportbuilder', [\n        'columnadded',\n        'columnaggregated',\n        'columndeleted',\n        'columnmoved',\n        'deletecolumn',\n        'deletecolumnconfirm',\n    ]);\n\n    prefetchStrings('core', [\n        'delete',\n    ]);\n\n    if (initialized) {\n        return;\n    }\n\n    document.addEventListener('click', event => {\n\n        // Add column to report.\n        const reportAddColumn = event.target.closest(reportSelectors.actions.reportAddColumn);\n        if (reportAddColumn) {\n            event.preventDefault();\n\n            const pendingPromise = new Pending('core_reportbuilder/columns:add');\n            const reportElement = reportAddColumn.closest(reportSelectors.regions.report);\n\n            addColumn(reportElement.dataset.reportId, reportAddColumn.dataset.uniqueIdentifier)\n                .then(data => publish(reportEvents.publish.reportColumnsUpdated, data))\n                .then(() => getString('columnadded', 'core_reportbuilder', reportAddColumn.dataset.name))\n                .then(addToast)\n                .then(() => {\n                    dispatchEvent(reportEvents.tableReload, {preservePagination: true}, reportElement);\n                    return pendingPromise.resolve();\n                })\n                .catch(Notification.exception);\n        }\n\n        // Remove column from report.\n        const reportRemoveColumn = event.target.closest(reportSelectors.actions.reportRemoveColumn);\n        if (reportRemoveColumn) {\n            event.preventDefault();\n\n            const reportElement = reportRemoveColumn.closest(reportSelectors.regions.report);\n            const columnHeader = reportRemoveColumn.closest(reportSelectors.regions.columnHeader);\n            const columnName = columnHeader.dataset.columnName;\n\n            Notification.saveCancelPromise(\n                getString('deletecolumn', 'core_reportbuilder', columnName),\n                getString('deletecolumnconfirm', 'core_reportbuilder', columnName),\n                getString('delete', 'core'),\n                {triggerElement: reportRemoveColumn}\n            ).then(() => {\n                const pendingPromise = new Pending('core_reportbuilder/columns:remove');\n\n                return deleteColumn(reportElement.dataset.reportId, columnHeader.dataset.columnId)\n                    .then(data => publish(reportEvents.publish.reportColumnsUpdated, data))\n                    .then(() => addToast(getString('columndeleted', 'core_reportbuilder', columnName)))\n                    .then(() => {\n                        dispatchEvent(reportEvents.tableReload, {preservePagination: true}, reportElement);\n                        return pendingPromise.resolve();\n                    })\n                    .catch(Notification.exception);\n            }).catch(() => {\n                return;\n            });\n        }\n    });\n\n    // Initialize sortable list to handle column moving (note JQuery dependency, see MDL-72293 for resolution).\n    var columnSortableList = new SortableList(`${reportSelectors.regions.reportTable} thead tr`, {isHorizontal: true});\n    columnSortableList.getElementName = element => Promise.resolve(element.data('columnName'));\n\n    $(document).on(SortableList.EVENTS.DRAG, `${reportSelectors.regions.report} th[data-column-id]`, (event, info) => {\n        const reportElement = event.target.closest(reportSelectors.regions.report);\n        const columnPosition = info.element.data('columnPosition');\n        const targetColumnPosition = info.targetNextElement.data('columnPosition');\n\n        $(reportElement).find('tbody tr').each(function() {\n            const cell = $(this).children(`td.c${columnPosition - 1}`)[0];\n            if (targetColumnPosition) {\n                var beforeCell = $(this).children(`td.c${targetColumnPosition - 1}`)[0];\n                this.insertBefore(cell, beforeCell);\n            } else {\n                this.appendChild(cell);\n            }\n        });\n    });\n\n    $(document).on(SortableList.EVENTS.DROP, `${reportSelectors.regions.report} th[data-column-id]`, (event, info) => {\n        if (info.positionChanged) {\n            const pendingPromise = new Pending('core_reportbuilder/columns:reorder');\n            const reportElement = event.target.closest(reportSelectors.regions.report);\n            const columnId = info.element.data('columnId');\n            const columnName = info.element.data('columnName');\n            const columnPosition = info.element.data('columnPosition');\n\n            // Select target position, if moving to the end then count number of element siblings.\n            let targetColumnPosition = info.targetNextElement.data('columnPosition') || info.element.siblings().length + 2;\n            if (targetColumnPosition > columnPosition) {\n                targetColumnPosition--;\n            }\n\n            reorderColumn(reportElement.dataset.reportId, columnId, targetColumnPosition)\n                .then(() => getString('columnmoved', 'core_reportbuilder', columnName))\n                .then(addToast)\n                .then(() => {\n                    dispatchEvent(reportEvents.tableReload, {preservePagination: true}, reportElement);\n                    return pendingPromise.resolve();\n                })\n                .catch(Notification.exception);\n        }\n    });\n\n    // Initialize inplace editable listeners for column aggregation.\n    document.addEventListener(inplaceEditableEvents.elementUpdated, event => {\n\n        const columnAggregation = event.target.closest('[data-itemtype=\"columnaggregation\"]');\n        if (columnAggregation) {\n            const pendingPromise = new Pending('core_reportbuilder/columns:aggregate');\n            const reportElement = columnAggregation.closest(reportSelectors.regions.report);\n            const columnHeader = columnAggregation.closest(reportSelectors.regions.columnHeader);\n\n            getString('columnaggregated', 'core_reportbuilder', columnHeader.dataset.columnName)\n                .then(addToast)\n                .then(() => {\n                    // Pass preserveTriggerElement parameter so columnAggregationLink will be focused after the report reload.\n                    const columnAggregationLink = `[data-itemtype=\"columnaggregation\"][data-itemid=\"`\n                        + `${columnAggregation.dataset.itemid}\"] > a`;\n\n                    // Now reload the table, and notify listeners that columns have been updated.\n                    dispatchEvent(reportEvents.tableReload, {preserveTriggerElement: columnAggregationLink}, reportElement);\n                    return getColumnSorting(reportElement.dataset.reportId);\n                })\n                .then(data => publish(reportEvents.publish.reportColumnsUpdated, data))\n                .then(() => pendingPromise.resolve())\n                .catch(Notification.exception);\n        }\n    });\n};\n"],"file":"columns.min.js"}