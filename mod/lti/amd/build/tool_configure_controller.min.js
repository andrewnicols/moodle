define ("mod_lti/tool_configure_controller",["jquery","core/ajax","core/paged_content_factory","core/notification","core/templates","mod_lti/events","mod_lti/keys","mod_lti/tool_types_and_proxies","mod_lti/tool_type","mod_lti/tool_proxy","core/str","core/config"],function($,ajax,pagedContentFactory,notification,templates,ltiEvents,KEYS,toolTypesAndProxies,toolType,toolProxy,str,config){var SELECTORS={EXTERNAL_REGISTRATION_CONTAINER:"#external-registration-container",EXTERNAL_REGISTRATION_PAGE_CONTAINER:"#external-registration-page-container",EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER:"#external-registration-template-container",CARTRIDGE_REGISTRATION_CONTAINER:"#cartridge-registration-container",CARTRIDGE_REGISTRATION_FORM:"#cartridge-registration-form",ADD_TOOL_FORM:"#add-tool-form",TOOL_CARD_CONTAINER:"#tool-card-container",TOOL_LIST_CONTAINER:"#tool-list-container",TOOL_CREATE_BUTTON:"#tool-create-button",TOOL_CREATE_LTILEGACY_BUTTON:"#tool-createltilegacy-button",REGISTRATION_CHOICE_CONTAINER:"#registration-choice-container",TOOL_URL:"#tool-url"},getToolListContainer=function(){return $(SELECTORS.TOOL_LIST_CONTAINER)},getToolCardContainer=function(){return $(SELECTORS.TOOL_CARD_CONTAINER)},getExternalRegistrationContainer=function(){return $(SELECTORS.EXTERNAL_REGISTRATION_CONTAINER)},getCartridgeRegistrationContainer=function(){return $(SELECTORS.CARTRIDGE_REGISTRATION_CONTAINER)},getRegistrationChoiceContainer=function(){return $(SELECTORS.REGISTRATION_CHOICE_CONTAINER)},closeLTIAdvRegistration=function(e){if(e.data&&"org.imsglobal.lti.close"===e.data.subject){$(SELECTORS.EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER).empty();hideExternalRegistration();showRegistrationChoices();showToolList();showRegistrationChoices();reloadToolList()}},initiateRegistration=function(url){$(SELECTORS.EXTERNAL_REGISTRATION_PAGE_CONTAINER).removeClass("hidden");var container=$(SELECTORS.EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER);container.append($("<iframe src='startltiadvregistration.php?url="+encodeURIComponent(url)+"&sesskey="+config.sesskey+"'></iframe>"));showExternalRegistration();window.addEventListener("message",closeLTIAdvRegistration,!1)},getToolURL=function(){return $(SELECTORS.TOOL_URL).val()},hideExternalRegistration=function(){getExternalRegistrationContainer().addClass("hidden")},hideCartridgeRegistration=function(){getCartridgeRegistrationContainer().addClass("hidden")},hideRegistrationChoices=function(){getRegistrationChoiceContainer().addClass("hidden")},showExternalRegistration=function(){hideCartridgeRegistration();hideRegistrationChoices();getExternalRegistrationContainer().removeClass("hidden");screenReaderAnnounce(getExternalRegistrationContainer())},showCartridgeRegistration=function(url){hideExternalRegistration();hideRegistrationChoices();var container=getCartridgeRegistrationContainer();container.find("input").val("");container.removeClass("hidden");container.find(SELECTORS.CARTRIDGE_REGISTRATION_FORM).attr("data-cartridge-url",url);screenReaderAnnounce(container)},showRegistrationChoices=function(){hideExternalRegistration();hideCartridgeRegistration();getRegistrationChoiceContainer().removeClass("hidden");screenReaderAnnounce(getRegistrationChoiceContainer())},screenReaderAnnounce=function(element){var children=element.children().detach();children.appendTo(element)},hideToolList=function(){getToolListContainer().addClass("hidden")},showToolList=function(){getToolListContainer().removeClass("hidden")},showRegistrationFeedback=function(data){var type=data.error?"error":"success";notification.addNotification({message:data.message,type:type})},startLoading=function(element){element.addClass("loading")},stopLoading=function(element){element.removeClass("loading")},reloadToolList=function(){M.util.js_pending("reloadToolList");var cardContainer=getToolCardContainer(),listContainer=getToolListContainer();fetchToolCount().done(function(data){pagedContentFactory.createWithTotalAndLimit(data.count,60,function(pagesData){return pagesData.map(function(pageData){return fetchToolData(pageData.limit,pageData.offset).then(function(data){return renderToolData(data)})})},{showFirstLast:!0}).done(function(html,js){templates.replaceNodeContents(cardContainer,html,js)}).always(function(){stopLoading(listContainer);M.util.js_complete("reloadToolList")})});startLoading(listContainer)},fetchToolCount=function(){return toolTypesAndProxies.count({orphanedonly:!0}).done(function(data){return data}).catch(function(error){notification.exception(error);return{count:0}})},fetchToolData=function(limit,offset){var args={orphanedonly:!0};if(null!==limit&&!Number.isNaN(limit)){args.limit=limit}if(null!==offset&&!Number.isNaN(offset)){args.offset=offset}return toolTypesAndProxies.query(args).done(function(data){return data}).catch(function(error){notification.exception(error);return{types:[],proxies:[],limit:limit,offset:offset}})},renderToolData=function(data){var context={tools:data.types,proxies:data.proxies};return templates.render("mod_lti/tool_list",context).done(function(html,js){return{html:html,js:js}})},addLTIAdvTool=function(){var url=getToolURL().trim();if(url){$(SELECTORS.TOOL_URL).val("");hideToolList();initiateRegistration(url)}},addLTILegacyTool=function(){var url=getToolURL().trim();if(""===url){return $.Deferred().resolve()}var toolButton=$(SELECTORS.TOOL_CREATE_LTILEGACY_BUTTON);startLoading(toolButton);var promise=toolType.isCartridge(url);promise.always(function(){stopLoading(toolButton)});promise.done(function(result){if(result.iscartridge){$(SELECTORS.TOOL_URL).val("");$(document).trigger(ltiEvents.START_CARTRIDGE_REGISTRATION,url)}else{$(document).trigger(ltiEvents.START_EXTERNAL_REGISTRATION,{url:url})}});promise.fail(function(){str.get_string("errorbadurl","mod_lti").done(function(s){$(document).trigger(ltiEvents.REGISTRATION_FEEDBACK,{message:s,error:!0})}).fail(notification.exception)});return promise},registerEventListeners=function(){$(document).on(ltiEvents.NEW_TOOL_TYPE,function(){reloadToolList()});$(document).on(ltiEvents.START_EXTERNAL_REGISTRATION,function(){showExternalRegistration();$(SELECTORS.TOOL_URL).val("");hideToolList()});$(document).on(ltiEvents.STOP_EXTERNAL_REGISTRATION,function(){showToolList();showRegistrationChoices()});$(document).on(ltiEvents.START_CARTRIDGE_REGISTRATION,function(event,url){showCartridgeRegistration(url)});$(document).on(ltiEvents.STOP_CARTRIDGE_REGISTRATION,function(){getCartridgeRegistrationContainer().find(SELECTORS.CARTRIDGE_REGISTRATION_FORM).removeAttr("data-cartridge-url");showRegistrationChoices()});$(document).on(ltiEvents.REGISTRATION_FEEDBACK,function(event,data){showRegistrationFeedback(data)});var addLegacyButton=$(SELECTORS.TOOL_CREATE_LTILEGACY_BUTTON);addLegacyButton.click(function(e){e.preventDefault();addLTILegacyTool()});var addLTIButton=$(SELECTORS.TOOL_CREATE_BUTTON);addLTIButton.click(function(e){e.preventDefault();addLTIAdvTool()})};return{init:function init(){registerEventListeners();reloadToolList()}}});
//# sourceMappingURL=tool_configure_controller.min.js.map
