define ("mod_lti/tool_card_controller",["jquery","core/ajax","core/notification","core/templates","core/modal_factory","mod_lti/tool_type","mod_lti/events","mod_lti/keys","core/str"],function($,ajax,notification,templates,modalFactory,toolType,ltiEvents,KEYS,str){var SELECTORS={DELETE_BUTTON:".delete",NAME_ELEMENT:".name",DESCRIPTION_ELEMENT:".description",CAPABILITIES_CONTAINER:".capabilities-container",ACTIVATE_BUTTON:".tool-card-footer a.activate"},ANNOUNCEMENT_TIMEOUT=2e3,getDeleteButton=function(element){return element.find(SELECTORS.DELETE_BUTTON)},getNameElement=function(element){return element.find(SELECTORS.NAME_ELEMENT)},getDescriptionElement=function(element){return element.find(SELECTORS.DESCRIPTION_ELEMENT)},getActivateButton=function(element){return element.find(SELECTORS.ACTIVATE_BUTTON)},hasActivateButton=function(element){return getActivateButton(element).length?!0:!1},getCapabilitiesContainer=function(element){return element.find(SELECTORS.CAPABILITIES_CONTAINER)},hasCapabilitiesContainer=function(element){return getCapabilitiesContainer(element).length?!0:!1},getTypeId=function(element){return element.attr("data-type-id")},clearAllAnnouncements=function(element){element.removeClass("announcement loading success fail capabilities")},startLoading=function(element){clearAllAnnouncements(element);element.addClass("announcement loading")},stopLoading=function(element){element.removeClass("announcement loading")},announceSuccess=function(element){var promise=$.Deferred();clearAllAnnouncements(element);element.addClass("announcement success");setTimeout(function(){element.removeClass("announcement success");promise.resolve()},ANNOUNCEMENT_TIMEOUT);return promise},announceFailure=function(element){var promise=$.Deferred();clearAllAnnouncements(element);element.addClass("announcement fail");setTimeout(function(){element.removeClass("announcement fail");promise.resolve()},ANNOUNCEMENT_TIMEOUT);return promise},deleteType=function(element){var promise=$.Deferred(),typeId=getTypeId(element);startLoading(element);if(""===typeId){return $.Deferred().resolve()}str.get_strings([{key:"delete",component:"mod_lti"},{key:"delete_confirmation",component:"mod_lti"},{key:"delete",component:"mod_lti"},{key:"cancel",component:"core"}]).done(function(strs){notification.confirm(strs[0],strs[1],strs[2],strs[3],function(){toolType.delete(typeId).done(function(){stopLoading(element);announceSuccess(element).done(function(){element.remove()}).fail(notification.exception).always(function(){promise.resolve()})}).fail(function(error){announceFailure(element);promise.reject(error)})},function(){stopLoading(element);promise.resolve()})}).fail(function(error){stopLoading(element);notification.exception(error);promise.reject(error)});return promise},setValueSnapshot=function(element,value){element.attr("data-val-snapshot",value)},getValueSnapshot=function(element){return element.attr("data-val-snapshot")},snapshotDescription=function(element){var descriptionElement=getDescriptionElement(element);if(descriptionElement.hasClass("loading")){return}var description=descriptionElement.text().trim();setValueSnapshot(descriptionElement,description)},updateDescription=function(element){var typeId=getTypeId(element);if(""===typeId){return $.Deferred().resolve()}var descriptionElement=getDescriptionElement(element);if(descriptionElement.hasClass("loading")){return $.Deferred().resolve()}var description=descriptionElement.text().trim(),snapshotVal=getValueSnapshot(descriptionElement);if(snapshotVal==description){return $.Deferred().resolve()}descriptionElement.addClass("loading");var promise=toolType.update({id:typeId,description:description});promise.done(function(type){descriptionElement.removeClass("loading");descriptionElement.text(type.description)}).fail(notification.exception);promise.fail(function(){descriptionElement.removeClass("loading")});return promise},snapshotName=function(element){var nameElement=getNameElement(element);if(nameElement.hasClass("loading")){return}var name=nameElement.text().trim();setValueSnapshot(nameElement,name)},updateName=function(element){var typeId=getTypeId(element);if(""===typeId){return $.Deferred().resolve()}var nameElement=getNameElement(element);if(nameElement.hasClass("loading")){return $.Deferred().resolve()}var name=nameElement.text().trim(),snapshotVal=getValueSnapshot(nameElement);if(snapshotVal==name){return $.Deferred().resolve()}nameElement.addClass("loading");var promise=toolType.update({id:typeId,name:name});promise.done(function(type){nameElement.removeClass("loading");nameElement.text(type.name)});promise.fail(function(){nameElement.removeClass("loading")});return promise},setStatusActive=function(element){var id=getTypeId(element);if(""===id){return $.Deferred().resolve()}startLoading(element);var promise=toolType.update({id:id,state:toolType.constants.state.configured});promise.then(function(toolTypeData){stopLoading(element);announceSuccess(element);return toolTypeData}).then(function(toolTypeData){return templates.render("mod_lti/tool_card",toolTypeData)}).then(function(html,js){templates.replaceNode(element,html,js)}).catch(function(){stopLoading(element);announceFailure(element)});return promise},displayCapabilitiesApproval=function(element){element.addClass("announcement capabilities")},hideCapabilitiesApproval=function(element){element.removeClass("announcement capabilities")},activateToolType=function(element){if(hasCapabilitiesContainer(element)){displayCapabilitiesApproval(element)}else{setStatusActive(element)}},registerEventListeners=function(element){var deleteButton=getDeleteButton(element);deleteButton.click(function(e){e.preventDefault();deleteType(element)});deleteButton.keypress(function(e){if(!e.metaKey&&!e.shiftKey&&!e.altKey&&!e.ctrlKey){if(e.keyCode==KEYS.ENTER||e.keyCode==KEYS.SPACE){e.preventDefault();deleteButton.click()}}});var descriptionElement=getDescriptionElement(element);descriptionElement.focus(function(e){e.preventDefault();snapshotDescription(element)});descriptionElement.blur(function(e){e.preventDefault();updateDescription(element)});descriptionElement.keypress(function(e){if(!e.metaKey&&!e.shiftKey&&!e.altKey&&!e.ctrlKey){if(e.keyCode==KEYS.ENTER){e.preventDefault();descriptionElement.blur()}}});var nameElement=getNameElement(element);nameElement.focus(function(e){e.preventDefault();snapshotName(element)});nameElement.blur(function(e){e.preventDefault();updateName(element)});nameElement.keypress(function(e){if(!e.metaKey&&!e.shiftKey&&!e.altKey&&!e.ctrlKey){if(e.keyCode==KEYS.ENTER){e.preventDefault();nameElement.blur()}}});if(hasActivateButton(element)){var activateButton=getActivateButton(element);activateButton.click(function(e){e.preventDefault();activateToolType(element)});activateButton.keypress(function(e){if(!e.metaKey&&!e.shiftKey&&!e.altKey&&!e.ctrlKey){if(e.keyCode==KEYS.ENTER||e.keyCode==KEYS.SPACE){e.preventDefault();activateButton.click()}}})}if(hasCapabilitiesContainer(element)){var capabilitiesContainer=getCapabilitiesContainer(element);capabilitiesContainer.on(ltiEvents.CAPABILITIES_AGREE,function(){setStatusActive(element)});capabilitiesContainer.on(ltiEvents.CAPABILITIES_DECLINE,function(){hideCapabilitiesApproval(element)})}},registerModal=function(element){var trigger=$("#"+element.data("uniqid")+"-"+element.data("deploymentid")),context={uniqid:element.data("uniqid"),platformid:element.data("platformid"),clientid:element.data("clientid"),deploymentid:element.data("deploymentid"),urls:{publickeyset:element.data("publickeyseturl"),accesstoken:element.data("accesstokenurl"),authrequest:element.data("authrequesturl")}},bodyPromise=templates.render("mod_lti/tool_config_modal_body",context),mailTo="mailto:?subject="+encodeURIComponent(element.data("mailtosubject"))+"&body="+encodeURIComponent(element.data("platformidstr"))+":%20"+encodeURIComponent(element.data("platformid"))+"%0D%0A"+encodeURIComponent(element.data("clientidstr"))+":%20"+encodeURIComponent(element.data("clientid"))+"%0D%0A"+encodeURIComponent(element.data("deploymentidstr"))+":%20"+encodeURIComponent(element.data("deploymentid"))+"%0D%0A"+encodeURIComponent(element.data("publickeyseturlstr"))+":%20"+encodeURIComponent(element.data("publickeyseturl"))+"%0D%0A"+encodeURIComponent(element.data("accesstokenurlstr"))+":%20"+encodeURIComponent(element.data("accesstokenurl"))+"%0D%0A"+encodeURIComponent(element.data("authrequesturlstr"))+":%20"+encodeURIComponent(element.data("authrequesturl"))+"%0D%0A";context={mailto:mailTo};var footerPromise=templates.render("mod_lti/tool_config_modal_footer",context);modalFactory.create({large:!0,title:element.data("modaltitle"),body:bodyPromise,footer:footerPromise},trigger)};return{init:function init(element){registerEventListeners(element);registerModal(element)}}});
//# sourceMappingURL=tool_card_controller.min.js.map
