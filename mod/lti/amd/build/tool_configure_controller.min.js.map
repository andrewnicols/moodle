{"version":3,"sources":["../src/tool_configure_controller.js"],"names":["define","$","ajax","notification","templates","ltiEvents","KEYS","toolType","toolProxy","str","config","SELECTORS","EXTERNAL_REGISTRATION_CONTAINER","EXTERNAL_REGISTRATION_PAGE_CONTAINER","EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER","CARTRIDGE_REGISTRATION_CONTAINER","CARTRIDGE_REGISTRATION_FORM","ADD_TOOL_FORM","TOOL_LIST_CONTAINER","TOOL_CREATE_BUTTON","TOOL_CREATE_LTILEGACY_BUTTON","REGISTRATION_CHOICE_CONTAINER","TOOL_URL","getToolListContainer","getExternalRegistrationContainer","getCartridgeRegistrationContainer","getRegistrationChoiceContainer","closeLTIAdvRegistration","e","data","subject","empty","hideExternalRegistration","showRegistrationChoices","showToolList","reloadToolList","initiateRegistration","url","removeClass","container","append","encodeURIComponent","sesskey","showExternalRegistration","window","addEventListener","getToolURL","val","addClass","hideCartridgeRegistration","hideRegistrationChoices","screenReaderAnnounce","showCartridgeRegistration","find","attr","element","children","detach","appendTo","hideToolList","showRegistrationFeedback","type","error","addNotification","message","startLoading","stopLoading","promise","Deferred","when","query","done","types","proxies","render","tools","html","js","runTemplateJS","resolve","fail","reject","exception","always","addLTIAdvTool","trim","addLTILegacyTool","toolButton","isCartridge","result","iscartridge","document","trigger","START_CARTRIDGE_REGISTRATION","START_EXTERNAL_REGISTRATION","get_string","s","REGISTRATION_FEEDBACK","registerEventListeners","on","NEW_TOOL_TYPE","STOP_EXTERNAL_REGISTRATION","event","STOP_CARTRIDGE_REGISTRATION","removeAttr","addLegacyButton","click","preventDefault","addLTIButton","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Standard Ajax wrapper for Moodle. It calls the central Ajax script,\n * which can call any existing webservice using the current session.\n * In addition, it can batch multiple requests and return multiple responses.\n *\n * @module     mod_lti/tool_configure_controller\n * @copyright  2015 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/templates', 'mod_lti/events', 'mod_lti/keys', 'mod_lti/tool_type',\n        'mod_lti/tool_proxy', 'core/str', 'core/config'],\n        function($, ajax, notification, templates, ltiEvents, KEYS, toolType, toolProxy, str, config) {\n\n    var SELECTORS = {\n        EXTERNAL_REGISTRATION_CONTAINER: '#external-registration-container',\n        EXTERNAL_REGISTRATION_PAGE_CONTAINER: '#external-registration-page-container',\n        EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER: '#external-registration-template-container',\n        CARTRIDGE_REGISTRATION_CONTAINER: '#cartridge-registration-container',\n        CARTRIDGE_REGISTRATION_FORM: '#cartridge-registration-form',\n        ADD_TOOL_FORM: '#add-tool-form',\n        TOOL_LIST_CONTAINER: '#tool-list-container',\n        TOOL_CREATE_BUTTON: '#tool-create-button',\n        TOOL_CREATE_LTILEGACY_BUTTON: '#tool-createltilegacy-button',\n        REGISTRATION_CHOICE_CONTAINER: '#registration-choice-container',\n        TOOL_URL: '#tool-url'\n    };\n\n    /**\n     * Get the tool list container element.\n     *\n     * @method getToolListContainer\n     * @private\n     * @return {Object} jQuery object\n     */\n    var getToolListContainer = function() {\n        return $(SELECTORS.TOOL_LIST_CONTAINER);\n    };\n\n    /**\n     * Get the external registration container element.\n     *\n     * @method getExternalRegistrationContainer\n     * @private\n     * @return {Object} jQuery object\n     */\n    var getExternalRegistrationContainer = function() {\n        return $(SELECTORS.EXTERNAL_REGISTRATION_CONTAINER);\n    };\n\n    /**\n     * Get the cartridge registration container element.\n     *\n     * @method getCartridgeRegistrationContainer\n     * @private\n     * @return {Object} jQuery object\n     */\n    var getCartridgeRegistrationContainer = function() {\n        return $(SELECTORS.CARTRIDGE_REGISTRATION_CONTAINER);\n    };\n\n    /**\n     * Get the registration choice container element.\n     *\n     * @method getRegistrationChoiceContainer\n     * @private\n     * @return {Object} jQuery object\n     */\n    var getRegistrationChoiceContainer = function() {\n        return $(SELECTORS.REGISTRATION_CHOICE_CONTAINER);\n    };\n\n    /**\n     * Close the LTI Advantage Registration IFrame.\n     *\n     * @private\n     * @param {Object} e post message event sent from the registration frame.\n     */\n    var closeLTIAdvRegistration = function(e) {\n        if (e.data && 'org.imsglobal.lti.close' === e.data.subject) {\n            $(SELECTORS.EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER).empty();\n            hideExternalRegistration();\n            showRegistrationChoices();\n            showToolList();\n            showRegistrationChoices();\n            reloadToolList();\n        }\n    };\n\n    /**\n     * Load the external registration template and render it in the DOM and display it.\n     *\n     * @method initiateRegistration\n     * @private\n     * @param {String} url where to send the registration request\n     */\n    var initiateRegistration = function(url) {\n        // Show the external registration page in an iframe.\n        $(SELECTORS.EXTERNAL_REGISTRATION_PAGE_CONTAINER).removeClass('hidden');\n        var container = $(SELECTORS.EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER);\n        container.append($(\"<iframe src='startltiadvregistration.php?url=\"\n                         + encodeURIComponent(url) + \"&sesskey=\" + config.sesskey + \"'></iframe>\"));\n        showExternalRegistration();\n        window.addEventListener(\"message\", closeLTIAdvRegistration, false);\n    };\n\n    /**\n     * Get the tool type URL.\n     *\n     * @method getToolURL\n     * @private\n     * @return {String} the tool type url\n     */\n    var getToolURL = function() {\n        return $(SELECTORS.TOOL_URL).val();\n    };\n\n    /**\n     * Hide the external registration container.\n     *\n     * @method hideExternalRegistration\n     * @private\n     */\n    var hideExternalRegistration = function() {\n        getExternalRegistrationContainer().addClass('hidden');\n    };\n\n    /**\n     * Hide the cartridge registration container.\n     *\n     * @method hideCartridgeRegistration\n     * @private\n     */\n    var hideCartridgeRegistration = function() {\n        getCartridgeRegistrationContainer().addClass('hidden');\n    };\n\n    /**\n     * Hide the registration choice container.\n     *\n     * @method hideRegistrationChoices\n     * @private\n     */\n    var hideRegistrationChoices = function() {\n        getRegistrationChoiceContainer().addClass('hidden');\n    };\n\n    /**\n     * Display the external registration panel and hides the other\n     * panels.\n     *\n     * @method showExternalRegistration\n     * @private\n     */\n    var showExternalRegistration = function() {\n        hideCartridgeRegistration();\n        hideRegistrationChoices();\n        getExternalRegistrationContainer().removeClass('hidden');\n        screenReaderAnnounce(getExternalRegistrationContainer());\n    };\n\n    /**\n     * Display the cartridge registration panel and hides the other\n     * panels.\n     *\n     * @method showCartridgeRegistration\n     * @param {String} url\n     * @private\n     */\n    var showCartridgeRegistration = function(url) {\n        hideExternalRegistration();\n        hideRegistrationChoices();\n        // Don't save the key and secret from the last tool.\n        var container = getCartridgeRegistrationContainer();\n        container.find('input').val('');\n        container.removeClass('hidden');\n        container.find(SELECTORS.CARTRIDGE_REGISTRATION_FORM).attr('data-cartridge-url', url);\n        screenReaderAnnounce(container);\n    };\n\n    /**\n     * Display the registration choices panel and hides the other\n     * panels.\n     *\n     * @method showRegistrationChoices\n     * @private\n     */\n    var showRegistrationChoices = function() {\n        hideExternalRegistration();\n        hideCartridgeRegistration();\n        getRegistrationChoiceContainer().removeClass('hidden');\n        screenReaderAnnounce(getRegistrationChoiceContainer());\n    };\n\n    /**\n     * JAWS does not notice visibility changes with aria-live.\n     * Remove and add the content back to force it to read it out.\n     * This function can be removed once JAWS supports visibility.\n     *\n     * @method screenReaderAnnounce\n     * @param {Object} element\n     * @private\n     */\n    var screenReaderAnnounce = function(element) {\n        var children = element.children().detach();\n        children.appendTo(element);\n    };\n\n    /**\n     * Hides the list of tool types.\n     *\n     * @method hideToolList\n     * @private\n     */\n    var hideToolList = function() {\n        getToolListContainer().addClass('hidden');\n    };\n\n    /**\n     * Display the list of tool types.\n     *\n     * @method hideToolList\n     * @private\n     */\n    var showToolList = function() {\n        getToolListContainer().removeClass('hidden');\n    };\n\n    /**\n     * Display the registration feedback alert and hide the other panels.\n     *\n     * @method showRegistrationFeedback\n     * @param {Object} data\n     * @private\n     */\n    var showRegistrationFeedback = function(data) {\n        var type = data.error ? 'error' : 'success';\n        notification.addNotification({\n            message: data.message,\n            type: type\n        });\n    };\n\n    /**\n     * Show the loading animation\n     *\n     * @method startLoading\n     * @private\n     * @param {Object} element jQuery object\n     */\n    var startLoading = function(element) {\n        element.addClass(\"loading\");\n    };\n\n    /**\n     * Hide the loading animation\n     *\n     * @method stopLoading\n     * @private\n     * @param {Object} element jQuery object\n     */\n    var stopLoading = function(element) {\n        element.removeClass(\"loading\");\n    };\n\n    /**\n     * Refresh the list of tool types and render the new ones.\n     *\n     * @method reloadToolList\n     * @private\n     */\n    var reloadToolList = function() {\n        var promise = $.Deferred();\n        var container = getToolListContainer();\n        startLoading(container);\n\n        $.when(\n                toolType.query(),\n                toolProxy.query({'orphanedonly': true})\n            )\n            .done(function(types, proxies) {\n                    templates.render('mod_lti/tool_list', {tools: types, proxies: proxies})\n                        .done(function(html, js) {\n                                container.empty();\n                                container.append(html);\n                                templates.runTemplateJS(js);\n                                promise.resolve();\n                            }).fail(promise.reject);\n                })\n            .fail(promise.reject);\n\n        promise.fail(notification.exception)\n            .always(function() {\n                    stopLoading(container);\n                });\n    };\n\n    /**\n     * Start the LTI Advantage registration.\n     *\n     * @method addLTIAdvTool\n     * @private\n     */\n    var addLTIAdvTool = function() {\n        var url = getToolURL().trim();\n\n        if (url) {\n            $(SELECTORS.TOOL_URL).val('');\n            hideToolList();\n            initiateRegistration(url);\n        }\n\n    };\n\n    /**\n     * Trigger appropriate registration process process for the user input\n     * URL. It can either be a cartridge or a registration url.\n     *\n     * @method addLTILegacyTool\n     * @private\n     * @return {Promise} jQuery Deferred object\n     */\n    var addLTILegacyTool = function() {\n        var url = getToolURL().trim();\n\n        if (url === \"\") {\n            return $.Deferred().resolve();\n        }\n        var toolButton = $(SELECTORS.TOOL_CREATE_LTILEGACY_BUTTON);\n        startLoading(toolButton);\n\n        var promise = toolType.isCartridge(url);\n\n        promise.always(function() {\n          stopLoading(toolButton);\n        });\n\n        promise.done(function(result) {\n            if (result.iscartridge) {\n                $(SELECTORS.TOOL_URL).val('');\n                $(document).trigger(ltiEvents.START_CARTRIDGE_REGISTRATION, url);\n            } else {\n                $(document).trigger(ltiEvents.START_EXTERNAL_REGISTRATION, {url: url});\n            }\n        });\n\n        promise.fail(function() {\n            str.get_string('errorbadurl', 'mod_lti')\n                .done(function(s) {\n                        $(document).trigger(ltiEvents.REGISTRATION_FEEDBACK, {\n                                message: s,\n                                error: true\n                            });\n                    })\n                .fail(notification.exception);\n        });\n\n        return promise;\n    };\n\n    /**\n     * Sets up the listeners for user interaction on the page.\n     *\n     * @method registerEventListeners\n     * @private\n     */\n    var registerEventListeners = function() {\n\n        // These are events fired by the registration processes. Either\n        // the cartridge registration or the external registration url.\n        $(document).on(ltiEvents.NEW_TOOL_TYPE, function() {\n            reloadToolList();\n        });\n\n        $(document).on(ltiEvents.START_EXTERNAL_REGISTRATION, function() {\n            showExternalRegistration();\n            $(SELECTORS.TOOL_URL).val('');\n            hideToolList();\n        });\n\n        $(document).on(ltiEvents.STOP_EXTERNAL_REGISTRATION, function() {\n            showToolList();\n            showRegistrationChoices();\n        });\n\n        $(document).on(ltiEvents.START_CARTRIDGE_REGISTRATION, function(event, url) {\n            showCartridgeRegistration(url);\n        });\n\n        $(document).on(ltiEvents.STOP_CARTRIDGE_REGISTRATION, function() {\n            getCartridgeRegistrationContainer().find(SELECTORS.CARTRIDGE_REGISTRATION_FORM).removeAttr('data-cartridge-url');\n            showRegistrationChoices();\n        });\n\n        $(document).on(ltiEvents.REGISTRATION_FEEDBACK, function(event, data) {\n            showRegistrationFeedback(data);\n        });\n\n        var addLegacyButton = $(SELECTORS.TOOL_CREATE_LTILEGACY_BUTTON);\n        addLegacyButton.click(function(e) {\n            e.preventDefault();\n            addLTILegacyTool();\n        });\n\n        var addLTIButton = $(SELECTORS.TOOL_CREATE_BUTTON);\n        addLTIButton.click(function(e) {\n            e.preventDefault();\n            addLTIAdvTool();\n        });\n\n    };\n\n    return /** @alias module:mod_lti/cartridge_registration_form */ {\n\n        /**\n         * Initialise this module.\n         */\n        init: function() {\n            registerEventListeners();\n            reloadToolList();\n        }\n    };\n});\n"],"file":"tool_configure_controller.min.js"}