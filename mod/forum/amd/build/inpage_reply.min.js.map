{"version":3,"sources":["../src/inpage_reply.js"],"names":["define","$","Templates","Notification","Repository","Selectors","DISPLAYCONSTANTS","NESTED_V2","THREADED","NESTED","FLAT_OLDEST_FIRST","FLAT_NEWEST_FIRST","EVENTS","POST_CREATED","CONTENT_FORMATS","MOODLE","showSubmitButtonLoadingIcon","button","textContainer","find","post","inpageSubmitBtnText","loadingIconContainer","width","outerWidth","css","addClass","removeClass","hideSubmitButtonLoadingIcon","registerEventListeners","root","on","inpageSubmitBtn","e","preventDefault","submitButton","currentTarget","allButtons","parent","inpageReplyButton","form","parents","inpageReplyForm","get","message","elements","value","trim","messageformat","postid","reply","subject","currentRoot","closest","isprivatereply","privatereply","checked","modeSelector","modeSelect","mode","length","parseInt","newid","prop","addDiscussionPost","then","context","messages","reduce","carry","type","addNotification","reset","id","capabilities","currentAuthorName","children","not","repliesContainer","authorName","text","parentauthorname","showactionmenu","view","controlreadstatus","edit","split","delete","export","urls","viewparent","render","html","js","repliesnode","first","prependNodeContents","appendNodeContents","trigger","M","core_formchangechecker","reset_form_dirty_state","inpageReplyContent","hide","location","href","catch","error","exception","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module handles the in page replying to forum posts.\n *\n * @module     mod_forum/inpage_reply\n * @copyright  2019 Peter Dias\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n        'jquery',\n        'core/templates',\n        'core/notification',\n        'mod_forum/repository',\n        'mod_forum/selectors',\n    ], function(\n        $,\n        Templates,\n        Notification,\n        Repository,\n        Selectors\n    ) {\n\n    var DISPLAYCONSTANTS = {\n        NESTED_V2: 4,\n        THREADED: 2,\n        NESTED: 3,\n        FLAT_OLDEST_FIRST: 1,\n        FLAT_NEWEST_FIRST: -1\n    };\n\n    var EVENTS = {\n        POST_CREATED: 'mod_forum-post-created'\n    };\n\n     /**\n      * Moodle formats taken from the FORMAT_* constants declared in lib/weblib.php.\n      * @type {Object}\n      */\n    var CONTENT_FORMATS = {\n        MOODLE: 0\n    };\n    /**\n     * Show the loading icon for the submit button.\n     *\n     * @param {Object} button The submit button element\n     */\n    var showSubmitButtonLoadingIcon = function(button) {\n        var textContainer = button.find(Selectors.post.inpageSubmitBtnText);\n        var loadingIconContainer = button.find(Selectors.post.loadingIconContainer);\n        var width = button.outerWidth();\n        // Fix the width so that the button size doesn't change when we show the loading icon.\n        button.css('width', width);\n        textContainer.addClass('hidden');\n        loadingIconContainer.removeClass('hidden');\n    };\n\n    /**\n     * Hide the loading icon for the submit button.\n     *\n     * @param {Object} button The submit button element\n     */\n    var hideSubmitButtonLoadingIcon = function(button) {\n        var textContainer = button.find(Selectors.post.inpageSubmitBtnText);\n        var loadingIconContainer = button.find(Selectors.post.loadingIconContainer);\n        // Reset the width back to it's default.\n        button.css('width', '');\n        textContainer.removeClass('hidden');\n        loadingIconContainer.addClass('hidden');\n    };\n\n    /**\n     * Register the event listeners for the submit button of the in page reply.\n     *\n     * @param {Object} root The discussion container element.\n     */\n    var registerEventListeners = function(root) {\n        root.on('click', Selectors.post.inpageSubmitBtn, function(e) {\n            e.preventDefault();\n            var submitButton = $(e.currentTarget);\n            var allButtons = submitButton.parent().find(Selectors.post.inpageReplyButton);\n            var form = submitButton.parents(Selectors.post.inpageReplyForm).get(0);\n            var message = form.elements.post.value.trim();\n            // For now, we consider the inline reply post written using the FORMAT_MOODLE (because a textarea is displayed).\n            // In the future, other formats should be supported, letting users to use their preferred editor and format.\n            var messageformat = CONTENT_FORMATS.MOODLE;\n            // The message post will be converted from messageformat to FORMAT_HTML.\n            var topreferredformat = true;\n            var postid = form.elements.reply.value;\n            var subject = form.elements.subject.value;\n            var currentRoot = submitButton.closest(Selectors.post.post);\n            var isprivatereply = form.elements.privatereply != undefined ? form.elements.privatereply.checked : false;\n            var modeSelector = root.find(Selectors.post.modeSelect);\n            var mode = modeSelector.length ? parseInt(modeSelector.get(0).value) : null;\n            var newid;\n\n            if (message.length) {\n                showSubmitButtonLoadingIcon(submitButton);\n                allButtons.prop('disabled', true);\n\n                Repository.addDiscussionPost(postid, subject, message, messageformat, isprivatereply, topreferredformat)\n                    .then(function(context) {\n                        var message = context.messages.reduce(function(carry, message) {\n                            if (message.type == 'success') {\n                                carry += '<p>' + message.message + '</p>';\n                            }\n                            return carry;\n                        }, '');\n                        Notification.addNotification({\n                            message: message,\n                            type: \"success\"\n                        });\n\n                        return context;\n                    })\n                    .then(function(context) {\n                        form.reset();\n                        var post = context.post;\n                        newid = post.id;\n\n                        switch (mode) {\n                            case DISPLAYCONSTANTS.NESTED_V2:\n                                var capabilities = post.capabilities;\n                                var currentAuthorName = currentRoot.children()\n                                                                   .not(Selectors.post.repliesContainer)\n                                                                   .find(Selectors.post.authorName)\n                                                                   .text();\n                                post.parentauthorname = currentAuthorName;\n                                post.showactionmenu = capabilities.view ||\n                                                      capabilities.controlreadstatus ||\n                                                      capabilities.edit ||\n                                                      capabilities.split ||\n                                                      capabilities.delete ||\n                                                      capabilities.export ||\n                                                      post.urls.viewparent;\n                                return Templates.render('mod_forum/forum_discussion_nested_v2_post_reply', post);\n                            case DISPLAYCONSTANTS.THREADED:\n                                return Templates.render('mod_forum/forum_discussion_threaded_post', post);\n                            case DISPLAYCONSTANTS.NESTED:\n                                return Templates.render('mod_forum/forum_discussion_nested_post', post);\n                            default:\n                                return Templates.render('mod_forum/forum_discussion_post', post);\n                        }\n                    })\n                    .then(function(html, js) {\n                        var repliesnode = currentRoot.find(Selectors.post.repliesContainer).first();\n\n                        if (mode == DISPLAYCONSTANTS.FLAT_NEWEST_FIRST) {\n                            return Templates.prependNodeContents(repliesnode, html, js);\n                        } else {\n                            return Templates.appendNodeContents(repliesnode, html, js);\n                        }\n                    })\n                    .then(function() {\n                        submitButton.trigger(EVENTS.POST_CREATED, newid);\n                        hideSubmitButtonLoadingIcon(submitButton);\n                        allButtons.prop('disabled', false);\n\n                        // Tell formchangechecker we submitted the form.\n                        if (typeof M.core_formchangechecker !== 'undefined') {\n                            M.core_formchangechecker.reset_form_dirty_state();\n                        }\n\n                        return currentRoot.find(Selectors.post.inpageReplyContent).hide();\n                    })\n                    .then(function() {\n                        location.href = \"#p\" + newid;\n                        return;\n                    })\n                    .catch(function(error) {\n                        hideSubmitButtonLoadingIcon(submitButton);\n                        allButtons.prop('disabled', false);\n                        return Notification.exception(error);\n                    });\n            }\n        });\n    };\n\n    return {\n        init: function(root) {\n            registerEventListeners(root);\n        },\n        CONTENT_FORMATS: CONTENT_FORMATS,\n        EVENTS: EVENTS\n    };\n});\n"],"file":"inpage_reply.min.js"}