function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define ("mod_forum/local/grades/grader",["exports","core/templates","./local/grader/selectors","./local/grader/user_picker","mod_forum/local/layout/fullscreen","./local/grader/gradingpanel","core/toast","core/notification","core/str","core_grades/grades/grader/gradingpanel/normalise","core/loadingicon","core/utils","core_grades/grades/grader/gradingpanel/comparison","core/modal_factory","core/modal_events","core/pubsub","core/drawer_events"],function(_exports,_templates,_selectors,_user_picker,_fullscreen,_gradingpanel,_toast,_notification,_str,_normalise,_loadingicon,_utils,_comparison,Modal,ModalEvents,_pubsub,_drawer_events){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});Object.defineProperty(_exports,"getGradingPanelFunctions",{enumerable:!0,get:function get(){return _gradingpanel.default}});_exports.view=_exports.launch=void 0;_templates=_interopRequireDefault(_templates);_selectors=_interopRequireDefault(_selectors);_user_picker=_interopRequireDefault(_user_picker);_gradingpanel=_interopRequireDefault(_gradingpanel);Modal=_interopRequireWildcard(Modal);ModalEvents=_interopRequireWildcard(ModalEvents);_drawer_events=_interopRequireDefault(_drawer_events);function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable})),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1,source;i<arguments.length;i++){source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach(function(key){_defineProperty(target,key,source[key])}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}return target}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0})}else{obj[key]=value}return obj}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if("Object"===n&&o.constructor)n=o.constructor.name;if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(null==len||len>arr.length)len=arr.length;for(var i=0,arr2=Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _arr=[],_n=!0,_d=!1,_s,_e;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done);_n=!0){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=!0;_e=err}finally{try{if(!_n&&null!=_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)})}}var templateNames={grader:{app:"mod_forum/local/grades/grader",gradingPanel:{error:"mod_forum/local/grades/local/grader/gradingpanel/error"},searchResults:"mod_forum/local/grades/local/grader/user_picker/user_search",status:"mod_forum/local/grades/local/grader/status"}},displayUserPicker=function(root,html){var pickerRegion=root.querySelector(_selectors.default.regions.pickerRegion);_templates.default.replaceNodeContents(pickerRegion,html,"")},fetchContentFromRender=function(html,js){return[html,js]},getUpdateUserContentFunction=function(root,getContentForUser,getGradeForUser,saveGradeForUser){var firstLoad=!0;return function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(user){var spinner,_yield$Promise$all,_yield$Promise$all2,_yield$Promise$all2$,html,js,userGrade,_yield$Templates$rend,_yield$Templates$rend2,gradingPanelHtml,gradingPanelJS,panelContainer,panel,form;return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:spinner=firstLoad?null:(0,_loadingicon.addIconToContainerWithPromise)(root);_context.next=3;return Promise.all([getContentForUser(user.id).then(fetchContentFromRender),getGradeForUser(user.id)]);case 3:_yield$Promise$all=_context.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,2);_yield$Promise$all2$=_slicedToArray(_yield$Promise$all2[0],2);html=_yield$Promise$all2$[0];js=_yield$Promise$all2$[1];userGrade=_yield$Promise$all2[1];_templates.default.replaceNodeContents(root.querySelector(_selectors.default.regions.moduleReplace),html,js);_context.next=12;return _templates.default.render(userGrade.templatename,userGrade.grade).then(fetchContentFromRender);case 12:_yield$Templates$rend=_context.sent;_yield$Templates$rend2=_slicedToArray(_yield$Templates$rend,2);gradingPanelHtml=_yield$Templates$rend2[0];gradingPanelJS=_yield$Templates$rend2[1];panelContainer=root.querySelector(_selectors.default.regions.gradingPanelContainer);panel=panelContainer.querySelector(_selectors.default.regions.gradingPanel);_templates.default.replaceNodeContents(panel,gradingPanelHtml,gradingPanelJS);form=panel.querySelector("form");(0,_comparison.fillInitialValues)(form);form.addEventListener("submit",function(event){saveGradeForUser(user);event.preventDefault()});panelContainer.scrollTop=0;firstLoad=!1;if(spinner){spinner.resolve()}return _context.abrupt("return",userGrade);case 26:case"end":return _context.stop();}}},_callee)}));return function(){return _ref.apply(this,arguments)}}()},showSearchResultContainer=function(bodyContainer,userPickerContainer,searchResultsContainer){bodyContainer.classList.add("hidden");userPickerContainer.classList.add("hidden");searchResultsContainer.classList.remove("hidden")},hideSearchResultContainer=function(bodyContainer,userPickerContainer,searchResultsContainer){bodyContainer.classList.remove("hidden");userPickerContainer.classList.remove("hidden");searchResultsContainer.classList.add("hidden")},showUserSearchInput=function(toggleSearchButton,searchContainer,searchInput){searchContainer.classList.remove("collapsed");toggleSearchButton.setAttribute("aria-expanded","true");toggleSearchButton.classList.add("expand");toggleSearchButton.classList.remove("collapse");var gradingInfoContainer=searchContainer.parentElement.querySelector(_selectors.default.regions.gradingInfoContainer);gradingInfoContainer.setAttribute("aria-hidden","true");var collapseGradingDrawer=searchContainer.parentElement.querySelector(_selectors.default.buttons.collapseGradingDrawer);collapseGradingDrawer.setAttribute("aria-hidden","true");collapseGradingDrawer.setAttribute("tabindex","-1");searchInput.focus()},hideUserSearchInput=function(toggleSearchButton,searchContainer,searchInput){searchContainer.classList.add("collapsed");toggleSearchButton.setAttribute("aria-expanded","false");toggleSearchButton.classList.add("collapse");toggleSearchButton.classList.remove("expand");toggleSearchButton.focus();var gradingInfoContainer=searchContainer.parentElement.querySelector(_selectors.default.regions.gradingInfoContainer);gradingInfoContainer.removeAttribute("aria-hidden");var collapseGradingDrawer=searchContainer.parentElement.querySelector(_selectors.default.buttons.collapseGradingDrawer);collapseGradingDrawer.removeAttribute("aria-hidden");collapseGradingDrawer.setAttribute("tabindex","0");searchInput.value=""},searchForUsers=function(userList,searchTerm){if(""===searchTerm){return userList}searchTerm=searchTerm.toLowerCase();return userList.filter(function(user){return user.fullname.toLowerCase().includes(searchTerm)})},renderSearchResults=function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(searchResultsContainer,users){var _yield$Templates$rend3,html,js;return regeneratorRuntime.wrap(function(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return _templates.default.renderForPromise(templateNames.grader.searchResults,{users:users});case 2:_yield$Templates$rend3=_context2.sent;html=_yield$Templates$rend3.html;js=_yield$Templates$rend3.js;_templates.default.replaceNodeContents(searchResultsContainer,html,js);case 6:case"end":return _context2.stop();}}},_callee2)}));return function(){return _ref2.apply(this,arguments)}}(),registerEventListeners=function(graderLayout,userPicker,saveGradeFunction,userList){var graderContainer=graderLayout.getContainer(),toggleSearchButton=graderContainer.querySelector(_selectors.default.buttons.toggleSearch),searchInputContainer=graderContainer.querySelector(_selectors.default.regions.userSearchContainer),searchInput=searchInputContainer.querySelector(_selectors.default.regions.userSearchInput),bodyContainer=graderContainer.querySelector(_selectors.default.regions.bodyContainer),userPickerContainer=graderContainer.querySelector(_selectors.default.regions.pickerRegion),searchResultsContainer=graderContainer.querySelector(_selectors.default.regions.searchResultsContainer);graderContainer.addEventListener("click",function(e){if(e.target.closest(_selectors.default.buttons.toggleFullscreen)){e.stopImmediatePropagation();e.preventDefault();graderLayout.toggleFullscreen();return}if(e.target.closest(_selectors.default.buttons.closeGrader)){e.stopImmediatePropagation();e.preventDefault();graderLayout.close();return}if(e.target.closest(_selectors.default.buttons.saveGrade)){saveGradeFunction(userPicker.currentUser)}if(e.target.closest(_selectors.default.buttons.toggleSearch)){if("true"===toggleSearchButton.getAttribute("aria-expanded")){hideUserSearchInput(toggleSearchButton,searchInputContainer,searchInput);hideSearchResultContainer(bodyContainer,userPickerContainer,searchResultsContainer);searchResultsContainer.innerHTML=""}else{showUserSearchInput(toggleSearchButton,searchInputContainer,searchInput);showSearchResultContainer(bodyContainer,userPickerContainer,searchResultsContainer);renderSearchResults(searchResultsContainer,userList)}return}var selectUserButton=e.target.closest(_selectors.default.buttons.selectUser);if(selectUserButton){var userId=selectUserButton.getAttribute("data-userid"),user=userList.find(function(user){return user.id==userId});userPicker.setUserId(userId);userPicker.showUser(user);hideUserSearchInput(toggleSearchButton,searchInputContainer,searchInput);hideSearchResultContainer(bodyContainer,userPickerContainer,searchResultsContainer);searchResultsContainer.innerHTML=""}});searchInput.addEventListener("input",(0,_utils.debounce)(function(){var users=searchForUsers(userList,searchInput.value);renderSearchResults(searchResultsContainer,users)},300));(0,_pubsub.subscribe)(_drawer_events.default.DRAWER_HIDDEN,function(drawerRoot){var gradingPanel=drawerRoot[0];if(gradingPanel.querySelector(_selectors.default.regions.gradingPanel)){setContentContainerMargin(graderContainer,0)}});(0,_pubsub.subscribe)(_drawer_events.default.DRAWER_SHOWN,function(drawerRoot){var gradingPanel=drawerRoot[0];if(gradingPanel.querySelector(_selectors.default.regions.gradingPanel)){setContentContainerMargin(graderContainer,gradingPanel.offsetWidth)}})},setContentContainerMargin=function(graderContainer,rightMargin){var contentContainer=graderContainer.querySelector(_selectors.default.regions.moduleContainer);if(contentContainer){contentContainer.style.marginRight="".concat(rightMargin,"px")}},getSaveUserGradeFunction=function(root,setGradeForUser){return function(){var _ref3=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(user){var result;return regeneratorRuntime.wrap(function(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;root.querySelector(_selectors.default.regions.gradingPanelErrors).innerHTML="";_context3.next=4;return setGradeForUser(user.id,root.querySelector(_selectors.default.values.sendStudentNotifications).value,root.querySelector(_selectors.default.regions.gradingPanel));case 4:result=_context3.sent;if(!result.success){_context3.next=11;break}_context3.t0=_toast.add;_context3.next=9;return(0,_str.get_string)("grades:gradesavedfor","mod_forum",user);case 9:_context3.t1=_context3.sent;(0,_context3.t0)(_context3.t1);case 11:if(result.failed){displayGradingError(root,user,result.error)}return _context3.abrupt("return",result);case 15:_context3.prev=15;_context3.t2=_context3["catch"](0);displayGradingError(root,user,_context3.t2);return _context3.abrupt("return",(0,_normalise.failedUpdate)(_context3.t2));case 19:case"end":return _context3.stop();}}},_callee3,null,[[0,15]])}));return function(){return _ref3.apply(this,arguments)}}()},displayGradingError=function(){var _ref4=_asyncToGenerator(regeneratorRuntime.mark(function _callee4(root,user,err){var _yield$Promise$all3,_yield$Promise$all4,_yield$Promise$all4$,html,js,errorString;return regeneratorRuntime.wrap(function(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.t0=Promise;_context4.t1=_templates.default.renderForPromise(templateNames.grader.gradingPanel.error,{error:err});_context4.next=4;return(0,_str.get_string)("grades:gradesavefailed","mod_forum",_objectSpread({error:err.message},user));case 4:_context4.t2=_context4.sent;_context4.t3=[_context4.t1,_context4.t2];_context4.next=8;return _context4.t0.all.call(_context4.t0,_context4.t3);case 8:_yield$Promise$all3=_context4.sent;_yield$Promise$all4=_slicedToArray(_yield$Promise$all3,2);_yield$Promise$all4$=_yield$Promise$all4[0];html=_yield$Promise$all4$.html;js=_yield$Promise$all4$.js;errorString=_yield$Promise$all4[1];_templates.default.replaceNodeContents(root.querySelector(_selectors.default.regions.gradingPanelErrors),html,js);(0,_toast.add)(errorString,{type:"warning"});case 16:case"end":return _context4.stop();}}},_callee4)}));return function(){return _ref4.apply(this,arguments)}}(),launch=function(){var _ref5=_asyncToGenerator(regeneratorRuntime.mark(function _callee6(getListOfUsers,getContentForUser,getGradeForUser,setGradeForUser){var _ref6,_ref6$initialUserId,initialUserId,moduleName,courseName,courseUrl,sendStudentNotifications,_ref6$focusOnClose,focusOnClose,userList,_yield$Promise$all5,_yield$Promise$all6,graderLayout,_yield$Promise$all6$,html,js,graderContainer,saveGradeFunction,updateUserContent,userIds,statusContainer,userPicker,_args6=arguments;return regeneratorRuntime.wrap(function(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_ref6=4<_args6.length&&_args6[4]!==void 0?_args6[4]:{},_ref6$initialUserId=_ref6.initialUserId,initialUserId=void 0===_ref6$initialUserId?null:_ref6$initialUserId,moduleName=_ref6.moduleName,courseName=_ref6.courseName,courseUrl=_ref6.courseUrl,sendStudentNotifications=_ref6.sendStudentNotifications,_ref6$focusOnClose=_ref6.focusOnClose,focusOnClose=void 0===_ref6$focusOnClose?null:_ref6$focusOnClose;_context6.next=3;return getListOfUsers();case 3:userList=_context6.sent;if(userList.length){_context6.next=12;break}_context6.t0=_notification.addNotification;_context6.next=8;return(0,_str.get_string)("nouserstograde","core_grades");case 8:_context6.t1=_context6.sent;_context6.t2={message:_context6.t1,type:"error"};(0,_context6.t0)(_context6.t2);return _context6.abrupt("return");case 12:_context6.next=14;return Promise.all([(0,_fullscreen.createLayout)({fullscreen:!1,showLoader:!1,focusOnClose:focusOnClose}),_templates.default.renderForPromise(templateNames.grader.app,{moduleName:moduleName,courseName:courseName,courseUrl:courseUrl,drawer:{show:!0},defaultsendnotifications:sendStudentNotifications})]);case 14:_yield$Promise$all5=_context6.sent;_yield$Promise$all6=_slicedToArray(_yield$Promise$all5,2);graderLayout=_yield$Promise$all6[0];_yield$Promise$all6$=_yield$Promise$all6[1];html=_yield$Promise$all6$.html;js=_yield$Promise$all6$.js;graderContainer=graderLayout.getContainer();saveGradeFunction=getSaveUserGradeFunction(graderContainer,setGradeForUser);_templates.default.replaceNodeContents(graderContainer,html,js);updateUserContent=getUpdateUserContentFunction(graderContainer,getContentForUser,getGradeForUser,saveGradeFunction);userIds=userList.map(function(user){return user.id});statusContainer=graderContainer.querySelector(_selectors.default.regions.statusContainer);_context6.next=28;return(0,_user_picker.default)(userList,function(){var _ref7=_asyncToGenerator(regeneratorRuntime.mark(function _callee5(user){var userGrade,renderContext;return regeneratorRuntime.wrap(function(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return updateUserContent(user);case 2:userGrade=_context5.sent;renderContext={status:userGrade.hasgrade,index:userIds.indexOf(user.id)+1,total:userList.length};_templates.default.render(templateNames.grader.status,renderContext).then(function(html){statusContainer.innerHTML=html;return html}).catch();case 5:case"end":return _context5.stop();}}},_callee5)}));return function(){return _ref7.apply(this,arguments)}}(),saveGradeFunction,{initialUserId:initialUserId});case 28:userPicker=_context6.sent;registerEventListeners(graderLayout,userPicker,saveGradeFunction,userList);displayUserPicker(graderContainer,userPicker.rootNode);case 31:case"end":return _context6.stop();}}},_callee6)}));return function(){return _ref5.apply(this,arguments)}}();_exports.launch=launch;var view=function(){var _ref8=_asyncToGenerator(regeneratorRuntime.mark(function _callee7(getGradeForUser,userid,moduleName){var _ref9,_ref9$focusOnClose,focusOnClose,_yield$Promise$all7,_yield$Promise$all8,userGrade,modal,spinner,output,_yield$Templates$rend4,html,js,_yield$renderGradeTem,_yield$renderGradeTem2,gradeHTML,gradeJS,gradeReplace,_args7=arguments;return regeneratorRuntime.wrap(function(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_ref9=3<_args7.length&&_args7[3]!==void 0?_args7[3]:{},_ref9$focusOnClose=_ref9.focusOnClose,focusOnClose=void 0===_ref9$focusOnClose?null:_ref9$focusOnClose;_context7.next=3;return Promise.all([getGradeForUser(userid),Modal.create({title:moduleName,large:!0,type:Modal.types.CANCEL})]);case 3:_yield$Promise$all7=_context7.sent;_yield$Promise$all8=_slicedToArray(_yield$Promise$all7,2);userGrade=_yield$Promise$all8[0];modal=_yield$Promise$all8[1];spinner=(0,_loadingicon.addIconToContainerWithPromise)(modal.getRoot());modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy();if(focusOnClose){try{focusOnClose.focus()}catch(e){}}});modal.show();output=document.createElement("div");_context7.next=13;return _templates.default.renderForPromise("mod_forum/local/grades/view_grade",userGrade);case 13:_yield$Templates$rend4=_context7.sent;html=_yield$Templates$rend4.html;js=_yield$Templates$rend4.js;_templates.default.replaceNodeContents(output,html,js);_context7.next=19;return renderGradeTemplate(userGrade);case 19:_yield$renderGradeTem=_context7.sent;_yield$renderGradeTem2=_slicedToArray(_yield$renderGradeTem,2);gradeHTML=_yield$renderGradeTem2[0];gradeJS=_yield$renderGradeTem2[1];gradeReplace=output.querySelector("[data-region=\"grade-template\"]");_templates.default.replaceNodeContents(gradeReplace,gradeHTML,gradeJS);modal.setBody(output.outerHTML);spinner.resolve();case 27:case"end":return _context7.stop();}}},_callee7)}));return function(){return _ref8.apply(this,arguments)}}();_exports.view=view;var renderGradeTemplate=function(){var _ref10=_asyncToGenerator(regeneratorRuntime.mark(function _callee8(userGrade){var _yield$Templates$rend5,html,js;return regeneratorRuntime.wrap(function(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.next=2;return _templates.default.renderForPromise(userGrade.templatename,userGrade.grade);case 2:_yield$Templates$rend5=_context8.sent;html=_yield$Templates$rend5.html;js=_yield$Templates$rend5.js;return _context8.abrupt("return",[html,js]);case 6:case"end":return _context8.stop();}}},_callee8)}));return function(){return _ref10.apply(this,arguments)}}()});
//# sourceMappingURL=grader.min.js.map
