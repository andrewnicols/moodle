{"version":3,"sources":["../../src/grades/expandconversation.js"],"names":["findGradableNode","node","closest","ForumSelectors","expandConversation","showPostInContext","rootNode","focusOnClose","postId","dataset","postid","discussionId","discussionid","discussionName","name","experimentalDisplayMode","Promise","all","Repository","getDiscussionPosts","parseInt","Modal","create","title","large","type","types","CANCEL","allPosts","modal","postsById","Map","posts","map","post","readonly","hasreplies","replies","id","forEach","parentid","parent","get","parentauthorname","author","fullname","push","getRoot","on","ModalEvents","hidden","destroy","focus","e","bodyRendered","relevantPost","querySelector","scrollIntoView","behavior","show","templatePromise","Templates","render","experimentaldisplaymode","setBody","registerEventListeners","addEventListener","target","preventDefault","err"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module handles the creation of a Modal that shows the user's post in context of the entire discussion.\n *\n * @module     mod_forum/grades/expandconversation\n * @package    mod_forum\n * @copyright  2019 Mathew May <mathew.solutions>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport * as ForumSelectors from './grader/selectors';\nimport Repository from 'mod_forum/repository';\nimport {exception as showException} from \"core/notification\";\nimport Templates from 'core/templates';\nimport * as Modal from 'core/modal_factory';\nimport * as ModalEvents from 'core/modal_events';\n\n/**\n * Find the Node containing the gradable details from the provided node by searching up the tree.\n *\n * @param {HTMLElement} node\n * @returns {HTMLElement}\n */\nconst findGradableNode = node => node.closest(ForumSelectors.expandConversation);\n\n/**\n * Show the post in context in a modal.\n *\n * @param {HTMLElement} rootNode The button that has been clicked\n */\nconst showPostInContext = async(rootNode, {\n    focusOnClose = null,\n} = {}) => {\n    const postId = rootNode.dataset.postid;\n    const discussionId = rootNode.dataset.discussionid;\n    const discussionName = rootNode.dataset.name;\n    const experimentalDisplayMode = rootNode.dataset.experimentalDisplayMode == \"1\";\n\n    const [\n        allPosts,\n        modal,\n    ] = await Promise.all([\n        Repository.getDiscussionPosts(parseInt(discussionId)),\n        Modal.create({\n            title: discussionName,\n            large: true,\n            type: Modal.types.CANCEL\n        }),\n    ]);\n\n    const postsById = new Map(allPosts.posts.map(post => {\n        post.readonly = true;\n        post.hasreplies = false;\n        post.replies = [];\n        return [post.id, post];\n    }));\n\n    let posts = [];\n    allPosts.posts.forEach(post => {\n        if (post.parentid) {\n            const parent = postsById.get(post.parentid);\n            if (parent) {\n                post.parentauthorname = parent.author.fullname;\n                parent.hasreplies = true;\n                parent.replies.push(post);\n            } else {\n                posts.push(post);\n            }\n        } else {\n            posts.push(post);\n        }\n    });\n\n    // Handle hidden event.\n    modal.getRoot().on(ModalEvents.hidden, function() {\n        // Destroy when hidden.\n        modal.destroy();\n        try {\n            focusOnClose.focus();\n        } catch (e) {\n            // eslint-disable-line\n        }\n    });\n\n    modal.getRoot().on(ModalEvents.bodyRendered, () => {\n        const relevantPost = modal.getRoot()[0].querySelector(`#p${postId}`);\n        if (relevantPost) {\n            relevantPost.scrollIntoView({behavior: \"smooth\"});\n        }\n    });\n\n    modal.show();\n\n    // Note: We do not use await here because it messes with the Modal transitions.\n    const templatePromise = Templates.render('mod_forum/grades/grader/discussion/post_modal', {\n        posts,\n        experimentaldisplaymode: experimentalDisplayMode\n    });\n    modal.setBody(templatePromise);\n};\n\n/**\n * Register event listeners for the expand conversations button.\n *\n * @param {HTMLElement} rootNode The root to listen to.\n */\nexport const registerEventListeners = (rootNode) => {\n    rootNode.addEventListener('click', (e) => {\n        const rootNode = findGradableNode(e.target);\n\n        if (rootNode) {\n            e.preventDefault();\n\n            try {\n                showPostInContext(rootNode, {\n                    focusOnClose: e.target,\n                });\n            } catch (err) {\n                showException(err);\n            }\n        }\n    });\n};\n"],"file":"expandconversation.min.js"}