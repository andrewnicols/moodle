function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define ("mod_forum/grades/grader",["exports","./grader/selectors","mod_forum/repository","core/templates","../local/grades/grader","core/notification","core_course/repository","core/url"],function(_exports,Selectors,_repository,_templates,Grader,_notification,_repository2,_url){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.registerLaunchListeners=void 0;Selectors=_interopRequireWildcard(Selectors);_repository=_interopRequireDefault(_repository);_templates=_interopRequireDefault(_templates);Grader=_interopRequireWildcard(Grader);_notification=_interopRequireDefault(_notification);_repository2=_interopRequireDefault(_repository2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable})),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1,source;i<arguments.length;i++){source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach(function(key){_defineProperty(target,key,source[key])}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}return target}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0})}else{obj[key]=value}return obj}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)})}}var templateNames={contentRegion:"mod_forum/grades/grader/discussion/posts"},getContentForUserIdFunction=function(cmid,experimentalDisplayMode){return function(userid){return _repository.default.getDiscussionByUserID(userid,cmid).then(function(context){context.discussions=context.discussions.map(discussionPostMapper);context.experimentaldisplaymode=experimentalDisplayMode?!0:!1;return _templates.default.render(templateNames.contentRegion,context)}).catch(_notification.default.exception)}},getUsersForCmidFunction=function(cmid,groupID){return _asyncToGenerator(regeneratorRuntime.mark(function _callee(){var context;return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _repository2.default.getUsersFromCourseModuleID(cmid,groupID);case 2:context=_context.sent;return _context.abrupt("return",context.users);case 4:case"end":return _context.stop();}}},_callee)}))},findGradableNode=function(node){return node.closest(Selectors.gradableItem)},discussionPostMapper=function(discussion){var parentMap=new Map;discussion.posts.parentposts.forEach(function(post){return parentMap.set(post.id,post)});var userPosts=discussion.posts.userposts.map(function(post){post.readonly=!0;post.hasreplies=!1;post.replies=[];var parent=post.parentid?parentMap.get(post.parentid):null;if(parent){parent.hasreplies=!1;parent.replies=[];parent.readonly=!0;post.parentauthorname=parent.author.fullname}return{parent:parent,post:post}});return _objectSpread(_objectSpread({},discussion),{},{posts:userPosts})},launchWholeForumGrading=function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(rootNode){var _ref3,_ref3$focusOnClose,focusOnClose,data,gradingPanelFunctions,groupID,_args2=arguments;return regeneratorRuntime.wrap(function(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_ref3=1<_args2.length&&_args2[1]!==void 0?_args2[1]:{},_ref3$focusOnClose=_ref3.focusOnClose,focusOnClose=void 0===_ref3$focusOnClose?null:_ref3$focusOnClose;data=rootNode.dataset;_context2.next=4;return Grader.getGradingPanelFunctions("mod_forum",data.contextid,data.gradingComponent,data.gradingComponentSubtype,data.gradableItemtype);case 4:gradingPanelFunctions=_context2.sent;groupID=data.group?data.group:0;_context2.next=8;return Grader.launch(getUsersForCmidFunction(data.cmid,groupID),getContentForUserIdFunction(data.cmid,"1"==data.experimentalDisplayMode),gradingPanelFunctions.getter,gradingPanelFunctions.setter,{groupid:data.groupid,initialUserId:data.initialuserid,moduleName:data.name,courseName:data.courseName,courseUrl:(0,_url.relativeUrl)("/course/view.php",{id:data.courseId}),sendStudentNotifications:data.sendStudentNotifications,focusOnClose:focusOnClose});case 8:case"end":return _context2.stop();}}},_callee2)}));return function(){return _ref2.apply(this,arguments)}}(),launchViewGrading=function(){var _ref4=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(rootNode){var _ref5,_ref5$focusOnClose,focusOnClose,data,gradingPanelFunctions,_args3=arguments;return regeneratorRuntime.wrap(function(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_ref5=1<_args3.length&&_args3[1]!==void 0?_args3[1]:{},_ref5$focusOnClose=_ref5.focusOnClose,focusOnClose=void 0===_ref5$focusOnClose?null:_ref5$focusOnClose;data=rootNode.dataset;_context3.next=4;return Grader.getGradingPanelFunctions("mod_forum",data.contextid,data.gradingComponent,data.gradingComponentSubtype,data.gradableItemtype);case 4:gradingPanelFunctions=_context3.sent;_context3.next=7;return Grader.view(gradingPanelFunctions.getter,data.userid,data.name,{focusOnClose:focusOnClose});case 7:case"end":return _context3.stop();}}},_callee3)}));return function(){return _ref4.apply(this,arguments)}}();_exports.registerLaunchListeners=function registerLaunchListeners(){document.addEventListener("click",function(){var _ref6=_asyncToGenerator(regeneratorRuntime.mark(function _callee4(e){var rootNode,_rootNode;return regeneratorRuntime.wrap(function(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!e.target.matches(Selectors.launch)){_context4.next=17;break}rootNode=findGradableNode(e.target);if(rootNode){_context4.next=4;break}throw Error("Unable to find a gradable item");case 4:if(!rootNode.matches(Selectors.gradableItems.wholeForum)){_context4.next=16;break}e.preventDefault();_context4.prev=6;_context4.next=9;return launchWholeForumGrading(rootNode,{focusOnClose:e.target});case 9:_context4.next=14;break;case 11:_context4.prev=11;_context4.t0=_context4["catch"](6);_notification.default.exception(_context4.t0);case 14:_context4.next=17;break;case 16:throw Error("Unable to find a valid gradable item");case 17:if(!e.target.matches(Selectors.viewGrade)){_context4.next=35;break}e.preventDefault();_rootNode=findGradableNode(e.target);if(_rootNode){_context4.next=22;break}throw Error("Unable to find a gradable item");case 22:if(!_rootNode.matches(Selectors.gradableItems.wholeForum)){_context4.next=34;break}e.preventDefault();_context4.prev=24;_context4.next=27;return launchViewGrading(_rootNode,{focusOnClose:e.target});case 27:_context4.next=32;break;case 29:_context4.prev=29;_context4.t1=_context4["catch"](24);_notification.default.exception(_context4.t1);case 32:_context4.next=35;break;case 34:throw Error("Unable to find a valid gradable item");case 35:case"end":return _context4.stop();}}},_callee4,null,[[6,11],[24,29]])}));return function(){return _ref6.apply(this,arguments)}}())}});
//# sourceMappingURL=grader.min.js.map
