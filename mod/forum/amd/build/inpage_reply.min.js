define ("mod_forum/inpage_reply",["jquery","core/templates","core/notification","mod_forum/repository","mod_forum/selectors","core_form/changechecker"],function($,Templates,Notification,Repository,Selectors,FormChangeChecker){var DISPLAYCONSTANTS={NESTED_V2:4,THREADED:2,NESTED:3,FLAT_OLDEST_FIRST:1,FLAT_NEWEST_FIRST:-1},EVENTS={POST_CREATED:"mod_forum-post-created"},CONTENT_FORMATS={MOODLE:0},showSubmitButtonLoadingIcon=function(button){var textContainer=button.find(Selectors.post.inpageSubmitBtnText),loadingIconContainer=button.find(Selectors.post.loadingIconContainer),width=button.outerWidth();button.css("width",width);textContainer.addClass("hidden");loadingIconContainer.removeClass("hidden")},hideSubmitButtonLoadingIcon=function(button){var textContainer=button.find(Selectors.post.inpageSubmitBtnText),loadingIconContainer=button.find(Selectors.post.loadingIconContainer);button.css("width","");textContainer.removeClass("hidden");loadingIconContainer.addClass("hidden")},registerEventListeners=function(root){root.on("click",Selectors.post.inpageSubmitBtn,function(e){e.preventDefault();var submitButton=$(e.currentTarget),allButtons=submitButton.parent().find(Selectors.post.inpageReplyButton),form=submitButton.parents(Selectors.post.inpageReplyForm).get(0),message=form.elements.post.value.trim(),messageformat=CONTENT_FORMATS.MOODLE,postid=form.elements.reply.value,subject=form.elements.subject.value,currentRoot=submitButton.closest(Selectors.post.post),isprivatereply=form.elements.privatereply!=void 0?form.elements.privatereply.checked:!1,modeSelector=root.find(Selectors.post.modeSelect),mode=modeSelector.length?parseInt(modeSelector.get(0).value):null,newid;if(message.length){showSubmitButtonLoadingIcon(submitButton);allButtons.prop("disabled",!0);Repository.addDiscussionPost(postid,subject,message,messageformat,isprivatereply,!0).then(function(context){var message=context.messages.reduce(function(carry,message){if("success"==message.type){carry+="<p>"+message.message+"</p>"}return carry},"");Notification.addNotification({message:message,type:"success"});return context}).then(function(context){form.reset();var post=context.post;newid=post.id;switch(mode){case DISPLAYCONSTANTS.NESTED_V2:var capabilities=post.capabilities,currentAuthorName=currentRoot.children().not(Selectors.post.repliesContainer).find(Selectors.post.authorName).text();post.parentauthorname=currentAuthorName;post.showactionmenu=capabilities.view||capabilities.controlreadstatus||capabilities.edit||capabilities.split||capabilities.delete||capabilities.export||post.urls.viewparent;return Templates.render("mod_forum/forum_discussion_nested_v2_post_reply",post);case DISPLAYCONSTANTS.THREADED:return Templates.render("mod_forum/forum_discussion_threaded_post",post);case DISPLAYCONSTANTS.NESTED:return Templates.render("mod_forum/forum_discussion_nested_post",post);default:return Templates.render("mod_forum/forum_discussion_post",post);}}).then(function(html,js){var repliesnode=currentRoot.find(Selectors.post.repliesContainer).first();if(mode==DISPLAYCONSTANTS.FLAT_NEWEST_FIRST){return Templates.prependNodeContents(repliesnode,html,js)}else{return Templates.appendNodeContents(repliesnode,html,js)}}).then(function(){submitButton.trigger(EVENTS.POST_CREATED,newid);hideSubmitButtonLoadingIcon(submitButton);allButtons.prop("disabled",!1);FormChangeChecker.resetFormDirtyState(submitButton[0]);return currentRoot.find(Selectors.post.inpageReplyContent).hide()}).then(function(){location.href="#p"+newid}).catch(function(error){hideSubmitButtonLoadingIcon(submitButton);allButtons.prop("disabled",!1);return Notification.exception(error)})}})};return{init:function(root){registerEventListeners(root)},CONTENT_FORMATS:CONTENT_FORMATS,EVENTS:EVENTS}});
//# sourceMappingURL=inpage_reply.min.js.map
