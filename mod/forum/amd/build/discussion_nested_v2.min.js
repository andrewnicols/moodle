function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define ("mod_forum/discussion_nested_v2",["exports","jquery","core/auto_rows","core/custom_interaction_events","core_form/changechecker","core/notification","core/templates","mod_forum/discussion","mod_forum/inpage_reply","mod_forum/lock_toggle","mod_forum/favourite_toggle","mod_forum/pin_toggle","mod_forum/selectors","mod_forum/subscription_toggle"],function(_exports,_jquery,_auto_rows,_custom_interaction_events,FormChangeChecker,_notification,_templates,_discussion,_inpage_reply,_lock_toggle,_favourite_toggle,_pin_toggle,_selectors,_subscription_toggle){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.init=void 0;_jquery=_interopRequireDefault(_jquery);_auto_rows=_interopRequireDefault(_auto_rows);_custom_interaction_events=_interopRequireDefault(_custom_interaction_events);FormChangeChecker=_interopRequireWildcard(FormChangeChecker);_notification=_interopRequireDefault(_notification);_templates=_interopRequireDefault(_templates);_discussion=_interopRequireDefault(_discussion);_inpage_reply=_interopRequireDefault(_inpage_reply);_lock_toggle=_interopRequireDefault(_lock_toggle);_favourite_toggle=_interopRequireDefault(_favourite_toggle);_pin_toggle=_interopRequireDefault(_pin_toggle);_selectors=_interopRequireDefault(_selectors);_subscription_toggle=_interopRequireDefault(_subscription_toggle);function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable})),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1,source;i<arguments.length;i++){source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach(function(key){_defineProperty(target,key,source[key])}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}return target}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0})}else{obj[key]=value}return obj}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)})}}var getPostContainer=function(element){return element.closest(_selectors.default.post.post)},getPostContainerById=function(element,id){return element.find("".concat(_selectors.default.post.post,"[data-post-id=").concat(id,"]"))},getParentPostContainers=function(element){return element.parents(_selectors.default.post.post)},getPostContentContainer=function(postContainer){return postContainer.children().not(_selectors.default.post.repliesContainer).find(_selectors.default.post.forumCoreContent)},getInPageReplyContainer=function(postContainer){return postContainer.children().filter(_selectors.default.post.inpageReplyContainer)},getInPageReplyForm=function(postContainer){return getInPageReplyContainer(postContainer).find(_selectors.default.post.inpageReplyContent)},getInPageReplyCreateButton=function(postContainer){return getPostContentContainer(postContainer).find(_selectors.default.post.inpageReplyCreateButton)},getRepliesVisibilityToggleContainer=function(postContainer){return postContainer.children(_selectors.default.post.repliesVisibilityToggleContainer)},getRepliesContainer=function(postContainer){return postContainer.children(_selectors.default.post.repliesContainer)},hasReplies=function(postContainer){return 0<getRepliesContainer(postContainer).children().length},getShowRepliesButton=function(replyVisibilityToggleContainer){return replyVisibilityToggleContainer.find(_selectors.default.post.showReplies)},getHideRepliesButton=function(replyVisibilityToggleContainer){return replyVisibilityToggleContainer.find(_selectors.default.post.hideReplies)},repliesVisible=function(postContainer){var repliesContainer=getRepliesContainer(postContainer);return repliesContainer.is(":visible")},showReplies=function(postContainer){var postIdToSee=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,repliesContainer=getRepliesContainer(postContainer),replyVisibilityToggleContainer=getRepliesVisibilityToggleContainer(postContainer),showButton=getShowRepliesButton(replyVisibilityToggleContainer),hideButton=getHideRepliesButton(replyVisibilityToggleContainer);showButton.addClass("hidden");hideButton.removeClass("hidden");repliesContainer.slideDown({duration:150,queue:!1,complete:function complete(){if(postIdToSee){var postContainerToSee=getPostContainerById(repliesContainer,postIdToSee);if(postContainerToSee.length){postContainerToSee[0].scrollIntoView()}}}}).css("display","none").fadeIn(150)},hideReplies=function(postContainer){var repliesContainer=getRepliesContainer(postContainer),replyVisibilityToggleContainer=getRepliesVisibilityToggleContainer(postContainer),showButton=getShowRepliesButton(replyVisibilityToggleContainer),hideButton=getHideRepliesButton(replyVisibilityToggleContainer);showButton.removeClass("hidden");hideButton.addClass("hidden");repliesContainer.slideUp({duration:150,queue:!1}).fadeOut(150)},showInPageReplyForm=null,buildShowInPageReplyFormFunction=function(additionalTemplateContext){return function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(postContainer){var inPageReplyContainer,repliesVisibilityToggleContainer,inPageReplyCreateButton,html;return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:inPageReplyContainer=getInPageReplyContainer(postContainer);repliesVisibilityToggleContainer=getRepliesVisibilityToggleContainer(postContainer);inPageReplyCreateButton=getInPageReplyCreateButton(postContainer);if(hasInPageReplyForm(inPageReplyContainer)){_context.next=15;break}_context.prev=4;_context.next=7;return renderInPageReplyTemplate(additionalTemplateContext,inPageReplyCreateButton,postContainer);case 7:html=_context.sent;_templates.default.appendNodeContents(inPageReplyContainer,html,"");_context.next=14;break;case 11:_context.prev=11;_context.t0=_context["catch"](4);_notification.default.exception(_context.t0);case 14:FormChangeChecker.watchForm(postContainer[0].querySelector("form"));case 15:inPageReplyCreateButton.fadeOut(150,function(){var inPageReplyForm=getInPageReplyForm(postContainer);inPageReplyForm.slideDown({duration:150,queue:!1,complete:function complete(){inPageReplyForm.find("textarea").focus()}}).css("display","none").fadeIn(150);if(repliesVisibilityToggleContainer.length&&hasReplies(postContainer)){repliesVisibilityToggleContainer.fadeIn(150);hideReplies(postContainer)}});case 16:case"end":return _context.stop();}}},_callee,null,[[4,11]])}));return function(){return _ref.apply(this,arguments)}}()},hideInPageReplyForm=function(postContainer){var postIdToSee=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,inPageReplyForm=getInPageReplyForm(postContainer),inPageReplyCreateButton=getInPageReplyCreateButton(postContainer),repliesVisibilityToggleContainer=getRepliesVisibilityToggleContainer(postContainer);if(repliesVisibilityToggleContainer.length&&hasReplies(postContainer)){repliesVisibilityToggleContainer.fadeOut(150);if(!repliesVisible(postContainer)){showReplies(postContainer,postIdToSee)}}inPageReplyForm.slideUp({duration:150,queue:!1,complete:function complete(){inPageReplyCreateButton.fadeIn(150)}}).fadeOut(200)},hasInPageReplyForm=function(inPageReplyContainer){return 0<inPageReplyContainer.find(_selectors.default.post.inpageReplyContent).length},renderInPageReplyTemplate=function(additionalTemplateContext,button,postContainer){var postContentContainer=getPostContentContainer(postContainer),currentSubject=postContentContainer.find(_selectors.default.post.forumSubject).text(),currentAuthorName=postContentContainer.find(_selectors.default.post.authorName).text(),context=_objectSpread({postid:postContainer.data("post-id"),reply_url:button.attr("data-href"),sesskey:M.cfg.sesskey,parentsubject:currentSubject,parentauthorname:currentAuthorName,canreplyprivately:button.data("can-reply-privately"),postformat:_inpage_reply.default.CONTENT_FORMATS.MOODLE},additionalTemplateContext);return _templates.default.render("mod_forum/inpage_reply_v2",context)},incrementTotalReplyCount=function(postContainer){getRepliesVisibilityToggleContainer(postContainer).find(_selectors.default.post.replyCount).each(function(index,element){var currentCount=parseInt(element.innerText,10);element.innerText=currentCount+1})},registerEventListeners=function(root){_custom_interaction_events.default.define(root,[_custom_interaction_events.default.events.activate]);_auto_rows.default.init(root);root.on(_custom_interaction_events.default.events.activate,_selectors.default.post.inpageReplyCreateButton,function(e,data){data.originalEvent.preventDefault();var postContainer=getPostContainer((0,_jquery.default)(e.currentTarget));showInPageReplyForm(postContainer)});root.on(_custom_interaction_events.default.events.activate,_selectors.default.post.inpageReplyCancelButton,function(e,data){data.originalEvent.preventDefault();var postContainer=getPostContainer((0,_jquery.default)(e.currentTarget));hideInPageReplyForm(postContainer)});root.on(_custom_interaction_events.default.events.activate,_selectors.default.post.showReplies,function(e,data){data.originalEvent.preventDefault();var postContainer=getPostContainer((0,_jquery.default)(e.target));showReplies(postContainer)});root.on(_custom_interaction_events.default.events.activate,_selectors.default.post.hideReplies,function(e,data){data.originalEvent.preventDefault();var postContainer=getPostContainer((0,_jquery.default)(e.target));hideReplies(postContainer)});root.on(_inpage_reply.default.EVENTS.POST_CREATED,_selectors.default.post.inpageSubmitBtn,function(e,newPostId){var currentTarget=(0,_jquery.default)(e.currentTarget),postContainer=getPostContainer(currentTarget),postContainers=getParentPostContainers(currentTarget);hideInPageReplyForm(postContainer,newPostId);postContainers.each(function(index,container){incrementTotalReplyCount((0,_jquery.default)(container))})})},init=function(root,context){showInPageReplyForm=buildShowInPageReplyFormFunction(context);registerEventListeners(root);_discussion.default.init(root);_inpage_reply.default.init(root);var discussionToolsContainer=root.find(_selectors.default.discussion.tools);_lock_toggle.default.init(discussionToolsContainer,!1);_favourite_toggle.default.init(discussionToolsContainer,!1,function(toggleElement,response){var newTargetState=response.userstate.favourited?0:1;return toggleElement.data("targetstate",newTargetState)});_pin_toggle.default.init(discussionToolsContainer,!1,function(toggleElement,response){var newTargetState=response.pinned?0:1;return toggleElement.data("targetstate",newTargetState)});_subscription_toggle.default.init(discussionToolsContainer,!1,function(toggleElement,response){var newTargetState=response.userstate.subscribed?0:1;toggleElement.data("targetstate",newTargetState)})};_exports.init=init});
//# sourceMappingURL=discussion_nested_v2.min.js.map
