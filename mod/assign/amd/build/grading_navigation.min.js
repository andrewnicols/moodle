define ("mod_assign/grading_navigation",["jquery","core/notification","core/str","core/form-autocomplete","core/ajax","mod_assign/grading_form_change_checker"],function($,notification,str,autocomplete,ajax,checker){var GradingNavigation=function(selector){this._regionSelector=selector;this._region=$(selector);this._filters=[];this._users=[];this._filteredUsers=[];this._lastXofYUpdate=0;this._firstLoadUsers=!0;this._loadAllUsers();this._region.find("[data-action=\"previous-user\"]").on("click",this._handlePreviousUser.bind(this));this._region.find("[data-action=\"next-user\"]").on("click",this._handleNextUser.bind(this));this._region.find("[data-action=\"change-user\"]").on("change",this._handleChangeUser.bind(this));this._region.find("[data-region=\"user-filters\"]").on("click",this._toggleExpandFilters.bind(this));$(document).on("user-changed",this._refreshSelector.bind(this));$(document).on("done-saving-show-next",this._handleNextUser.bind(this));var toggleLink=this._region.find("[data-region=\"user-filters\"]"),configPanel=$(document.getElementById(toggleLink.attr("aria-controls")));configPanel.on("change","select",this._filterChanged.bind(this));var userid=$("[data-region=\"grading-navigation-panel\"]").data("first-userid");if(userid){this._selectUserById(userid)}str.get_string("changeuser","mod_assign").done(function(s){autocomplete.enhance("[data-action=change-user]",!1,"mod_assign/participant_selector",s)}).fail(notification.exception);$(document).bind("start-loading-user",function(){this._isLoading=!0}.bind(this));$(document).bind("finish-loading-user",function(){this._isLoading=!1}.bind(this))};GradingNavigation.prototype._isLoading=!1;GradingNavigation.prototype._regionSelector=null;GradingNavigation.prototype._filters=null;GradingNavigation.prototype._users=null;GradingNavigation.prototype._region=null;GradingNavigation.prototype._lastFilters="";GradingNavigation.prototype._loadAllUsers=function(){var select=this._region.find("[data-action=change-user]"),assignmentid=select.attr("data-assignmentid"),groupid=select.attr("data-groupid"),filterPanel=this._region.find("[data-region=\"configure-filters\"]"),filter=filterPanel.find("select[name=\"filter\"]").val(),workflowFilter=filterPanel.find("select[name=\"workflowfilter\"]");if(workflowFilter){filter+=","+workflowFilter.val()}var markerFilter=filterPanel.find("select[name=\"markerfilter\"]");if(markerFilter){filter+=","+markerFilter.val()}if(this._lastFilters==filter){return!1}this._lastFilters=filter;ajax.call([{methodname:"mod_assign_list_participants",args:{assignid:assignmentid,groupid:groupid,filter:"",onlyids:!0,tablesort:!0},done:this._usersLoaded.bind(this),fail:notification.exception}]);return!0};GradingNavigation.prototype._usersLoaded=function(users){this._firstLoadUsers=!1;this._filteredUsers=this._users=users;if(this._users.length){var toggleLink=this._region.find("[data-region=\"user-filters\"]"),configPanel=$(document.getElementById(toggleLink.attr("aria-controls")));configPanel.find("select[name=\"filter\"]").trigger("change")}else{this._selectNoUser()}this._triggerNextUserEvent()};GradingNavigation.prototype._checkClickOutsideConfigureFilters=function(event){var configPanel=this._region.find("[data-region=\"configure-filters\"]");if(!configPanel.is(event.target)&&0===configPanel.has(event.target).length){var toggleLink=this._region.find("[data-region=\"user-filters\"]");configPanel.hide();configPanel.attr("aria-hidden","true");toggleLink.attr("aria-expanded","false");$(document).unbind("click.mod_assign_grading_navigation")}};GradingNavigation.prototype._updateFilterPreferences=function(userId,filterList,preferenceNames){var preferences=[],i=0;if(0==filterList.length||this._firstLoadUsers){var deferred=$.Deferred();deferred.resolve();return deferred}for(i=0;i<filterList.length;i++){var newValue=filterList[i];if("none"==newValue){newValue=""}preferences.push({userid:userId,name:preferenceNames[i],value:newValue})}return ajax.call([{methodname:"core_user_set_user_preferences",args:{preferences:preferences}}])[0]};GradingNavigation.prototype._filterChanged=function(){var filterPanel=this._region.find("[data-region=\"configure-filters\"]"),filters=filterPanel.find("select"),preferenceNames=[];this._filters=[];filters.each(function(idx,ele){var element=$(ele);this._filters.push(element.val());preferenceNames.push("assign_"+element.prop("name"))}.bind(this));var filterlist=[];filterPanel.find("option:checked").each(function(idx,ele){filterlist[filterlist.length]=$(ele).text()});if(filterlist.length){this._region.find("[data-region=\"user-filters\"] span").text(filterlist.join(", "))}else{str.get_string("nofilters","mod_assign").done(function(s){this._region.find("[data-region=\"user-filters\"] span").text(s)}.bind(this)).fail(notification.exception)}var select=this._region.find("[data-action=change-user]"),currentUserID=select.data("currentuserid");this._updateFilterPreferences(currentUserID,this._filters,preferenceNames).done(function(){if(!this._loadAllUsers()){var userid=parseInt(select.attr("data-selected")),foundIndex=0;$.each(this._filteredUsers,function(index,user){if(userid==user.id){foundIndex=index}});if(this._filteredUsers.length){this._selectUserById(this._filteredUsers[foundIndex].id)}else{this._selectNoUser()}}}.bind(this)).fail(notification.exception);this._refreshCount()};GradingNavigation.prototype._selectNoUser=function(){if(this._isLoading){return}if(checker.checkFormForChanges("[data-region=\"grade-panel\"] .gradeform")){str.get_strings([{key:"unsavedchanges",component:"mod_assign"},{key:"unsavedchangesquestion",component:"mod_assign"},{key:"saveandcontinue",component:"mod_assign"},{key:"cancel",component:"core"}]).done(function(strs){notification.confirm(strs[0],strs[1],strs[2],strs[3],function(){$(document).trigger("save-changes",-1)})})}else{$(document).trigger("user-changed",-1)}};GradingNavigation.prototype._selectUserById=function(userid){var select=this._region.find("[data-action=change-user]"),useridnumber=parseInt(userid,10);if(this._isLoading){return}if(checker.checkFormForChanges("[data-region=\"grade-panel\"] .gradeform")){str.get_strings([{key:"unsavedchanges",component:"mod_assign"},{key:"unsavedchangesquestion",component:"mod_assign"},{key:"saveandcontinue",component:"mod_assign"},{key:"cancel",component:"core"}]).done(function(strs){notification.confirm(strs[0],strs[1],strs[2],strs[3],function(){$(document).trigger("save-changes",useridnumber)})})}else{select.attr("data-selected",userid);if(!isNaN(useridnumber)&&0<useridnumber){$(document).trigger("user-changed",userid)}}};GradingNavigation.prototype._toggleExpandFilters=function(event){event.preventDefault();var toggleLink=$(event.target).closest("[data-region=\"user-filters\"]"),expanded="true"==toggleLink.attr("aria-expanded"),configPanel=$(document.getElementById(toggleLink.attr("aria-controls")));if(expanded){configPanel.hide();configPanel.attr("aria-hidden","true");toggleLink.attr("aria-expanded","false");$(document).unbind("click.mod_assign_grading_navigation")}else{configPanel.css("display","inline-block");configPanel.attr("aria-hidden","false");toggleLink.attr("aria-expanded","true");event.stopPropagation();$(document).on("click.mod_assign_grading_navigation",this._checkClickOutsideConfigureFilters.bind(this))}};GradingNavigation.prototype._handlePreviousUser=function(e){e.preventDefault();var select=this._region.find("[data-action=change-user]"),currentUserId=select.attr("data-selected"),i=0,currentIndex=0;for(i=0;i<this._filteredUsers.length;i++){if(this._filteredUsers[i].id==currentUserId){currentIndex=i;break}}var count=this._filteredUsers.length,newIndex=currentIndex-1;if(0>newIndex){newIndex=count-1}if(count){this._selectUserById(this._filteredUsers[newIndex].id)}};GradingNavigation.prototype._handleNextUser=function(e,saved){e.preventDefault();var select=this._region.find("[data-action=change-user]"),currentUserId=select.attr("data-selected"),i=0,currentIndex=0;for(i=0;i<this._filteredUsers.length;i++){if(this._filteredUsers[i].id==currentUserId){currentIndex=i;break}}var count=this._filteredUsers.length,newIndex=(currentIndex+1)%count;if(saved&&count){var userid=this._filteredUsers[newIndex].id,useridnumber=parseInt(userid,10);select.attr("data-selected",userid);if(!isNaN(useridnumber)&&0<useridnumber){$(document).trigger("user-changed",userid)}}else if(count){this._selectUserById(this._filteredUsers[newIndex].id)}};GradingNavigation.prototype._setCountString=function(x,y){var updateNumber=0;this._lastXofYUpdate++;updateNumber=this._lastXofYUpdate;str.get_string("xofy","mod_assign",{x:x,y:y}).done(function(s){if(updateNumber==this._lastXofYUpdate){this._region.find("[data-region=\"user-count-summary\"]").text(s)}}.bind(this)).fail(notification.exception)};GradingNavigation.prototype._refreshCount=function(){var select=this._region.find("[data-action=change-user]"),userid=select.attr("data-selected"),i=0,currentIndex=0;if(isNaN(userid)||0>=userid){this._region.find("[data-region=\"user-count\"]").hide()}else{this._region.find("[data-region=\"user-count\"]").show();for(i=0;i<this._filteredUsers.length;i++){if(this._filteredUsers[i].id==userid){currentIndex=i;break}}var count=this._filteredUsers.length;if(count){currentIndex+=1}this._setCountString(currentIndex,count);if(0<currentIndex){var url=new URL(window.location);if(0<parseInt(url.searchParams.get("blindid"))){var newid=this._filteredUsers[currentIndex-1].recordid;url.searchParams.set("blindid",newid)}else{url.searchParams.set("userid",userid)}window.history.replaceState({},"",url)}}};GradingNavigation.prototype._refreshSelector=function(event,userid){var select=this._region.find("[data-action=change-user]");userid=parseInt(userid,10);if(!isNaN(userid)&&0<userid){select.attr("data-selected",userid)}this._refreshCount()};GradingNavigation.prototype._triggerNextUserEvent=function(){if(1<this._filteredUsers.length){$(document).trigger("next-user",{nextUserId:null,nextUser:!0})}else{$(document).trigger("next-user",{nextUser:!1})}};GradingNavigation.prototype._handleChangeUser=function(){var select=this._region.find("[data-action=change-user]"),userid=parseInt(select.val(),10);if(this._isLoading){return}if(checker.checkFormForChanges("[data-region=\"grade-panel\"] .gradeform")){str.get_strings([{key:"unsavedchanges",component:"mod_assign"},{key:"unsavedchangesquestion",component:"mod_assign"},{key:"saveandcontinue",component:"mod_assign"},{key:"cancel",component:"core"}]).done(function(strs){notification.confirm(strs[0],strs[1],strs[2],strs[3],function(){$(document).trigger("save-changes",userid)})})}else{if(!isNaN(userid)&&0<userid){select.attr("data-selected",userid);$(document).trigger("user-changed",userid)}}};return GradingNavigation});
//# sourceMappingURL=grading_navigation.min.js.map
