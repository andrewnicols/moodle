define ("mod_bigbluebuttonbn/recordings",["exports","./repository","core/notification","core/str","core/loadingicon","core/modal_factory","core/modal_events","core/pending"],function(_exports,repository,_notification,Str,_loadingicon,_modal_factory,_modal_events,_pending){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.init=void 0;repository=_interopRequireWildcard(repository);Str=_interopRequireWildcard(Str);_modal_factory=_interopRequireDefault(_modal_factory);_modal_events=_interopRequireDefault(_modal_events);_pending=_interopRequireDefault(_pending);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!=typeof obj&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}const stringList=["view_recording_yui_first","view_recording_yui_prev","view_recording_yui_next","view_recording_yui_last","view_recording_yui_page","view_recording_yui_go","view_recording_yui_rows","view_recording_yui_show_all"],getStringsForYui=()=>{const stringMap=stringList.map(key=>{return{key,component:"bigbluebuttonbn"}});return(0,Str.get_strings)(stringMap).then(_ref=>{let[first,prev,next,last,goToLabel,goToAction,perPage,showAll]=_ref;return{first,prev,next,last,goToLabel,goToAction,perPage,showAll}}).catch()},getYuiInstance=lang=>new Promise(resolve=>{YUI({lang}).use("intl","datatable","datatable-sort","datatable-paginator","datatype-number",Y=>{resolve(Y)})}),formatDates=(locale,dateList)=>dateList.map(row=>{const date=new Date(row.date);row.date=date.toLocaleDateString(locale,{weekday:"long",year:"numeric",month:"long",day:"numeric"});return row}),getFormattedData=response=>{const recordingData=response.tabledata,rowData=JSON.parse(recordingData.data);return formatDates(recordingData.locale,rowData)},getTableNode=tableSelector=>document.querySelector(tableSelector),fetchRecordingData=tableSelector=>{const tableNode=getTableNode(tableSelector);if(tableNode.dataset.importMode){return repository.fetchRecordingsToImport(tableNode.dataset.bbbid,tableNode.dataset.bbbSourceInstanceId,tableNode.dataset.bbbSourceCourseId,tableNode.dataset.tools,tableNode.dataset.groupId)}else{return repository.fetchRecordings(tableNode.dataset.bbbid,tableNode.dataset.tools,tableNode.dataset.groupId)}},getDataTableFunctions=(tableId,searchFormId,dataTable)=>{const tableNode=getTableNode(tableId),bbbid=tableNode.dataset.bbbid,updateTableFromResponse=response=>{if(!response||!response.status){return}dataTable.get("data").reset(getFormattedData(response));dataTable.set("currentData",dataTable.get("data"));const currentFilter=dataTable.get("currentFilter");if(currentFilter){filterByText(currentFilter)}},refreshTableData=()=>fetchRecordingData(tableId).then(updateTableFromResponse),filterByText=value=>{const dataModel=dataTable.get("currentData");dataTable.set("currentFilter",value);const escapedRegex=value.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),rsearch=new RegExp("<span>.*?".concat(escapedRegex,".*?</span>"),"i");dataTable.set("data",dataModel.filter({asList:!0},item=>{const name=item.get("recording");if(name&&rsearch.test(name)){return!0}const description=item.get("description");return description&&rsearch.test(description)}))},requestAction=element=>{const getDataFromAction=(element,dataType)=>{const dataElement=element.closest("[data-".concat(dataType,"]"));if(dataElement){return dataElement.dataset[dataType]}return null},elementData=element.dataset,payload={bigbluebuttonbnid:bbbid,recordingid:getDataFromAction(element,"recordingid"),additionaloptions:getDataFromAction(element,"additionaloptions"),action:elementData.action};if(!payload.additionaloptions){payload.additionaloptions={}}if("import"===elementData.action){const bbbsourceid=getDataFromAction(element,"source-instance-id"),bbbcourseid=getDataFromAction(element,"source-course-id");if(!payload.additionaloptions){payload.additionaloptions={}}payload.additionaloptions.sourceid=bbbsourceid?bbbsourceid:0;payload.additionaloptions.bbbcourseid=bbbcourseid?bbbcourseid:0}payload.additionaloptions=JSON.stringify(payload.additionaloptions);if("1"===element.dataset.requireConfirmation){return new Promise(resolve=>_modal_factory.default.create({title:Str.get_string("confirm"),body:recordingConfirmationMessage(payload),type:_modal_factory.default.types.SAVE_CANCEL}).then(async modal=>{modal.setSaveButtonText(await Str.get_string("ok","moodle"));modal.getRoot().on(_modal_events.default.save,()=>{resolve(!0)});modal.getRoot().on(_modal_events.default.hidden,()=>{modal.destroy();resolve(!1)});modal.show();return modal}).catch(Notification.exception)).then(proceed=>proceed?repository.updateRecording(payload):()=>null)}else{return repository.updateRecording(payload)}},recordingConfirmationMessage=async data=>{var _document$querySelect,_document$querySelect2;const playbackElement=document.querySelector("#playbacks-".concat(data.recordingid)),recordingType=await Str.get_string("true"===playbackElement.dataset.imported?"view_recording_link":"view_recording","bigbluebuttonbn"),confirmation=await Str.get_string("view_recording_".concat(data.action,"_confirmation"),"bigbluebuttonbn",recordingType);if("import"===data.action){return confirmation}const associatedLinkCount=null===(_document$querySelect=document.querySelector("a#recording-".concat(data.action,"-").concat(data.recordingid)))||void 0===_document$querySelect?void 0:null===(_document$querySelect2=_document$querySelect.dataset)||void 0===_document$querySelect2?void 0:_document$querySelect2.links;if(!associatedLinkCount||0===associatedLinkCount){return confirmation}const confirmationWarning=await Str.get_string(1===associatedLinkCount?"view_recording_".concat(data.action,"_confirmation_warning_p"):"view_recording_".concat(data.action,"_confirmation_warning_s"),"bigbluebuttonbn",associatedLinkCount);return confirmationWarning+"\n\n"+confirmation},processAction=e=>{const popoutLink=e.target.closest("[data-action=\"play\"]");if(popoutLink){e.preventDefault();const videoPlayer=window.open("","_blank");videoPlayer.opener=null;videoPlayer.location.href=popoutLink.href;return}const clickedLink=e.target.closest("a[data-action]");if(clickedLink&&!clickedLink.classList.contains("disabled")){e.preventDefault();const iconPromise=(0,_loadingicon.addIconToContainerWithPromise)(dataTable.get("boundingBox").getDOMNode());requestAction(clickedLink).then(refreshTableData).catch(_notification.exception).then(iconPromise.resolve).catch()}},processSearchSubmission=e=>{e.preventDefault();const parentNode=e.target.closest("div[role=search]"),searchInput=parentNode.querySelector("input[name=search]");filterByText(searchInput.value)};return{filterByText,refreshTableData,registerEventListeners:()=>{const boundingBox=dataTable.get("boundingBox").getDOMNode();boundingBox.addEventListener("click",processAction);const searchForm=document.querySelector(searchFormId);if(searchForm){const searchButton=document.querySelector(searchFormId+" button");searchButton.addEventListener("click",processSearchSubmission)}}}},setupDatatable=(tableId,searchFormId,response)=>{if(!response){return Promise.resolve()}if(!response.status){return Promise.resolve()}const recordingData=response.tabledata,pendingPromise=new _pending.default("mod_bigbluebuttonbn/recordings/setupDatatable");return Promise.all([getYuiInstance(recordingData.locale),getStringsForYui()]).then(_ref2=>{let[yuiInstance,strings]=_ref2;yuiInstance.Intl.add("datatable-paginator",yuiInstance.config.lang,{...strings});return yuiInstance}).then(yuiInstance=>{const tableData=getFormattedData(response);yuiInstance.RecordsPaginatorView=Y.Base.create("my-paginator-view",yuiInstance.DataTable.Paginator.View,[],{_modelChange:function(e){var changed=e.changed,totalItems=changed&&changed.totalItems;if(totalItems){this._updateControlsUI(e.target.get("page"))}}});const dataTable=new yuiInstance.DataTable({paginatorView:"RecordsPaginatorView",width:"1195px",columns:recordingData.columns,data:tableData,rowsPerPage:10,paginatorLocation:["header","footer"],autoSync:!0});return dataTable}).then(dataTable=>{dataTable.render(tableId);const{registerEventListeners}=getDataTableFunctions(tableId,searchFormId,dataTable);registerEventListeners();return dataTable}).then(dataTable=>{pendingPromise.resolve();return dataTable})};_exports.init=(tableId,searchFormId)=>{fetchRecordingData(tableId).then(response=>setupDatatable(tableId,searchFormId,response)).catch(_notification.exception)}});
//# sourceMappingURL=recordings.min.js.map
