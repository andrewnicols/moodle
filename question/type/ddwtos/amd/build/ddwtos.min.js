define ("qtype_ddwtos/ddwtos",["jquery","core/dragdrop","core/key_codes"],function($,dragDrop,keys){"use strict";function DragDropToTextQuestion(containerId,readOnly){this.containerId=containerId;if(readOnly){this.getRoot().addClass("qtype_ddwtos-readonly")}this.resizeAllDragsAndDrops();this.cloneDrags();this.positionDrags()}DragDropToTextQuestion.prototype.resizeAllDragsAndDrops=function(){var thisQ=this;this.getRoot().find(".answercontainer > div").each(function(i,node){thisQ.resizeAllDragsAndDropsInGroup(thisQ.getClassnameNumericSuffix($(node),"draggrouphomes"))})};DragDropToTextQuestion.prototype.resizeAllDragsAndDropsInGroup=function(group){var thisQ=this,dragHomes=this.getRoot().find(".draggrouphomes"+group+" span.draghome"),maxWidth=0,maxHeight=0;dragHomes.each(function(i,drag){maxWidth=Math.max(maxWidth,Math.ceil(drag.offsetWidth));maxHeight=Math.max(maxHeight,Math.ceil(0+drag.offsetHeight))});maxWidth+=8;maxHeight+=2;dragHomes.each(function(i,drag){thisQ.setElementSize(drag,maxWidth,maxHeight)});this.getRoot().find("span.drop.group"+group).each(function(i,drop){thisQ.setElementSize(drop,maxWidth,maxHeight)})};DragDropToTextQuestion.prototype.setElementSize=function(element,width,height){$(element).width(width).height(height).css("lineHeight",height+"px")};DragDropToTextQuestion.prototype.cloneDrags=function(){var thisQ=this;thisQ.getRoot().find("span.draghome").each(function(index,draghome){var drag=$(draghome),placeHolder=drag.clone();placeHolder.removeClass();placeHolder.addClass("draghome choice"+thisQ.getChoice(drag)+" group"+thisQ.getGroup(drag)+" dragplaceholder");drag.before(placeHolder)})};DragDropToTextQuestion.prototype.positionDrags=function(){var thisQ=this,root=this.getRoot();root.find("span.draghome").not(".dragplaceholder").each(function(i,dragNode){var drag=$(dragNode),currentPlace=thisQ.getClassnameNumericSuffix(drag,"inplace");drag.addClass("unplaced").removeClass("placed");drag.removeAttr("tabindex");if(null!==currentPlace){drag.removeClass("inplace"+currentPlace)}});root.find("input.placeinput").each(function(i,inputNode){var input=$(inputNode),choice=input.val(),place=thisQ.getPlace(input),drop=root.find(".drop.place"+place),dropPosition=drop.offset();drop.data("prev-top",dropPosition.top).data("prev-left",dropPosition.left);if("0"===choice){return}var unplacedDrag=thisQ.getUnplacedChoice(thisQ.getGroup(input),choice),hiddenDrag=thisQ.getDragClone(unplacedDrag);if(hiddenDrag.length){if(unplacedDrag.hasClass("infinite")){var noOfDrags=thisQ.noOfDropsInGroup(thisQ.getGroup(unplacedDrag)),cloneDrags=thisQ.getInfiniteDragClones(unplacedDrag,!1);if(cloneDrags.length<noOfDrags){var cloneDrag=unplacedDrag.clone();hiddenDrag.after(cloneDrag);questionManager.addEventHandlersToDrag(cloneDrag)}else{hiddenDrag.addClass("active")}}else{hiddenDrag.addClass("active")}}thisQ.sendDragToDrop(thisQ.getUnplacedChoice(thisQ.getGroup(input),choice),drop)})};DragDropToTextQuestion.prototype.handleDragStart=function(e){var thisQ=this,drag=$(e.target).closest(".draghome"),info=dragDrop.prepare(e);if(!info.start||drag.hasClass("beingdragged")){return}drag.addClass("beingdragged");var currentPlace=this.getClassnameNumericSuffix(drag,"inplace");if(null!==currentPlace){this.setInputValue(currentPlace,0);drag.removeClass("inplace"+currentPlace);var hiddenDrop=thisQ.getDrop(drag,currentPlace);if(hiddenDrop.length){hiddenDrop.addClass("active");drag.offset(hiddenDrop.offset())}}else{var hiddenDrag=thisQ.getDragClone(drag);if(hiddenDrag.length){if(drag.hasClass("infinite")){var noOfDrags=this.noOfDropsInGroup(this.getGroup(drag)),cloneDrags=this.getInfiniteDragClones(drag,!1);if(cloneDrags.length<noOfDrags){var cloneDrag=drag.clone();cloneDrag.removeClass("beingdragged");hiddenDrag.after(cloneDrag);questionManager.addEventHandlersToDrag(cloneDrag);drag.offset(cloneDrag.offset())}else{hiddenDrag.addClass("active");drag.offset(hiddenDrag.offset())}}else{hiddenDrag.addClass("active");drag.offset(hiddenDrag.offset())}}}dragDrop.start(e,drag,function(x,y,drag){thisQ.dragMove(x,y,drag)},function(x,y,drag){thisQ.dragEnd(x,y,drag)})};DragDropToTextQuestion.prototype.dragMove=function(pageX,pageY,drag){var thisQ=this;this.getRoot().find("span.drop.group"+this.getGroup(drag)).each(function(i,dropNode){var drop=$(dropNode);if(thisQ.isPointInDrop(pageX,pageY,drop)){drop.addClass("valid-drag-over-drop")}else{drop.removeClass("valid-drag-over-drop")}});this.getRoot().find("span.draghome.placed.group"+this.getGroup(drag)).not(".beingdragged").each(function(i,dropNode){var drop=$(dropNode);if(thisQ.isPointInDrop(pageX,pageY,drop)&&!thisQ.isDragSameAsDrop(drag,drop)){drop.addClass("valid-drag-over-drop")}else{drop.removeClass("valid-drag-over-drop")}})};DragDropToTextQuestion.prototype.dragEnd=function(pageX,pageY,drag){var thisQ=this,root=this.getRoot(),placed=!1;root.find("span.drop.group"+this.getGroup(drag)).each(function(i,dropNode){var drop=$(dropNode);if(!thisQ.isPointInDrop(pageX,pageY,drop)){return!0}drop.removeClass("valid-drag-over-drop");thisQ.sendDragToDrop(drag,drop);placed=!0;return!1});root.find("span.draghome.placed.group"+this.getGroup(drag)).not(".beingdragged").each(function(i,placedNode){var placedDrag=$(placedNode);if(!thisQ.isPointInDrop(pageX,pageY,placedDrag)||thisQ.isDragSameAsDrop(drag,placedDrag)){return!0}placedDrag.removeClass("valid-drag-over-drop");var currentPlace=thisQ.getClassnameNumericSuffix(placedDrag,"inplace"),drop=thisQ.getDrop(drag,currentPlace);thisQ.sendDragToDrop(drag,drop);placed=!0;return!1});if(!placed){this.sendDragHome(drag)}};DragDropToTextQuestion.prototype.sendDragToDrop=function(drag,drop){var oldDrag=this.getCurrentDragInPlace(this.getPlace(drop));if(0!==oldDrag.length){var currentPlace=this.getClassnameNumericSuffix(oldDrag,"inplace"),hiddenDrop=this.getDrop(oldDrag,currentPlace);hiddenDrop.addClass("active");oldDrag.addClass("beingdragged");oldDrag.offset(hiddenDrop.offset());this.sendDragHome(oldDrag)}if(0===drag.length){this.setInputValue(this.getPlace(drop),0);if(drop.data("isfocus")){drop.focus()}}else{this.setInputValue(this.getPlace(drop),this.getChoice(drag));drag.removeClass("unplaced").addClass("placed inplace"+this.getPlace(drop));drag.attr("tabindex",0);this.animateTo(drag,drop)}};DragDropToTextQuestion.prototype.sendDragHome=function(drag){var currentPlace=this.getClassnameNumericSuffix(drag,"inplace");if(null!==currentPlace){drag.removeClass("inplace"+currentPlace)}drag.data("unplaced",!0);this.animateTo(drag,this.getDragHome(this.getGroup(drag),this.getChoice(drag)))};DragDropToTextQuestion.prototype.handleKeyPress=function(e){var drop=$(e.target).closest(".drop");if(0===drop.length){var placedDrag=$(e.target),currentPlace=this.getClassnameNumericSuffix(placedDrag,"inplace");if(null!==currentPlace){drop=this.getDrop(placedDrag,currentPlace)}}var currentDrag=this.getCurrentDragInPlace(this.getPlace(drop)),nextDrag=$();switch(e.keyCode){case keys.space:case keys.arrowRight:case keys.arrowDown:nextDrag=this.getNextDrag(this.getGroup(drop),currentDrag);break;case keys.arrowLeft:case keys.arrowUp:nextDrag=this.getPreviousDrag(this.getGroup(drop),currentDrag);break;case keys.escape:break;default:questionManager.isKeyboardNavigation=!1;return;}if(nextDrag.length){nextDrag.data("isfocus",!0);nextDrag.addClass("beingdragged");var hiddenDrag=this.getDragClone(nextDrag);if(hiddenDrag.length){if(nextDrag.hasClass("infinite")){var noOfDrags=this.noOfDropsInGroup(this.getGroup(nextDrag)),cloneDrags=this.getInfiniteDragClones(nextDrag,!1);if(cloneDrags.length<noOfDrags){var cloneDrag=nextDrag.clone();cloneDrag.removeClass("beingdragged");cloneDrag.removeAttr("tabindex");hiddenDrag.after(cloneDrag);questionManager.addEventHandlersToDrag(cloneDrag);nextDrag.offset(cloneDrag.offset())}else{hiddenDrag.addClass("active");nextDrag.offset(hiddenDrag.offset())}}else{hiddenDrag.addClass("active");nextDrag.offset(hiddenDrag.offset())}}}else{drop.data("isfocus",!0)}e.preventDefault();this.sendDragToDrop(nextDrag,drop)};DragDropToTextQuestion.prototype.getNextDrag=function(group,drag){var choice,numChoices=this.noOfChoicesInGroup(group);if(0===drag.length){choice=1}else{choice=this.getChoice(drag)+1}var next=this.getUnplacedChoice(group,choice);while(0===next.length&&choice<numChoices){choice++;next=this.getUnplacedChoice(group,choice)}return next};DragDropToTextQuestion.prototype.getPreviousDrag=function(group,drag){var choice;if(0===drag.length){choice=this.noOfChoicesInGroup(group)}else{choice=this.getChoice(drag)-1}var previous=this.getUnplacedChoice(group,choice);while(0===previous.length&&1<choice){choice--;previous=this.getUnplacedChoice(group,choice)}return previous};DragDropToTextQuestion.prototype.animateTo=function(drag,target){var currentPos=drag.offset(),targetPos=target.offset(),thisQ=this;M.util.js_pending("qtype_ddwtos-animate-"+thisQ.containerId);drag.animate({left:parseInt(drag.css("left"))+targetPos.left-currentPos.left,top:parseInt(drag.css("top"))+targetPos.top-currentPos.top},{duration:"fast",done:function(){$("body").trigger("qtype_ddwtos-dragmoved",[drag,target,thisQ]);M.util.js_complete("qtype_ddwtos-animate-"+thisQ.containerId)}})};DragDropToTextQuestion.prototype.isPointInDrop=function(pageX,pageY,drop){var position=drop.offset();return pageX>=position.left&&pageX<position.left+drop.width()&&pageY>=position.top&&pageY<position.top+drop.height()};DragDropToTextQuestion.prototype.setInputValue=function(place,choice){this.getRoot().find("input.placeinput.place"+place).val(choice)};DragDropToTextQuestion.prototype.getRoot=function(){return $(document.getElementById(this.containerId))};DragDropToTextQuestion.prototype.getDragHome=function(group,choice){if(!this.getRoot().find(".draghome.dragplaceholder.group"+group+".choice"+choice).is(":visible")){return this.getRoot().find(".draggrouphomes"+group+" span.draghome.infinite.choice"+choice+".group"+group)}return this.getRoot().find(".draghome.dragplaceholder.group"+group+".choice"+choice)};DragDropToTextQuestion.prototype.getUnplacedChoice=function(group,choice){return this.getRoot().find(".draghome.group"+group+".choice"+choice+".unplaced").slice(0,1)};DragDropToTextQuestion.prototype.getCurrentDragInPlace=function(place){return this.getRoot().find("span.draghome.inplace"+place)};DragDropToTextQuestion.prototype.noOfDropsInGroup=function(group){return this.getRoot().find(".drop.group"+group).length};DragDropToTextQuestion.prototype.noOfChoicesInGroup=function(group){return this.getRoot().find(".draghome.group"+group).length};DragDropToTextQuestion.prototype.getClassnameNumericSuffix=function(node,prefix){var classes=node.attr("class");if(""!==classes){for(var classesArr=classes.split(" "),index=0,patt1;index<classesArr.length;index++){patt1=new RegExp("^"+prefix+"([0-9])+$");if(patt1.test(classesArr[index])){var match=/([0-9])+$/.exec(classesArr[index]);return+match[0]}}}return null};DragDropToTextQuestion.prototype.getChoice=function(drag){return this.getClassnameNumericSuffix(drag,"choice")};DragDropToTextQuestion.prototype.getGroup=function(node){return this.getClassnameNumericSuffix(node,"group")};DragDropToTextQuestion.prototype.getPlace=function(node){return this.getClassnameNumericSuffix(node,"place")};DragDropToTextQuestion.prototype.getDragClone=function(drag){return this.getRoot().find(".draggrouphomes"+this.getGroup(drag)+" span.draghome.choice"+this.getChoice(drag)+".group"+this.getGroup(drag)+".dragplaceholder")};DragDropToTextQuestion.prototype.getInfiniteDragClones=function(drag,inHome){if(inHome){return this.getRoot().find(".draggrouphomes"+this.getGroup(drag)+" span.draghome.choice"+this.getChoice(drag)+".group"+this.getGroup(drag)+".infinite").not(".dragplaceholder")}return this.getRoot().find("span.draghome.choice"+this.getChoice(drag)+".group"+this.getGroup(drag)+".infinite").not(".dragplaceholder")};DragDropToTextQuestion.prototype.getDrop=function(drag,currentPlace){return this.getRoot().find(".drop.group"+this.getGroup(drag)+".place"+currentPlace)};DragDropToTextQuestion.prototype.isDragSameAsDrop=function(drag,drop){return this.getChoice(drag)===this.getChoice(drop)&&this.getGroup(drag)===this.getGroup(drop)};var questionManager={eventHandlersInitialised:!1,dragEventHandlersInitialised:{},isKeyboardNavigation:!1,questions:{},init:function(containerId,readOnly){questionManager.questions[containerId]=new DragDropToTextQuestion(containerId,readOnly);if(!questionManager.eventHandlersInitialised){questionManager.setupEventHandlers();questionManager.eventHandlersInitialised=!0}if(!questionManager.dragEventHandlersInitialised.hasOwnProperty(containerId)){questionManager.dragEventHandlersInitialised[containerId]=!0;var questionContainer=document.getElementById(containerId);if(questionContainer.classList.contains("ddwtos")&&!questionContainer.classList.contains("qtype_ddwtos-readonly")){questionManager.addEventHandlersToDrag($(questionContainer).find("span.draghome"))}}},setupEventHandlers:function(){$("body").on("keydown",".que.ddwtos:not(.qtype_ddwtos-readonly) span.drop",questionManager.handleKeyPress).on("keydown",".que.ddwtos:not(.qtype_ddwtos-readonly) span.draghome.placed:not(.beingdragged)",questionManager.handleKeyPress).on("qtype_ddwtos-dragmoved",questionManager.handleDragMoved)},addEventHandlersToDrag:function(element){element.unbind("mousedown touchstart");element.on("mousedown touchstart",questionManager.handleDragStart)},handleDragStart:function(e){e.preventDefault();var question=questionManager.getQuestionForEvent(e);if(question){question.handleDragStart(e)}},handleKeyPress:function(e){if(questionManager.isKeyboardNavigation){return}questionManager.isKeyboardNavigation=!0;var question=questionManager.getQuestionForEvent(e);if(question){question.handleKeyPress(e)}},getQuestionForEvent:function(e){var containerId=$(e.currentTarget).closest(".que.ddwtos").attr("id");return questionManager.questions[containerId]},handleDragMoved:function(e,drag,target,thisQ){drag.removeClass("beingdragged");drag.css("top","").css("left","");target.after(drag);target.removeClass("active");if("undefined"!=typeof drag.data("unplaced")&&!0===drag.data("unplaced")){drag.removeClass("placed").addClass("unplaced");drag.removeAttr("tabindex");drag.removeData("unplaced");if(drag.hasClass("infinite")&&1<thisQ.getInfiniteDragClones(drag,!0).length){thisQ.getInfiniteDragClones(drag,!0).first().remove()}}if("undefined"!=typeof drag.data("isfocus")&&!0===drag.data("isfocus")){drag.focus();drag.removeData("isfocus")}if("undefined"!=typeof target.data("isfocus")&&!0===target.data("isfocus")){target.removeData("isfocus")}if(questionManager.isKeyboardNavigation){questionManager.isKeyboardNavigation=!1}}};return{init:questionManager.init}});
//# sourceMappingURL=ddwtos.min.js.map
