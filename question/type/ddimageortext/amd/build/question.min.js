define ("qtype_ddimageortext/question",["jquery","core/dragdrop","core/key_codes"],function($,dragDrop,keys){"use strict";function DragDropOntoImageQuestion(containerId,readOnly,places){this.containerId=containerId;M.util.js_pending("qtype_ddimageortext-init-"+this.containerId);this.places=places;this.allImagesLoaded=!1;this.imageLoadingTimeoutId=null;this.isPrinting=!1;if(readOnly){this.getRoot().addClass("qtype_ddimageortext-readonly")}var thisQ=this;this.getNotYetLoadedImages().one("load",function(){thisQ.waitForAllImagesToBeLoaded()});this.waitForAllImagesToBeLoaded()}DragDropOntoImageQuestion.prototype.waitForAllImagesToBeLoaded=function(){var thisQ=this;if(this.allImagesLoaded){return}if(null!==this.imageLoadingTimeoutId){clearTimeout(this.imageLoadingTimeoutId)}if(0<this.getNotYetLoadedImages().length){this.imageLoadingTimeoutId=setTimeout(function(){thisQ.waitForAllImagesToBeLoaded()},100);return}this.allImagesLoaded=!0;thisQ.setupQuestion()};DragDropOntoImageQuestion.prototype.getNotYetLoadedImages=function(){var thisQ=this;return this.getRoot().find(".ddarea img").not(function(i,imgNode){return thisQ.imageIsLoaded(imgNode)})};DragDropOntoImageQuestion.prototype.imageIsLoaded=function(imgElement){return imgElement.complete&&0!==imgElement.naturalHeight};DragDropOntoImageQuestion.prototype.setupQuestion=function(){this.resizeAllDragsAndDrops();this.cloneDrags();this.positionDragsAndDrops();M.util.js_complete("qtype_ddimageortext-init-"+this.containerId)};DragDropOntoImageQuestion.prototype.resizeAllDragsAndDrops=function(){var thisQ=this;this.getRoot().find(".draghomes > div").each(function(i,node){thisQ.resizeAllDragsAndDropsInGroup(thisQ.getClassnameNumericSuffix($(node),"dragitemgroup"))})};DragDropOntoImageQuestion.prototype.resizeAllDragsAndDropsInGroup=function(group){var root=this.getRoot(),dragHomes=root.find(".dragitemgroup"+group+" .draghome"),maxWidth=0,maxHeight=0;dragHomes.each(function(i,drag){maxWidth=Math.max(maxWidth,Math.ceil(drag.offsetWidth));maxHeight=Math.max(maxHeight,Math.ceil(drag.offsetHeight))});maxWidth+=10;maxHeight+=10;dragHomes.each(function(i,drag){var left=Math.round((maxWidth-drag.offsetWidth)/2),top=Math.floor((maxHeight-drag.offsetHeight)/2);$(drag).css({"padding-left":left+"px","padding-right":maxWidth-drag.offsetWidth-left+"px","padding-top":top+"px","padding-bottom":maxHeight-drag.offsetHeight-top+"px"})});for(var i in this.places){if(!this.places.hasOwnProperty(i)){continue}var place=this.places[i],label=place.text;if(parseInt(place.group)!==group){continue}if(""===label){label=M.util.get_string("blank","qtype_ddimageortext")}root.find(".dropzones").append("<div class=\"dropzone active group"+place.group+" place"+i+"\" tabindex=\"0\"><span class=\"accesshide\">"+label+"</span>&nbsp;</div>");root.find(".dropzone.place"+i).width(maxWidth-2).height(maxHeight-2)}};DragDropOntoImageQuestion.prototype.cloneDrags=function(){var thisQ=this;thisQ.getRoot().find(".draghome").each(function(index,dragHome){var drag=$(dragHome),placeHolder=drag.clone();placeHolder.removeClass();placeHolder.addClass("draghome choice"+thisQ.getChoice(drag)+" group"+thisQ.getGroup(drag)+" dragplaceholder");drag.before(placeHolder)})};DragDropOntoImageQuestion.prototype.cloneDragsForOneChoice=function(dragHome){if(dragHome.hasClass("infinite")){for(var noOfDrags=this.noOfDropsInGroup(this.getGroup(dragHome)),i=0;i<noOfDrags;i++){this.cloneDrag(dragHome)}}else{this.cloneDrag(dragHome)}};DragDropOntoImageQuestion.prototype.cloneDrag=function(dragHome){var drag=dragHome.clone();drag.removeClass("draghome").addClass("drag unplaced moodle-has-zindex").offset(dragHome.offset());this.getRoot().find(".dragitems").append(drag)};DragDropOntoImageQuestion.prototype.positionDragsAndDrops=function(){var thisQ=this,root=this.getRoot(),bgRatio=this.bgRatio();root.find(".ddarea .dropzone").each(function(i,dropNode){var drop=$(dropNode),place=thisQ.places[thisQ.getPlace(drop)];drop.css("left",parseInt(place.xy[0])*bgRatio).css("top",parseInt(place.xy[1])*bgRatio);drop.data("originX",parseInt(place.xy[0])).data("originY",parseInt(place.xy[1]));thisQ.handleElementScale(drop,"left top")});root.find(".draghome").not(".dragplaceholder").each(function(i,dragNode){var drag=$(dragNode),currentPlace=thisQ.getClassnameNumericSuffix(drag,"inplace");drag.addClass("unplaced").removeClass("placed");drag.removeAttr("tabindex");if(null!==currentPlace){drag.removeClass("inplace"+currentPlace)}});root.find("input.placeinput").each(function(i,inputNode){var input=$(inputNode),choice=input.val();if(0===choice.length||0<choice.length&&"0"===choice){return}var place=thisQ.getPlace(input),unplacedDrag=thisQ.getUnplacedChoice(thisQ.getGroup(input),choice),hiddenDrag=thisQ.getDragClone(unplacedDrag);if(hiddenDrag.length){if(unplacedDrag.hasClass("infinite")){var noOfDrags=thisQ.noOfDropsInGroup(thisQ.getGroup(unplacedDrag)),cloneDrags=thisQ.getInfiniteDragClones(unplacedDrag,!1);if(cloneDrags.length<noOfDrags){var cloneDrag=unplacedDrag.clone();cloneDrag.removeClass("beingdragged");cloneDrag.removeAttr("tabindex");hiddenDrag.after(cloneDrag)}else{hiddenDrag.addClass("active")}}else{hiddenDrag.addClass("active")}}var drop=root.find(".dropzone.place"+place);thisQ.sendDragToDrop(unplacedDrag,drop)})};DragDropOntoImageQuestion.prototype.handleDragStart=function(e){var thisQ=this,drag=$(e.target).closest(".draghome"),currentIndex=this.calculateZIndex(),info=dragDrop.prepare(e);if(!info.start||drag.hasClass("beingdragged")){return}drag.addClass("beingdragged").css("transform","").css("z-index",currentIndex+2);var currentPlace=this.getClassnameNumericSuffix(drag,"inplace");if(null!==currentPlace){this.setInputValue(currentPlace,0);drag.removeClass("inplace"+currentPlace);var hiddenDrop=thisQ.getDrop(drag,currentPlace);if(hiddenDrop.length){hiddenDrop.addClass("active");drag.offset(hiddenDrop.offset())}}else{var hiddenDrag=thisQ.getDragClone(drag);if(hiddenDrag.length){if(drag.hasClass("infinite")){var noOfDrags=this.noOfDropsInGroup(thisQ.getGroup(drag)),cloneDrags=this.getInfiniteDragClones(drag,!1);if(cloneDrags.length<noOfDrags){var cloneDrag=drag.clone();cloneDrag.removeClass("beingdragged");cloneDrag.removeAttr("tabindex");hiddenDrag.after(cloneDrag);questionManager.addEventHandlersToDrag(cloneDrag);drag.offset(cloneDrag.offset())}else{hiddenDrag.addClass("active");drag.offset(hiddenDrag.offset())}}else{hiddenDrag.addClass("active");drag.offset(hiddenDrag.offset())}}}dragDrop.start(e,drag,function(x,y,drag){thisQ.dragMove(x,y,drag)},function(x,y,drag){thisQ.dragEnd(x,y,drag)})};DragDropOntoImageQuestion.prototype.dragMove=function(pageX,pageY,drag){var thisQ=this,highlighted=!1;this.getRoot().find(".dropzone.group"+this.getGroup(drag)).each(function(i,dropNode){var drop=$(dropNode);if(thisQ.isPointInDrop(pageX,pageY,drop)&&!highlighted){highlighted=!0;drop.addClass("valid-drag-over-drop")}else{drop.removeClass("valid-drag-over-drop")}});this.getRoot().find(".draghome.placed.group"+this.getGroup(drag)).not(".beingdragged").each(function(i,dropNode){var drop=$(dropNode);if(thisQ.isPointInDrop(pageX,pageY,drop)&&!highlighted&&!thisQ.isDragSameAsDrop(drag,drop)){highlighted=!0;drop.addClass("valid-drag-over-drop")}else{drop.removeClass("valid-drag-over-drop")}})};DragDropOntoImageQuestion.prototype.dragEnd=function(pageX,pageY,drag){var thisQ=this,root=this.getRoot(),placed=!1;root.find(".dropzone.group"+this.getGroup(drag)).each(function(i,dropNode){var drop=$(dropNode);if(!thisQ.isPointInDrop(pageX,pageY,drop)){return!0}drop.removeClass("valid-drag-over-drop");thisQ.sendDragToDrop(drag,drop);placed=!0;return!1});if(!placed){root.find(".draghome.placed.group"+this.getGroup(drag)).not(".beingdragged").each(function(i,placedNode){var placedDrag=$(placedNode);if(!thisQ.isPointInDrop(pageX,pageY,placedDrag)||thisQ.isDragSameAsDrop(drag,placedDrag)){return!0}placedDrag.removeClass("valid-drag-over-drop");var currentPlace=thisQ.getClassnameNumericSuffix(placedDrag,"inplace"),drop=thisQ.getDrop(drag,currentPlace);thisQ.sendDragToDrop(drag,drop);placed=!0;return!1})}if(!placed){this.sendDragHome(drag)}};DragDropOntoImageQuestion.prototype.sendDragToDrop=function(drag,drop){var oldDrag=this.getCurrentDragInPlace(this.getPlace(drop));if(0!==oldDrag.length){oldDrag.addClass("beingdragged");oldDrag.offset(oldDrag.offset());var currentPlace=this.getClassnameNumericSuffix(oldDrag,"inplace"),hiddenDrop=this.getDrop(oldDrag,currentPlace);hiddenDrop.addClass("active");this.sendDragHome(oldDrag)}if(0===drag.length){this.setInputValue(this.getPlace(drop),0);if(drop.data("isfocus")){drop.focus()}}else{this.setInputValue(this.getPlace(drop),this.getChoice(drag));drag.removeClass("unplaced").addClass("placed inplace"+this.getPlace(drop));drag.attr("tabindex",0);this.animateTo(drag,drop)}};DragDropOntoImageQuestion.prototype.sendDragHome=function(drag){var currentPlace=this.getClassnameNumericSuffix(drag,"inplace");if(null!==currentPlace){drag.removeClass("inplace"+currentPlace)}drag.data("unplaced",!0);this.animateTo(drag,this.getDragHome(this.getGroup(drag),this.getChoice(drag)))};DragDropOntoImageQuestion.prototype.handleKeyPress=function(e){var drop=$(e.target).closest(".dropzone");if(0===drop.length){var placedDrag=$(e.target),currentPlace=this.getClassnameNumericSuffix(placedDrag,"inplace");if(null!==currentPlace){drop=this.getDrop(placedDrag,currentPlace)}}var currentDrag=this.getCurrentDragInPlace(this.getPlace(drop)),nextDrag=$();switch(e.keyCode){case keys.space:case keys.arrowRight:case keys.arrowDown:nextDrag=this.getNextDrag(this.getGroup(drop),currentDrag);break;case keys.arrowLeft:case keys.arrowUp:nextDrag=this.getPreviousDrag(this.getGroup(drop),currentDrag);break;case keys.escape:questionManager.isKeyboardNavigation=!1;break;default:questionManager.isKeyboardNavigation=!1;return;}if(nextDrag.length){nextDrag.data("isfocus",!0);nextDrag.addClass("beingdragged");var hiddenDrag=this.getDragClone(nextDrag);if(hiddenDrag.length){if(nextDrag.hasClass("infinite")){var noOfDrags=this.noOfDropsInGroup(this.getGroup(nextDrag)),cloneDrags=this.getInfiniteDragClones(nextDrag,!1);if(cloneDrags.length<noOfDrags){var cloneDrag=nextDrag.clone();cloneDrag.removeClass("beingdragged");cloneDrag.removeAttr("tabindex");hiddenDrag.after(cloneDrag);questionManager.addEventHandlersToDrag(cloneDrag);nextDrag.offset(cloneDrag.offset())}else{hiddenDrag.addClass("active");nextDrag.offset(hiddenDrag.offset())}}else{hiddenDrag.addClass("active");nextDrag.offset(hiddenDrag.offset())}}}else{drop.data("isfocus",!0)}e.preventDefault();this.sendDragToDrop(nextDrag,drop)};DragDropOntoImageQuestion.prototype.getNextDrag=function(group,drag){var choice,numChoices=this.noOfChoicesInGroup(group);if(0===drag.length){choice=1}else{choice=this.getChoice(drag)+1}var next=this.getUnplacedChoice(group,choice);while(0===next.length&&choice<numChoices){choice++;next=this.getUnplacedChoice(group,choice)}return next};DragDropOntoImageQuestion.prototype.getPreviousDrag=function(group,drag){var choice;if(0===drag.length){choice=this.noOfChoicesInGroup(group)}else{choice=this.getChoice(drag)-1}var previous=this.getUnplacedChoice(group,choice);while(0===previous.length&&1<choice){choice--;previous=this.getUnplacedChoice(group,choice)}return previous};DragDropOntoImageQuestion.prototype.animateTo=function(drag,target){var currentPos=drag.offset(),targetPos=target.offset(),thisQ=this;M.util.js_pending("qtype_ddimageortext-animate-"+thisQ.containerId);drag.animate({left:parseInt(drag.css("left"))+targetPos.left-currentPos.left,top:parseInt(drag.css("top"))+targetPos.top-currentPos.top},{duration:"fast",done:function(){$("body").trigger("qtype_ddimageortext-dragmoved",[drag,target,thisQ]);M.util.js_complete("qtype_ddimageortext-animate-"+thisQ.containerId)}})};DragDropOntoImageQuestion.prototype.isPointInDrop=function(pageX,pageY,drop){var position=drop.offset();if(drop.hasClass("draghome")){return pageX>=position.left&&pageX<position.left+drop.outerWidth()&&pageY>=position.top&&pageY<position.top+drop.outerHeight()}return pageX>=position.left&&pageX<position.left+drop.width()&&pageY>=position.top&&pageY<position.top+drop.height()};DragDropOntoImageQuestion.prototype.setInputValue=function(place,choice){this.getRoot().find("input.placeinput.place"+place).val(choice)};DragDropOntoImageQuestion.prototype.getRoot=function(){return $(document.getElementById(this.containerId))};DragDropOntoImageQuestion.prototype.bgImage=function(){return this.getRoot().find("img.dropbackground")};DragDropOntoImageQuestion.prototype.getDragHome=function(group,choice){if(!this.getRoot().find(".draghome.dragplaceholder.group"+group+".choice"+choice).is(":visible")){return this.getRoot().find(".dragitemgroup"+group+" .draghome.infinite.choice"+choice+".group"+group)}return this.getRoot().find(".draghome.dragplaceholder.group"+group+".choice"+choice)};DragDropOntoImageQuestion.prototype.getUnplacedChoice=function(group,choice){return this.getRoot().find(".ddarea .draghome.group"+group+".choice"+choice+".unplaced").slice(0,1)};DragDropOntoImageQuestion.prototype.getCurrentDragInPlace=function(place){return this.getRoot().find(".ddarea .draghome.inplace"+place)};DragDropOntoImageQuestion.prototype.noOfDropsInGroup=function(group){return this.getRoot().find(".dropzone.group"+group).length};DragDropOntoImageQuestion.prototype.noOfChoicesInGroup=function(group){return this.getRoot().find(".dragitemgroup"+group+" .draghome").length};DragDropOntoImageQuestion.prototype.getClassnameNumericSuffix=function(node,prefix){var classes=node.attr("class");if(""!==classes){for(var classesArr=classes.split(" "),index=0,patt1;index<classesArr.length;index++){patt1=new RegExp("^"+prefix+"([0-9])+$");if(patt1.test(classesArr[index])){var match=/([0-9])+$/.exec(classesArr[index]);return+match[0]}}}return null};DragDropOntoImageQuestion.prototype.getChoice=function(drag){return this.getClassnameNumericSuffix(drag,"choice")};DragDropOntoImageQuestion.prototype.getGroup=function(node){return this.getClassnameNumericSuffix(node,"group")};DragDropOntoImageQuestion.prototype.getPlace=function(node){return this.getClassnameNumericSuffix(node,"place")};DragDropOntoImageQuestion.prototype.getDragClone=function(drag){return this.getRoot().find(".dragitemgroup"+this.getGroup(drag)+" .draghome.choice"+this.getChoice(drag)+".group"+this.getGroup(drag)+".dragplaceholder")};DragDropOntoImageQuestion.prototype.getInfiniteDragClones=function(drag,inHome){if(inHome){return this.getRoot().find(".dragitemgroup"+this.getGroup(drag)+" .draghome.choice"+this.getChoice(drag)+".group"+this.getGroup(drag)+".infinite").not(".dragplaceholder")}return this.getRoot().find(".draghome.choice"+this.getChoice(drag)+".group"+this.getGroup(drag)+".infinite").not(".dragplaceholder")};DragDropOntoImageQuestion.prototype.getDrop=function(drag,currentPlace){return this.getRoot().find(".dropzone.group"+this.getGroup(drag)+".place"+currentPlace)};DragDropOntoImageQuestion.prototype.handleResize=function(){var thisQ=this,bgRatio=this.bgRatio();if(this.isPrinting){bgRatio=1}this.getRoot().find(".ddarea .dropzone").each(function(i,dropNode){$(dropNode).css("left",parseInt($(dropNode).data("originX"))*parseFloat(bgRatio)).css("top",parseInt($(dropNode).data("originY"))*parseFloat(bgRatio));thisQ.handleElementScale(dropNode,"left top")});this.getRoot().find("div.droparea .draghome").not(".beingdragged").each(function(key,drag){$(drag).css("left",parseFloat($(drag).data("originX"))*parseFloat(bgRatio)).css("top",parseFloat($(drag).data("originY"))*parseFloat(bgRatio));thisQ.handleElementScale(drag,"left top")})};DragDropOntoImageQuestion.prototype.bgRatio=function(){var bgImg=this.bgImage(),bgImgNaturalWidth=bgImg.get(0).naturalWidth,bgImgClientWidth=bgImg.width();return bgImgClientWidth/bgImgNaturalWidth};DragDropOntoImageQuestion.prototype.handleElementScale=function(element,type){var bgRatio=parseFloat(this.bgRatio());if(this.isPrinting){bgRatio=1}$(element).css({"-webkit-transform":"scale("+bgRatio+")","-moz-transform":"scale("+bgRatio+")","-ms-transform":"scale("+bgRatio+")","-o-transform":"scale("+bgRatio+")",transform:"scale("+bgRatio+")","transform-origin":type})};DragDropOntoImageQuestion.prototype.calculateZIndex=function(){var zIndex=0;this.getRoot().find(".ddarea .dropzone, div.droparea .draghome").each(function(i,dropNode){dropNode=$(dropNode);var itemZIndex=dropNode.css("z-index")?parseInt(dropNode.css("z-index")):0;if(itemZIndex>zIndex){zIndex=itemZIndex}});return zIndex};DragDropOntoImageQuestion.prototype.isDragSameAsDrop=function(drag,drop){return this.getChoice(drag)===this.getChoice(drop)&&this.getGroup(drag)===this.getGroup(drop)};var questionManager={eventHandlersInitialised:!1,dragEventHandlersInitialised:{},isPrinting:!1,isKeyboardNavigation:!1,questions:{},init:function(containerId,readOnly,places){questionManager.questions[containerId]=new DragDropOntoImageQuestion(containerId,readOnly,places);if(!questionManager.eventHandlersInitialised){questionManager.setupEventHandlers();questionManager.eventHandlersInitialised=!0}if(!questionManager.dragEventHandlersInitialised.hasOwnProperty(containerId)){questionManager.dragEventHandlersInitialised[containerId]=!0;var questionContainer=document.getElementById(containerId);if(questionContainer.classList.contains("ddimageortext")&&!questionContainer.classList.contains("qtype_ddimageortext-readonly")){questionManager.addEventHandlersToDrag($(questionContainer).find(".draghome"))}}},setupEventHandlers:function(){$("body").on("keydown",".que.ddimageortext:not(.qtype_ddimageortext-readonly) .dropzones .dropzone",questionManager.handleKeyPress).on("keydown",".que.ddimageortext:not(.qtype_ddimageortext-readonly) .draghome.placed:not(.beingdragged)",questionManager.handleKeyPress).on("qtype_ddimageortext-dragmoved",questionManager.handleDragMoved);$(window).on("resize",function(){questionManager.handleWindowResize(!1)});window.addEventListener("beforeprint",function(){questionManager.isPrinting=!0;questionManager.handleWindowResize(questionManager.isPrinting)});window.addEventListener("afterprint",function(){questionManager.isPrinting=!1;questionManager.handleWindowResize(questionManager.isPrinting)});setTimeout(function(){questionManager.fixLayoutIfThingsMoved()},100)},addEventHandlersToDrag:function(element){element.unbind("mousedown touchstart");element.on("mousedown touchstart",questionManager.handleDragStart)},handleDragStart:function(e){e.preventDefault();var question=questionManager.getQuestionForEvent(e);if(question){question.handleDragStart(e)}},handleKeyPress:function(e){if(questionManager.isKeyboardNavigation){return}questionManager.isKeyboardNavigation=!0;var question=questionManager.getQuestionForEvent(e);if(question){question.handleKeyPress(e)}},handleWindowResize:function(isPrinting){for(var containerId in questionManager.questions){if(questionManager.questions.hasOwnProperty(containerId)){questionManager.questions[containerId].isPrinting=isPrinting;questionManager.questions[containerId].handleResize()}}},fixLayoutIfThingsMoved:function(){this.handleWindowResize(questionManager.isPrinting);setTimeout(function(){questionManager.fixLayoutIfThingsMoved(questionManager.isPrinting)},100)},handleDragMoved:function(e,drag,target,thisQ){drag.removeClass("beingdragged").css("z-index","");drag.css("top",target.position().top).css("left",target.position().left);target.after(drag);target.removeClass("active");if("undefined"!=typeof drag.data("unplaced")&&!0===drag.data("unplaced")){drag.removeClass("placed").addClass("unplaced");drag.removeAttr("tabindex");drag.removeData("unplaced");drag.css("top","").css("left","").css("transform","");if(drag.hasClass("infinite")&&1<thisQ.getInfiniteDragClones(drag,!0).length){thisQ.getInfiniteDragClones(drag,!0).first().remove()}}else{drag.data("originX",target.data("originX")).data("originY",target.data("originY"));thisQ.handleElementScale(drag,"left top")}if("undefined"!=typeof drag.data("isfocus")&&!0===drag.data("isfocus")){drag.focus();drag.removeData("isfocus")}if("undefined"!=typeof target.data("isfocus")&&!0===target.data("isfocus")){target.removeData("isfocus")}if(questionManager.isKeyboardNavigation){questionManager.isKeyboardNavigation=!1}},getQuestionForEvent:function(e){var containerId=$(e.currentTarget).closest(".que.ddimageortext").attr("id");return questionManager.questions[containerId]}};return{init:questionManager.init}});
//# sourceMappingURL=question.min.js.map
