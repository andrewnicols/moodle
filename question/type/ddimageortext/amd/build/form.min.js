define ("qtype_ddimageortext/form",["jquery","core/dragdrop"],function($,dragDrop){"use strict";var dragDropToImageForm={maxBgImageSize:null,maxDragImageSize:null,fp:null,init:function init(){dragDropToImageForm.fp=dragDropToImageForm.filePickers();$("#id_previewareaheader").append("<div class=\"ddarea que ddimageortext\">  <div class=\"droparea\">    <img class=\"dropbackground\" />    <div class=\"dropzones\"></div>  </div>  <div class=\"dragitems\"></div></div>");dragDropToImageForm.updateVisibilityOfFilePickers();dragDropToImageForm.setOptionsForDragItemSelectors();dragDropToImageForm.setupEventHandlers();dragDropToImageForm.waitForFilePickerToInitialise()},waitForFilePickerToInitialise:function waitForFilePickerToInitialise(){if(null===dragDropToImageForm.fp.file("bgimage").href){setTimeout(dragDropToImageForm.waitForFilePickerToInitialise,1e3);return}M.util.js_pending("dragDropToImageForm");$("form.mform").on("change",".filepickerhidden",function(){M.util.js_pending("dragDropToImageForm");dragDropToImageForm.loadPreviewImage()});dragDropToImageForm.loadPreviewImage()},loadPreviewImage:function loadPreviewImage(){$("fieldset#id_previewareaheader .dropbackground").one("load",dragDropToImageForm.afterPreviewImageLoaded).attr("src",dragDropToImageForm.fp.file("bgimage").href)},afterPreviewImageLoaded:function afterPreviewImageLoaded(){dragDropToImageForm.createDropZones();M.util.js_complete("dragDropToImageForm")},createDropZones:function createDropZones(){var dropZoneHolder=$(".dropzones");dropZoneHolder.empty();var bgimageurl=dragDropToImageForm.fp.file("bgimage").href;if(null===bgimageurl){return}for(var numDrops=dragDropToImageForm.form.getFormValue("nodropzone",[]),dropNo=0,dragNo;dropNo<numDrops;dropNo++){dragNo=dragDropToImageForm.form.getFormValue("drops",[dropNo,"choice"]);if("0"===dragNo){continue}dragNo=dragNo-1;var group=dragDropToImageForm.form.getFormValue("drags",[dragNo,"draggroup"]),label=dragDropToImageForm.form.getFormValue("draglabel",[dragNo]);if("image"===dragDropToImageForm.form.getFormValue("drags",[dragNo,"dragitemtype"])){var imgUrl=dragDropToImageForm.fp.file("dragitem["+dragNo+"]").href;if(null===imgUrl){continue}dropZoneHolder.append("<img class=\"droppreview group"+group+" drop"+dropNo+"\" src=\""+imgUrl+"\" alt=\""+label+"\" data-drop-no=\""+dropNo+"\">")}else if(""!==label){dropZoneHolder.append("<div class=\"droppreview group"+group+" drop"+dropNo+"\"  data-drop-no=\""+dropNo+"\">"+label+"</div>")}}dragDropToImageForm.waitForAllDropImagesToBeLoaded()},waitForAllDropImagesToBeLoaded:function waitForAllDropImagesToBeLoaded(){var notYetLoadedImages=$(".dropzones img").not(function(i,imgNode){return dragDropToImageForm.imageIsLoaded(imgNode)});if(0<notYetLoadedImages.length){setTimeout(function(){dragDropToImageForm.waitForAllDropImagesToBeLoaded()},100);return}dragDropToImageForm.updateDropZones()},imageIsLoaded:function imageIsLoaded(imgElement){return imgElement.complete&&0!==imgElement.naturalHeight},updateDropZones:function updateDropZones(){var bgimageurl=dragDropToImageForm.fp.file("bgimage").href;if(null===bgimageurl){return}for(var dropBackgroundPosition=$("fieldset#id_previewareaheader .dropbackground").offset(),numDrops=dragDropToImageForm.form.getFormValue("nodropzone",[]),dropNo=0,drop;dropNo<numDrops;dropNo++){drop=$(".dropzones .drop"+dropNo);if(0===drop.length){continue}var dragNo=dragDropToImageForm.form.getFormValue("drops",[dropNo,"choice"])-1;drop.offset({left:dropBackgroundPosition.left+parseInt(dragDropToImageForm.form.getFormValue("drops",[dropNo,"xleft"])),top:dropBackgroundPosition.top+parseInt(dragDropToImageForm.form.getFormValue("drops",[dropNo,"ytop"]))});var label=dragDropToImageForm.form.getFormValue("draglabel",[dragNo]);if(drop.is("img")){drop.attr("alt",label)}else{drop.html(label)}}$(".dropzones .droppreview").css("padding","0");for(var numGroups=$(".draggroup select").first().find("option").length,group=1;group<=numGroups;group++){dragDropToImageForm.resizeAllDragsAndDropsInGroup(group)}},resizeAllDragsAndDropsInGroup:function resizeAllDragsAndDropsInGroup(group){var drops=$(".dropzones .droppreview.group"+group),maxWidth=0,maxHeight=0;drops.each(function(i,drop){maxWidth=Math.max(maxWidth,Math.ceil(drop.offsetWidth));maxHeight=Math.max(maxHeight,Math.ceil(drop.offsetHeight))});maxWidth+=10;maxHeight+=10;drops.each(function(i,drop){var left=Math.round((maxWidth-drop.offsetWidth)/2),top=Math.floor((maxHeight-drop.offsetHeight)/2);$(drop).css({"padding-left":left+"px","padding-right":maxWidth-drop.offsetWidth-left+"px","padding-top":top+"px","padding-bottom":maxHeight-drop.offsetHeight-top+"px"})})},setupEventHandlers:function setupEventHandlers(){$("fieldset#id_draggableitemheader").on("change input","input, select",function(e){var input=$(e.target).closest("select, input");if(input.hasClass("dragitemtype")){dragDropToImageForm.updateVisibilityOfFilePickers()}dragDropToImageForm.setOptionsForDragItemSelectors();if(input.is(".dragitemtype, .draggroup")){dragDropToImageForm.createDropZones()}else if(input.is(".draglabel")){dragDropToImageForm.updateDropZones()}});$("fieldset#id_dropzoneheader").on("change input","input, select",function(e){var input=$(e.target).closest("select, input");if(input.is("select")){dragDropToImageForm.createDropZones()}else{dragDropToImageForm.updateDropZones()}});$("fieldset#id_previewareaheader").on("mousedown touchstart",".droppreview",function(e){dragDropToImageForm.dragStart(e)});$(window).on("resize",function(){dragDropToImageForm.updateDropZones()})},updateVisibilityOfFilePickers:function updateVisibilityOfFilePickers(){for(var numDrags=dragDropToImageForm.form.getFormValue("noitems",[]),dragNo=0,picker;dragNo<numDrags;dragNo++){picker=$("input#id_dragitem_"+dragNo).closest(".fitem_ffilepicker");if("image"===dragDropToImageForm.form.getFormValue("drags",[dragNo,"dragitemtype"])){picker.show()}else{picker.hide()}}},setOptionsForDragItemSelectors:function setOptionsForDragItemSelectors(){for(var dragItemOptions={0:""},numDrags=dragDropToImageForm.form.getFormValue("noitems",[]),numDrops=dragDropToImageForm.form.getFormValue("nodropzone",[]),dragNo=0;dragNo<numDrags;dragNo++){var label=dragDropToImageForm.form.getFormValue("draglabel",[dragNo]),file=dragDropToImageForm.fp.file(dragDropToImageForm.form.toNameWithIndex("dragitem",[dragNo]));if("image"===dragDropToImageForm.form.getFormValue("drags",[dragNo,"dragitemtype"])&&null!==file.name){dragItemOptions[dragNo+1]=dragNo+1+". "+label+" ("+file.name+")"}else if(""!==label){dragItemOptions[dragNo+1]=dragNo+1+". "+label}}for(var dropNo=0;dropNo<numDrops;dropNo++){var selector=$("#id_drops_"+dropNo+"_choice"),selectedvalue=selector.val();selector.find("option").remove();for(var value in dragItemOptions){if(!dragItemOptions.hasOwnProperty(value)){continue}selector.append("<option value=\""+value+"\">"+dragItemOptions[value]+"</option>");var optionnode=selector.find("option[value=\""+value+"\"]");if(parseInt(value)===parseInt(selectedvalue)){optionnode.attr("selected",!0)}else if(dragDropToImageForm.isItemUsed(parseInt(value))){optionnode.attr("disabled",!0)}}}},isItemUsed:function isItemUsed(value){if(0===value){return!1}if(dragDropToImageForm.form.getFormValue("drags",[value-1,"infinite"])){return!1}return 0!==$("fieldset#id_dropzoneheader select").filter(function(i,selectNode){return parseInt($(selectNode).val())===value}).length},dragStart:function dragStart(e){var drop=$(e.target).closest(".droppreview"),info=dragDrop.prepare(e);if(!info.start){return}dragDrop.start(e,drop,function(x,y,drop){dragDropToImageForm.dragMove(drop)},function(){dragDropToImageForm.dragEnd()})},dragMove:function dragMove(drop){var backgroundImage=$("fieldset#id_previewareaheader .dropbackground"),backgroundPosition=backgroundImage.offset(),dropNo=drop.data("dropNo"),dropPosition=drop.offset(),left=Math.round(dropPosition.left-backgroundPosition.left),top=Math.round(dropPosition.top-backgroundPosition.top);left=Math.round(Math.max(0,Math.min(left,backgroundImage.outerWidth()-drop.outerWidth())));top=Math.round(Math.max(0,Math.min(top,backgroundImage.outerHeight()-drop.outerHeight())));dragDropToImageForm.form.setFormValue("drops",[dropNo,"xleft"],left);dragDropToImageForm.form.setFormValue("drops",[dropNo,"ytop"],top)},dragEnd:function dragEnd(){dragDropToImageForm.updateDropZones()},form:{toNameWithIndex:function toNameWithIndex(name,indexes){for(var indexString=name,i=0;i<indexes.length;i++){indexString=indexString+"["+indexes[i]+"]"}return indexString},getEl:function getEl(name,indexes){var form=$("form.mform")[0];return form.elements[this.toNameWithIndex(name,indexes)]},getFormValue:function getFormValue(name,indexes){var el=this.getEl(name,indexes);if(!el.type){el=el[el.length-1]}if("checkbox"===el.type){return el.checked}else{return el.value}},setFormValue:function setFormValue(name,indexes,value){var el=this.getEl(name,indexes);if("checkbox"===el.type){el.checked=value}else{el.value=value}}},filePickers:function filePickers(){var draftItemIdsToName,nameToParentNode;if(draftItemIdsToName===void 0){draftItemIdsToName={};nameToParentNode={};var fp=$("form.mform input.filepickerhidden");fp.each(function(index,filepicker){draftItemIdsToName[filepicker.value]=filepicker.name;nameToParentNode[filepicker.name]=filepicker.parentNode})}return{file:function file(name){var parentNode=$(nameToParentNode[name]),fileAnchor=parentNode.find("div.filepicker-filelist a");if(fileAnchor.length){return{href:fileAnchor.get(0).href,name:fileAnchor.get(0).innerHTML}}else{return{href:null,name:null}}},name:function name(draftitemid){return draftItemIdsToName[draftitemid]}}}};return{init:dragDropToImageForm.init}});
//# sourceMappingURL=form.min.js.map
