{"version":3,"sources":["../src/question.js"],"names":["define","$","dragDrop","Shapes","keys","DragDropMarkersQuestion","containerId","readOnly","visibleDropZones","thisQ","shapes","shapeSVGs","isPrinting","getRoot","addClass","cloneDrags","repositionDrags","drawDropzones","prototype","length","bgImage","find","html","outerWidth","outerHeight","svg","nextColourIndex","dropZoneNo","colourClass","addDropzone","dropZone","shape","make","existingmarkertext","bgRatio","parse","coords","markertext","remove","append","markerspan","handles","getHandlePositions","positionLeft","moveHandle","x","positionTop","y","css","data","position","left","top","handleElementScale","shapeSVG","makeSvg","setAttribute","root","not","each","key","item","input","choiceNo","getChoiceNoFromElement","getCoords","drag","i","dragInDrop","clone","sendDragToDrop","getDragClone","cloneDragIfNeeded","inputNode","val","coordsStrings","split","convertToWindowXY","Point","point","offset","convertToBgImgXY","coordsInBgImg","bgPosition","width","height","document","getElementById","handleDragStart","e","dragged","target","closest","info","prepare","start","placed","hasClass","hiddenDrag","dragEnd","dragXY","bgImgXY","sendDragHome","removeDragIfNeeded","saveCoordsForChoice","items","thiQ","join","handleKeyPress","keyCode","arrowLeft","arrowRight","arrowDown","arrowUp","space","escape","preventDefault","constrainToBgImg","focus","windowxy","bgImg","Math","max","min","node","getClassnameNumericSuffix","prefix","classes","attr","classesarr","index","patt1","RegExp","test","match","exec","handleResize","parseFloat","originCoords","updateSvg","markerSpan","draghome","placeHolder","removeClass","getDragNoClass","before","getDragNo","includeSelector","className","isInfiniteDrag","dropArea","after","isScaling","initialLoad","getInput","noOfDrags","displayedDragsInDropArea","displayedDragsInDragHomes","dragClone","questionManager","addEventHandlersToMarker","dragsInHome","displayedDrags","first","bgImgNaturalWidth","get","naturalWidth","bgImgClientWidth","element","type","eventHandlersInitialised","markerEventHandlersInitialised","isKeyboardNavigation","questions","init","setupEventHandlers","hasOwnProperty","questionContainer","classList","contains","window","on","handleWindowResize","addEventListener","setTimeout","fixLayoutIfThingsMoved","focusin","handleKeyboardFocus","focusout","question","getQuestionForEvent","isNavigating","currentTarget"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Question class for drag and drop marker question type, used to support the question and preview pages.\n *\n * @module     qtype_ddmarker/question\n * @copyright  2018 The Open University\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/dragdrop', 'qtype_ddmarker/shapes', 'core/key_codes'], function($, dragDrop, Shapes, keys) {\n\n    \"use strict\";\n\n    /**\n     * Object to handle one drag-drop markers question.\n     *\n     * @param {String} containerId id of the outer div for this question.\n     * @param {boolean} readOnly whether the question is being displayed read-only.\n     * @param {Object[]} visibleDropZones the geometry of any drop-zones to show.\n     *      Objects have fields shape, coords and markertext.\n     * @constructor\n     */\n    function DragDropMarkersQuestion(containerId, readOnly, visibleDropZones) {\n        var thisQ = this;\n        this.containerId = containerId;\n        this.visibleDropZones = visibleDropZones;\n        this.shapes = [];\n        this.shapeSVGs = [];\n        this.isPrinting = false;\n        if (readOnly) {\n            this.getRoot().addClass('qtype_ddmarker-readonly');\n        }\n        thisQ.cloneDrags();\n        thisQ.repositionDrags();\n        thisQ.drawDropzones();\n    }\n\n    /**\n     * Draws the svg shapes of any drop zones that should be visible for feedback purposes.\n     */\n    DragDropMarkersQuestion.prototype.drawDropzones = function() {\n        if (this.visibleDropZones.length > 0) {\n            var bgImage = this.bgImage();\n\n            this.getRoot().find('div.dropzones').html('<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"dropzones\" ' +\n                'width=\"' + bgImage.outerWidth() + '\" ' +\n                'height=\"' + bgImage.outerHeight() + '\"></svg>');\n            var svg = this.getRoot().find('svg.dropzones');\n\n            var nextColourIndex = 0;\n            for (var dropZoneNo = 0; dropZoneNo < this.visibleDropZones.length; dropZoneNo++) {\n                var colourClass = 'color' + nextColourIndex;\n                nextColourIndex = (nextColourIndex + 1) % 8;\n                this.addDropzone(svg, dropZoneNo, colourClass);\n            }\n        }\n    };\n\n    /**\n     * Adds a dropzone shape with colour, coords and link provided to the array of shapes.\n     *\n     * @param {jQuery} svg the SVG image to which to add this drop zone.\n     * @param {int} dropZoneNo which drop-zone to add.\n     * @param {string} colourClass class name\n     */\n    DragDropMarkersQuestion.prototype.addDropzone = function(svg, dropZoneNo, colourClass) {\n        var dropZone = this.visibleDropZones[dropZoneNo],\n            shape = Shapes.make(dropZone.shape, ''),\n            existingmarkertext,\n            bgRatio = this.bgRatio();\n        if (!shape.parse(dropZone.coords, bgRatio)) {\n            return;\n        }\n\n        existingmarkertext = this.getRoot().find('div.markertexts span.markertext' + dropZoneNo);\n        if (existingmarkertext.length) {\n            if (dropZone.markertext !== '') {\n                existingmarkertext.html(dropZone.markertext);\n            } else {\n                existingmarkertext.remove();\n            }\n        } else if (dropZone.markertext !== '') {\n            var classnames = 'markertext markertext' + dropZoneNo;\n            this.getRoot().find('div.markertexts').append('<span class=\"' + classnames + '\">' +\n                dropZone.markertext + '</span>');\n            var markerspan = this.getRoot().find('div.ddarea div.markertexts span.markertext' + dropZoneNo);\n            if (markerspan.length) {\n                var handles = shape.getHandlePositions();\n                var positionLeft = handles.moveHandle.x - (markerspan.outerWidth() / 2) - 4;\n                var positionTop = handles.moveHandle.y - (markerspan.outerHeight() / 2);\n                markerspan\n                    .css('left', positionLeft)\n                    .css('top', positionTop);\n                markerspan\n                    .data('originX', markerspan.position().left / bgRatio)\n                    .data('originY', markerspan.position().top / bgRatio);\n                this.handleElementScale(markerspan, 'center');\n            }\n        }\n\n        var shapeSVG = shape.makeSvg(svg[0]);\n        shapeSVG.setAttribute('class', 'dropzone ' + colourClass);\n\n        this.shapes[this.shapes.length] = shape;\n        this.shapeSVGs[this.shapeSVGs.length] = shapeSVG;\n    };\n\n    /**\n     * Draws the drag items on the page (and drop zones if required).\n     * The idea is to re-draw all the drags and drops whenever there is a change\n     * like a widow resize or an item dropped in place.\n     */\n    DragDropMarkersQuestion.prototype.repositionDrags = function() {\n        var root = this.getRoot(),\n            thisQ = this;\n\n        root.find('div.draghomes .marker').not('.dragplaceholder').each(function(key, item) {\n            $(item).addClass('unneeded');\n        });\n\n        root.find('input.choices').each(function(key, input) {\n            var choiceNo = thisQ.getChoiceNoFromElement(input),\n                coords = thisQ.getCoords(input);\n            if (coords.length) {\n                var drag = thisQ.getRoot().find('.draghomes' + ' span.marker' + '.choice' + choiceNo).not('.dragplaceholder');\n                drag.remove();\n                for (var i = 0; i < coords.length; i++) {\n                    var dragInDrop = drag.clone();\n                    dragInDrop.data('pagex', coords[i].x).data('pagey', coords[i].y);\n                    // We always save the coordinates in the 1:1 ratio.\n                    // So we need to set the scale ratio to 1 for the initial load.\n                    dragInDrop.data('scaleRatio', 1);\n                    thisQ.sendDragToDrop(dragInDrop, false, true);\n                }\n                thisQ.getDragClone(drag).addClass('active');\n                thisQ.cloneDragIfNeeded(drag);\n            }\n        });\n    };\n\n    /**\n     * Determine what drag items need to be shown and\n     * return coords of all drag items except any that are currently being dragged\n     * based on contents of hidden inputs and whether drags are 'infinite' or how many\n     * drags should be shown.\n     *\n     * @param {jQuery} inputNode\n     * @returns {Point[]} coordinates of however many copies of the drag item should be shown.\n     */\n    DragDropMarkersQuestion.prototype.getCoords = function(inputNode) {\n        var coords = [],\n            val = $(inputNode).val();\n        if (val !== '') {\n            var coordsStrings = val.split(';');\n            for (var i = 0; i < coordsStrings.length; i++) {\n                coords[i] = this.convertToWindowXY(Shapes.Point.parse(coordsStrings[i]));\n            }\n        }\n        return coords;\n    };\n\n    /**\n     * Converts the relative x and y position coordinates into\n     * absolute x and y position coordinates.\n     *\n     * @param {Point} point relative to the background image.\n     * @returns {Point} point relative to the page.\n     */\n    DragDropMarkersQuestion.prototype.convertToWindowXY = function(point) {\n        var bgImage = this.bgImage();\n        // The +1 seems rather odd, but seems to give the best results in\n        // the three main browsers at a range of zoom levels.\n        // (Its due to the 1px border around the image, that shifts the\n        // image pixels by 1 down and to the left.)\n        return point.offset(bgImage.offset().left + 1, bgImage.offset().top + 1);\n    };\n\n    /**\n     * Utility function converting window coordinates to relative to the\n     * background image coordinates.\n     *\n     * @param {Point} point relative to the page.\n     * @returns {Point} point relative to the background image.\n     */\n    DragDropMarkersQuestion.prototype.convertToBgImgXY = function(point) {\n        var bgImage = this.bgImage();\n        return point.offset(-bgImage.offset().left - 1, -bgImage.offset().top - 1);\n    };\n\n    /**\n     * Is the point within the background image?\n     *\n     * @param {Point} point relative to the BG image.\n     * @return {boolean} true it they are.\n     */\n    DragDropMarkersQuestion.prototype.coordsInBgImg = function(point) {\n        var bgImage = this.bgImage();\n        var bgPosition = bgImage.offset();\n\n        return point.x >= bgPosition.left && point.x < bgPosition.left + bgImage.width()\n            && point.y >= bgPosition.top && point.y < bgPosition.top + bgImage.height();\n    };\n\n    /**\n     * Get the outer div for this question.\n     * @returns {jQuery} containing that div.\n     */\n    DragDropMarkersQuestion.prototype.getRoot = function() {\n        return $(document.getElementById(this.containerId));\n    };\n\n    /**\n     * Get the img that is the background image.\n     * @returns {jQuery} containing that img.\n     */\n    DragDropMarkersQuestion.prototype.bgImage = function() {\n        return this.getRoot().find('img.dropbackground');\n    };\n\n    DragDropMarkersQuestion.prototype.handleDragStart = function(e) {\n        var thisQ = this,\n            dragged = $(e.target).closest('.marker');\n\n        var info = dragDrop.prepare(e);\n        if (!info.start) {\n            return;\n        }\n\n        dragged.addClass('beingdragged').css('transform', '');\n\n        var placed = !dragged.hasClass('unneeded');\n        if (!placed) {\n            var hiddenDrag = thisQ.getDragClone(dragged);\n            if (hiddenDrag.length) {\n                hiddenDrag.addClass('active');\n                dragged.offset(hiddenDrag.offset());\n            }\n        }\n\n        dragDrop.start(e, dragged, function() {\n            void (1);\n        }, function(x, y, dragged) {\n            thisQ.dragEnd(dragged);\n        });\n    };\n\n    /**\n     * Functionality at the end of a drag drop.\n     * @param {jQuery} dragged the marker that was dragged.\n     */\n    DragDropMarkersQuestion.prototype.dragEnd = function(dragged) {\n        var placed = false,\n            choiceNo = this.getChoiceNoFromElement(dragged),\n            bgRatio = this.bgRatio(),\n            dragXY;\n\n        dragged.data('pagex', dragged.offset().left).data('pagey', dragged.offset().top);\n        dragXY = new Shapes.Point(dragged.data('pagex'), dragged.data('pagey'));\n        if (this.coordsInBgImg(dragXY)) {\n            this.sendDragToDrop(dragged, true);\n            placed = true;\n\n            // It seems that the dragdrop sometimes leaves the drag\n            // one pixel out of position. Put it in exactly the right place.\n            var bgImgXY = this.convertToBgImgXY(dragXY);\n            bgImgXY = new Shapes.Point(bgImgXY.x / bgRatio, bgImgXY.y / bgRatio);\n            dragged.data('originX', bgImgXY.x).data('originY', bgImgXY.y);\n        }\n\n        if (!placed) {\n            this.sendDragHome(dragged);\n            this.removeDragIfNeeded(dragged);\n        } else {\n            this.cloneDragIfNeeded(dragged);\n        }\n\n        this.saveCoordsForChoice(choiceNo);\n    };\n\n    /**\n     * Save the coordinates for a dropped item in the form field.\n     * @param {Number} choiceNo which copy of the choice this was.\n     */\n    DragDropMarkersQuestion.prototype.saveCoordsForChoice = function(choiceNo) {\n        var coords = [],\n            items = this.getRoot().find('div.droparea span.marker.choice' + choiceNo),\n            thiQ = this,\n            bgRatio = this.bgRatio();\n\n        if (items.length) {\n            items.each(function() {\n                var drag = $(this);\n                if (!drag.hasClass('beingdragged')) {\n                    if (drag.data('scaleRatio') !== bgRatio) {\n                        // The scale ratio for the draggable item was changed. We need to update that.\n                        drag.data('pagex', drag.offset().left).data('pagey', drag.offset().top);\n                    }\n                    var dragXY = new Shapes.Point(drag.data('pagex'), drag.data('pagey'));\n                    if (thiQ.coordsInBgImg(dragXY)) {\n                        var bgImgXY = thiQ.convertToBgImgXY(dragXY);\n                        bgImgXY = new Shapes.Point(bgImgXY.x / bgRatio, bgImgXY.y / bgRatio);\n                        coords[coords.length] = bgImgXY;\n                    }\n                }\n            });\n        }\n\n        this.getRoot().find('input.choice' + choiceNo).val(coords.join(';'));\n    };\n\n    /**\n     * Handle key down / press events on markers.\n     * @param {KeyboardEvent} e\n     */\n    DragDropMarkersQuestion.prototype.handleKeyPress = function(e) {\n        var drag = $(e.target).closest('.marker'),\n            point = new Shapes.Point(drag.offset().left, drag.offset().top),\n            choiceNo = this.getChoiceNoFromElement(drag);\n\n        switch (e.keyCode) {\n            case keys.arrowLeft:\n            case 65: // A.\n                point.x -= 1;\n                break;\n            case keys.arrowRight:\n            case 68: // D.\n                point.x += 1;\n                break;\n            case keys.arrowDown:\n            case 83: // S.\n                point.y += 1;\n                break;\n            case keys.arrowUp:\n            case 87: // W.\n                point.y -= 1;\n                break;\n            case keys.space:\n            case keys.escape:\n                point = null;\n                break;\n            default:\n                return; // Ingore other keys.\n        }\n        e.preventDefault();\n\n        if (point !== null) {\n            point = this.constrainToBgImg(point);\n            drag.offset({'left': point.x, 'top': point.y});\n            drag.data('pagex', drag.offset().left).data('pagey', drag.offset().top);\n            var dragXY = this.convertToBgImgXY(new Shapes.Point(drag.data('pagex'), drag.data('pagey')));\n            drag.data('originX', dragXY.x / this.bgRatio()).data('originY', dragXY.y / this.bgRatio());\n            if (this.coordsInBgImg(new Shapes.Point(drag.offset().left, drag.offset().top))) {\n                if (drag.hasClass('unneeded')) {\n                    this.sendDragToDrop(drag, true);\n                    var hiddenDrag = this.getDragClone(drag);\n                    if (hiddenDrag.length) {\n                        hiddenDrag.addClass('active');\n                    }\n                    this.cloneDragIfNeeded(drag);\n                }\n            }\n        } else {\n            drag.css('left', '').css('top', '');\n            drag.data('pagex', drag.offset().left).data('pagey', drag.offset().top);\n            this.sendDragHome(drag);\n            this.removeDragIfNeeded(drag);\n        }\n        drag.focus();\n        this.saveCoordsForChoice(choiceNo);\n    };\n\n    /**\n     * Makes sure the dragged item always exists within the background image area.\n     *\n     * @param {Point} windowxy\n     * @returns {Point} coordinates\n     */\n    DragDropMarkersQuestion.prototype.constrainToBgImg = function(windowxy) {\n        var bgImg = this.bgImage(),\n            bgImgXY = this.convertToBgImgXY(windowxy);\n        bgImgXY.x = Math.max(0, bgImgXY.x);\n        bgImgXY.y = Math.max(0, bgImgXY.y);\n        bgImgXY.x = Math.min(bgImg.width(), bgImgXY.x);\n        bgImgXY.y = Math.min(bgImg.height(), bgImgXY.y);\n        return this.convertToWindowXY(bgImgXY);\n    };\n\n    /**\n     * Returns the choice number for a node.\n     *\n     * @param {Element|jQuery} node\n     * @returns {Number}\n     */\n    DragDropMarkersQuestion.prototype.getChoiceNoFromElement = function(node) {\n        return Number(this.getClassnameNumericSuffix(node, 'choice'));\n    };\n\n    /**\n     * Returns the numeric part of a class with the given prefix.\n     *\n     * @param {Element|jQuery} node\n     * @param {String} prefix\n     * @returns {Number|null}\n     */\n    DragDropMarkersQuestion.prototype.getClassnameNumericSuffix = function(node, prefix) {\n        var classes = $(node).attr('class');\n        if (classes !== undefined && classes !== '') {\n            var classesarr = classes.split(' ');\n            for (var index = 0; index < classesarr.length; index++) {\n                var patt1 = new RegExp('^' + prefix + '([0-9])+$');\n                if (patt1.test(classesarr[index])) {\n                    var patt2 = new RegExp('([0-9])+$');\n                    var match = patt2.exec(classesarr[index]);\n                    return Number(match[0]);\n                }\n            }\n        }\n        return null;\n    };\n\n    /**\n     * Handle when the window is resized.\n     */\n    DragDropMarkersQuestion.prototype.handleResize = function() {\n        var thisQ = this,\n            bgRatio = this.bgRatio();\n        if (this.isPrinting) {\n            bgRatio = 1;\n        }\n\n        this.getRoot().find('div.droparea .marker').not('.beingdragged').each(function(key, drag) {\n            $(drag)\n                .css('left', parseFloat($(drag).data('originX')) * parseFloat(bgRatio))\n                .css('top', parseFloat($(drag).data('originY')) * parseFloat(bgRatio));\n            thisQ.handleElementScale(drag, 'left top');\n        });\n\n        this.getRoot().find('div.droparea svg.dropzones')\n            .width(this.bgImage().width())\n            .height(this.bgImage().height());\n\n        for (var dropZoneNo = 0; dropZoneNo < this.visibleDropZones.length; dropZoneNo++) {\n            var dropZone = thisQ.visibleDropZones[dropZoneNo];\n            var originCoords = dropZone.coords;\n            var shape = thisQ.shapes[dropZoneNo];\n            var shapeSVG = thisQ.shapeSVGs[dropZoneNo];\n            shape.parse(originCoords, bgRatio);\n            shape.updateSvg(shapeSVG);\n\n            var handles = shape.getHandlePositions();\n            var markerSpan = this.getRoot().find('div.ddarea div.markertexts span.markertext' + dropZoneNo);\n            markerSpan\n                .css('left', handles.moveHandle.x - (markerSpan.outerWidth() / 2) - 4)\n                .css('top', handles.moveHandle.y - (markerSpan.outerHeight() / 2));\n            thisQ.handleElementScale(markerSpan, 'center');\n        }\n    };\n\n    /**\n     * Clone the drag.\n     */\n    DragDropMarkersQuestion.prototype.cloneDrags = function() {\n        var thisQ = this;\n        this.getRoot().find('div.draghomes span.marker').each(function(index, draghome) {\n            var drag = $(draghome);\n            var placeHolder = drag.clone();\n            placeHolder.removeClass();\n            placeHolder.addClass('marker');\n            placeHolder.addClass('choice' + thisQ.getChoiceNoFromElement(drag));\n            placeHolder.addClass(thisQ.getDragNoClass(drag, false));\n            placeHolder.addClass('dragplaceholder');\n            drag.before(placeHolder);\n        });\n    };\n\n    /**\n     * Get the drag number of a drag.\n     *\n     * @param {jQuery} drag the drag.\n     * @returns {Number} the drag number.\n     */\n    DragDropMarkersQuestion.prototype.getDragNo = function(drag) {\n        return this.getClassnameNumericSuffix(drag, 'dragno');\n    };\n\n    /**\n     * Get the drag number prefix of a drag.\n     *\n     * @param {jQuery} drag the drag.\n     * @param {Boolean} includeSelector include the CSS selector prefix or not.\n     * @return {String} Class name\n     */\n    DragDropMarkersQuestion.prototype.getDragNoClass = function(drag, includeSelector) {\n        var className = 'dragno' + this.getDragNo(drag);\n        if (this.isInfiniteDrag(drag)) {\n            className = 'infinite';\n        }\n\n        if (includeSelector) {\n            return '.' + className;\n        }\n\n        return className;\n    };\n\n    /**\n     * Get drag clone for a given drag.\n     *\n     * @param {jQuery} drag the drag.\n     * @returns {jQuery} the drag's clone.\n     */\n    DragDropMarkersQuestion.prototype.getDragClone = function(drag) {\n        return this.getRoot().find('.draghomes' + ' span.marker' +\n            '.choice' + this.getChoiceNoFromElement(drag) + this.getDragNoClass(drag, true) + '.dragplaceholder');\n    };\n\n    /**\n     * Get the drop area element.\n     * @returns {jQuery} droparea element.\n     */\n    DragDropMarkersQuestion.prototype.dropArea = function() {\n        return this.getRoot().find('div.droparea');\n    };\n\n    /**\n     * Animate a drag back to its home.\n     *\n     * @param {jQuery} drag the item being moved.\n     */\n    DragDropMarkersQuestion.prototype.sendDragHome = function(drag) {\n        drag.removeClass('beingdragged')\n            .addClass('unneeded')\n            .css('top', '')\n            .css('left', '')\n            .css('transform', '');\n        var placeHolder = this.getDragClone(drag);\n        placeHolder.after(drag);\n        placeHolder.removeClass('active');\n    };\n\n    /**\n     * Animate a drag item into a given place.\n     *\n     * @param {jQuery} drag the item to place.\n     * @param {boolean} isScaling Scaling or not.\n     * @param {boolean} initialLoad Whether it is the initial load or not.\n     */\n    DragDropMarkersQuestion.prototype.sendDragToDrop = function(drag, isScaling, initialLoad = false) {\n        var dropArea = this.dropArea(),\n            bgRatio = this.bgRatio();\n        drag.removeClass('beingdragged').removeClass('unneeded');\n        var dragXY = this.convertToBgImgXY(new Shapes.Point(drag.data('pagex'), drag.data('pagey')));\n        if (isScaling) {\n            drag.data('originX', dragXY.x / bgRatio).data('originY', dragXY.y / bgRatio);\n            drag.css('left', dragXY.x).css('top', dragXY.y);\n        } else {\n            drag.data('originX', dragXY.x).data('originY', dragXY.y);\n            drag.css('left', dragXY.x * bgRatio).css('top', dragXY.y * bgRatio);\n        }\n        // We need to save the original scale ratio for each draggable item.\n        if (!initialLoad) {\n            // Only set the scale ratio for a current being-dragged item, not for the initial loading.\n            drag.data('scaleRatio', bgRatio);\n        }\n        dropArea.append(drag);\n        this.handleElementScale(drag, 'left top');\n    };\n\n    /**\n     * Clone the drag at the draghome area if needed.\n     *\n     * @param {jQuery} drag the item to place.\n     */\n    DragDropMarkersQuestion.prototype.cloneDragIfNeeded = function(drag) {\n        var inputNode = this.getInput(drag),\n            noOfDrags = Number(this.getClassnameNumericSuffix(inputNode, 'noofdrags')),\n            displayedDragsInDropArea = this.getRoot().find('div.droparea .marker.choice' +\n                this.getChoiceNoFromElement(drag) + this.getDragNoClass(drag, true)).length,\n            displayedDragsInDragHomes = this.getRoot().find('div.draghomes .marker.choice' +\n                this.getChoiceNoFromElement(drag) + this.getDragNoClass(drag, true)).not('.dragplaceholder').length;\n\n        if ((this.isInfiniteDrag(drag) ||\n                !this.isInfiniteDrag(drag) && displayedDragsInDropArea < noOfDrags) && displayedDragsInDragHomes === 0) {\n            var dragClone = drag.clone();\n            dragClone.addClass('unneeded')\n                .css('top', '')\n                .css('left', '')\n                .css('transform', '');\n            this.getDragClone(drag)\n                .removeClass('active')\n                .after(dragClone);\n            questionManager.addEventHandlersToMarker(dragClone);\n        }\n    };\n\n    /**\n     * Remove the clone drag at the draghome area if needed.\n     *\n     * @param {jQuery} drag the item to place.\n     */\n    DragDropMarkersQuestion.prototype.removeDragIfNeeded = function(drag) {\n        var dragsInHome = this.getRoot().find('div.draghomes .marker.choice' +\n            this.getChoiceNoFromElement(drag) + this.getDragNoClass(drag, true)).not('.dragplaceholder');\n        var displayedDrags = dragsInHome.length;\n        while (displayedDrags > 1) {\n            dragsInHome.first().remove();\n            displayedDrags--;\n        }\n    };\n\n    /**\n     * Get the input belong to drag.\n     *\n     * @param {jQuery} drag the item to place.\n     * @returns {jQuery} input element.\n     */\n    DragDropMarkersQuestion.prototype.getInput = function(drag) {\n        var choiceNo = this.getChoiceNoFromElement(drag);\n        return this.getRoot().find('input.choices.choice' + choiceNo);\n    };\n\n    /**\n     * Return the background ratio.\n     *\n     * @returns {number} Background ratio.\n     */\n    DragDropMarkersQuestion.prototype.bgRatio = function() {\n        var bgImg = this.bgImage();\n        var bgImgNaturalWidth = bgImg.get(0).naturalWidth;\n        var bgImgClientWidth = bgImg.width();\n\n        return bgImgClientWidth / bgImgNaturalWidth;\n    };\n\n    /**\n     * Scale the drag if needed.\n     *\n     * @param {jQuery} element the item to place.\n     * @param {String} type scaling type\n     */\n    DragDropMarkersQuestion.prototype.handleElementScale = function(element, type) {\n        var bgRatio = parseFloat(this.bgRatio());\n        if (this.isPrinting) {\n            bgRatio = 1;\n        }\n        $(element).css({\n            '-webkit-transform': 'scale(' + bgRatio + ')',\n            '-moz-transform': 'scale(' + bgRatio + ')',\n            '-ms-transform': 'scale(' + bgRatio + ')',\n            '-o-transform': 'scale(' + bgRatio + ')',\n            'transform': 'scale(' + bgRatio + ')',\n            'transform-origin': type\n        });\n    };\n\n    /**\n     * Check if the given drag is in infinite mode or not.\n     *\n     * @param {jQuery} drag The drag item need to check.\n     */\n    DragDropMarkersQuestion.prototype.isInfiniteDrag = function(drag) {\n        return drag.hasClass('infinite');\n    };\n\n    /**\n     * Singleton that tracks all the DragDropToTextQuestions on this page, and deals\n     * with event dispatching.\n     *\n     * @type {Object}\n     */\n    var questionManager = {\n\n        /**\n         * {boolean} ensures that the event handlers are only initialised once per page.\n         */\n        eventHandlersInitialised: false,\n\n        /**\n         * {Object} ensures that the marker event handlers are only initialised once per question,\n         * indexed by containerId (id on the .que div).\n         */\n        markerEventHandlersInitialised: {},\n\n        /**\n         * {boolean} is printing or not.\n         */\n        isPrinting: false,\n\n        /**\n         * {boolean} is keyboard navigation.\n         */\n        isKeyboardNavigation: false,\n\n        /**\n         * {Object} all the questions on this page, indexed by containerId (id on the .que div).\n         */\n        questions: {}, // An object containing all the information about each question on the page.\n\n        /**\n         * Initialise one question.\n         *\n         * @param {String} containerId the id of the div.que that contains this question.\n         * @param {boolean} readOnly whether the question is read-only.\n         * @param {Object[]} visibleDropZones data on any drop zones to draw as part of the feedback.\n         */\n        init: function(containerId, readOnly, visibleDropZones) {\n            questionManager.questions[containerId] =\n                new DragDropMarkersQuestion(containerId, readOnly, visibleDropZones);\n            if (!questionManager.eventHandlersInitialised) {\n                questionManager.setupEventHandlers();\n                questionManager.eventHandlersInitialised = true;\n            }\n            if (!questionManager.markerEventHandlersInitialised.hasOwnProperty(containerId)) {\n                questionManager.markerEventHandlersInitialised[containerId] = true;\n                // We do not use the body event here to prevent the other event on Mobile device, such as scroll event.\n                var questionContainer = document.getElementById(containerId);\n                if (questionContainer.classList.contains('ddmarker') &&\n                    !questionContainer.classList.contains('qtype_ddmarker-readonly')) {\n                    // TODO: Convert all the jQuery selectors and events to native Javascript.\n                    questionManager.addEventHandlersToMarker($(questionContainer).find('div.draghomes .marker'));\n                    questionManager.addEventHandlersToMarker($(questionContainer).find('div.droparea .marker'));\n                }\n            }\n        },\n\n        /**\n         * Set up the event handlers that make this question type work. (Done once per page.)\n         */\n        setupEventHandlers: function() {\n            $(window).on('resize', function() {\n                questionManager.handleWindowResize(false);\n            });\n            window.addEventListener('beforeprint', function() {\n                questionManager.isPrinting = true;\n                questionManager.handleWindowResize(questionManager.isPrinting);\n            });\n            window.addEventListener('afterprint', function() {\n                questionManager.isPrinting = false;\n                questionManager.handleWindowResize(questionManager.isPrinting);\n            });\n            setTimeout(function() {\n                questionManager.fixLayoutIfThingsMoved();\n            }, 100);\n        },\n\n        /**\n         * Binding the event again for newly created element.\n         *\n         * @param {jQuery} element Element to bind the event\n         */\n        addEventHandlersToMarker: function(element) {\n            element\n                .on('mousedown touchstart', questionManager.handleDragStart)\n                .on('keydown keypress', questionManager.handleKeyPress)\n                .focusin(function(e) {\n                    questionManager.handleKeyboardFocus(e, true);\n                })\n                .focusout(function(e) {\n                    questionManager.handleKeyboardFocus(e, false);\n                });\n        },\n\n        /**\n         * Handle mouse down / touch start events on markers.\n         * @param {Event} e the DOM event.\n         */\n        handleDragStart: function(e) {\n            e.preventDefault();\n            var question = questionManager.getQuestionForEvent(e);\n            if (question) {\n                question.handleDragStart(e);\n            }\n        },\n\n        /**\n         * Handle key down / press events on markers.\n         * @param {Event} e\n         */\n        handleKeyPress: function(e) {\n            var question = questionManager.getQuestionForEvent(e);\n            if (question) {\n                question.handleKeyPress(e);\n            }\n        },\n\n        /**\n         * Handle when the window is resized.\n         * @param {boolean} isPrinting\n         */\n        handleWindowResize: function(isPrinting) {\n            for (var containerId in questionManager.questions) {\n                if (questionManager.questions.hasOwnProperty(containerId)) {\n                    questionManager.questions[containerId].isPrinting = isPrinting;\n                    questionManager.questions[containerId].handleResize();\n                }\n            }\n        },\n\n        /**\n         * Handle focus lost events on markers.\n         * @param {Event} e\n         * @param {boolean} isNavigating\n         */\n        handleKeyboardFocus: function(e, isNavigating) {\n            questionManager.isKeyboardNavigation = isNavigating;\n        },\n\n        /**\n         * Sometimes, despite our best efforts, things change in a way that cannot\n         * be specifically caught (e.g. dock expanding or collapsing in Boost).\n         * Therefore, we need to periodically check everything is in the right position.\n         */\n        fixLayoutIfThingsMoved: function() {\n            if (!questionManager.isKeyboardNavigation) {\n                this.handleWindowResize(questionManager.isPrinting);\n            }\n            // We use setTimeout after finishing work, rather than setInterval,\n            // in case positioning things is slow. We want 100 ms gap\n            // between executions, not what setInterval does.\n            setTimeout(function() {\n                questionManager.fixLayoutIfThingsMoved(questionManager.isPrinting);\n            }, 100);\n        },\n\n        /**\n         * Given an event, work out which question it effects.\n         * @param {Event} e the event.\n         * @returns {DragDropMarkersQuestion|undefined} The question, or undefined.\n         */\n        getQuestionForEvent: function(e) {\n            var containerId = $(e.currentTarget).closest('.que.ddmarker').attr('id');\n            return questionManager.questions[containerId];\n        }\n    };\n\n    /**\n     * @alias module:qtype_ddmarker/question\n     */\n    return {\n        /**\n         * Initialise one drag-drop markers question.\n         *\n         * @param {String} containerId id of the outer div for this question.\n         * @param {String} bgImgUrl the URL of the background image.\n         * @param {boolean} readOnly whether the question is being displayed read-only.\n         * @param {String[]} visibleDropZones the geometry of any drop-zones to show.\n         */\n        init: questionManager.init\n    };\n});\n"],"file":"question.min.js"}