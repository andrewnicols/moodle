function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define ("core_calendar/view_manager",["exports","jquery","core/templates","core/notification","core_calendar/repository","core_calendar/events","core_calendar/selectors","core/modal_factory","core/modal_events","core_calendar/summary_modal","core/custom_interaction_events","core/pending"],function(_exports,_jquery,_templates,_notification,CalendarRepository,_events,CalendarSelectors,_modal_factory,_modal_events,_summary_modal,_custom_interaction_events,_pending){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.reloadCurrentUpcoming=_exports.reloadCurrentMonth=_exports.reloadCurrentDay=_exports.refreshMonthContent=_exports.refreshDayContent=_exports.init=_exports.changeMonth=_exports.changeDay=void 0;_jquery=_interopRequireDefault(_jquery);_templates=_interopRequireDefault(_templates);_notification=_interopRequireDefault(_notification);CalendarRepository=_interopRequireWildcard(CalendarRepository);_events=_interopRequireDefault(_events);CalendarSelectors=_interopRequireWildcard(CalendarSelectors);_modal_factory=_interopRequireDefault(_modal_factory);_modal_events=_interopRequireDefault(_modal_events);_summary_modal=_interopRequireDefault(_summary_modal);_custom_interaction_events=_interopRequireDefault(_custom_interaction_events);_pending=_interopRequireDefault(_pending);function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var registerEventListeners=function(root){root=(0,_jquery.default)(root);root.on("click",CalendarSelectors.links.eventLink,function(e){var target=e.target,eventLink=null,eventId=null,pendingPromise=new _pending.default("core_calendar/view_manager:eventLink:click");if(target.matches(CalendarSelectors.actions.viewEvent)){eventLink=target}else{eventLink=target.closest(CalendarSelectors.actions.viewEvent)}if(eventLink){eventId=eventLink.dataset.eventId}else{eventId=target.querySelector(CalendarSelectors.actions.viewEvent).dataset.eventId}if(eventId){e.preventDefault();e.stopPropagation();renderEventSummaryModal(eventId).then(pendingPromise.resolve).catch()}else{pendingPromise.resolve()}});root.on("click",CalendarSelectors.links.navLink,function(e){var wrapper=root.find(CalendarSelectors.wrapper),view=wrapper.data("view"),courseId=wrapper.data("courseid"),categoryId=wrapper.data("categoryid"),link=e.currentTarget;if("month"===view){changeMonth(root,link.href,link.dataset.year,link.dataset.month,courseId,categoryId,link.dataset.day);e.preventDefault()}else if("day"===view){changeDay(root,link.href,link.dataset.year,link.dataset.month,link.dataset.day,courseId,categoryId);e.preventDefault()}});var viewSelector=root.find(CalendarSelectors.viewSelector);_custom_interaction_events.default.define(viewSelector,[_custom_interaction_events.default.events.activate]);viewSelector.on(_custom_interaction_events.default.events.activate,function(e){e.preventDefault();var option=e.target;if(option.classList.contains("active")){return}var view=option.dataset.view,year=option.dataset.year,month=option.dataset.month,day=option.dataset.day,courseId=option.dataset.courseid,categoryId=option.dataset.categoryid;if("month"==view){refreshMonthContent(root,year,month,courseId,categoryId,root,"core_calendar/calendar_month",day).then(function(){return window.history.pushState({},"","?view=month")}).fail(_notification.default.exception)}else if("day"==view){refreshDayContent(root,year,month,day,courseId,categoryId,root,"core_calendar/calendar_day").then(function(){return window.history.pushState({},"","?view=day")}).fail(_notification.default.exception)}else if("upcoming"==view){reloadCurrentUpcoming(root,courseId,categoryId,root,"core_calendar/calendar_upcoming").then(function(){return window.history.pushState({},"","?view=upcoming")}).fail(_notification.default.exception)}})},refreshMonthContent=function(root,year,month,courseId,categoryId){var target=5<arguments.length&&arguments[5]!==void 0?arguments[5]:null,template=6<arguments.length&&arguments[6]!==void 0?arguments[6]:"",day=7<arguments.length&&arguments[7]!==void 0?arguments[7]:1;startLoading(root);target=target||root.find(CalendarSelectors.wrapper);template=template||root.attr("data-template");M.util.js_pending([root.get("id"),year,month,courseId].join("-"));var includenavigation=root.data("includenavigation"),mini=root.data("mini");return CalendarRepository.getCalendarMonthData(year,month,courseId,categoryId,includenavigation,mini,day).then(function(context){context.viewingmonth=!0;return _templates.default.render(template,context)}).then(function(html,js){return _templates.default.replaceNode(target,html,js)}).then(function(){document.querySelector("body").dispatchEvent(new CustomEvent(_events.default.viewUpdated))}).always(function(){M.util.js_complete([root.get("id"),year,month,courseId].join("-"));return stopLoading(root)}).fail(_notification.default.exception)};_exports.refreshMonthContent=refreshMonthContent;var changeMonth=function(root,url,year,month,courseId,categoryId){var day=6<arguments.length&&arguments[6]!==void 0?arguments[6]:1;return refreshMonthContent(root,year,month,courseId,categoryId,null,"",day).then(function(){if(url.length&&"#"!==url){window.history.pushState({},"",url)}for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}return args}).then(function(){(0,_jquery.default)("body").trigger(_events.default.monthChanged,[year,month,courseId,categoryId]);for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2]}return args})};_exports.changeMonth=changeMonth;var reloadCurrentMonth=function(root){var courseId=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0,categoryId=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0,year=root.find(CalendarSelectors.wrapper).data("year"),month=root.find(CalendarSelectors.wrapper).data("month"),day=root.find(CalendarSelectors.wrapper).data("day");courseId=courseId||root.find(CalendarSelectors.wrapper).data("courseid");categoryId=categoryId||root.find(CalendarSelectors.wrapper).data("categoryid");return refreshMonthContent(root,year,month,courseId,categoryId,null,"",day)};_exports.reloadCurrentMonth=reloadCurrentMonth;var refreshDayContent=function(root,year,month,day,courseId,categoryId){var target=6<arguments.length&&arguments[6]!==void 0?arguments[6]:null,template=7<arguments.length&&arguments[7]!==void 0?arguments[7]:"";startLoading(root);if(!target||0==target.length){target=root.find(CalendarSelectors.wrapper)}template=template||root.attr("data-template");M.util.js_pending([root.get("id"),year,month,day,courseId,categoryId].join("-"));var includenavigation=root.data("includenavigation");return CalendarRepository.getCalendarDayData(year,month,day,courseId,categoryId,includenavigation).then(function(context){context.viewingday=!0;return _templates.default.render(template,context)}).then(function(html,js){return _templates.default.replaceNode(target,html,js)}).then(function(){document.querySelector("body").dispatchEvent(new CustomEvent(_events.default.viewUpdated))}).always(function(){M.util.js_complete([root.get("id"),year,month,day,courseId,categoryId].join("-"));return stopLoading(root)}).fail(_notification.default.exception)};_exports.refreshDayContent=refreshDayContent;var reloadCurrentDay=function(root){var courseId=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0,categoryId=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0,wrapper=root.find(CalendarSelectors.wrapper),year=wrapper.data("year"),month=wrapper.data("month"),day=wrapper.data("day");courseId=courseId||root.find(CalendarSelectors.wrapper).data("courseid");categoryId=categoryId||root.find(CalendarSelectors.wrapper).data("categoryid");return refreshDayContent(root,year,month,day,courseId,categoryId)};_exports.reloadCurrentDay=reloadCurrentDay;var changeDay=function(root,url,year,month,day,courseId,categoryId){return refreshDayContent(root,year,month,day,courseId,categoryId).then(function(){if(url.length&&"#"!==url){window.history.pushState({},"",url)}for(var _len3=arguments.length,args=Array(_len3),_key3=0;_key3<_len3;_key3++){args[_key3]=arguments[_key3]}return args}).then(function(){(0,_jquery.default)("body").trigger(_events.default.dayChanged,[year,month,courseId,categoryId]);for(var _len4=arguments.length,args=Array(_len4),_key4=0;_key4<_len4;_key4++){args[_key4]=arguments[_key4]}return args})};_exports.changeDay=changeDay;var startLoading=function(root){var loadingIconContainer=root.find(CalendarSelectors.containers.loadingIcon);loadingIconContainer.removeClass("hidden")},stopLoading=function(root){var loadingIconContainer=root.find(CalendarSelectors.containers.loadingIcon);loadingIconContainer.addClass("hidden")},reloadCurrentUpcoming=function(root){var courseId=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0,categoryId=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0,target=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null,template=4<arguments.length&&arguments[4]!==void 0?arguments[4]:"";startLoading(root);target=target||root.find(CalendarSelectors.wrapper);template=template||root.attr("data-template");courseId=courseId||root.find(CalendarSelectors.wrapper).data("courseid");categoryId=categoryId||root.find(CalendarSelectors.wrapper).data("categoryid");return CalendarRepository.getCalendarUpcomingData(courseId,categoryId).then(function(context){context.viewingupcoming=!0;return _templates.default.render(template,context)}).then(function(html,js){return _templates.default.replaceNode(target,html,js)}).then(function(){document.querySelector("body").dispatchEvent(new CustomEvent(_events.default.viewUpdated))}).always(function(){return stopLoading(root)}).fail(_notification.default.exception)};_exports.reloadCurrentUpcoming=reloadCurrentUpcoming;var getEventTypeClassFromType=function(eventType){return"calendar_event_"+eventType},renderEventSummaryModal=function(eventId){var pendingPromise=new _pending.default("core_calendar/view_manager:renderEventSummaryModal");return CalendarRepository.getEventById(eventId).then(function(getEventResponse){if(!getEventResponse.event){throw new Error("Error encountered while trying to fetch calendar event with ID: "+eventId)}return getEventResponse.event}).then(function(eventData){var modalParams={title:eventData.name,type:_summary_modal.default.TYPE,body:_templates.default.render("core_calendar/event_summary_body",eventData),templateContext:{canedit:eventData.canedit,candelete:eventData.candelete,headerclasses:getEventTypeClassFromType(eventData.normalisedeventtype),isactionevent:eventData.isactionevent,url:eventData.url,action:eventData.action}};return _modal_factory.default.create(modalParams)}).then(function(modal){modal.getRoot().on(_modal_events.default.hidden,function(){modal.destroy()});modal.show();return modal}).then(function(modal){pendingPromise.resolve();return modal}).catch(_notification.default.exception)};_exports.init=function init(root,view){registerEventListeners(root,view)}});
//# sourceMappingURL=view_manager.min.js.map
