function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define ("block_accessreview/module",["exports","core/ajax","core/templates","core/notification"],function(_exports,_ajax,Templates,_notification){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.init=void 0;Templates=_interopRequireWildcard(Templates);function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if("Object"===n&&o.constructor)n=o.constructor.name;if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(null==len||len>arr.length)len=arr.length;for(var i=0,arr2=Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _arr=[],_n=!0,_d=!1,_s,_e;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done);_n=!0){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=!0;_e=err}finally{try{if(!_n&&null!=_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}var toggleState=!0,renderTemplate=function(element,errorCount,checkCount,displayFormat,minViews,viewDelta){var weight=parseInt((errorCount-minViews)/viewDelta*2),context={resultPassed:!errorCount,classList:"",passRate:{errorCount:errorCount,checkCount:checkCount,failureRate:Math.round(100*(errorCount/checkCount))}};if(!element){return Promise.resolve()}var elementClassList=["block_accessreview"];if(context.resultPassed){elementClassList.push("block_accessreview_success")}else if(weight){elementClassList.push("block_accessreview_danger")}else{elementClassList.push("block_accessreview_warning")}var showIcons="showicons"==displayFormat||"showboth"==displayFormat,showBackground="showbackground"==displayFormat||"showboth"==displayFormat;if(showBackground&&!showIcons){var _element$classList;(_element$classList=element.classList).add.apply(_element$classList,elementClassList.concat(["alert"]));return Promise.resolve()}if(showIcons&&!showBackground){context.classList=elementClassList.join(" ")}return Templates.renderForPromise("block_accessreview/status",context).then(function(_ref){var html=_ref.html,js=_ref.js;Templates.appendNodeContents(element,html,js);if(showBackground){var _element$classList2;(_element$classList2=element.classList).add.apply(_element$classList2,elementClassList.concat(["alert"]))}}).catch()},showAccessMap=function(courseId,displayFormat){var updatePreference=2<arguments.length&&arguments[2]!==void 0?arguments[2]:!1;return Promise.all(fetchReviewData(courseId,updatePreference)).then(function(_ref2){var _document$querySelect,_document$querySelect2,_ref3=_slicedToArray(_ref2,2),sectionData=_ref3[0],moduleData=_ref3[1],_getErrorTotals=getErrorTotals(sectionData,moduleData),minViews=_getErrorTotals.minViews,viewDelta=_getErrorTotals.viewDelta;sectionData.forEach(function(section){var element=document.querySelector("#section-".concat(section.section," .summary"));if(!element){return}renderTemplate(element,section.numerrors,section.numchecks,displayFormat,minViews,viewDelta)});moduleData.forEach(function(module){var element=document.getElementById("module-".concat(module.cmid));if(!element){return}renderTemplate(element,module.numerrors,module.numchecks,displayFormat,minViews,viewDelta)});(_document$querySelect=document.querySelector(".icon-accessmap").classList).remove.apply(_document$querySelect,["fa-eye-slash"]);(_document$querySelect2=document.querySelector(".icon-accessmap").classList).add.apply(_document$querySelect2,["fa-eye"]);return{sectionData:sectionData,moduleData:moduleData}}).catch(_notification.exception)},hideAccessMap=function(){var _document$querySelect3,_document$querySelect4,updatePreference=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!1;document.querySelectorAll(".block_accessreview_view").forEach(function(node){return node.remove()});var classList=["block_accessreview","block_accessreview_success","block_accessreview_warning","block_accessreview_danger","block_accessreview_view","alert"];document.querySelectorAll(".block_accessreview").forEach(function(node){var _node$classList;return(_node$classList=node.classList).remove.apply(_node$classList,classList)});if(updatePreference){setToggleStatePreference(!1)}(_document$querySelect3=document.querySelector(".icon-accessmap").classList).remove.apply(_document$querySelect3,["fa-eye"]);(_document$querySelect4=document.querySelector(".icon-accessmap").classList).add.apply(_document$querySelect4,["fa-eye-slash"])},toggleAccessMap=function(courseId,displayFormat){toggleState=!toggleState;if(!toggleState){hideAccessMap(!0)}else{showAccessMap(courseId,displayFormat,!0)}},getErrorTotals=function(sectionData,moduleData){var totals={totalErrors:0,totalUsers:0,minViews:0,maxViews:0,viewDelta:0};[].concat(sectionData,moduleData).forEach(function(item){totals.totalErrors+=item.numerrors;if(item.numerrors<totals.minViews){totals.minViews=item.numerrors}if(item.numerrors>totals.maxViews){totals.maxViews=item.numerrors}totals.totalUsers+=item.numchecks});totals.viewDelta=totals.maxViews-totals.minViews+1;return totals},registerEventListeners=function(courseId,displayFormat){document.addEventListener("click",function(e){if(e.target.closest("#toggle-accessmap")){e.preventDefault();toggleAccessMap(courseId,displayFormat)}})},getTogglePreferenceParams=function(toggleState){return{methodname:"core_user_update_user_preferences",args:{preferences:[{type:"block_accessreviewtogglestate",value:toggleState}]}}},setToggleStatePreference=function(toggleState){return(0,_ajax.call)([getTogglePreferenceParams(toggleState)])},fetchReviewData=function(courseid){var updatePreference=1<arguments.length&&arguments[1]!==void 0?arguments[1]:!1,calls=[{methodname:"block_accessreview_get_section_data",args:{courseid:courseid}},{methodname:"block_accessreview_get_module_data",args:{courseid:courseid}}];if(updatePreference){calls.push(getTogglePreferenceParams(!0))}return(0,_ajax.call)(calls)},init=function(toggled,displayFormat,courseId){toggleState=1==toggled;if(toggleState){showAccessMap(courseId,displayFormat)}registerEventListeners(courseId,displayFormat)};_exports.init=init});
//# sourceMappingURL=module.min.js.map
