define ("block_timeline/event_list",["jquery","core/notification","core/templates","core/str","core/user_date","block_timeline/calendar_events_repository","core/pending"],function($,Notification,Templates,Str,UserDate,CalendarEventsRepository,Pending){var courseview=!1,SELECTORS={EMPTY_MESSAGE:"[data-region=\"no-events-empty-message\"]",ROOT:"[data-region=\"event-list-container\"]",EVENT_LIST_CONTENT:"[data-region=\"event-list-content\"]",EVENT_LIST_WRAPPER:"[data-region=\"event-list-wrapper\"]",EVENT_LIST_LOADING_PLACEHOLDER:"[data-region=\"event-list-loading-placeholder\"]",TIMELINE_BLOCK:"[data-region=\"timeline\"]",TIMELINE_SEARCH:"[data-action=\"search\"]",MORE_ACTIVITIES_BUTTON:"[data-action=\"more-events\"]",MORE_ACTIVITIES_BUTTON_CONTAINER:"[data-region=\"more-events-button-container\"]"},TEMPLATES={EVENT_LIST_CONTENT:"block_timeline/event-list-content",MORE_ACTIVITIES_BUTTON:"block_timeline/event-list-loadmore",LOADING_ICON:"core/loading"},hideContent=function(root){root.find(SELECTORS.EVENT_LIST_CONTENT).addClass("hidden");root.find(SELECTORS.EMPTY_MESSAGE).removeClass("hidden")},showContent=function(root){root.find(SELECTORS.EVENT_LIST_CONTENT).removeClass("hidden");root.find(SELECTORS.EMPTY_MESSAGE).addClass("hidden")},emptyContent=function(root){root.find(SELECTORS.EVENT_LIST_CONTENT).empty()},buildTemplateContext=function(calendarEvents){var eventsByDay={},templateContext={courseview:courseview,eventsbyday:[]};calendarEvents.forEach(function(calendarEvent){var dayTimestamp=calendarEvent.timeusermidnight;if(eventsByDay[dayTimestamp]){eventsByDay[dayTimestamp].push(calendarEvent)}else{eventsByDay[dayTimestamp]=[calendarEvent]}});Object.keys(eventsByDay).forEach(function(dayTimestamp){var events=eventsByDay[dayTimestamp];templateContext.eventsbyday.push({dayTimestamp:dayTimestamp,events:events})});return templateContext},render=function(calendarEvents){var templateContext=buildTemplateContext(calendarEvents),templateName=TEMPLATES.EVENT_LIST_CONTENT;return Templates.render(templateName,templateContext)},load=function(midnight,limit,daysOffset,daysLimit,lastId,courseId,searchValue){var endTime=daysLimit!=void 0?midnight+daysLimit*86400:!1,args={starttime:midnight+daysOffset*86400,limit:limit};if(lastId){args.aftereventid=lastId}if(endTime){args.endtime=endTime}if(searchValue){args.searchvalue=searchValue}if(courseId){args.courseid=courseId;return CalendarEventsRepository.queryByCourse(args)}else{return CalendarEventsRepository.queryByTime(args)}},createLazyLoadingContent=function(root,firstLoad,itemLimit,midnight,lastId,courseId,daysOffset,daysLimit,searchValue){return loadEventsForLazyLoading(root,itemLimit,midnight,lastId,courseId,daysOffset,daysLimit,searchValue).then(function(data){if(data.calendarEvents.length){var lastEventId=data.calendarEvents.at(-1).id,lastTimeStamp=data.calendarEvents.at(-1).timeusermidnight;firstLoad.resolve({hasContent:!0,lastId:lastEventId,lastTimeStamp:lastTimeStamp,loadedAll:data.loadedAll});return render(data.calendarEvents,midnight)}else{firstLoad.resolve({hasContent:!1,lastId:0,lastTimeStamp:0,loadedAll:!0});return data.calendarEvents}}).catch(Notification.exception)},loadEventsForLazyLoading=function(root,itemLimit,midnight,lastId,courseId,daysOffset,daysLimit,searchValue){var eventsPromise=load(midnight,itemLimit+1,daysOffset,daysLimit,lastId,courseId,searchValue),calendarEvents=[],loadedAll=!0;return eventsPromise.then(function(result){if(!result.events.length){return{calendarEvents:calendarEvents,loadedAll:loadedAll}}var overdueFilter=document.querySelector("[data-filtername='overdue']"),filterByOverdue=overdueFilter&&overdueFilter.getAttribute("aria-current");calendarEvents=result.events.filter(function(event){if("open"==event.eventtype||"opensubmission"==event.eventtype){var dayTimestamp=UserDate.getUserMidnightForTimestamp(event.timesort,midnight);return dayTimestamp>midnight}return!filterByOverdue||event.overdue});loadedAll=calendarEvents.length<=itemLimit;if(!loadedAll){calendarEvents.pop()}if(calendarEvents.length){var lastEventId=calendarEvents.at(-1).id;setOffset(root,lastEventId)}return{calendarEvents:calendarEvents,loadedAll:loadedAll}})},loadMoreEvents=function(root){var midnight=parseInt(root.attr("data-midnight"),10),courseId=root.attr("data-course-id"),daysOffset=parseInt(root.attr("data-days-offset"),10),daysLimit=root.attr("data-days-limit"),lastId=getOffset(root),eventListWrapper=root.find(SELECTORS.EVENT_LIST_WRAPPER),searchValue=root.closest(SELECTORS.TIMELINE_BLOCK).find(SELECTORS.TIMELINE_SEARCH).val(),eventsPromise=loadEventsForLazyLoading(root,10,midnight,lastId,courseId,daysOffset,daysLimit,searchValue);eventsPromise.then(function(data){if(data.calendarEvents.length){var renderPromise=render(data.calendarEvents),lastTimestamp=getLastTimestamp(root);renderPromise.then(function(html,js){html=$(html);html.find("[data-timestamp=\"".concat(lastTimestamp,"\"]")).remove();Templates.appendNodeContents(eventListWrapper,html.html(),js);if(!data.loadedAll){Templates.render(TEMPLATES.MORE_ACTIVITIES_BUTTON,{}).then(function(html){eventListWrapper.append(html);setLastTimestamp(root,data.calendarEvents.at(-1).timeusermidnight);initEventListener(root);return html}).catch(function(){return!1})}return html}).catch(Notification.exception)}return data}).then(function(){return disableMoreActivitiesButtonLoading(root)}).catch(Notification.exception)},getOffset=function(element){return parseInt(element.attr("data-lazyload-offset"),10)},setOffset=function(element,offset){element.attr("data-lazyload-offset",offset)},getLastTimestamp=function(element){return parseInt(element.attr("data-timestamp"),10)},setLastTimestamp=function(element,timestamp){element.attr("data-timestamp",timestamp)},enableMoreActivitiesButtonLoading=function(root){var loadMoreButton=root.find(SELECTORS.MORE_ACTIVITIES_BUTTON);loadMoreButton.prop("disabled",!0);Templates.render(TEMPLATES.LOADING_ICON,{}).then(function(html){loadMoreButton.append(html);return html}).catch(function(){return!1})},disableMoreActivitiesButtonLoading=function(root){var loadMoreButtonContainer=root.find(SELECTORS.MORE_ACTIVITIES_BUTTON_CONTAINER);loadMoreButtonContainer.remove()},initEventListener=function(root){var loadMoreButton=root.find(SELECTORS.MORE_ACTIVITIES_BUTTON);loadMoreButton.on("click",function(){enableMoreActivitiesButtonLoading(root);loadMoreEvents(root)})};return{init:function init(root){var additionalConfig=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},pendingPromise=new Pending("block/timeline:event-init");root=$(root);courseview=!!additionalConfig.courseview;var firstLoad=$.Deferred(),eventListContent=root.find(SELECTORS.EVENT_LIST_CONTENT),loadingPlaceholder=root.find(SELECTORS.EVENT_LIST_LOADING_PLACEHOLDER),courseId=root.attr("data-course-id"),daysOffset=parseInt(root.attr("data-days-offset"),10),daysLimit=root.attr("data-days-limit"),midnight=parseInt(root.attr("data-midnight"),10),searchValue=root.closest(SELECTORS.TIMELINE_BLOCK).find(SELECTORS.TIMELINE_SEARCH).val();emptyContent(root);showContent(root);loadingPlaceholder.removeClass("hidden");if(daysLimit!=void 0){daysLimit=parseInt(daysLimit,10)}return createLazyLoadingContent(root,firstLoad,5,midnight,0,courseId,daysOffset,daysLimit,searchValue).then(function(html,js){firstLoad.then(function(data){if(!data.hasContent){loadingPlaceholder.addClass("hidden");return hideContent(root)}html=$(html);html.addClass("hidden");Templates.replaceNodeContents(eventListContent,html,js);html.removeClass("hidden");loadingPlaceholder.addClass("hidden");if(!data.loadedAll){Templates.render(TEMPLATES.MORE_ACTIVITIES_BUTTON,{courseview:courseview}).then(function(html){eventListContent.append(html);setLastTimestamp(root,data.lastTimeStamp);initEventListener(root);return html}).catch(function(){return!1})}return data}).catch(function(){return!1});return html}).then(function(){return pendingPromise.resolve()}).catch(Notification.exception)},rootSelector:SELECTORS.ROOT}});
//# sourceMappingURL=event_list.min.js.map
