define ("block_timeline/event_list",["jquery","core/notification","core/templates","core/paged_content_factory","core/str","core/user_date","block_timeline/calendar_events_repository"],function($,Notification,Templates,PagedContentFactory,Str,UserDate,CalendarEventsRepository){var SELECTORS={EMPTY_MESSAGE:"[data-region=\"empty-message\"]",ROOT:"[data-region=\"event-list-container\"]",EVENT_LIST_CONTENT:"[data-region=\"event-list-content\"]",EVENT_LIST_LOADING_PLACEHOLDER:"[data-region=\"event-list-loading-placeholder\"]"},TEMPLATES={EVENT_LIST_CONTENT:"block_timeline/event-list-content"},DEFAULT_PAGED_CONTENT_CONFIG={ignoreControlWhileLoading:!0,controlPlacementBottom:!0,ariaLabels:{itemsperpagecomponents:"ariaeventlistpagelimit, block_timeline"}},hideContent=function(root){root.find(SELECTORS.EVENT_LIST_CONTENT).addClass("hidden");root.find(SELECTORS.EMPTY_MESSAGE).removeClass("hidden")},showContent=function(root){root.find(SELECTORS.EVENT_LIST_CONTENT).removeClass("hidden");root.find(SELECTORS.EMPTY_MESSAGE).addClass("hidden")},emptyContent=function(root){root.find(SELECTORS.EVENT_LIST_CONTENT).empty()},buildTemplateContext=function(calendarEvents,midnight){var eventsByDay={},templateContext={eventsbyday:[]};calendarEvents.forEach(function(calendarEvent){var dayTimestamp=UserDate.getUserMidnightForTimestamp(calendarEvent.timesort,midnight);if(eventsByDay[dayTimestamp]){eventsByDay[dayTimestamp].push(calendarEvent)}else{eventsByDay[dayTimestamp]=[calendarEvent]}});Object.keys(eventsByDay).forEach(function(dayTimestamp){var events=eventsByDay[dayTimestamp];templateContext.eventsbyday.push({past:dayTimestamp<midnight,dayTimestamp:dayTimestamp,events:events})});return templateContext},render=function(calendarEvents,midnight){var templateContext=buildTemplateContext(calendarEvents,midnight),templateName=TEMPLATES.EVENT_LIST_CONTENT;return Templates.render(templateName,templateContext)},load=function(midnight,limit,daysOffset,daysLimit,lastId,courseId){var endTime=daysLimit!=void 0?midnight+daysLimit*86400:!1,args={starttime:midnight+daysOffset*86400,limit:limit};if(lastId){args.aftereventid=lastId}if(endTime){args.endtime=endTime}if(courseId){args.courseid=courseId;return CalendarEventsRepository.queryByCourse(args)}else{return CalendarEventsRepository.queryByTime(args)}},loadEventsFromPageData=function(pageData,actions,midnight,lastIds,preloadedPages,courseId,daysOffset,daysLimit){var pageNumber=pageData.pageNumber,limit=pageData.limit,lastPageNumber=pageNumber;while(!lastIds.hasOwnProperty(lastPageNumber)){lastPageNumber--}var lastId=lastIds[lastPageNumber],eventsPromise=null;if(preloadedPages&&preloadedPages.hasOwnProperty(pageNumber)){eventsPromise=preloadedPages[pageNumber]}else{eventsPromise=load(midnight,limit+1,daysOffset,daysLimit,lastId,courseId)}return eventsPromise.then(function(result){if(!result.events.length){actions.allItemsLoaded(pageNumber);return[]}var calendarEvents=result.events.filter(function(event){if("open"==event.eventtype||"opensubmission"==event.eventtype){var dayTimestamp=UserDate.getUserMidnightForTimestamp(event.timesort,midnight);return dayTimestamp>midnight}return!0}),loadedAll=calendarEvents.length<=limit;if(loadedAll){actions.allItemsLoaded(pageNumber)}else{calendarEvents.pop()}return calendarEvents})},createPagedContent=function(pageLimit,preloadedPages,midnight,firstLoad,courseId,daysOffset,daysLimit,paginationAriaLabel,additionalConfig){var lastIds={1:0},hasContent=!1,config=$.extend({},DEFAULT_PAGED_CONTENT_CONFIG,additionalConfig);return Str.get_string("ariaeventlistpagelimit","block_timeline",$.isArray(pageLimit)?pageLimit[0].value:pageLimit).then(function(string){config.ariaLabels.itemsperpage=string;config.ariaLabels.paginationnav=paginationAriaLabel;return string}).then(function(){return PagedContentFactory.createWithLimit(pageLimit,function(pagesData,actions){var promises=[];pagesData.forEach(function(pageData){var pageNumber=pageData.pageNumber,pagePromise=loadEventsFromPageData(pageData,actions,midnight,lastIds,preloadedPages,courseId,daysOffset,daysLimit).then(function(calendarEvents){if(calendarEvents.length){hasContent=!0;var lastEventId=calendarEvents[calendarEvents.length-1].id;lastIds[pageNumber+1]=lastEventId;return render(calendarEvents,midnight)}else{return calendarEvents}}).catch(Notification.exception);promises.push(pagePromise)});$.when.apply($,promises).then(function(){firstLoad.resolve(hasContent)}).catch(function(){firstLoad.resolve(hasContent)});return promises},config)})};return{init:function init(root,pageLimit,preloadedPages,paginationAriaLabel,additionalConfig){root=$(root);var firstLoad=$.Deferred(),eventListContent=root.find(SELECTORS.EVENT_LIST_CONTENT),loadingPlaceholder=root.find(SELECTORS.EVENT_LIST_LOADING_PLACEHOLDER),courseId=root.attr("data-course-id"),daysOffset=parseInt(root.attr("data-days-offset"),10),daysLimit=root.attr("data-days-limit"),midnight=parseInt(root.attr("data-midnight"),10);emptyContent(root);showContent(root);loadingPlaceholder.removeClass("hidden");if(daysLimit!=void 0){daysLimit=parseInt(daysLimit,10)}return createPagedContent(pageLimit,preloadedPages,midnight,firstLoad,courseId,daysOffset,daysLimit,paginationAriaLabel,additionalConfig).then(function(html,js){html=$(html);html.addClass("hidden");Templates.replaceNodeContents(eventListContent,html,js);firstLoad.then(function(hasContent){html.removeClass("hidden");loadingPlaceholder.addClass("hidden");if(!hasContent){hideContent(root)}return hasContent}).catch(function(){return!1});return html}).catch(Notification.exception)},rootSelector:SELECTORS.ROOT}});
//# sourceMappingURL=event_list.min.js.map
