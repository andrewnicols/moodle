define ("block_timeline/view_courses",["jquery","core/notification","core/custom_interaction_events","core/templates","block_timeline/event_list","core_course/repository","block_timeline/calendar_events_repository","core/pending"],function($,Notification,CustomEvents,Templates,EventList,CourseRepository,EventsRepository,Pending){var SELECTORS={MORE_COURSES_BUTTON:"[data-action=\"more-courses\"]",MORE_COURSES_BUTTON_CONTAINER:"[data-region=\"more-courses-button-container\"]",NO_COURSES_EMPTY_MESSAGE:"[data-region=\"no-courses-empty-message\"]",NO_COURSES_WITH_EVENTS_MESSAGE:"[data-region=\"no-events-empty-message\"]",COURSES_LIST:"[data-region=\"courses-list\"]",COURSE_ITEMS_LOADING_PLACEHOLDER:"[data-region=\"course-items-loading-placeholder\"]",COURSE_EVENTS_CONTAINER:"[data-region=\"course-events-container\"]",COURSE_NAME:"[data-region=\"course-name\"]",LOADING_ICON:".loading-icon",TIMELINE_BLOCK:"[data-region=\"timeline\"]",TIMELINE_SEARCH:"[data-action=\"search\"]"},TEMPLATES={COURSE_ITEMS:"block_timeline/course-items",LOADING_ICON:"core/loading"},SECONDS_IN_DAY=86400;const additionalConfig={courseview:!0};var hideLoadingPlaceholder=function(root){root.find(SELECTORS.COURSE_ITEMS_LOADING_PLACEHOLDER).addClass("hidden")};const showLoadingPlaceholder=function(root){root.find(SELECTORS.COURSE_ITEMS_LOADING_PLACEHOLDER).removeClass("hidden")};var hideMoreCoursesButton=function(root){root.find(SELECTORS.MORE_COURSES_BUTTON_CONTAINER).addClass("hidden")},showMoreCoursesButton=function(root){root.find(SELECTORS.MORE_COURSES_BUTTON_CONTAINER).removeClass("hidden")},enableMoreCoursesButtonLoading=function(root){var button=root.find(SELECTORS.MORE_COURSES_BUTTON);button.prop("disabled",!0);Templates.render(TEMPLATES.LOADING_ICON,{}).then(function(html){button.append(html);return html}).catch(function(){return!1})},disableMoreCoursesButtonLoading=function(root){var button=root.find(SELECTORS.MORE_COURSES_BUTTON);button.prop("disabled",!1);button.find(SELECTORS.LOADING_ICON).remove()};const showNoCoursesWithEventsMessage=function(root){const container=root.find(SELECTORS.COURSES_LIST);Templates.replaceNodeContents(container,"","");root.find(SELECTORS.NO_COURSES_WITH_EVENTS_MESSAGE).removeClass("hidden")},hideNoCoursesWithEventsMessage=function(root){root.find(SELECTORS.NO_COURSES_WITH_EVENTS_MESSAGE).addClass("hidden")};var renderCourseItemsHTML=function(root,html){let append=2<arguments.length&&arguments[2]!==void 0?arguments[2]:!1;var container=root.find(SELECTORS.COURSES_LIST);if(append){Templates.appendNodeContents(container,html,"")}else{Templates.replaceNodeContents(container,html,"")}},getOffset=function(root){return parseInt(root.attr("data-offset"),10)},setOffset=function(root,offset){root.attr("data-offset",offset)},getLimit=function(root){return parseInt(root.attr("data-limit"),10)},getDaysOffset=function(root){return parseInt(root.attr("data-days-offset"),10)},getDaysLimit=function(root){var daysLimit=root.attr("data-days-limit");return daysLimit!=void 0?parseInt(daysLimit,10):void 0},getMidnight=function(root){return parseInt(root.attr("data-midnight"),10)},getStartTime=function(root){var midnight=getMidnight(root),daysOffset=getDaysOffset(root);return midnight+daysOffset*SECONDS_IN_DAY},getEndTime=function(root){var midnight=getMidnight(root),daysLimit=getDaysLimit(root);return daysLimit!=void 0?midnight+daysLimit*SECONDS_IN_DAY:null},getEventsForCourseIds=function(courseIds,startTime,limit,endTime,searchValue){var args={courseids:courseIds,starttime:startTime,limit:limit};if(endTime){args.endtime=endTime}if(searchValue){args.searchvalue=searchValue}return EventsRepository.queryByCourses(args)},getEventReloadTime=function(root){return root.data("last-event-load-time")},setEventReloadTime=function(root,time){root.data("last-event-load-time",time)},hasReloadedEventsSince=function(root,time){return getEventReloadTime(root)>time},loadEventsForCourses=function(courses,startTime,endTime,searchValue){var courseIds=courses.map(function(course){return course.id});return getEventsForCourseIds(courseIds,startTime,5+1,endTime,searchValue)},updateDisplayFromCourses=function(courses,root,midnight,daysOffset,daysLimit,append){return Templates.render(TEMPLATES.COURSE_ITEMS,{courses:courses,midnight:midnight,hasdaysoffset:!0,hasdayslimit:daysLimit!=void 0,daysoffset:daysOffset,dayslimit:daysLimit,nodayslimit:daysLimit==void 0,courseview:!0,hascourses:!0}).then(function(html){hideLoadingPlaceholder(root);if(html){renderCourseItemsHTML(root,html,append)}return html}).then(function(html){if(courses.length<2){hideMoreCoursesButton(root)}else{showMoreCoursesButton(root)}return html}).catch(function(){hideLoadingPlaceholder(root)})},loadMoreCourses=function(root){let append=1<arguments.length&&arguments[1]!==void 0?arguments[1]:!1;const pendingPromise=new Pending("block/timeline:load-more-courses");var offset=getOffset(root),limit=getLimit(root);const startTime=getStartTime(root),endTime=getEndTime(root),searchValue=root.closest(SELECTORS.TIMELINE_BLOCK).find(SELECTORS.TIMELINE_SEARCH).val();return CourseRepository.getEnrolledCoursesWithEventsByTimelineClassification("inprogress",limit,offset,"fullname asc",searchValue,startTime,endTime).then(function(result){var startEventLoadingTime=Date.now(),courses=result.courses,nextOffset=result.nextoffset,daysOffset=getDaysOffset(root),daysLimit=getDaysLimit(root),midnight=getMidnight(root);const moreCoursesAvailable=result.morecoursesavailable;setOffset(root,nextOffset);var eventsPromise=loadEventsForCourses(courses,startTime,endTime,searchValue),renderPromise=updateDisplayFromCourses(courses,root,midnight,daysOffset,daysLimit,append);return $.when(eventsPromise,renderPromise).then(function(eventsByCourse){if(hasReloadedEventsSince(root,startEventLoadingTime)){return eventsByCourse}if(0<courses.length){courses.forEach(function(course){const courseId=course.id,courseEventsContainer=root.find("[data-region=\"course-events-container\"][data-course-id=\""+courseId+"\"]"),eventListRoot=courseEventsContainer.find(EventList.rootSelector);EventList.init(eventListRoot,additionalConfig)});if(!moreCoursesAvailable){hideMoreCoursesButton(root)}else{showMoreCoursesButton(root)}}else{hideMoreCoursesButton(root);if(0==offset){showNoCoursesWithEventsMessage(root)}}return eventsByCourse})}).then(()=>{return pendingPromise.resolve()}).catch(Notification.exception)},registerEventListeners=function(root){CustomEvents.define(root,[CustomEvents.events.activate]);root.on(CustomEvents.events.activate,SELECTORS.MORE_COURSES_BUTTON,function(e,data){enableMoreCoursesButtonLoading(root);loadMoreCourses(root,!0).then(function(){disableMoreCoursesButtonLoading(root)}).catch(function(){disableMoreCoursesButtonLoading(root)});if(data){data.originalEvent.preventDefault();data.originalEvent.stopPropagation()}e.stopPropagation()})},shown=function(root){if(!root.attr("data-seen")&&!root.find(SELECTORS.NO_COURSES_EMPTY_MESSAGE).length){loadMoreCourses(root);root.attr("data-seen",!0)}};return{init:function(root){root=$(root);if(!root.find(SELECTORS.NO_COURSES_EMPTY_MESSAGE).length){setEventReloadTime(root,Date.now());if(root.hasClass("active")){loadMoreCourses(root);root.attr("data-seen",!0)}registerEventListeners(root)}},reset:function(root){setOffset(root,0);showLoadingPlaceholder(root);hideNoCoursesWithEventsMessage(root);root.removeAttr("data-seen");if(root.hasClass("active")){shown(root)}},shown:shown}});
//# sourceMappingURL=view_courses.min.js.map
