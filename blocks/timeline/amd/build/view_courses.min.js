define ("block_timeline/view_courses",["jquery","core/notification","core/custom_interaction_events","core/str","core/templates","block_timeline/event_list","core_course/repository","block_timeline/calendar_events_repository"],function($,Notification,CustomEvents,Str,Templates,EventList,CourseRepository,EventsRepository){var SELECTORS={MORE_COURSES_BUTTON:"[data-action=\"more-courses\"]",MORE_COURSES_BUTTON_CONTAINER:"[data-region=\"more-courses-button-container\"]",NO_COURSES_EMPTY_MESSAGE:"[data-region=\"no-courses-empty-message\"]",COURSES_LIST:"[data-region=\"courses-list\"]",COURSE_ITEMS_LOADING_PLACEHOLDER:"[data-region=\"course-items-loading-placeholder\"]",COURSE_EVENTS_CONTAINER:"[data-region=\"course-events-container\"]",COURSE_NAME:"[data-region=\"course-name\"]",LOADING_ICON:".loading-icon"},TEMPLATES={COURSE_ITEMS:"block_timeline/course-items",LOADING_ICON:"core/loading"},COURSE_EVENT_LIMIT=5,SECONDS_IN_DAY=86400,hideLoadingPlaceholder=function(root){root.find(SELECTORS.COURSE_ITEMS_LOADING_PLACEHOLDER).addClass("hidden")},hideMoreCoursesButton=function(root){root.find(SELECTORS.MORE_COURSES_BUTTON_CONTAINER).addClass("hidden")},showMoreCoursesButton=function(root){root.find(SELECTORS.MORE_COURSES_BUTTON_CONTAINER).removeClass("hidden")},enableMoreCoursesButtonLoading=function(root){var button=root.find(SELECTORS.MORE_COURSES_BUTTON);button.prop("disabled",!0);Templates.render(TEMPLATES.LOADING_ICON,{}).then(function(html){button.append(html);return html}).catch(function(){return!1})},disableMoreCoursesButtonLoading=function(root){var button=root.find(SELECTORS.MORE_COURSES_BUTTON);button.prop("disabled",!1);button.find(SELECTORS.LOADING_ICON).remove()},showNoCoursesEmptyMessage=function(root){root.find(SELECTORS.NO_COURSES_EMPTY_MESSAGE).removeClass("hidden")},renderCourseItemsHTML=function(root,html){var container=root.find(SELECTORS.COURSES_LIST);Templates.appendNodeContents(container,html,"")},hasLoadedCourses=function(root){return 0<root.find(SELECTORS.COURSE_EVENTS_CONTAINER).length},getOffset=function(root){return parseInt(root.attr("data-offset"),10)},setOffset=function(root,offset){root.attr("data-offset",offset)},getLimit=function(root){return parseInt(root.attr("data-limit"),10)},getDaysOffset=function(root){return parseInt(root.attr("data-days-offset"),10)},getDaysLimit=function(root){var daysLimit=root.attr("data-days-limit");return daysLimit!=void 0?parseInt(daysLimit,10):void 0},getMidnight=function(root){return parseInt(root.attr("data-midnight"),10)},getStartTime=function(root){var midnight=getMidnight(root),daysOffset=getDaysOffset(root);return midnight+daysOffset*SECONDS_IN_DAY},getEndTime=function(root){var midnight=getMidnight(root),daysLimit=getDaysLimit(root);return daysLimit!=void 0?midnight+daysLimit*SECONDS_IN_DAY:!1},getEventsForCourseIds=function(courseIds,startTime,limit,endTime){var args={courseids:courseIds,starttime:startTime,limit:limit};if(endTime){args.endtime=endTime}return EventsRepository.queryByCourses(args)},getEventReloadTime=function(root){return root.data("last-event-load-time")},setEventReloadTime=function(root,time){root.data("last-event-load-time",time)},hasReloadedEventsSince=function(root,time){return getEventReloadTime(root)>time},loadEventsForCourses=function(courses,startTime,endTime){var courseIds=courses.map(function(course){return course.id});return getEventsForCourseIds(courseIds,startTime,COURSE_EVENT_LIMIT+1,endTime)},updateDisplayFromCourses=function(courses,root,midnight,daysOffset,daysLimit,noEventsURL){return Templates.render(TEMPLATES.COURSE_ITEMS,{courses:courses,midnight:midnight,hasdaysoffset:!0,hasdayslimit:daysLimit!=void 0,daysoffset:daysOffset,dayslimit:daysLimit,nodayslimit:daysLimit==void 0,urls:{noevents:noEventsURL}}).then(function(html){hideLoadingPlaceholder(root);if(html){renderCourseItemsHTML(root,html)}else{if(!hasLoadedCourses(root)){showNoCoursesEmptyMessage(root)}}return html}).then(function(html){if(courses.length<2){hideMoreCoursesButton(root)}else{showMoreCoursesButton(root)}return html}).catch(function(){hideLoadingPlaceholder(root)})},loadMoreCourses=function(root){var offset=getOffset(root),limit=getLimit(root);return CourseRepository.getEnrolledCoursesByTimelineClassification("inprogress",limit,offset,"fullname asc").then(function(result){var startEventLoadingTime=Date.now(),courses=result.courses,nextOffset=result.nextoffset,daysOffset=getDaysOffset(root),daysLimit=getDaysLimit(root),midnight=getMidnight(root),startTime=getStartTime(root),endTime=getEndTime(root),noEventsURL=root.attr("data-no-events-url");setOffset(root,nextOffset);var eventsPromise=loadEventsForCourses(courses,startTime,endTime),renderPromise=updateDisplayFromCourses(courses,root,midnight,daysOffset,daysLimit,noEventsURL);return $.when(eventsPromise,renderPromise).then(function(eventsByCourse){if(hasReloadedEventsSince(root,startEventLoadingTime)){return eventsByCourse}courses.forEach(function(course){var courseId=course.id,events=[],courseEventsContainer=root.find("[data-region=\"course-events-container\"][data-course-id=\""+courseId+"\"]"),eventListRoot=courseEventsContainer.find(EventList.rootSelector),courseGroups=eventsByCourse.groupedbycourse.filter(function(group){return group.courseid==courseId});if(courseGroups.length){events=courseGroups[0].events}var pageOnePreload=$.Deferred().resolve({events:events}).promise();Str.get_string("ariaeventlistpaginationnavcourses","block_timeline",course.fullnamedisplay).then(function(string){EventList.init(eventListRoot,COURSE_EVENT_LIMIT,{1:pageOnePreload},string);return string}).catch(function(){EventList.init(eventListRoot,COURSE_EVENT_LIMIT,{1:pageOnePreload})})});return eventsByCourse})}).catch(Notification.exception)},reloadCourseEvents=function(root){var startReloadTime=Date.now(),startTime=getStartTime(root),endTime=getEndTime(root),courseEventsContainers=root.find(SELECTORS.COURSE_EVENTS_CONTAINER),courseIds=courseEventsContainers.map(function(){return $(this).attr("data-course-id")}).get();setEventReloadTime(root,startReloadTime);return getEventsForCourseIds(courseIds,startTime,COURSE_EVENT_LIMIT+1,endTime).then(function(eventsByCourse){if(hasReloadedEventsSince(root,startReloadTime)){return eventsByCourse}courseEventsContainers.each(function(index,container){container=$(container);var courseId=container.attr("data-course-id"),courseName=container.find(SELECTORS.COURSE_NAME).text(),eventListContainer=container.find(EventList.rootSelector),pageDeferred=$.Deferred(),events=[],courseGroups=eventsByCourse.groupedbycourse.filter(function(group){return group.courseid==courseId});if(courseGroups.length){events=courseGroups[0].events}pageDeferred.resolve({events:events});Str.get_string("ariaeventlistpaginationnavcourses","block_timeline",courseName).then(function(string){EventList.init(eventListContainer,COURSE_EVENT_LIMIT,{1:pageDeferred.promise()},string);return string}).catch(function(){EventList.init(eventListContainer,COURSE_EVENT_LIMIT,{1:pageDeferred.promise()})})});return eventsByCourse}).catch(Notification.exception)},registerEventListeners=function(root){CustomEvents.define(root,[CustomEvents.events.activate]);root.on(CustomEvents.events.activate,SELECTORS.MORE_COURSES_BUTTON,function(e,data){enableMoreCoursesButtonLoading(root);loadMoreCourses(root).then(function(){disableMoreCoursesButtonLoading(root)}).catch(function(){disableMoreCoursesButtonLoading(root)});if(data){data.originalEvent.preventDefault();data.originalEvent.stopPropagation()}e.stopPropagation()})},shown=function(root){if(!root.attr("data-seen")){if(hasLoadedCourses(root)){reloadCourseEvents(root)}else{loadMoreCourses(root)}root.attr("data-seen",!0)}};return{init:function init(root){root=$(root);setEventReloadTime(root,Date.now());if(root.hasClass("active")){loadMoreCourses(root);root.attr("data-seen",!0)}registerEventListeners(root)},reset:function reset(root){root.removeAttr("data-seen");if(root.hasClass("active")){shown(root)}},shown:shown}});
//# sourceMappingURL=view_courses.min.js.map
