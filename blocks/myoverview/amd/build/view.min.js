define ("block_myoverview/view",["jquery","block_myoverview/repository","core/paged_content_factory","core/pubsub","core/custom_interaction_events","core/notification","core/templates","core_course/events","block_myoverview/selectors","core/paged_content_events"],function($,Repository,PagedContentFactory,PubSub,CustomEvents,Notification,Templates,CourseEvents,Selectors,PagedContentEvents){var SELECTORS={COURSE_REGION:"[data-region=\"course-view-content\"]",ACTION_HIDE_COURSE:"[data-action=\"hide-course\"]",ACTION_SHOW_COURSE:"[data-action=\"show-course\"]",ACTION_ADD_FAVOURITE:"[data-action=\"add-favourite\"]",ACTION_REMOVE_FAVOURITE:"[data-action=\"remove-favourite\"]",FAVOURITE_ICON:"[data-region=\"favourite-icon\"]",ICON_IS_FAVOURITE:"[data-region=\"is-favourite\"]",ICON_NOT_FAVOURITE:"[data-region=\"not-favourite\"]",PAGED_CONTENT_CONTAINER:"[data-region=\"page-container\"]"},TEMPLATES={COURSES_CARDS:"block_myoverview/view-cards",COURSES_LIST:"block_myoverview/view-list",COURSES_SUMMARY:"block_myoverview/view-summary",NOCOURSES:"core_course/no-courses"},GROUPINGS={GROUPING_ALLINCLUDINGHIDDEN:"allincludinghidden",GROUPING_ALL:"all",GROUPING_INPROGRESS:"inprogress",GROUPING_FUTURE:"future",GROUPING_PAST:"past",GROUPING_FAVOURITES:"favourites",GROUPING_HIDDEN:"hidden"},NUMCOURSES_PERPAGE=[12,24,48,96,0],loadedPages=[],courseOffset=0,lastPage=0,lastLimit=0,namespace=null,getFilterValues=function(root){var courseRegion=root.find(Selectors.courseView.region);return{display:courseRegion.attr("data-display"),grouping:courseRegion.attr("data-grouping"),sort:courseRegion.attr("data-sort"),displaycategories:courseRegion.attr("data-displaycategories"),customfieldname:courseRegion.attr("data-customfieldname"),customfieldvalue:courseRegion.attr("data-customfieldvalue")}},DEFAULT_PAGED_CONTENT_CONFIG={ignoreControlWhileLoading:!0,controlPlacementBottom:!0,persistentLimitKey:"block_myoverview_user_paging_preference"},getMyCourses=function(filters,limit){return Repository.getEnrolledCoursesByTimeline({offset:courseOffset,limit:limit,classification:filters.grouping,sort:filters.sort,customfieldname:filters.customfieldname,customfieldvalue:filters.customfieldvalue})},getFavouriteIconContainer=function(root,courseId){return root.find(SELECTORS.FAVOURITE_ICON+"[data-course-id=\""+courseId+"\"]")},getPagedContentContainer=function(root,index){return root.find("[data-region=\"paged-content-page\"][data-page=\""+index+"\"]")},getCourseId=function(root){return root.attr("data-course-id")},hideFavouriteIcon=function(root,courseId){var iconContainer=getFavouriteIconContainer(root,courseId),isFavouriteIcon=iconContainer.find(SELECTORS.ICON_IS_FAVOURITE);isFavouriteIcon.addClass("hidden");isFavouriteIcon.attr("aria-hidden",!0);var notFavourteIcon=iconContainer.find(SELECTORS.ICON_NOT_FAVOURITE);notFavourteIcon.removeClass("hidden");notFavourteIcon.attr("aria-hidden",!1)},showFavouriteIcon=function(root,courseId){var iconContainer=getFavouriteIconContainer(root,courseId),isFavouriteIcon=iconContainer.find(SELECTORS.ICON_IS_FAVOURITE);isFavouriteIcon.removeClass("hidden");isFavouriteIcon.attr("aria-hidden",!1);var notFavourteIcon=iconContainer.find(SELECTORS.ICON_NOT_FAVOURITE);notFavourteIcon.addClass("hidden");notFavourteIcon.attr("aria-hidden",!0)},getAddFavouriteMenuItem=function(root,courseId){return root.find("[data-action=\"add-favourite\"][data-course-id=\""+courseId+"\"]")},getRemoveFavouriteMenuItem=function(root,courseId){return root.find("[data-action=\"remove-favourite\"][data-course-id=\""+courseId+"\"]")},addToFavourites=function(root,courseId){var removeAction=getRemoveFavouriteMenuItem(root,courseId),addAction=getAddFavouriteMenuItem(root,courseId);setCourseFavouriteState(courseId,!0).then(function(success){if(success){PubSub.publish(CourseEvents.favourited,courseId);removeAction.removeClass("hidden");addAction.addClass("hidden");showFavouriteIcon(root,courseId)}else{Notification.alert("Starring course failed","Could not change favourite state")}}).catch(Notification.exception)},removeFromFavourites=function(root,courseId){var removeAction=getRemoveFavouriteMenuItem(root,courseId),addAction=getAddFavouriteMenuItem(root,courseId);setCourseFavouriteState(courseId,!1).then(function(success){if(success){PubSub.publish(CourseEvents.unfavorited,courseId);removeAction.addClass("hidden");addAction.removeClass("hidden");hideFavouriteIcon(root,courseId)}else{Notification.alert("Starring course failed","Could not change favourite state")}}).catch(Notification.exception)},getHideCourseMenuItem=function(root,courseId){return root.find("[data-action=\"hide-course\"][data-course-id=\""+courseId+"\"]")},getShowCourseMenuItem=function(root,courseId){return root.find("[data-action=\"show-course\"][data-course-id=\""+courseId+"\"]")},hideCourse=function(root,courseId){var hideAction=getHideCourseMenuItem(root,courseId),showAction=getShowCourseMenuItem(root,courseId),filters=getFilterValues(root);setCourseHiddenState(courseId,!0);if(filters.grouping!=GROUPINGS.GROUPING_ALLINCLUDINGHIDDEN){hideElement(root,courseId)}hideAction.addClass("hidden");showAction.removeClass("hidden")},showCourse=function(root,courseId){var hideAction=getHideCourseMenuItem(root,courseId),showAction=getShowCourseMenuItem(root,courseId),filters=getFilterValues(root);setCourseHiddenState(courseId,null);if(filters.grouping!=GROUPINGS.GROUPING_ALLINCLUDINGHIDDEN){hideElement(root,courseId)}hideAction.removeClass("hidden");showAction.addClass("hidden")},setCourseHiddenState=function(courseId,status){if(!1===status){status=null}return Repository.updateUserPreferences({preferences:[{type:"block_myoverview_hidden_course_"+courseId,value:status}]})},hideElement=function(root,id){var pagingBar=root.find("[data-region=\"paging-bar\"]"),jumpto=parseInt(pagingBar.attr("data-active-page-number")),courseList=loadedPages[jumpto],reducedCourse=courseList.courses.reduce(function(accumulator,current){if(id!=current.id){accumulator.push(current)}return accumulator},[]);if(loadedPages[jumpto+1]!=void 0){var newElement=loadedPages[jumpto+1].courses.slice(0,1);loadedPages.forEach(function(courseList,index){if(index>jumpto){var popElement=[];if(loadedPages[index+1]!=void 0){popElement=loadedPages[index+1].courses.slice(0,1)}loadedPages[index].courses=$.merge(loadedPages[index].courses.slice(1),popElement)}});reducedCourse=$.merge(reducedCourse,newElement)}if(lastPage==jumpto+1&&0==loadedPages[jumpto+1].courses.length){var pagedContentContainer=root.find("[data-region=\"paged-content-container\"]");PagedContentFactory.resetLastPageNumber($(pagedContentContainer).attr("id"),jumpto)}loadedPages[jumpto].courses=reducedCourse;courseOffset--;var pagedContentPage=getPagedContentContainer(root,jumpto);renderCourses(root,loadedPages[jumpto]).then(function(html,js){return Templates.replaceNodeContents(pagedContentPage,html,js)}).catch(Notification.exception);loadedPages.forEach(function(courseList,index){if(index>jumpto){var page=getPagedContentContainer(root,index);page.remove()}})},setCourseFavouriteState=function(courseId,status){return Repository.setFavouriteCourses({courses:[{id:courseId,favourite:status}]}).then(function(result){if(0==result.warnings.length){loadedPages.forEach(function(courseList){courseList.courses.forEach(function(course,index){if(course.id==courseId){courseList.courses[index].isfavourite=status}})});return!0}else{return!1}}).catch(Notification.exception)},renderCourses=function(root,coursesData){var filters=getFilterValues(root),currentTemplate="";if("card"==filters.display){currentTemplate=TEMPLATES.COURSES_CARDS}else if("list"==filters.display){currentTemplate=TEMPLATES.COURSES_LIST}else{currentTemplate=TEMPLATES.COURSES_SUMMARY}coursesData.courses=coursesData.courses.map(function(course){course.showcoursecategory="on"==filters.displaycategories?!0:!1;return course});if(coursesData.courses.length){return Templates.render(currentTemplate,{courses:coursesData.courses})}else{var nocoursesimg=root.find(Selectors.courseView.region).attr("data-nocoursesimg");return Templates.render(TEMPLATES.NOCOURSES,{nocoursesimg:nocoursesimg})}},setLimit=function(limit){this.find(Selectors.courseView.region).attr("data-paging",limit)},registerPagedEventHandlers=function(root,namespace){var event=namespace+PagedContentEvents.SET_ITEMS_PER_PAGE_LIMIT;PubSub.subscribe(event,setLimit.bind(root))},initializePagedContent=function(root){namespace="block_myoverview_"+root.attr("id")+"_"+Math.random();var pagingLimit=parseInt(root.find(Selectors.courseView.region).attr("data-paging"),10),itemsPerPage=NUMCOURSES_PERPAGE.map(function(value){var active=!1;if(value==pagingLimit){active=!0}return{value:value,active:active}}),totalCourseCount=parseInt(root.find(Selectors.courseView.region).attr("data-totalcoursecount"),10);itemsPerPage=itemsPerPage.filter(function(pagingOption){return pagingOption.value<totalCourseCount||0===pagingOption.value});var filters=getFilterValues(root),config=$.extend({},DEFAULT_PAGED_CONTENT_CONFIG);config.eventNamespace=namespace;var pagedContentPromise=PagedContentFactory.createWithLimit(itemsPerPage,function(pagesData,actions){var promises=[];pagesData.forEach(function(pageData){var currentPage=pageData.pageNumber,limit=0<pageData.limit?pageData.limit:0;if(lastLimit!=limit){loadedPages=[];courseOffset=0;lastPage=0}if(lastPage==currentPage){actions.allItemsLoaded(lastPage);promises.push(renderCourses(root,loadedPages[currentPage]));return}lastLimit=limit;if(loadedPages[currentPage+1]==void 0){if(loadedPages[currentPage]==void 0){limit*=2}}var pagePromise=getMyCourses(filters,limit).then(function(coursesData){var courses=coursesData.courses,nextPageStart=0,pageCourses=[];if(loadedPages[currentPage]!=void 0){pageCourses=loadedPages[currentPage].courses;var currentPageLength=pageCourses.length;if(currentPageLength<pageData.limit){nextPageStart=pageData.limit-currentPageLength;pageCourses=$.merge(loadedPages[currentPage].courses,courses.slice(0,nextPageStart))}}else{nextPageStart=pageData.limit||!1;pageCourses=0<pageData.limit?courses.slice(0,pageData.limit):courses}loadedPages[currentPage]={courses:pageCourses};var remainingCourses=!1!==nextPageStart?courses.slice(nextPageStart,courses.length):[];if(remainingCourses.length){loadedPages[currentPage+1]={courses:remainingCourses}}if(loadedPages[currentPage].courses.length<pageData.limit||!remainingCourses.length){lastPage=currentPage;actions.allItemsLoaded(currentPage)}else if(loadedPages[currentPage+1]!=void 0&&loadedPages[currentPage+1].courses.length<pageData.limit){lastPage=currentPage+1}courseOffset=coursesData.nextoffset;return renderCourses(root,loadedPages[currentPage])}).catch(Notification.exception);promises.push(pagePromise)});return promises},config);pagedContentPromise.then(function(html,js){registerPagedEventHandlers(root,namespace);return Templates.replaceNodeContents(root.find(Selectors.courseView.region),html,js)}).catch(Notification.exception)},registerEventListeners=function(root){CustomEvents.define(root,[CustomEvents.events.activate]);root.on(CustomEvents.events.activate,SELECTORS.ACTION_ADD_FAVOURITE,function(e,data){var favourite=$(e.target).closest(SELECTORS.ACTION_ADD_FAVOURITE),courseId=getCourseId(favourite);addToFavourites(root,courseId);data.originalEvent.preventDefault()});root.on(CustomEvents.events.activate,SELECTORS.ACTION_REMOVE_FAVOURITE,function(e,data){var favourite=$(e.target).closest(SELECTORS.ACTION_REMOVE_FAVOURITE),courseId=getCourseId(favourite);removeFromFavourites(root,courseId);data.originalEvent.preventDefault()});root.on(CustomEvents.events.activate,SELECTORS.FAVOURITE_ICON,function(e,data){data.originalEvent.preventDefault()});root.on(CustomEvents.events.activate,SELECTORS.ACTION_HIDE_COURSE,function(e,data){var target=$(e.target).closest(SELECTORS.ACTION_HIDE_COURSE),courseId=getCourseId(target);hideCourse(root,courseId);data.originalEvent.preventDefault()});root.on(CustomEvents.events.activate,SELECTORS.ACTION_SHOW_COURSE,function(e,data){var target=$(e.target).closest(SELECTORS.ACTION_SHOW_COURSE),courseId=getCourseId(target);showCourse(root,courseId);data.originalEvent.preventDefault()})},init=function(root){root=$(root);loadedPages=[];lastPage=0;courseOffset=0;initializePagedContent(root);if(!root.attr("data-init")){registerEventListeners(root);root.attr("data-init",!0)}},reset=function(root){if(0<loadedPages.length){loadedPages.forEach(function(courseList,index){var pagedContentPage=getPagedContentContainer(root,index);renderCourses(root,courseList).then(function(html,js){return Templates.replaceNodeContents(pagedContentPage,html,js)}).catch(Notification.exception)})}else{init(root)}};return{init:init,reset:reset}});
//# sourceMappingURL=view.min.js.map
