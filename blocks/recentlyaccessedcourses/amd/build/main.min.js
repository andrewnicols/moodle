define ("block_recentlyaccessedcourses/main",["jquery","core/custom_interaction_events","core/notification","core/pubsub","core/paged_content_paging_bar","core/templates","core_course/events","core_course/repository","core/aria"],function($,CustomEvents,Notification,PubSub,PagedContentPagingBar,Templates,CourseEvents,CoursesRepository,Aria){var SELECTORS={BLOCK_CONTAINER:"[data-region=\"recentlyaccessedcourses\"]",CARD_CONTAINER:"[data-region=\"card-deck\"]",COURSE_IS_FAVOURITE:"[data-region=\"is-favourite\"]",CONTENT:"[data-region=\"view-content\"]",EMPTY_MESSAGE:"[data-region=\"empty-message\"]",LOADING_PLACEHOLDER:"[data-region=\"loading-placeholder\"]",PAGING_BAR:"[data-region=\"paging-bar\"]",PAGING_BAR_NEXT:"[data-control=\"next\"]",PAGING_BAR_PREVIOUS:"[data-control=\"previous\"]"},contentLoaded=!1,allCourses=[],visibleCoursesId=null,cardWidth=null,viewIndex=0,availableVisibleCards=1,showEmptyMessage=function(root){root.find(SELECTORS.EMPTY_MESSAGE).removeClass("hidden");root.find(SELECTORS.LOADING_PLACEHOLDER).addClass("hidden");root.find(SELECTORS.CONTENT).addClass("hidden")},showContent=function(root){root.find(SELECTORS.CONTENT).removeClass("hidden");root.find(SELECTORS.EMPTY_MESSAGE).addClass("hidden");root.find(SELECTORS.LOADING_PLACEHOLDER).addClass("hidden")},showPagingBar=function(root){var pagingBar=root.find(SELECTORS.PAGING_BAR);pagingBar.css("opacity",1);pagingBar.css("visibility","visible");Aria.unhide(pagingBar)},hidePagingBar=function(root){var pagingBar=root.find(SELECTORS.PAGING_BAR);pagingBar.css("opacity",0);pagingBar.css("visibility","hidden");Aria.hide(pagingBar)},favouriteCourse=function(root,courseId){allCourses.forEach(function(course){if(course.attr("data-course-id")==courseId){course.find(SELECTORS.COURSE_IS_FAVOURITE).removeClass("hidden")}})},unfavouriteCourse=function(root,courseId){allCourses.forEach(function(course){if(course.attr("data-course-id")==courseId){course.find(SELECTORS.COURSE_IS_FAVOURITE).addClass("hidden")}})},renderAllCourses=function(courses){var showcoursecategory=$(SELECTORS.BLOCK_CONTAINER).data("displaycoursecategory"),promises=courses.map(function(course){course.showcoursecategory=showcoursecategory;return Templates.render("block_recentlyaccessedcourses/course-card",course)});return $.when.apply(null,promises).then(function(){var renderedCourses=[];promises.forEach(function(promise){promise.then(function(html){renderedCourses.push($(html))}).catch(Notification.exception)});return renderedCourses})},loadContent=function(userid){return CoursesRepository.getLastAccessedCourses(userid,10).then(function(courses){return renderAllCourses(courses)})},recalculateVisibleCourses=function(root){var container=root.find(SELECTORS.CONTENT).find(SELECTORS.CARD_CONTAINER),availableWidth=parseFloat(root.css("width")),numberOfCourses=allCourses.length,start=0;if(!cardWidth){container.html(allCourses[0]);cardWidth=allCourses[0].outerWidth(!0)}availableVisibleCards=Math.floor(availableWidth/cardWidth);if(viewIndex+availableVisibleCards<numberOfCourses){start=viewIndex}else{var overflow=viewIndex+availableVisibleCards-numberOfCourses;start=viewIndex-overflow;start=0<=start?start:0}if(0===availableVisibleCards){availableVisibleCards=1}var coursesToShow=allCourses.slice(start,start+availableVisibleCards),newVisibleCoursesId=coursesToShow.reduce(function(carry,course){return carry+course.attr("data-course-id")},"");if(allCourses.length>coursesToShow.length){container.addClass("justify-content-center");container.removeClass("justify-content-start")}else{container.removeClass("justify-content-center");container.addClass("justify-content-start")}if(visibleCoursesId!=newVisibleCoursesId){var pagingBar=root.find(PagedContentPagingBar.rootSelector);container.html(coursesToShow);visibleCoursesId=newVisibleCoursesId;if(availableVisibleCards>=allCourses.length){hidePagingBar(root)}else{showPagingBar(root);if(0===viewIndex){PagedContentPagingBar.disablePreviousControlButtons(pagingBar)}else{PagedContentPagingBar.enablePreviousControlButtons(pagingBar)}if(viewIndex+availableVisibleCards>=allCourses.length){PagedContentPagingBar.disableNextControlButtons(pagingBar)}else{PagedContentPagingBar.enableNextControlButtons(pagingBar)}}}},registerEventListeners=function(root){var resizeTimeout=null,drawerToggling=!1;PubSub.subscribe(CourseEvents.favourited,function(courseId){favouriteCourse(root,courseId)});PubSub.subscribe(CourseEvents.unfavorited,function(courseId){unfavouriteCourse(root,courseId)});PubSub.subscribe("nav-drawer-toggle-start",function(){if(!contentLoaded||!allCourses.length||drawerToggling){return}drawerToggling=!0;var recalculationCount=0,doRecalculation=function(){setTimeout(function(){recalculateVisibleCourses(root);recalculationCount++;if(5>recalculationCount&&drawerToggling){doRecalculation()}},100)};doRecalculation(root)});PubSub.subscribe("nav-drawer-toggle-end",function(){drawerToggling=!1});$(window).on("resize",function(){if(!contentLoaded||!allCourses.length){return}if(!resizeTimeout){resizeTimeout=setTimeout(function(){resizeTimeout=null;recalculateVisibleCourses(root)},66)}});CustomEvents.define(root,[CustomEvents.events.activate]);root.on(CustomEvents.events.activate,SELECTORS.PAGING_BAR_NEXT,function(e,data){var button=$(e.target).closest(SELECTORS.PAGING_BAR_NEXT);if(!button.hasClass("disabled")){viewIndex=viewIndex+availableVisibleCards;recalculateVisibleCourses(root)}data.originalEvent.preventDefault()});root.on(CustomEvents.events.activate,SELECTORS.PAGING_BAR_PREVIOUS,function(e,data){var button=$(e.target).closest(SELECTORS.PAGING_BAR_PREVIOUS);if(!button.hasClass("disabled")){viewIndex=viewIndex-availableVisibleCards;viewIndex=0>viewIndex?0:viewIndex;recalculateVisibleCourses(root)}data.originalEvent.preventDefault()})};return{init:function(userid,root){root=$(root);registerEventListeners(root);loadContent(userid).then(function(renderedCourses){allCourses=renderedCourses;contentLoaded=!0;if(allCourses.length){showContent(root);recalculateVisibleCourses(root)}else{showEmptyMessage(root)}}).catch(Notification.exception)}}});
//# sourceMappingURL=main.min.js.map
