define ("tool_lp/competencypicker_user_plans",["jquery","core/notification","core/ajax","core/templates","core/str","tool_lp/tree","tool_lp/competencypicker"],function($,Notification,Ajax,Templates,Str,Tree,PickerBase){var Picker=function(userId,singlePlan,multiSelect){PickerBase.prototype.constructor.apply(this,[1,!1,"self",multiSelect]);this._userId=userId;this._plans=[];if(singlePlan){this._planId=singlePlan;this._singlePlan=!0}};Picker.prototype=Object.create(PickerBase.prototype);Picker.prototype._plans=null;Picker.prototype._planId=null;Picker.prototype._singlePlan=!1;Picker.prototype._userId=null;Picker.prototype._afterRender=function(){var self=this;PickerBase.prototype._afterRender.apply(self,arguments);if(!self._singlePlan){self._find("[data-action=\"chooseplan\"]").change(function(e){self._planId=$(e.target).val();self._loadCompetencies().then(self._refresh.bind(self)).catch(Notification.exception)})}};Picker.prototype._fetchCompetencies=function(planId,searchText){var self=this;return Ajax.call([{methodname:"core_competency_list_plan_competencies",args:{id:planId}}])[0].done(function(competencies){var i,comp,tree=[];for(i=0;i<competencies.length;i++){comp=competencies[i].competency;if(0>comp.shortname.toLowerCase().indexOf(searchText.toLowerCase())){continue}comp.children=[];comp.haschildren=0;tree.push(comp)}self._competencies=tree}).fail(Notification.exception)};Picker.prototype._getPlan=function(id){var plan;$.each(this._plans,function(i,f){if(f.id==id){plan=f}});return plan};Picker.prototype._loadCompetencies=function(){return this._fetchCompetencies(this._planId,this._searchText)};Picker.prototype._loadPlans=function(){var promise,self=this;if(0<self._plans.length){return $.when()}if(self._singlePlan){promise=Ajax.call([{methodname:"core_competency_read_plan",args:{id:this._planId}}])[0].then(function(plan){return[plan]})}else{promise=Ajax.call([{methodname:"core_competency_list_user_plans",args:{userid:self._userId}}])[0]}return promise.done(function(plans){self._plans=plans}).fail(Notification.exception)};Picker.prototype._preRender=function(){var self=this;return self._loadPlans().then(function(){if(!self._planId&&0<self._plans.length){self._planId=self._plans[0].id}if(!self._planId){self._plans=[];return $.when()}return self._loadCompetencies()})};Picker.prototype._render=function(){var self=this;return self._preRender().then(function(){if(!self._singlePlan){$.each(self._plans,function(i,plan){if(plan.id==self._planId){plan.selected=!0}else{plan.selected=!1}})}var context={competencies:self._competencies,plan:self._getPlan(self._planId),plans:self._plans,search:self._searchText,singlePlan:self._singlePlan};return Templates.render("tool_lp/competency_picker_user_plans",context)})};return Picker});
//# sourceMappingURL=competencypicker_user_plans.min.js.map
