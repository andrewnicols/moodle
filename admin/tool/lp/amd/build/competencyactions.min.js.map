{"version":3,"sources":["../src/competencyactions.js"],"names":["define","$","url","templates","notification","str","ajax","dragdrop","Ariatree","Dialogue","menubar","Picker","Outcomes","RuleConfig","Pending","treeModel","moveSource","moveTarget","pageContextId","pickerInstance","ruleConfigInstance","relatedTarget","taxonomiesConstants","rulesModules","selectedCompetencyId","addHandler","parent","data","params","competencyframeworkid","getCompetencyFrameworkId","pagecontextid","parentid","id","relocate","queryparams","param","window","location","relativeUrl","hasRule","pendingPromise","get_strings","key","component","shortname","then","strings","confirm","resolve","catch","exception","doMove","frameworkid","requests","call","methodname","args","competencyid","search","val","reloadPage","confirmMove","targetComp","getCompetency","sourceComp","confirmMessage","showConfirm","path","indexOf","initMovePopup","popup","body","getContent","treeRoot","find","tree","on","evt","target","selected","show","close","addCompetencyChildren","competencies","i","length","haschildren","children","moveHandler","e","preventDefault","competency","searchtext","when","apply","framework","competenciestree","onecompetency","Promise","all","render","html","editHandler","context","js","replaceNode","updateSearchHandler","moveUpHandler","moveDownHandler","fail","seeCoursesHandler","courses","get_string","linkedcourses","relateCompetenciesHandler","compIds","competencyIds","calls","each","index","value","push","relatedcompetencyid","promises","updatedRelatedCompetencies","setDisallowedCompetencyIDs","display","ruleConfigHandler","setTargetCompetencyId","ruleConfigSaveHandler","config","update","idnumber","description","descriptionformat","ruletype","ruleoutcome","ruleconfig","result","renderCompetencySummary","doDelete","success","managePage","alert","deleteCompetencyHandler","dragStart","originalEvent","dataTransfer","setData","allowDrop","dropEffect","dragEnter","addClass","dragLeave","removeClass","dropOver","getData","deleteRelatedHandler","relatedid","substr","triggerCompetencyViewedEvent","getTaxonomyAtLevel","level","constant","promise","Deferred","showdeleterelatedaction","showrelatedcompetencies","showrule","pluginbaseurl","NONE","getString","name","modInfo","type","strs","rule","outcome","replaceNodeContents","spinner","spinnerJs","strAddTaxonomy","strSelectedTaxonomy","selectionChanged","node","btn","actionMenu","selectedTitle","sublevel","closeAll","clone","remove","end","text","hide","getCompetencyLevel","selectedTaxonomyString","buttonString","parseTaxonomies","taxonomiesstr","split","unshift","init","model","pagectxid","taxonomies","rulesMods","enhance","bind","top"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle selection changes and actions on the competency tree.\n *\n * @module     tool_lp/competencyactions\n * @package    tool_lp\n * @copyright  2015 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery',\n        'core/url',\n        'core/templates',\n        'core/notification',\n        'core/str',\n        'core/ajax',\n        'tool_lp/dragdrop-reorder',\n        'tool_lp/tree',\n        'tool_lp/dialogue',\n        'tool_lp/menubar',\n        'tool_lp/competencypicker',\n        'tool_lp/competency_outcomes',\n        'tool_lp/competencyruleconfig',\n        'core/pending',\n        ],\n       function(\n            $, url, templates, notification, str, ajax, dragdrop, Ariatree, Dialogue, menubar, Picker, Outcomes, RuleConfig, Pending\n        ) {\n\n    // Private variables and functions.\n    /** @var {Object} treeModel - This is an object representing the nodes in the tree. */\n    var treeModel = null;\n    /** @var {Node} moveSource - The start of a drag operation */\n    var moveSource = null;\n    /** @var {Node} moveTarget - The end of a drag operation */\n    var moveTarget = null;\n    /** @var {Number} pageContextId The page context ID. */\n    var pageContextId;\n    /** @type {Object} Picker instance. */\n    var pickerInstance;\n    /** @type {Object} Rule config instance. */\n    var ruleConfigInstance;\n    /** @type {Object} The competency we're picking a relation to. */\n    var relatedTarget;\n    /** @type {Object} Taxonomy constants indexed per level. */\n    var taxonomiesConstants;\n    /** @type {Array} The rules modules. Values are object containing type, namd and amd. */\n    var rulesModules;\n    /** @type {Number} the selected competency ID. */\n    var selectedCompetencyId = null;\n\n    /**\n     * Respond to choosing the \"Add\" menu item for the selected node in the tree.\n     * @method addHandler\n     */\n    var addHandler = function() {\n        var parent = $('[data-region=\"competencyactions\"]').data('competency');\n\n        var params = {\n            competencyframeworkid: treeModel.getCompetencyFrameworkId(),\n            pagecontextid: pageContextId\n        };\n\n        if (parent !== null) {\n            // We are adding at a sub node.\n            params.parentid = parent.id;\n        }\n\n        var relocate = function() {\n            var queryparams = $.param(params);\n            window.location = url.relativeUrl('/admin/tool/lp/editcompetency.php?' + queryparams);\n        };\n\n        if (parent !== null && treeModel.hasRule(parent.id)) {\n            var pendingPromise = new Pending('tool_lp/competencyactions:addHandler');\n            str.get_strings([\n                {key: 'confirm', component: 'moodle'},\n                {key: 'addingcompetencywillresetparentrule', component: 'tool_lp', param: parent.shortname},\n                {key: 'yes', component: 'core'},\n                {key: 'no', component: 'core'}\n            ])\n            .then(function(strings) {\n                return notification.confirm(\n                    strings[0],\n                    strings[1],\n                    strings[2],\n                    strings[3],\n                    relocate\n                );\n            })\n            .then(pendingPromise.resolve)\n            .catch(notification.exception);\n        } else {\n            relocate();\n        }\n    };\n\n    /**\n     * A source and destination has been chosen - so time to complete a move.\n     * @method doMove\n     */\n    var doMove = function() {\n        var frameworkid = $('[data-region=\"filtercompetencies\"]').data('frameworkid');\n\n        var pendingPromise = new Pending('tool_lp/competencyactions:doMove');\n        var requests = ajax.call([\n            {\n                methodname: 'core_competency_set_parent_competency',\n                args: {competencyid: moveSource, parentid: moveTarget}\n            },\n            {\n                methodname: 'tool_lp_data_for_competencies_manage_page',\n                args: {\n                    competencyframeworkid: frameworkid,\n                    search: $('[data-region=\"filtercompetencies\"] input').val()\n                }\n            }\n        ]);\n\n        requests[1]\n        .then(reloadPage)\n        .then(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /**\n     * Confirms a competency move.\n     *\n     * @method confirmMove\n     */\n    var confirmMove = function() {\n        moveTarget = typeof moveTarget === \"undefined\" ? 0 : moveTarget;\n        if (moveTarget == moveSource) {\n            // No move to do.\n            return;\n        }\n\n        var targetComp = treeModel.getCompetency(moveTarget) || {},\n            sourceComp = treeModel.getCompetency(moveSource) || {},\n            confirmMessage = 'movecompetencywillresetrules',\n            showConfirm = false;\n\n        // We shouldn't be moving the competency to the same parent.\n        if (sourceComp.parentid == moveTarget) {\n            return;\n        }\n\n        // If we are moving to a child of self.\n        if (targetComp.path && targetComp.path.indexOf('/' + sourceComp.id + '/') >= 0) {\n            confirmMessage = 'movecompetencytochildofselfwillresetrules';\n\n            // Show a confirmation if self has rules, as they'll disappear.\n            showConfirm = showConfirm || treeModel.hasRule(sourceComp.id);\n        }\n\n        // Show a confirmation if the current parent, or the destination have rules.\n        showConfirm = showConfirm || (treeModel.hasRule(targetComp.id) || treeModel.hasRule(sourceComp.parentid));\n\n        // Show confirm, and/or do the things.\n        if (showConfirm) {\n            var pendingPromise = new Pending('tool_lp/competencyactions:confirmMove');\n            str.get_strings([\n                {key: 'confirm', component: 'moodle'},\n                {key: confirmMessage, component: 'tool_lp'},\n                {key: 'yes', component: 'moodle'},\n                {key: 'no', component: 'moodle'}\n            ])\n            .then(function(strings) {\n                return notification.confirm(\n                    strings[0], // Confirm.\n                    strings[1], // Delete competency X?\n                    strings[2], // Delete.\n                    strings[3], // Cancel.\n                    doMove\n                );\n            })\n            .then(pendingPromise.resolve)\n            .catch(notification.exception);\n\n        } else {\n            doMove();\n        }\n    };\n\n    /**\n     * A move competency popup was opened - initialise the aria tree in it.\n     * @method initMovePopup\n     * @param {dialogue} popup The tool_lp/dialogue that was created.\n     */\n    var initMovePopup = function(popup) {\n        var body = $(popup.getContent());\n        var treeRoot = body.find('[data-enhance=movetree]');\n        var tree = new Ariatree(treeRoot, false);\n        tree.on('selectionchanged', function(evt, params) {\n            var target = params.selected;\n            moveTarget = $(target).data('id');\n        });\n        treeRoot.show();\n\n        body.on('click', '[data-action=\"move\"]', function() {\n          popup.close();\n          confirmMove();\n        });\n        body.on('click', '[data-action=\"cancel\"]', function() {\n          popup.close();\n        });\n    };\n\n    /**\n     * Turn a flat list of competencies into a tree structure (recursive).\n     * @method addCompetencyChildren\n     * @param {Object} parent The current parent node in the tree\n     * @param {Object[]} competencies The flat list of competencies\n     */\n    var addCompetencyChildren = function(parent, competencies) {\n        var i;\n\n        for (i = 0; i < competencies.length; i++) {\n            if (competencies[i].parentid == parent.id) {\n                parent.haschildren = true;\n                competencies[i].children = [];\n                competencies[i].haschildren = false;\n                parent.children[parent.children.length] = competencies[i];\n                addCompetencyChildren(competencies[i], competencies);\n            }\n        }\n    };\n\n    /**\n     * A node was chosen and \"Move\" was selected from the menu. Open a popup to select the target.\n     * @param {Event} e\n     * @method moveHandler\n     */\n    var moveHandler = function(e) {\n        e.preventDefault();\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\n\n        // Remember what we are moving.\n        moveSource = competency.id;\n\n        // Load data for the template.\n        var pendingPromise = new Pending('tool_lp/competencyactions:confirmMove');\n        var requests = ajax.call([\n            {\n                methodname: 'core_competency_search_competencies',\n                args: {\n                    competencyframeworkid: competency.competencyframeworkid,\n                    searchtext: ''\n                }\n            }, {\n                methodname: 'core_competency_read_competency_framework',\n                args: {\n                    id: competency.competencyframeworkid\n                }\n            }\n        ]);\n\n        // When all data has arrived, continue.\n        $.when.apply(null, requests)\n        .then(function(competencies, framework) {\n            // Expand the list of competencies into a tree.\n            var i;\n            var competenciestree = [];\n            for (i = 0; i < competencies.length; i++) {\n                var onecompetency = competencies[i];\n                if (onecompetency.parentid == \"0\") {\n                    onecompetency.children = [];\n                    onecompetency.haschildren = 0;\n                    competenciestree[competenciestree.length] = onecompetency;\n                    addCompetencyChildren(onecompetency, competencies);\n                }\n            }\n\n            return Promise.all([\n                competenciestree,\n                framework,\n                str.get_strings([\n                    {key: 'movecompetency', component: 'tool_lp', param: competency.shortname},\n                    {key: 'move', component: 'tool_lp'},\n                    {key: 'cancel', component: 'moodle'}\n                ])\n            ]);\n        })\n        .then(function([competenciestree, framework, strings]) {\n            var context = {\n                framework: framework,\n                competencies: competenciestree\n            };\n\n            return Promise.all([\n                strings,\n                templates.render('tool_lp/competencies_move_tree', context),\n            ]);\n        })\n        .then(function([strings, html]) {\n            return new Dialogue(\n                strings[0], // Move competency x.\n                html, // The move tree.\n                initMovePopup\n            );\n        })\n        .then(pendingPromise.resolve)\n        .catch(notification.exception);\n\n    };\n\n    /**\n     * Edit the selected competency.\n     * @method editHandler\n     */\n    var editHandler = function() {\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\n\n        var params = {\n            competencyframeworkid: treeModel.getCompetencyFrameworkId(),\n            id: competency.id,\n            parentid: competency.parentid,\n            pagecontextid: pageContextId\n        };\n\n        var queryparams = $.param(params);\n        window.location = url.relativeUrl('/admin/tool/lp/editcompetency.php?' + queryparams);\n    };\n\n    /**\n     * Re-render the page with the latest data.\n     * @param {Object} context\n     * @method reloadPage\n     * @returns {Promise}\n     */\n    var reloadPage = function(context) {\n        return templates.render('tool_lp/manage_competencies_page', context)\n        .then(function(html, js) {\n            return templates.replaceNode($('[data-region=\"managecompetencies\"]'), html, js);\n        })\n        .catch(notification.exception);\n    };\n\n    /**\n     * Perform a search and render the page with the new search results.\n     * @param {Event} e\n     * @method updateSearchHandler\n     */\n    var updateSearchHandler = function(e) {\n        e.preventDefault();\n        var pendingPromise = new Pending('tool_lp/competencyactions:updateSearchHandler');\n\n        var frameworkid = $('[data-region=\"filtercompetencies\"]').data('frameworkid');\n\n        ajax.call([{\n            methodname: 'tool_lp_data_for_competencies_manage_page',\n            args: {\n                competencyframeworkid: frameworkid,\n                search: $('[data-region=\"filtercompetencies\"] input').val()\n            }\n        }])[0]\n        .then(reloadPage)\n        .then(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /**\n     * Move a competency \"up\". This only affects the sort order within the same branch of the tree.\n     * @method moveUpHandler\n     */\n    var moveUpHandler = function() {\n        var pendingPromise = new Pending('tool_lp/competencyactions:moveUpHandler');\n\n        // We are chaining ajax requests here.\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\n\n        var requests = ajax.call([\n            {\n                methodname: 'core_competency_move_up_competency',\n                args: {id: competency.id}\n            },\n            {\n                methodname: 'tool_lp_data_for_competencies_manage_page',\n                args: {\n                    competencyframeworkid: competency.competencyframeworkid,\n                    search: $('[data-region=\"filtercompetencies\"] input').val(),\n                }\n            }\n        ]);\n\n        requests[1]\n        .then(reloadPage)\n        .then(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /**\n     * Move a competency \"down\". This only affects the sort order within the same branch of the tree.\n     * @method moveDownHandler\n     */\n    var moveDownHandler = function() {\n        var pendingPromise = new Pending('tool_lp/competencyactions:moveUpHandler');\n\n        // We are chaining ajax requests here.\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\n\n        var requests = ajax.call([\n            {\n                methodname: 'core_competency_move_down_competency',\n                args: {id: competency.id}\n            },\n            {\n                methodname: 'tool_lp_data_for_competencies_manage_page',\n                args: {\n                    competencyframeworkid: competency.competencyframeworkid,\n                    search: $('[data-region=\"filtercompetencies\"] input').val(),\n                }\n            }\n        ]);\n\n        requests[1]\n        .then(reloadPage)\n        .then(pendingPromise.resolve)\n        .fail(notification.exception);\n    };\n\n    /**\n     * Open a dialogue to show all the courses using the selected competency.\n     * @method seeCoursesHandler\n     */\n    var seeCoursesHandler = function() {\n        var pendingPromise = new Pending('tool_lp/competencyactions:seeCoursesHandler');\n\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\n\n        ajax.call([{\n            methodname: 'tool_lp_list_courses_using_competency',\n            args: {id: competency.id}\n        }])[0]\n        .then(function(courses) {\n            var context = {\n                courses: courses\n            };\n            return Promise.all([\n                templates.render('tool_lp/linked_courses_summary', context),\n                str.get_string('linkedcourses', 'tool_lp'),\n            ]);\n        })\n        .then(function([html, linkedcourses]) {\n            return new Dialogue(\n                linkedcourses, // Title.\n                html, // The linked courses.\n                initMovePopup\n            );\n        })\n        .then(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /**\n     * Open a competencies popup to relate competencies.\n     *\n     * @method relateCompetenciesHandler\n     */\n    var relateCompetenciesHandler = function() {\n        relatedTarget = $('[data-region=\"competencyactions\"]').data('competency');\n\n        if (!pickerInstance) {\n            pickerInstance = new Picker(pageContextId, relatedTarget.competencyframeworkid);\n            pickerInstance.on('save', function(e, data) {\n                var pendingPromise = new Pending();\n                var compIds = data.competencyIds;\n\n                var calls = [];\n                $.each(compIds, function(index, value) {\n                    calls.push({\n                        methodname: 'core_competency_add_related_competency',\n                        args: {competencyid: value, relatedcompetencyid: relatedTarget.id}\n                    });\n                });\n\n                calls.push({\n                    methodname: 'tool_lp_data_for_related_competencies_section',\n                    args: {competencyid: relatedTarget.id}\n                });\n\n                var promises = ajax.call(calls);\n\n                promises[calls.length - 1].then(function(context) {\n                    return templates.render('tool_lp/related_competencies', context);\n                })\n                .then(function(html, js) {\n                    return templates.replaceNode($('[data-region=\"relatedcompetencies\"]'), html, js);\n                })\n                .then(updatedRelatedCompetencies)\n                .then(pendingPromise.resolve)\n                .catch(notification.exception);\n            });\n        }\n\n        pickerInstance.setDisallowedCompetencyIDs([relatedTarget.id]);\n        pickerInstance.display();\n    };\n\n    var ruleConfigHandler = function(e) {\n        e.preventDefault();\n        relatedTarget = $('[data-region=\"competencyactions\"]').data('competency');\n        ruleConfigInstance.setTargetCompetencyId(relatedTarget.id);\n        ruleConfigInstance.display();\n    };\n\n    var ruleConfigSaveHandler = function(e, config) {\n        var update = {\n            id: relatedTarget.id,\n            shortname: relatedTarget.shortname,\n            idnumber: relatedTarget.idnumber,\n            description: relatedTarget.description,\n            descriptionformat: relatedTarget.descriptionformat,\n            ruletype: config.ruletype,\n            ruleoutcome: config.ruleoutcome,\n            ruleconfig: config.ruleconfig\n        };\n\n        var pendingPromise = new Pending('tool_lp/competencyactions:ruleConfigSaveHandler');\n\n        ajax.call([{\n            methodname: 'core_competency_update_competency',\n            args: {competency: update}\n        }])[0]\n        .then(function(result) {\n            if (result) {\n                relatedTarget.ruletype = config.ruletype;\n                relatedTarget.ruleoutcome = config.ruleoutcome;\n                relatedTarget.ruleconfig = config.ruleconfig;\n                renderCompetencySummary(relatedTarget);\n            }\n            return result;\n        })\n        .then(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /**\n     * Delete a competency.\n     * @method doDelete\n     */\n    var doDelete = function() {\n        var pendingPromise = new Pending('tool_lp/competencyactions:doDelete');\n\n        // We are chaining ajax requests here.\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\n        var requests = ajax.call([\n            {\n                methodname: 'core_competency_delete_competency',\n                args: {id: competency.id}\n            },\n            {\n                methodname: 'tool_lp_data_for_competencies_manage_page',\n                args: {\n                    competencyframeworkid: competency.competencyframeworkid,\n                    search: $('[data-region=\"filtercompetencies\"] input').val(),\n                }\n            }\n        ]);\n\n        requests.push(str.get_strings([\n            {\n                key: 'competencycannotbedeleted',\n                component: 'tool_lp',\n                param: competency.shortname,\n            },\n            {\n                key: 'cancel',\n                component: 'moodle',\n            },\n        ]));\n\n        Promise.all(requests)\n        .then(function([success, managePage, strings]) {\n            if (!success) {\n                notification.alert(null, strings[0]);\n            }\n\n            return reloadPage(managePage);\n        })\n        .then(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /**\n     * Show a confirm dialogue before deleting a competency.\n     * @method deleteCompetencyHandler\n     */\n    var deleteCompetencyHandler = function() {\n        var pendingPromise = new Pending('tool_lp/competencyactions:deleteCompetencyHandler');\n\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\n        var confirmMessage = 'deletecompetency';\n\n        if (treeModel.hasRule(competency.parentid)) {\n            confirmMessage = 'deletecompetencyparenthasrule';\n        }\n\n        str.get_strings([\n            {key: 'confirm', component: 'moodle'},\n            {key: confirmMessage, component: 'tool_lp', param: competency.shortname},\n            {key: 'delete', component: 'moodle'},\n            {key: 'cancel', component: 'moodle'}\n        ])\n        .then(function(strings) {\n            return notification.confirm(\n                strings[0], // Confirm.\n                strings[1], // Delete competency X?\n                strings[2], // Delete.\n                strings[3], // Cancel.\n                doDelete\n            );\n        })\n        .then(pendingPromise.resolve)\n        .fail(notification.exception);\n    };\n\n    /**\n     * HTML5 implementation of drag/drop (there is an accesible alternative in the menus).\n     * @method dragStart\n     * @param {Event} e\n     */\n    var dragStart = function(e) {\n        e.originalEvent.dataTransfer.setData('text', $(e.target).parent().data('id'));\n    };\n\n    /**\n     * HTML5 implementation of drag/drop (there is an accesible alternative in the menus).\n     * @method allowDrop\n     * @param {Event} e\n     */\n    var allowDrop = function(e) {\n        e.originalEvent.dataTransfer.dropEffect = 'move';\n        e.preventDefault();\n    };\n\n    /**\n     * HTML5 implementation of drag/drop (there is an accesible alternative in the menus).\n     * @method dragEnter\n     * @param {Event} e\n     */\n    var dragEnter = function(e) {\n        e.preventDefault();\n        $(this).addClass('currentdragtarget');\n    };\n\n    /**\n     * HTML5 implementation of drag/drop (there is an accesible alternative in the menus).\n     * @method dragLeave\n     * @param {Event} e\n     */\n    var dragLeave = function(e) {\n        e.preventDefault();\n        $(this).removeClass('currentdragtarget');\n    };\n\n    /**\n     * HTML5 implementation of drag/drop (there is an accesible alternative in the menus).\n     * @method dropOver\n     * @param {Event} e\n     */\n    var dropOver = function(e) {\n        e.preventDefault();\n        moveSource = e.originalEvent.dataTransfer.getData('text');\n        moveTarget = $(e.target).parent().data('id');\n        $(this).removeClass('currentdragtarget');\n\n        confirmMove();\n    };\n\n    /**\n     * Deletes a related competency without confirmation.\n     *\n     * @param {Event} e The event that triggered the action.\n     * @method deleteRelatedHandler\n     */\n    var deleteRelatedHandler = function(e) {\n        e.preventDefault();\n\n        var pendingPromise = new Pending('tool_lp/competencyactions:deleteRelatedHandler');\n\n        var relatedid = this.id.substr(11);\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\n\n        ajax.call([\n            {\n                methodname: 'core_competency_remove_related_competency',\n                args: {\n                    relatedcompetencyid: relatedid,\n                    competencyid: competency.id,\n                },\n            },\n            {\n                methodname: 'tool_lp_data_for_related_competencies_section',\n                args: {\n                    competencyid: competency.id,\n                },\n            },\n        ])[1]\n        .then(function(context) {\n            return templates.render('tool_lp/related_competencies', context);\n        })\n        .then(function(html, js) {\n            return templates.replaceNode($('[data-region=\"relatedcompetencies\"]'), html, js);\n        })\n        .then(updatedRelatedCompetencies)\n        .then(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /**\n     * Updates the competencies list (with relations) and add listeners.\n     *\n     * @method updatedRelatedCompetencies\n     */\n    var updatedRelatedCompetencies = function() {\n        // Listeners to newly loaded related competencies.\n        $('[data-action=\"deleterelation\"]').on('click', deleteRelatedHandler);\n\n    };\n\n    /**\n     * Log the competency viewed event.\n     *\n     * @param  {Object} competency The competency.\n     * @method triggerCompetencyViewedEvent\n     */\n    var triggerCompetencyViewedEvent = function(competency) {\n        if (competency.id !== selectedCompetencyId) {\n            // Set the selected competency id.\n            selectedCompetencyId = competency.id;\n\n            var pendingPromise = new Pending('tool_lp/competencyactions:triggerCompetencyViewedEvent');\n            ajax.call([{\n                methodname: 'core_competency_competency_viewed',\n                args: {id: competency.id}\n            }])[0]\n            .then(pendingPromise.resolve)\n            .catch(notification.exception);\n        }\n    };\n\n    /**\n     * Return the taxonomy constant for a level.\n     *\n     * @param  {Number} level The level.\n     * @return {String}\n     * @function getTaxonomyAtLevel\n     */\n    var getTaxonomyAtLevel = function(level) {\n        var constant = taxonomiesConstants[level];\n        if (!constant) {\n            constant = 'competency';\n        }\n        return constant;\n    };\n\n    /**\n     * Render the competency summary.\n     *\n     * @param  {Object} competency The competency.\n     */\n    var renderCompetencySummary = function(competency) {\n        var promise = $.Deferred().resolve().promise();\n        var context = {};\n\n        context.competency = competency;\n        context.showdeleterelatedaction = true;\n        context.showrelatedcompetencies = true;\n        context.showrule = false;\n        context.pluginbaseurl = url.relativeUrl('/admin/tool/lp');\n\n        var pendingPromise = new Pending('tool_lp/competencyactions:renderCompetencySummary');\n\n        if (competency.ruleoutcome != Outcomes.NONE) {\n            // Get the outcome and rule name.\n            promise = Outcomes.getString(competency.ruleoutcome)\n            .then(function(str) {\n                var name;\n                $.each(rulesModules, function(index, modInfo) {\n                    if (modInfo.type == competency.ruletype) {\n                        name = modInfo.name;\n                    }\n                });\n                return [str, name];\n            });\n        }\n\n        promise.then(function(strs) {\n            if (typeof strs !== 'undefined') {\n                context.showrule = true;\n                context.rule = {\n                    outcome: strs[0],\n                    type: strs[1]\n                };\n            }\n            return context;\n        })\n        .then(function(context) {\n            return templates.render('tool_lp/competency_summary', context);\n        })\n        .then(function(html, js) {\n            return templates.replaceNodeContents($('[data-region=\"competencyinfo\"]'), html, js);\n        })\n        .then(function() {\n            return templates.render('tool_lp/loading', {});\n        })\n        .then(function(spinner, spinnerJs) {\n            return templates.replaceNodeContents('[data-region=\"relatedcompetencies\"]', spinner, spinnerJs);\n        })\n        .then(function() {\n            $('[data-action=\"deleterelation\"]').on('click', deleteRelatedHandler);\n\n            return;\n        })\n        .then(function() {\n            return ajax.call([{\n                methodname: 'tool_lp_data_for_related_competencies_section',\n                args: {competencyid: competency.id}\n            }])[0];\n        })\n        .then(function(context) {\n            return templates.render('tool_lp/related_competencies', context);\n        })\n        .then(function(html, js) {\n            return templates.replaceNode($('[data-region=\"relatedcompetencies\"]'), html, js);\n        })\n        .then(updatedRelatedCompetencies)\n        .then(pendingPromise.resolve)\n        .catch(notification.exception);\n    };\n\n    /**\n     * Return the string \"Add <taxonomy>\".\n     *\n     * @param  {Number} level The level.\n     * @return {String}\n     * @function strAddTaxonomy\n     */\n    var strAddTaxonomy = function(level) {\n        return str.get_string('taxonomy_add_' + getTaxonomyAtLevel(level), 'tool_lp');\n    };\n\n    /**\n     * Return the string \"Selected <taxonomy>\".\n     *\n     * @param  {Number} level The level.\n     * @return {String}\n     * @function strSelectedTaxonomy\n     */\n    var strSelectedTaxonomy = function(level) {\n        return str.get_string('taxonomy_selected_' + getTaxonomyAtLevel(level), 'tool_lp');\n    };\n\n    /**\n     * Handler when a node in the aria tree is selected.\n     * @method selectionChanged\n     * @param {Event} evt The event that triggered the selection change.\n     * @param {Object} params The parameters for the event. Contains a list of selected nodes.\n     * @return {Boolean}\n     */\n    var selectionChanged = function(evt, params) {\n        var node = params.selected,\n            id = $(node).data('id'),\n            btn = $('[data-region=\"competencyactions\"] [data-action=\"add\"]'),\n            actionMenu = $('[data-region=\"competencyactionsmenu\"]'),\n            selectedTitle = $('[data-region=\"selected-competency\"]'),\n            level = 0,\n            sublevel = 1;\n\n        menubar.closeAll();\n\n        if (typeof id === \"undefined\") {\n            // Assume this is the root of the tree.\n            // Here we are only getting the text from the top of the tree, to do it we clone the tree,\n            // remove all children and then call text on the result.\n            $('[data-region=\"competencyinfo\"]').html(node.clone().children().remove().end().text());\n            $('[data-region=\"competencyactions\"]').data('competency', null);\n            actionMenu.hide();\n\n        } else {\n            var competency = treeModel.getCompetency(id);\n\n            level = treeModel.getCompetencyLevel(id);\n            sublevel = level + 1;\n\n            actionMenu.show();\n            $('[data-region=\"competencyactions\"]').data('competency', competency);\n            renderCompetencySummary(competency);\n            // Log Competency viewed event.\n            triggerCompetencyViewedEvent(competency);\n        }\n\n        var pendingPromise = new Pending('tool_lp/competencyactions:selectionChanged');\n\n        Promise.all([\n            strSelectedTaxonomy(level),\n            strAddTaxonomy(sublevel),\n        ])\n        .then(function([selectedTaxonomyString, buttonString]) {\n            selectedTitle.text(selectedTaxonomyString);\n            btn.show().find('[data-region=\"term\"]').text(buttonString);\n            return;\n        })\n        .then(pendingPromise.resolve)\n        .catch(notification.exception);\n\n        // We handled this event so consume it.\n        evt.preventDefault();\n        return false;\n    };\n\n    /**\n     * Return the string \"Selected <taxonomy>\".\n     *\n     * @function parseTaxonomies\n     * @param  {String} taxonomiesstr Comma separated list of taxonomies.\n     * @return {Array} of level => taxonomystr\n     */\n    var parseTaxonomies = function(taxonomiesstr) {\n        var all = taxonomiesstr.split(',');\n        all.unshift(\"\");\n        delete all[0];\n\n        // Note we don't need to fill holes, because other functions check for empty anyway.\n        return all;\n    };\n\n    return {\n        /**\n         * Initialise this page (attach event handlers etc).\n         *\n         * @method init\n         * @param {Object} model The tree model provides some useful functions for loading and searching competencies.\n         * @param {Number} pagectxid The page context ID.\n         * @param {Object} taxonomies Constants indexed by level.\n         * @param {Object} rulesMods The modules of the rules.\n         */\n        init: function(model, pagectxid, taxonomies, rulesMods) {\n            treeModel = model;\n            pageContextId = pagectxid;\n            taxonomiesConstants = parseTaxonomies(taxonomies);\n            rulesModules = rulesMods;\n\n            $('[data-region=\"competencyactions\"] [data-action=\"add\"]').on('click', addHandler);\n\n            menubar.enhance('.competencyactionsmenu', {\n                '[data-action=\"edit\"]': editHandler,\n                '[data-action=\"delete\"]': deleteCompetencyHandler,\n                '[data-action=\"move\"]': moveHandler,\n                '[data-action=\"moveup\"]': moveUpHandler,\n                '[data-action=\"movedown\"]': moveDownHandler,\n                '[data-action=\"linkedcourses\"]': seeCoursesHandler,\n                '[data-action=\"relatedcompetencies\"]': relateCompetenciesHandler.bind(this),\n                '[data-action=\"competencyrules\"]': ruleConfigHandler.bind(this)\n            });\n            $('[data-region=\"competencyactionsmenu\"]').hide();\n            $('[data-region=\"competencyactions\"] [data-action=\"add\"]').hide();\n\n            $('[data-region=\"filtercompetencies\"]').on('submit', updateSearchHandler);\n            // Simple html5 drag drop because we already added an accessible alternative.\n            var top = $('[data-region=\"managecompetencies\"] [data-enhance=\"tree\"]');\n            top.on('dragstart', 'li>span', dragStart)\n                .on('dragover', 'li>span', allowDrop)\n                .on('dragenter', 'li>span', dragEnter)\n                .on('dragleave', 'li>span', dragLeave)\n                .on('drop', 'li>span', dropOver);\n\n            model.on('selectionchanged', selectionChanged);\n\n            // Prepare the configuration tool.\n            ruleConfigInstance = new RuleConfig(treeModel, rulesModules);\n            ruleConfigInstance.on('save', ruleConfigSaveHandler.bind(this));\n        }\n    };\n});\n"],"file":"competencyactions.min.js"}