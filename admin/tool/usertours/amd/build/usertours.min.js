define ("tool_usertours/usertours",["exports","./tour","core/templates","core/log","core/notification","./repository","core/pending","./events"],function(_exports,_tour,_templates,_log,_notification,tourRepository,_pending,_events){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.resetTourState=_exports.init=void 0;_tour=_interopRequireDefault(_tour);_templates=_interopRequireDefault(_templates);_log=_interopRequireDefault(_log);_notification=_interopRequireDefault(_notification);tourRepository=_interopRequireWildcard(tourRepository);_pending=_interopRequireDefault(_pending);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(null===obj||"object"!=typeof obj&&"function"!=typeof obj){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}let currentTour=null,tourId=null;const findMatchingTour=(tourDetails,filters)=>{return tourDetails.find(tour=>filters.some(filter=>{if(filter&&filter.filterMatches){return filter.filterMatches(tour)}return!0}))},init=async(tourDetails,filters)=>{const requirements=[];filters.forEach(filter=>{requirements.push("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise(function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["tool_usertours/filter_".concat(filter)],resolve,reject)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(("tool_usertours/filter_".concat(filter)))):Promise.resolve(_systemImportTransformerGlobalIdentifier["tool_usertours/filter_".concat(filter)]))});const filterPlugins=await Promise.all(requirements),matchingTour=findMatchingTour(tourDetails,filterPlugins);if(!matchingTour){return}tourId=matchingTour.tourId;let startTour=matchingTour.startTour;if("undefined"==typeof startTour){startTour=!0}if(startTour){fetchTour(tourId)}addResetLink();document.querySelector("body").addEventListener("click",e=>{const resetLink=e.target.closest("#resetpagetour");if(resetLink){e.preventDefault();resetTourState(tourId)}})};_exports.init=init;const fetchTour=async tourId=>{const pendingPromise=new _pending.default("admin_usertour_fetchTour:".concat(tourId));try{const response=await tourRepository.fetchTour(tourId);if(!response.hasOwnProperty("tourconfig")){pendingPromise.resolve()}const{html}=await _templates.default.renderForPromise("tool_usertours/tourstep",response.tourconfig);startBootstrapTour(tourId,html,response.tourconfig);pendingPromise.resolve()}catch(error){pendingPromise.resolve();_notification.default.exception(error)}},getPreferredResetLocation=()=>{let location=document.querySelector(".tool_usertours-resettourcontainer");if(location){return location}location=document.querySelector(".logininfo");if(location){return location}location=document.querySelector("footer");if(location){return location}return document.body},addResetLink=()=>{const pendingPromise=new _pending.default("admin_usertour_addResetLink");_templates.default.render("tool_usertours/resettour",{}).then(function(html,js){_templates.default.appendNodeContents(getPreferredResetLocation(),html,js)}).catch().then(pendingPromise.resolve).catch()},startBootstrapTour=(tourId,template,tourConfig)=>{if(currentTour&&currentTour.tourRunning){currentTour.endTour();currentTour=null}document.addEventListener(_events.eventTypes.tourEnded,markTourComplete);document.addEventListener(_events.eventTypes.stepRenderer,markStepShown);tourConfig.tourName=tourConfig.name;delete tourConfig.name;tourConfig.template=template;tourConfig.steps=tourConfig.steps.map(function(step){if("undefined"!=typeof step.element){step.target=step.element;delete step.element}if("undefined"!=typeof step.reflex){step.moveOnClick=!!step.reflex;delete step.reflex}if("undefined"!=typeof step.content){step.body=step.content;delete step.content}return step});currentTour=new _tour.default(tourConfig);return currentTour.startTour()},markStepShown=e=>{const tour=e.detail.tour,stepConfig=tour.getStepConfig(tour.getCurrentStepNumber());tourRepository.markStepShown(stepConfig.stepid,tourId,tour.getCurrentStepNumber()).catch(_log.default.error)},markTourComplete=e=>{document.removeEventListener(_events.eventTypes.tourEnded,markTourComplete);document.removeEventListener(_events.eventTypes.stepRenderer,markStepShown);const tour=e.detail.tour,stepConfig=tour.getStepConfig(tour.getCurrentStepNumber());tourRepository.markTourComplete(stepConfig.stepid,tourId,tour.getCurrentStepNumber()).catch(_log.default.error)},resetTourState=tourId=>tourRepository.resetTourState(tourId).then(response=>{if(response.startTour){fetchTour(response.startTour)}}).catch(_notification.default.exception);_exports.resetTourState=resetTourState});
//# sourceMappingURL=usertours.min.js.map
