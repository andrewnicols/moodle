define ("tool_usertours/usertours",["core/ajax","tool_usertours/tour","jquery","core/templates","core/str","core/log","core/notification"],function(ajax,BootstrapTour,$,templates,str,log,notification){var usertours={tourId:null,currentTour:null,init:function init(tourDetails,filters){for(var requirements=[],req=0;req<filters.length;req++){requirements[req]="tool_usertours/filter_"+filters[req]}require(requirements,function(){var matchingTour=null;for(var key in tourDetails){for(var tour=tourDetails[key],i=0,filter;i<filters.length;i++){filter=arguments[i];if(filter.filterMatches(tour)){matchingTour=tour}else{matchingTour=null;break}}if(matchingTour){break}}if(null===matchingTour){return}usertours.tourId=matchingTour.tourId;var startTour=matchingTour.startTour;if("undefined"==typeof startTour){startTour=!0}if(startTour){usertours.fetchTour(usertours.tourId)}usertours.addResetLink();$("body").on("click","[data-action=\"tool_usertours/resetpagetour\"]",function(e){e.preventDefault();usertours.resetTourState(usertours.tourId)})})},fetchTour:function fetchTour(tourId){M.util.js_pending("admin_usertour_fetchTour"+tourId);$.when(ajax.call([{methodname:"tool_usertours_fetch_and_start_tour",args:{tourid:tourId,context:M.cfg.contextid,pageurl:window.location.href}}])[0],templates.render("tool_usertours/tourstep",{})).then(function(response,template){if(!response.hasOwnProperty("tourconfig")){return}return usertours.startBootstrapTour(tourId,template[0],response.tourconfig)}).always(function(){M.util.js_complete("admin_usertour_fetchTour"+tourId)}).fail(notification.exception)},addResetLink:function addResetLink(){var ele;M.util.js_pending("admin_usertour_addResetLink");if($(".tool_usertours-resettourcontainer").length){ele=$(".tool_usertours-resettourcontainer")}else if($(".logininfo").length){ele=$(".logininfo")}else if($("footer").length){ele=$("footer")}else{ele=$("body")}templates.render("tool_usertours/resettour",{}).then(function(html,js){templates.appendNodeContents(ele,html,js)}).always(function(){M.util.js_complete("admin_usertour_addResetLink")}).fail()},startBootstrapTour:function startBootstrapTour(tourId,template,tourConfig){if(usertours.currentTour){tourConfig.onEnd=null;usertours.currentTour.endTour();delete usertours.currentTour}tourConfig.eventHandlers={afterEnd:[usertours.markTourComplete],afterRender:[usertours.markStepShown]};tourConfig.tourName=tourConfig.name;delete tourConfig.name;tourConfig.template=template;tourConfig.steps=tourConfig.steps.map(function(step){if("undefined"!=typeof step.element){step.target=step.element;delete step.element}if("undefined"!=typeof step.reflex){step.moveOnClick=!!step.reflex;delete step.reflex}if("undefined"!=typeof step.content){step.body=step.content;delete step.content}return step});usertours.currentTour=new BootstrapTour(tourConfig);return usertours.currentTour.startTour()},markStepShown:function markStepShown(){var stepConfig=this.getStepConfig(this.getCurrentStepNumber());$.when(ajax.call([{methodname:"tool_usertours_step_shown",args:{tourid:usertours.tourId,context:M.cfg.contextid,pageurl:window.location.href,stepid:stepConfig.stepid,stepindex:this.getCurrentStepNumber()}}])[0]).fail(log.error)},markTourComplete:function markTourComplete(){var stepConfig=this.getStepConfig(this.getCurrentStepNumber());$.when(ajax.call([{methodname:"tool_usertours_complete_tour",args:{tourid:usertours.tourId,context:M.cfg.contextid,pageurl:window.location.href,stepid:stepConfig.stepid,stepindex:this.getCurrentStepNumber()}}])[0]).fail(log.error)},resetTourState:function resetTourState(tourId){$.when(ajax.call([{methodname:"tool_usertours_reset_tour",args:{tourid:tourId,context:M.cfg.contextid,pageurl:window.location.href}}])[0]).then(function(response){if(response.startTour){usertours.fetchTour(response.startTour)}}).fail(notification.exception)}};return{init:usertours.init,resetTourState:usertours.resetTourState}});
//# sourceMappingURL=usertours.min.js.map
