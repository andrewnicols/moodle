{"version":3,"sources":["../src/usertours.js"],"names":["currentTour","tourId","findMatchingTour","tourDetails","filters","find","tour","some","filter","filterMatches","init","requirements","forEach","push","filterPlugins","Promise","all","matchingTour","startTour","fetchTour","addResetLink","document","querySelector","addEventListener","e","resetLink","target","closest","preventDefault","resetTourState","pendingPromise","Pending","response","tourRepository","hasOwnProperty","resolve","html","Templates","renderForPromise","tourconfig","startBootstrapTour","error","notification","exception","getPreferredResetLocation","location","body","render","then","js","appendNodeContents","catch","template","tourConfig","tourRunning","endTour","eventTypes","tourEnded","markTourComplete","stepRenderer","markStepShown","tourName","name","steps","map","step","element","reflex","moveOnClick","content","BootstrapTour","detail","stepConfig","getStepConfig","getCurrentStepNumber","stepid","log","removeEventListener"],"mappings":"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","sourcesContent":["/**\n * User tour control library.\n *\n * @module     tool_usertours/usertours\n * @copyright  2016 Andrew Nicols <andrew@nicols.co.uk>\n */\nimport BootstrapTour from './tour';\nimport Templates from 'core/templates';\nimport log from 'core/log';\nimport notification from 'core/notification';\nimport * as tourRepository from './repository';\nimport Pending from 'core/pending';\nimport {eventTypes} from './events';\n\nlet currentTour = null;\nlet tourId = null;\n\n/**\n * Find the first matching tour.\n *\n * @param {object[]} tourDetails\n * @param {object[]} filters\n * @returns {null|object}\n */\nconst findMatchingTour = (tourDetails, filters) => {\n    return tourDetails.find(tour => filters.some(filter => {\n        if (filter && filter.filterMatches) {\n            return filter.filterMatches(tour);\n        }\n\n        return true;\n    }));\n};\n\n/**\n * Initialise the user tour for the current page.\n *\n * @method  init\n * @param   {Array}    tourDetails      The matching tours for this page.\n * @param   {Array}    filters          The names of all client side filters.\n */\nexport const init = async(tourDetails, filters) => {\n    const requirements = [];\n    filters.forEach(filter => {\n        requirements.push(import(`tool_usertours/filter_${filter}`));\n    });\n\n    const filterPlugins = await Promise.all(requirements);\n\n    const matchingTour = findMatchingTour(tourDetails, filterPlugins);\n    if (!matchingTour) {\n        return;\n    }\n\n    // Only one tour per page is allowed.\n    tourId = matchingTour.tourId;\n\n    let startTour = matchingTour.startTour;\n    if (typeof startTour === 'undefined') {\n        startTour = true;\n    }\n\n    if (startTour) {\n        // Fetch the tour configuration.\n        fetchTour(tourId);\n    }\n\n    addResetLink();\n\n    // Watch for the reset link.\n    document.querySelector('body').addEventListener('click', e => {\n        const resetLink = e.target.closest('#resetpagetour');\n        if (resetLink) {\n            e.preventDefault();\n            resetTourState(tourId);\n        }\n    });\n};\n\n/**\n * Fetch the configuration specified tour, and start the tour when it has been fetched.\n *\n * @method  fetchTour\n * @param   {Number}    tourId      The ID of the tour to start.\n */\nconst fetchTour = async tourId => {\n    const pendingPromise = new Pending(`admin_usertour_fetchTour:${tourId}`);\n\n    try {\n        const response = await tourRepository.fetchTour(tourId);\n        if (!response.hasOwnProperty('tourconfig')) {\n            pendingPromise.resolve();\n        }\n\n        const {html} = await Templates.renderForPromise('tool_usertours/tourstep', response.tourconfig);\n        startBootstrapTour(tourId, html, response.tourconfig);\n\n        pendingPromise.resolve();\n    } catch (error) {\n        pendingPromise.resolve();\n        notification.exception(error);\n    }\n};\n\nconst getPreferredResetLocation = () => {\n    let location = document.querySelector('.tool_usertours-resettourcontainer');\n    if (location) {\n        return location;\n    }\n\n    location = document.querySelector('.logininfo');\n    if (location) {\n        return location;\n    }\n\n    location = document.querySelector('footer');\n    if (location) {\n        return location;\n    }\n\n    return document.body;\n};\n\n/**\n * Add a reset link to the page.\n *\n * @method  addResetLink\n */\nconst addResetLink = () => {\n    const pendingPromise = new Pending('admin_usertour_addResetLink');\n\n    Templates.render('tool_usertours/resettour', {})\n    .then(function(html, js) {\n        // Append the link to the most suitable place on the page with fallback to legacy selectors and finally the body if\n        // there is no better place.\n        Templates.appendNodeContents(getPreferredResetLocation(), html, js);\n\n        return;\n    })\n    .catch()\n    .then(pendingPromise.resolve)\n    .catch();\n};\n\n/**\n * Start the specified tour.\n *\n * @method  startBootstrapTour\n * @param   {Number}    tourId      The ID of the tour to start.\n * @param   {String}    template    The template to use.\n * @param   {Object}    tourConfig  The tour configuration.\n * @return  {Object}\n */\nconst startBootstrapTour = (tourId, template, tourConfig) => {\n    if (currentTour && currentTour.tourRunning) {\n        // End the current tour.\n        currentTour.endTour();\n        currentTour = null;\n    }\n\n    document.addEventListener(eventTypes.tourEnded, markTourComplete);\n    document.addEventListener(eventTypes.stepRenderer, markStepShown);\n\n    // Sort out the tour name.\n    tourConfig.tourName = tourConfig.name;\n    delete tourConfig.name;\n\n    // Add the template to the configuration.\n    // This enables translations of the buttons.\n    tourConfig.template = template;\n\n    tourConfig.steps = tourConfig.steps.map(function(step) {\n        if (typeof step.element !== 'undefined') {\n            step.target = step.element;\n            delete step.element;\n        }\n\n        if (typeof step.reflex !== 'undefined') {\n            step.moveOnClick = !!step.reflex;\n            delete step.reflex;\n        }\n\n        if (typeof step.content !== 'undefined') {\n            step.body = step.content;\n            delete step.content;\n        }\n\n        return step;\n    });\n\n    currentTour = new BootstrapTour(tourConfig);\n    return currentTour.startTour();\n};\n\n/**\n * Mark the specified step as being shownd by the user.\n *\n * @method  markStepShown\n * @param   {Event} e\n */\nconst markStepShown = e => {\n    const tour = e.detail.tour;\n    const stepConfig = tour.getStepConfig(tour.getCurrentStepNumber());\n    tourRepository.markStepShown(\n        stepConfig.stepid,\n        tourId,\n        tour.getCurrentStepNumber()\n    ).catch(log.error);\n};\n\n/**\n * Mark the specified tour as being completed by the user.\n *\n * @method  markTourComplete\n * @param   {Event} e\n * @listens tool_usertours/stepRendered\n */\nconst markTourComplete = e => {\n    document.removeEventListener(eventTypes.tourEnded, markTourComplete);\n    document.removeEventListener(eventTypes.stepRenderer, markStepShown);\n\n    const tour = e.detail.tour;\n    const stepConfig = tour.getStepConfig(tour.getCurrentStepNumber());\n    tourRepository.markTourComplete(\n        stepConfig.stepid,\n        tourId,\n        tour.getCurrentStepNumber()\n    ).catch(log.error);\n};\n\n/**\n * Reset the state, and restart the the tour on the current page.\n *\n * @method  resetTourState\n * @param   {Number}    tourId      The ID of the tour to start.\n * @returns {Promise}\n */\nexport const resetTourState = tourId => tourRepository.resetTourState(tourId)\n.then(response => {\n    if (response.startTour) {\n        fetchTour(response.startTour);\n    }\n    return;\n}).catch(notification.exception);\n"],"file":"usertours.min.js"}