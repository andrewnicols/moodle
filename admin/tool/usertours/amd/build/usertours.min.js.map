{"version":3,"sources":["../src/usertours.js"],"names":["currentTour","tourId","findMatchingTour","tourDetails","filters","find","tour","some","filter","filterMatches","init","requirements","forEach","push","Promise","all","filterPlugins","matchingTour","startTour","fetchTour","addResetLink","document","querySelector","addEventListener","e","resetLink","target","closest","preventDefault","resetTourState","pendingPromise","Pending","tourRepository","response","hasOwnProperty","resolve","Templates","renderForPromise","tourconfig","html","startBootstrapTour","notification","exception","getPreferredResetLocation","location","body","render","then","js","appendNodeContents","catch","template","tourConfig","tourRunning","endTour","eventTypes","tourEnded","markTourComplete","stepRenderer","markStepShown","tourName","name","steps","map","step","element","reflex","moveOnClick","content","BootstrapTour","detail","stepConfig","getStepConfig","getCurrentStepNumber","stepid","log","error","removeEventListener"],"mappings":"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","sourcesContent":["/**\n * User tour control library.\n *\n * @module     tool_usertours/usertours\n * @copyright  2016 Andrew Nicols <andrew@nicols.co.uk>\n */\nimport BootstrapTour from './tour';\nimport Templates from 'core/templates';\nimport log from 'core/log';\nimport notification from 'core/notification';\nimport * as tourRepository from './repository';\nimport Pending from 'core/pending';\nimport {eventTypes} from './events';\n\nlet currentTour = null;\nlet tourId = null;\n\n/**\n * Find the first matching tour.\n *\n * @param {object[]} tourDetails\n * @param {object[]} filters\n * @returns {null|object}\n */\nconst findMatchingTour = (tourDetails, filters) => {\n    return tourDetails.find(tour => filters.some(filter => {\n        if (filter && filter.filterMatches) {\n            return filter.filterMatches(tour);\n        }\n\n        return true;\n    }));\n};\n\n/**\n * Initialise the user tour for the current page.\n *\n * @method  init\n * @param   {Array}    tourDetails      The matching tours for this page.\n * @param   {Array}    filters          The names of all client side filters.\n */\nexport const init = async(tourDetails, filters) => {\n    const requirements = [];\n    filters.forEach(filter => {\n        requirements.push(import(`tool_usertours/filter_${filter}`));\n    });\n\n    const filterPlugins = await Promise.all(requirements);\n\n    const matchingTour = findMatchingTour(tourDetails, filterPlugins);\n    if (!matchingTour) {\n        return;\n    }\n\n    // Only one tour per page is allowed.\n    tourId = matchingTour.tourId;\n\n    let startTour = matchingTour.startTour;\n    if (typeof startTour === 'undefined') {\n        startTour = true;\n    }\n\n    if (startTour) {\n        // Fetch the tour configuration.\n        fetchTour(tourId);\n    }\n\n    addResetLink();\n\n    // Watch for the reset link.\n    document.querySelector('body').addEventListener('click', e => {\n        const resetLink = e.target.closest('#resetpagetour');\n        if (resetLink) {\n            e.preventDefault();\n            resetTourState(tourId);\n        }\n    });\n};\n\n/**\n * Fetch the configuration specified tour, and start the tour when it has been fetched.\n *\n * @method  fetchTour\n * @param   {Number}    tourId      The ID of the tour to start.\n */\nconst fetchTour = async tourId => {\n    const pendingPromise = new Pending(`admin_usertour_fetchTour:${tourId}`);\n\n    try {\n        const response = await tourRepository.fetchTour(tourId);\n        if (!response.hasOwnProperty('tourconfig')) {\n            pendingPromise.resolve();\n        }\n\n        const {html} = await Templates.renderForPromise('tool_usertours/tourstep', response.tourconfig);\n        startBootstrapTour(tourId, html, response.tourconfig);\n\n        pendingPromise.resolve();\n    } catch (error) {\n        pendingPromise.resolve();\n        notification.exception(error);\n    }\n};\n\nconst getPreferredResetLocation = () => {\n    let location = document.querySelector('.tool_usertours-resettourcontainer');\n    if (location) {\n        return location;\n    }\n\n    location = document.querySelector('.logininfo');\n    if (location) {\n        return location;\n    }\n\n    location = document.querySelector('footer');\n    if (location) {\n        return location;\n    }\n\n    return document.body;\n};\n\n/**\n * Add a reset link to the page.\n *\n * @method  addResetLink\n */\nconst addResetLink = () => {\n    const pendingPromise = new Pending('admin_usertour_addResetLink');\n\n    Templates.render('tool_usertours/resettour', {})\n    .then(function(html, js) {\n        // Append the link to the most suitable place on the page with fallback to legacy selectors and finally the body if\n        // there is no better place.\n        Templates.appendNodeContents(getPreferredResetLocation(), html, js);\n\n        return;\n    })\n    .catch()\n    .then(pendingPromise.resolve)\n    .catch();\n};\n\n/**\n * Start the specified tour.\n *\n * @method  startBootstrapTour\n * @param   {Number}    tourId      The ID of the tour to start.\n * @param   {String}    template    The template to use.\n * @param   {Object}    tourConfig  The tour configuration.\n * @return  {Object}\n */\nconst startBootstrapTour = (tourId, template, tourConfig) => {\n    if (currentTour && currentTour.tourRunning) {\n        // End the current tour.\n        currentTour.endTour();\n        currentTour = null;\n    }\n\n    document.addEventListener(eventTypes.tourEnded, markTourComplete);\n    document.addEventListener(eventTypes.stepRenderer, markStepShown);\n\n    // Sort out the tour name.\n    tourConfig.tourName = tourConfig.name;\n    delete tourConfig.name;\n\n    // Add the template to the configuration.\n    // This enables translations of the buttons.\n    tourConfig.template = template;\n\n    tourConfig.steps = tourConfig.steps.map(function(step) {\n        if (typeof step.element !== 'undefined') {\n            step.target = step.element;\n            delete step.element;\n        }\n\n        if (typeof step.reflex !== 'undefined') {\n            step.moveOnClick = !!step.reflex;\n            delete step.reflex;\n        }\n\n        if (typeof step.content !== 'undefined') {\n            step.body = step.content;\n            delete step.content;\n        }\n\n        return step;\n    });\n\n    currentTour = new BootstrapTour(tourConfig);\n    return currentTour.startTour();\n};\n\n/**\n * Mark the specified step as being shownd by the user.\n *\n * @method  markStepShown\n * @param   {Event} e\n */\nconst markStepShown = e => {\n    const tour = e.detail.tour;\n    const stepConfig = tour.getStepConfig(tour.getCurrentStepNumber());\n    tourRepository.markStepShown(\n        stepConfig.stepid,\n        tourId,\n        tour.getCurrentStepNumber()\n    ).catch(log.error);\n};\n\n/**\n * Mark the specified tour as being completed by the user.\n *\n * @method  markTourComplete\n * @param   {Event} e\n * @listens tool_usertours/stepRendered\n */\nconst markTourComplete = e => {\n    document.removeEventListener(eventTypes.tourEnded, markTourComplete);\n    document.removeEventListener(eventTypes.stepRenderer, markStepShown);\n\n    const tour = e.detail.tour;\n    const stepConfig = tour.getStepConfig(tour.getCurrentStepNumber());\n    tourRepository.markTourComplete(\n        stepConfig.stepid,\n        tourId,\n        tour.getCurrentStepNumber()\n    ).catch(log.error);\n};\n\n/**\n * Reset the state, and restart the the tour on the current page.\n *\n * @method  resetTourState\n * @param   {Number}    tourId      The ID of the tour to start.\n * @returns {Promise}\n */\nexport const resetTourState = tourId => tourRepository.resetTourState(tourId)\n.then(response => {\n    if (response.startTour) {\n        fetchTour(response.startTour);\n    }\n    return;\n}).catch(notification.exception);\n"],"file":"usertours.min.js"}