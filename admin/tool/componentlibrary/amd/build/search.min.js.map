{"version":3,"sources":["../src/search.js"],"names":["lunrIndex","pagesIndex","fetchJson","jsonFile","fetch","response","ok","Log","debug","status","json","initLunr","then","jsondata","ref","field","boost","forEach","p","add","catch","Notification","exception","initUI","searchInput","document","querySelector","selectors","searchinput","addEventListener","e","query","currentTarget","value","length","dropdownmenu","classList","remove","renderResults","searchIndex","keyCode","enter","preventDefault","escape","search","map","result","filter","page","uri","results","dropdownMenu","innerHTML","baseUrl","M","cfg","wwwroot","slice","link","createElement","chapter","split","appendChild","createTextNode","title","href"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Interface to the Lunr search engines.\n *\n * @module     tool_componentlibrary/search\n * @copyright  2021 Bas Brands <bas@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport lunrJs from 'tool_componentlibrary/lunr';\nimport selectors from 'tool_componentlibrary/selectors';\nimport Log from 'core/log';\nimport Notification from 'core/notification';\nimport {enter, escape} from 'core/key_codes';\n\nlet lunrIndex = null;\nlet pagesIndex = null;\n\n/**\n * Get the jsonFile that is generated when the component library is build.\n *\n * @method\n * @private\n * @param {String} jsonFile the URL to the json file.\n * @return {Object}\n */\nconst fetchJson = async(jsonFile) => {\n    const response = await fetch(jsonFile);\n\n    if (!response.ok) {\n        Log.debug(`Error getting Hugo index file: ${response.status}`);\n    }\n\n    return await response.json();\n};\n\n/**\n * Initiate lunr on the data in the jsonFile and add the jsondata to the pagesIndex\n *\n * @method\n * @private\n * @param {String} jsonFile the URL to the json file.\n */\nconst initLunr = jsonFile => {\n    fetchJson(jsonFile).then(jsondata => {\n        pagesIndex = jsondata;\n        // Using an arrow function here will break lunr on compile.\n        lunrIndex = lunrJs(function() {\n            this.ref('uri');\n            this.field('title', {boost: 10});\n            this.field('content');\n            this.field('tags', {boost: 5});\n            jsondata.forEach(p => {\n                this.add(p);\n            });\n        });\n        return null;\n    }).catch(Notification.exception);\n};\n\n/**\n * Setup the eventlistener to listen on user input on the search field.\n *\n * @method\n * @private\n */\nconst initUI = () => {\n    const searchInput = document.querySelector(selectors.searchinput);\n    searchInput.addEventListener('keyup', e => {\n        const query = e.currentTarget.value;\n        if (query.length < 2) {\n            document.querySelector(selectors.dropdownmenu).classList.remove('show');\n            return;\n        }\n        renderResults(searchIndex(query));\n    });\n    searchInput.addEventListener('keydown', e => {\n        if (e.keyCode === enter) {\n            e.preventDefault();\n        }\n        if (e.keyCode === escape) {\n            searchInput.value = '';\n        }\n    });\n};\n\n/**\n * Trigger a search in lunr and transform the result.\n *\n * @method\n * @private\n * @param  {String} query\n * @return {Array} results\n */\nconst searchIndex = query => {\n    // Find the item in our index corresponding to the lunr one to have more info\n    // Lunr result:\n    //  {ref: \"/section/page1\", score: 0.2725657778206127}\n    // Our result:\n    //  {title:\"Page1\", href:\"/section/page1\", ...}\n\n    return lunrIndex.search(query + ' ' + query + '*').map(result => {\n        return pagesIndex.filter(page => {\n            return page.uri === result.ref;\n        })[0];\n    });\n};\n\n/**\n * Display the 10 first results\n *\n * @method\n * @private\n * @param {Array} results to display\n */\nconst renderResults = results => {\n    const dropdownMenu = document.querySelector(selectors.dropdownmenu);\n    if (!results.length) {\n        dropdownMenu.classList.remove('show');\n        return;\n    }\n\n    // Clear out the results.\n    dropdownMenu.innerHTML = '';\n\n    const baseUrl = M.cfg.wwwroot + '/admin/tool/componentlibrary/docspage.php';\n\n    // Only show the ten first results\n    results.slice(0, 10).forEach(function(result) {\n        const link = document.createElement(\"a\");\n        const chapter = result.uri.split('/')[1];\n        link.appendChild(document.createTextNode(`${chapter} > ${result.title}`));\n        link.classList.add('dropdown-item');\n        link.href = baseUrl + result.uri;\n\n        dropdownMenu.appendChild(link);\n    });\n\n    dropdownMenu.classList.add('show');\n};\n\n/**\n * Initialize module.\n *\n * @method\n * @param {String} jsonFile Full path to the search DB json file.\n */\nexport const search = jsonFile => {\n    initLunr(jsonFile);\n    initUI();\n};\n"],"file":"search.min.js"}